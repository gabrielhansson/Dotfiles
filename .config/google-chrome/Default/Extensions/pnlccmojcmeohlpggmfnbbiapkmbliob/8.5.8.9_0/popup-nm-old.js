// Copyright (C) 1999-2019 Siber Systems Inc. All Rights Reserved.
var PopupNMOld=function(){function t(){PopupBase.call(this),this.kMinV8RoboFormVersion="8-0-1-3",this.kMouseEvents=["mousedown","mouseup","mouseover","mousemove","mouseout","mousewheel"],this.base=PopupBase.prototype,window.oncontextmenu=function(){return!1},this.g_current_items=[],this.g_current_button_type=""}function e(){console_output("PT: "+format_log_args(e.caller,arguments))}return t.prototype=Object.create(PopupBase.prototype),t.prototype.OnLoad=function(){this.base.OnLoad.call(this);try{this.AddStyleSheets(),g_bg_connector.setPopupActive(!0),g_bg_connector.initUI();var t=this;function o(){if(g_is_mac)try{var e=document.createElement("img");e.setAttribute("id","rf-embed-placeholder"),e.setAttribute("height","241"),e.setAttribute("width","128"),document.body.replaceChild(e,$("toolbar")),g_bg_connector.getProp("toolbar-image",function(t){t&&""!=t&&(e.setAttribute("src",t),e.naturalWidth&&e.naturalHeight&&(e.width=e.naturalWidth/window.devicePixelRatio,e.height=e.naturalHeight/window.devicePixelRatio),e.naturalWidth,e.naturalHeight)}),window.addEventListener("mouseover",function(e){t.OnMouseOver_Mac(e)},!1)}catch(t){}GetSelectedTab(null,function(e){e&&e.id&&(g_isfirefox&&t.g_is_V8?g_bg_connector.SetChromeV8Style(function(){t.InitPopup(e.id)}):t.InitPopup(e.id))}),browser.runtime.onMessage.addListener(function(e,o,n){switch(e.name){case"update-match":return g_isfirefox&&t.g_is_V8?g_bg_connector.SetChromeV8Style(function(){t.UpdateMatch(e.tab_id)}):t.UpdateMatch(e.tab_id),void n({});case"close-popup":return window.close(),void n({});case"putSetting":return void t.OnSettingChanged(e.data)}})}g_is_mac?o():g_bg_connector.getRfVersion(function(e){e&&(CompareVersions(e,t.kMinV8RoboFormVersion,"-")>=0&&(t.g_is_V8=!0));o()})}catch(t){e(t),this.OnError(kCannotLoadExtension,t)}},t.prototype.AddStyleSheets=function(){AddCssFile("popup-nm.css")},t.prototype.OnUnload=function(){g_bg_connector.setPopupActive(!1),this.base.OnUnload.call(this)},t.prototype.GetDefaultContainer=function(){return $("ui-items")},t.prototype.OnSettingChanged=function(t){var e=t.section,o=t.name;t.value;if("nm-settings"==e&&!g_is_mac)switch(o){case"horizontal":this.UpdateUI()}},t.prototype.OnMouseOver_Mac=function(t){g_bg_connector.updateNativeToolbar(t.clientX,t.clientY,t.screenX,t.screenY)},t.prototype.InitPopup=function(t){if(t&&(g_bg_connector.setCurrentBrowser(t),!g_isfirefox&&this.g_is_V8&&g_bg_connector.onUIEvent(JSON.stringify({type:"chrome-set-V8-style"})),!g_is_mac)){var e=this;this.EnsureUptodate(function(){e.UpdateUI(),document.body.addEventListener("mousemove",function(t){e.setupClientToScreenOffsetFromEvent(t)},!1),setTimeout(function(){document.body.addEventListener("mouseup",function(t){e.OnUIEvent(t)},!1);var t=$("layout-button");t&&t.addEventListener("click",function(){var t=!GetSetting("nm-settings","horizontal");PutSetting("nm-settings","horizontal",t),PutSettingNotify("nm-settings","horizontal",t),e.UpdateUI()},!1),g_bg_connector.onUIEvent(JSON.stringify({type:"init-popup"})),setInterval(function(){e.OnUpdateSettings()},1e3)},10),g_isfirefox&&GetSetting("nm-settings","focus")&&setTimeout(function(){var t=e.GetSearchEditBox();t&&t.focus()},200)})}},t.prototype.SetupAutoFocus=function(t){GetSetting("nm-settings","focus")&&t.setAttribute("autofocus","")},t.prototype.OnUpdateSettings=function(){if(g_bg_connector){var t=this;this.EnsureUptodate(function(e){e||t.UpdateUI()})}},t.prototype.UpdateMatch=function(t){if(g_bg_connector.setCurrentBrowser(t),!g_isfirefox&&this.g_is_V8&&g_bg_connector.onUIEvent(JSON.stringify({type:"chrome-set-V8-style"})),!g_is_mac){var e=this;this.EnsureUptodate(function(t){t?g_bg_connector.getProp(["match","!ToolbarButtonTextType"],function(t){var o=t.match,n=e.GetButtonType(t["!ToolbarButtonTextType"]),i=ParseJSON(o),r=i&&i.m_nID,c=r&&$(r);if(c){var s=e.CreateUIItem(i,n);c.parentNode.replaceChild(s,c),e.g_match_node=s}else e.g_match_node&&e.g_match_node.parentNode&&e.g_match_node.parentNode.removeChild(e.g_match_node),e.g_match_node=void 0;setTimeout(function(){e.CheckOverflow(),setTimeout(function(){e.UpdateUIInfo()},1)},1)}):e.UpdateUI()})}},t.prototype.CreateInlineButtonsWrapper=function(){return this.createElement("table",{id:"inline-buttons-wrapper",class:"inline-buttons-wrapper"})},t.prototype.UpdateUI=function(){var t=this;g_bg_connector.getProp(["toolbar","!ToolbarButtonTextType"],function(e){var o=JSON.parse(e.toolbar),n=[];if(t.g_is_V8){o.unshift(new ViewItem(void 0,void 0,"header-title"));for(var i=0;i<o.length;i++){"save"!=(d=o[i]).m_sName&&"generate"!=d.m_sName&&"sync"!=d.m_sName&&"security-center"!=d.m_sName||n.push(d)}if(n.length){var r;for(i=0;i<n.length;i++)(r=o.indexOf(n[i]))>-1&&o.splice(r,1);o.splice(r,0,new ViewItem(void 0,void 0,"inline-buttons-wrapper"))}}var c=t.GetButtonType(e["!ToolbarButtonTextType"]);if(t.g_is_V8&&t.g_current_button_type==c&&t.g_current_items.length>0&&t.g_current_items.length==t.g_ui_nodes.length){for(var s=0,a=t.g_ui_nodes.slice(),u=0;u<o.length;u++){var _,l=o[u];if(s>=t.g_current_items.length)t.AddUIItem(l,c,null);else if(_="match"==(h=t.g_current_items[s]).m_sName?t.g_match_node:a[s],h.m_nID!=l.m_nID||h.m_sName!=l.m_sName||h.m_sType!=l.m_sType||h.m_sIconData!=l.m_sIconData||h.m_sSuffix!=l.m_sSuffix||h.m_sText!=l.m_sText||h.m_nFlags!=l.m_nFlags||h.m_nMaxWidth!=l.m_nMaxWidth||h.m_sTooltip!=l.m_sTooltip)if(h.m_nID!=l.m_nID){var p=!1;for(i=s;i<t.g_current_items.length;i++){var d;if((d=t.g_current_items[i]).m_nID==l.m_nID){for(var g=s;g<i;g++)_="match"==(h=t.g_current_items[g]).m_sName?t.g_match_node:a[g],t.RemoveUIItem(h,_);p=!0,s=i+1;break}}p||t.AddUIItem(l,c,_)}else t.UpdateUIItem(l,c,_),s++;else s++}if(s<t.g_current_items.length)for(i=s;i<t.g_current_items.length;i++){var h;_="match"==(h=t.g_current_items[i]).m_sName?t.g_match_node:a[i],t.RemoveUIItem(h,_)}return t.g_current_items=o,void setTimeout(function(){t.CheckOverflow(),setTimeout(function(){t.UpdateUIInfo()},1)},1)}t.g_current_items=o,t.g_current_button_type=c;var m="",f=!1;if(t.g_is_V8){var v=t.GetSearchEditBox();v&&(m=v.value,f=v===document.activeElement)}t.base.UpdateUI.call(t),t.CreateItemsView(o,c),t.AppendItemsView(t.CreateInlineButtonsRows(t.BuildItemsView(n,c)),$("inline-buttons-wrapper"));var b=$("custom-ui-items");b&&0==b.childNodes.length&&(b.style.display="none");var y=$("ui-items");y&&0==y.childNodes.length&&(y.style.display="none"),setTimeout(function(){t.CheckOverflow(),setTimeout(function(){if(t.UpdateUIInfo(),t.g_is_V8&&(""!=m||f)){var e=t.GetSearchEditBox();if(e){if(m){e.value=m;var o=$("search_icon_id");o&&(o.style.display="none")}f&&(e.focus(),m&&t.ScheduleUpdateSearchList(!0))}}},1)},1)})},t.prototype.CreateMatchTitle=function(){var t,e=this.createElement("div",{class:"toolbar-match-title-V8",id:"match-title"},[t=this.createTextNode("Fill from:")]);return g_bg_connector.getProp("IDS_Toolbar_Chrome_Match_Title",function(e){t.data=e}),e},t.prototype.EnsureUptodate=function(t){if(g_bg_connector){var e=this;g_bg_connector.ensureUptodate(function(o){var n=o.timestamp;if(o.uptodate){if(e.g_time_stamp==n)return void t(!0);e.g_time_stamp}e.g_time_stamp=n,t(!1)})}},t.prototype.SetHorizontalLayout=function(t){this.base.SetHorizontalLayout.call(this,t);var e=$("layout-content");e&&g_bg_connector.getProp(t?"IDS_Toolbar_SwitchToVertical_Tip":"IDS_Toolbar_SwitchToHorizontal_Tip",function(t){e.title=t}),g_bg_connector.onUIEvent(JSON.stringify({"set-horizontal-layout":t}))},t.prototype.UpdateUIInfo=function(){var t,e=$("layout-button"),o=this.getElementRect(document.body),n=o.left,i=o.top;t=this.g_is_V8?document.body.getElementsByClassName("toolbar-button-V8"):document.body.getElementsByClassName("toolbar-button");for(var r=[],c=0;c<t.length;c++){var s=t[c];if(s!=e){var a=this.getElementRect(s);a.left-=n,a.right-=n,a.top-=i,a.bottom-=i,a.id=s.id,r.push(a)}}this.GetSearchEditBox()&&((a=this.GetSearchBoxRect()).left-=n,a.right-=n,a.top-=i,a.bottom-=i,a.id=this.g_search_box_id,r.push(a)),g_bg_connector.setUIItemsInfo("toolbar",JSON.stringify(r))},t.prototype.OnHomeButtonClick=function(){g_bg_connector.OpenStartPage()},t.prototype.OnSettingsButtonClick=function(){var t=this.getElementRect($("chrome_settings_id"));g_bg_connector.onUIEvent(JSON.stringify({type:"chrome-settings",left:t.left,top:t.top,right:t.right,bottom:t.bottom}))},t.prototype.CreateTitle=function(){var t=this,e=this.createElement("div",{class:"toolbar-title-V8"}),o=this.createElement("div",{class:"toolbar-title-icon-V8 toolbar-home-icon-V8"});o.addEventListener("click",function(){t.OnHomeButtonClick()},!1),e.appendChild(o);var n,i=this.createElement("div",{class:"toolbar-title-icon-V8 toolbar-main-settings-icon-V8",id:"chrome_settings_id"});i.addEventListener("click",function(){t.OnSettingsButtonClick()},!1),e.appendChild(i);var r=this.createElement("div",{class:"toolbar-title-text-V8"},[n=this.createTextNode("RoboForm")]);return g_bg_connector.getProp("IDS_Cmd_RoboForm_Flat",function(t){n.data=t}),e.appendChild(r),e},t.prototype.OnMatch=function(t,e,o){var n,i=o.m_nID;e.appendChild(n=this.createElement("div",{class:"toolbar-minidialog-icon-V8"})),n.addEventListener("click",function(){g_bg_connector.onUIEvent(JSON.stringify({type:"chrome-minidialog",id:i}))},!1),this.kMinidialogButtonMouseEvents.forEach(function(t){n.addEventListener(t,function(t){t.stopImmediatePropagation()},!1)}),n.addEventListener("mouseover",function(){RemoveClass(e,"toolbar-button-V8-hover")},!1),n.addEventListener("mouseout",function(){AddClass(e,"toolbar-button-V8-hover")},!1)},t.prototype.OnIdMatch=function(t,e,o){this.OnMatch(t,e,o)},t.prototype.AddSearchListeners=function(t){var e=this;t.addEventListener("paste",function(){e.ScheduleUpdateSearchList(!0,100)},!1)},t.prototype.SetupSearchPlaceholder=function(t){g_bg_connector.getProp("IDS_Toolbar_Search_Flat",function(e){t.placeholder=e})},t.prototype.GetContext=function(){},t.prototype.GetItemInfo=function(){},t.prototype.PostUIEvent=function(t){g_bg_connector.onUIEvent(JSON.stringify(t))},t.prototype.OnUIEvent=function(t){this.base.OnUIEvent.call(this,t)},t.prototype.OnSearchBarBlur=function(){var t=this;this.IsSearchListFocused(function(e){e||t.ScheduleUpdateSearchList(!1)})},t.prototype.OnSearchBarMouseDown=function(){this.UpdateSelectionSearch()},t.prototype.OnSearchBarEnter=function(t){var e=this;this.IsSearchListVisible(function(o){o?t.blur():e.ScheduleUpdateSearchList(!0)})},t.prototype.OnSearchBarEscape=function(){g_bg_connector.closePopupToolbar()},t.prototype.IsSearchListVisible=function(t){g_bg_connector.getProp("search-list-visible",function(e){t("true"==e)})},t.prototype.IsSearchListFocused=function(t){g_bg_connector.getProp("search-list-focused",function(e){t("true"==e)})},t.prototype.UpdateSearchList=function(){var t=this.GetSearchEditBox(),e=this.getElementRect(document.body),o=this.makeScreenRect(e);g_bg_connector.onUIEvent(JSON.stringify({id:this.g_search_box_id,type:"search",value:t.value,item_rect:this.GetSearchBoxRect(),toolbar_rect:e,toolbar_screen_rect:o}))},t.prototype.HideSearchList=function(){g_bg_connector.onUIEvent(JSON.stringify({id:this.g_search_box_id,type:"hide-search"}))},t.prototype.setupClientToScreenOffsetFromEvent=function(t){g_isopera||void 0!==t.screenX&&void 0!==t.screenY&&void 0!==t.clientX&&void 0!==t.clientY&&0!=t.screenX&&0!=t.screenY&&(this.g_clientToScreenOffsetX=t.screenX-t.clientX,this.g_clientToScreenOffsetY=t.screenY-t.clientY)},t}();
//# sourceMappingURL=popup-nm-old.js.map