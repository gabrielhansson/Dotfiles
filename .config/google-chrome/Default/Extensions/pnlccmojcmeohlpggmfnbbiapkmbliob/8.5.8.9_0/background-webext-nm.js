// Copyright (C) 1999-2019 Siber Systems Inc. All Rights Reserved.
function Browser_StartupNM(){ClearSensitiveSettings(),Browser_ConfigurePrototypesNM(),Configure_ClassesNM(),ConfigureRoboForm(),Browser_ConfigureRoboFormNM(),WebExt_ConfigureRoboFormNM(),g_roboform=new RoboFormNM,g_roboform.g_proxy=getProxyRfo().GetNativeProxy(),g_roboform.g_proxy_connected=!0,g_roboform.CheckVersions(function(){g_roboform.Browser_Startup()},RequestExtensionUpdate),ShowToolbarStatus(g_roboform.g_bToolbarVisible)}function WebExt_ConfigureRoboFormNM(){RoboFormNM.prototype.UpdateWindowTab=function(o,r,e,t){var s=g_roboform.GetCurrentWindowTab(o);s&&s==r&&(s=void 0);g_roboform.FindCreateTabBrowser(r,e);function n(e){browser.windows.get(o,function(t){if(t&&t.type){var n=t.type;switch(n){case"normal":case"popup":break;default:return void log("UpdateWindowTab","no html document, window type="+t.type)}Browser_IsServiceWnd(n,e)||(g_roboform.UpdateCurrentWindowTab(o,r),s&&g_roboform.UpdateTabToolbar(s,!1,o,n),r&&(g_roboform.UpdateTabToolbar(r,!0,o,n),UpdateMatchBar(r)))}})}t?n(t):browser.tabs.get(r,function(e){if(g_roboform.GetLastError())return browser.runtime.lastError.message,g_roboform.UpdateCurrentWindowTab(o,void 0),void g_roboform.RemoveTabBrowser(r);n(e)})},RoboFormNM.prototype.UpdateTabToolbar=function(o,r,e,t){try{this.g_proxy.updateToolbarPosition(o,r,e,t)}catch(o){log("UpdateTabToolbar",o)}},RoboFormNM.prototype.ShowRoboFormToolbar=function(o,r){function e(o,e){if(e&&e.id){e.id,e.type;var t=e.type;switch(t){case"normal":if(!r)break;return;case"popup":if(r)break;return;default:return void log("ShowRoboFormToolbar","no html document, window type="+t)}var s=e.id;browser.tabs.query({windowId:s},function(o){var r;for(var e in g_roboform.UpdateCurrentWindowTab(s,void 0),o){var n=o[e],i=n.id;if(i){g_roboform.FindCreateTabBrowser(i,n.url);Browser_IsCurrentTab(n)&&!Browser_IsServiceWnd(t,n)?r=i:g_roboform.UpdateTabToolbar(i,!1,s,t)}}r&&(g_roboform.UpdateCurrentWindowTab(s,r),g_roboform.UpdateTabToolbar(r,!0,s,t),UpdateMatchBar(r))})}}r?this.g_proxy.setToolbarForPopupVisible(o):this.g_proxy.setToolbarVisible(o),browser.windows.getAll({populate:!0},function(o){for(var r in o)e(r,o[r])}),r||ShowToolbarStatus(o)},RoboFormNM.prototype.EnableBrowserActionPopup=function(o){var r;this.g_proxy&&void 0!==this.g_proxy.setPopupToolbar&&this.g_proxy.setPopupToolbar(o),browser.browserAction.setPopup({popup:o?"popup.html":""}),r=o?"IDS_BrowserButton_ShowPopup_Title":"remote-service-missing"==g_roboform.g_service_status||"user-data-missing"==g_roboform.g_service_status?"IDS_BrowserButton_RemoteServiceMissing_Title":"login-required"==g_roboform.g_service_status?"IDS_BrowserButton_OneFileLogin_Title":"IDS_BrowserButton_ShowToolbar_Title",this.g_proxy.getProp(r,function(o){browser.browserAction.setTitle({title:o})})},RoboFormNM.prototype.UpdateBrowserAction=function(){UpdateBrowserAction()},RoboFormNM.prototype.ClosePopupToolbar=function(){this.g_popup_active&&(this.g_proxy.onUIEvent(JSON.stringify({type:"close-popup"})),browser.runtime.sendMessage({name:"close-popup"})),this.g_popup_active=!1},RoboFormNM.prototype.Browser_Startup=function(){RoboFormBase.prototype.Browser_Startup.call(this),ShowRoboFormStatus(!0),g_roboform.OnAuthRequired(),browser.webRequest&&browser.webRequest.onBeforeRequest&&browser.webRequest.onBeforeRequest.addListener(Browser_OnBeforeRequest,{urls:["*://www.roboform.com/needroboform.html*"]},["blocking"]),browser.browserAction.onClicked.addListener(function(){g_roboform.OnButtonClicked()}),g_roboform.EnableBrowserActionPopup(GetSetting("nm-settings","popup")),g_roboform.ShowRoboFormToolbar(g_roboform.g_bToolbarVisible,!1),g_roboform.ShowRoboFormToolbar(GetSettingToolbarForPopupVisible(),!0),window.setTimeout(UpdateBrowserAction,500),window.setInterval(function(){g_roboform.EnsureUptodate(function(o){o||UpdateBrowserAction()})},1e3)},RoboFormNM.prototype.Browser_OnTabActivated=function(o){RoboFormBase.prototype.Browser_OnTabActivated.call(this,o),UpdateBrowserAction()},RoboFormNM.prototype.Browser_OnTabUpdated=function(o,r,e){RoboFormBase.prototype.Browser_OnWindowFocused.call(this,o,r,e),UpdateBrowserAction()},RoboFormNM.prototype.Browser_OnTabRemoved=function(o,r){RoboFormBase.prototype.Browser_OnTabRemoved.call(this,o,r);var e=this;window.setTimeout(function(){e.UpdateBrowserAction()},200)},RoboFormNM.prototype.Browser_OnTabDetached=function(o,r){RoboFormBase.prototype.Browser_OnTabDetached.call(this,o,r);var e=this;window.setTimeout(function(){e.UpdateBrowserAction()},200)},RoboFormNM.prototype.Browser_OnWindowFocused=function(o){g_roboform.g_proxy&&void 0!==g_roboform.g_proxy.onFocusChanged&&g_roboform.g_proxy.onFocusChanged(o),RoboFormBase.prototype.Browser_OnWindowFocused.call(this,o)},RoboFormNM.prototype.Browser_OnWindowRemoved=function(o){RoboFormBase.prototype.Browser_OnWindowRemoved.call(this,o),g_roboform.g_proxy&&g_roboform.g_proxy.onWindowRemoved(o)},RoboFormNM.prototype.ShowRoboFormStatus=function(){g_roboform.g_proxy&&void 0!==g_roboform.g_proxy.getProp&&window.setTimeout(UpdateBrowserAction,500)}}function Browser_ConfigurePrototypesNM(){CBrowser.prototype.Navigate=function(o,r){r?browser.tabs.create({url:o}):(this.disableStartPage(),browser.tabs.update(this.m_tab_id,{url:o}))},CBrowser.prototype.DoShowToolbar=function(o){browser.tabs.get(this.m_tab_id,function(r){if(g_roboform.GetLastError())return browser.runtime.lastError.message,void g_roboform.RemoveTabBrowser(this.tab_id);browser.windows.get(r.windowId,function(r){if(r&&r.type)switch(r.type){case"normal":g_roboform.g_bToolbarVisible=o,g_roboform.ShowRoboFormToolbar(o,!1),PutSetting("nm-settings","toolbar",o),PutSettingNotify("nm-settings","toolbar",o);break;case"popup":g_roboform.ShowRoboFormToolbar(o,!0),PutSetting("nm-settings","popup-windows-toolbar",o),PutSettingNotify("nm-settings","popup-windows-toolbar",o)}})})},CFrame.prototype.AddLink=function(o){try{var r=JSON.parse(o);browser.bookmarks.create({title:r.m_title,url:r.m_url})}catch(o){log("AddLink",o)}},CFrame.prototype.GetRealUrlFromTab=function(){var o=this.m_id,r=this.m_tab_id;return this.m_pBrowser&&this.m_pBrowser.m_basic_auth_url?(this.m_pBrowser.m_basic_auth_url,g_roboform.g_proxy.onMessage(r,o,"GetRealUrlFromTab",this.m_pBrowser.m_basic_auth_url),!0):(browser.tabs.get(this.m_tab_id,function(e){g_roboform.GetLastError()&&(browser.runtime.lastError.message,g_roboform.RemoveTabBrowser(this.tab_id)),e&&e.url?(e.url,g_roboform.g_proxy.onMessage(e.id,o,"GetRealUrlFromTab",e.url)):g_roboform.g_proxy.onMessage(r,o,"GetRealUrlFromTab","")}),!0)},CFrame.prototype.UpdateSiteIcons=function(o){var r=JSON.parse(o);if(r&&Array.isArray(r)){var e=this.m_tab_id,t=this.m_id,s=[],n=null;!function(o){var r=new XMLHttpRequest;r.open("GET","chrome://favicon/invalid_url",!0),r.responseType="arraybuffer",r.onreadystatechange=function(){4==r.readyState&&200==r.status&&(n=new Uint8Array(r.response),i(o,0))},r.send()}(r)}function i(o,r){if(r!=o.length){var a=o[r],b=new XMLHttpRequest;b.open("GET","chrome://favicon/"+a,!0),b.responseType="arraybuffer",b.timeout=1e4,b.ontimeout=function(){i(o,r+1)},b.onreadystatechange=function(){if(4==b.readyState){if(200==b.status){var e=b.response,t=new Uint8Array(e);(function(o){if(o.length>262144)return!1;if(null==n)return!0;if(n.length!=o.length)return!0;for(var r=0;r<o.length;r++)if(n[r]!=o[r])return!0;return!1})(t)&&s.push({url:a,icon_data:window.btoa(String.fromCharCode.apply(null,t))})}i(o,r+1)}},b.send()}else g_roboform.g_proxy.onMessage(e,t,"onSiteIconsUpdated",JSON.stringify(s),"")}},CBrowser.prototype.addTopFrame=function(o){this.m_tab_id;var r=new CFrame;r.attach("top0",this.m_tab_id,void 0,this,!0,o,void 0),this.addFrame(r)}}function Browser_OnBeforeRequest(o){var r={},e={},t=o.url.indexOf("//"),s=o.url.indexOf("?");if(-1==t||-1==s)return o.url,r;for(var n=o.url.slice(s+1,o.url.length).split("&"),i=0;i<n.length;i++){var a=n[i].indexOf("=");if(-1==a)return o.url,r;e[n[i].slice(0,a)]=n[i].slice(a+1,n[i].length)}if(void 0!==e.rfobject$){r.redirectUrl="javascript:void(0)";var b=g_roboform.FindTabBrowser(o.tabId);if(b){if(o.frameId)return r;var p=b.m_frames[b.m_main_frame_id];p&&p.postMessageToCS({name:"GetValueByID",data:e})}else o.tabId}return r}function UpdateMatchBar(o,r,e){g_roboform.g_popup_active&&browser.runtime.sendMessage({name:"update-match",tab_id:o,path:e})}function UpdateBrowserAction(){var o=g_default_icon_path;try{g_roboform.g_proxy.getProp(["rf-icon","service-status"],function(o){o["rf-icon"];var r=o["service-status"];r&&"remote-service-missing"==r?("remote-service-missing"!=g_roboform.g_service_status&&("normal"==g_roboform.g_service_status&&g_roboform.ClosePopupToolbar(),g_roboform.g_popup_enabled=!1,g_roboform.EnableBrowserActionPopup((g_ischrome||g_isopera)&&GetSetting("nm-settings","popup")),g_roboform.g_service_status="remote-service-missing"),browser.browserAction.setIcon({path:"robo_loggedoff.ico"})):r&&"login-required"==r?("login-required"!=g_roboform.g_service_status&&("normal"==g_roboform.g_service_status&&g_roboform.ClosePopupToolbar(),g_roboform.g_popup_enabled=!1,g_roboform.EnableBrowserActionPopup((g_ischrome||g_isopera)&&GetSetting("nm-settings","popup")),g_roboform.g_service_status="login-required"),browser.browserAction.setIcon({path:"robo_loggedoff.ico"})):r&&"user-data-missing"==r?("user-data-missing"!=g_roboform.g_service_status&&(g_roboform.g_service_status="user-data-missing",g_roboform.g_popup_enabled=!1,g_roboform.EnableBrowserActionPopup(!1),g_roboform.ClosePopupToolbar()),browser.browserAction.setIcon({path:g_disabled_icon_path})):("normal"!=g_roboform.g_service_status&&(g_roboform.g_service_status="normal",g_roboform.g_popup_enabled=GetSetting("nm-settings","popup"),g_roboform.EnableBrowserActionPopup(GetSetting("nm-settings","popup")),(g_ischrome||g_isopera)&&g_roboform.g_popup_active&&browser.runtime.sendMessage({name:"service-status-changed"})),browser.browserAction.setIcon({path:"robo16.png"})),GetSetting("nm-settings","open-startpage-on-empty-tabs")&&GetSelectedTab(null,function(o){var r=IsBlankTabUrl(o.url);!g_roboform.g_show_startpage_on_browser_action&&r?FindTabWithUrl(RF_ROBOFORM_STARTPAGE_URL,function(o){o?g_roboform.EnableBrowserActionPopup(GetSetting("nm-settings","popup")):(g_roboform.EnableBrowserActionPopup(!1),g_roboform.g_show_startpage_on_browser_action=!0)}):g_roboform.g_show_startpage_on_browser_action&&!r&&(g_roboform.g_show_startpage_on_browser_action=!1,g_roboform.EnableBrowserActionPopup(GetSetting("nm-settings","popup")))})})}catch(r){browser.browserAction.setIcon({path:o}),g_roboform.g_service_status="normal",g_roboform.EnableBrowserActionPopup(!0)}}
//# sourceMappingURL=background-webext-nm.js.map