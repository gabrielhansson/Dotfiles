// Copyright (C) 1999-2019 Siber Systems Inc. All Rights Reserved.
var RoboFormNM=function(){function t(){RoboFormBase.call(this),this.g_rf_version=void 0,this.g_proxy=void 0,this.g_proxy_connected=!1,this.g_service_status="normal",this.g_popup_enabled=!0,this.g_show_startpage_on_browser_action=!1,this.base=RoboFormBase.prototype}function e(){console_output("RoboFormNM: "+format_log_args(e.caller,arguments))}return t.prototype=Object.create(RoboFormBase.prototype),t.prototype.CheckVersions=function(t,o){try{var r=this;this.g_proxy.getProp(["version","product-version"],function(i){var s=i.version;if(r.g_rf_version=i["product-version"],g_isedge){if(CompareVersions(r.g_rf_version,kMinRequiredRoboFormVersion,"-")<0){var a="You have installed the RoboForm for Microsoft Edge extension, but the RoboForm software on your computer is old. Please install an updated version of RoboForm on your computer.";null!=typeof alert&&alert(a),e(a);OpenRoboFormURL("https://www.roboform.com/download"),OnError(kCannotLoadExtension),browser.browserAction.setPopup({popup:""})}else t()}else{if(s!=r.g_rf_version){a="RoboForm installation is incomplete.\n\nVersions of the components do not match:\nPlugin version: "+s+"\nRoboForm version: "+r.g_rf_version+"\n\nPlease close the browser and reinstall RoboForm\n";null!=typeof alert&&alert(a),e(a)}GetExtensionVersion(function(i){try{var s=i.match(new RegExp(".[^\\s]*",""));i=(i=s?s[0]:i).replace(new RegExp("\\.","g"),"-");var a=CompareVersions(i,r.g_rf_version,"-");a>0?(a=CompareVersions(r.g_rf_version,kMinRequiredRoboFormVersion,"-"))<0&&OpenRoboFormURL(url,[url.replace("/download/chrome-extension?","/download-from-chrome-extension?")]):a<0&&o()}catch(t){e("version check error",t)}t()})}})}catch(t){e("CheckVersions",t),OnError(kCannotLoadExtension)}},t.prototype.EnsureUptodate=function(t){this.g_proxy&&this.g_proxy.ensureUptodate(function(e){var o=e.timestamp;if(e.uptodate){if(g_time_stamp==o)return void t(!0);g_time_stamp}g_time_stamp=o,t(!1)})},t.prototype.CreateTabBrowser=function(t){var e,o=this.base.CreateTabBrowser.call(this,t);if("string"==typeof(e=this.g_proxy.addBrowser(t,o))){if("E_INVALIDARG"==e){var r=this;return void window.setTimeout(function(){r.g_proxy.addBrowser(t,o),this.forEachGoodFrame(function(t){r.g_proxy.addFrame(this.m_tab_id,t.m_id,t.m_is_top,t.m_url,t.m_status,t)})},1e3)}delete this.g_browsers[e]}return o},t.prototype.RemoveTabBrowser=function(t){this.base.RemoveTabBrowser.call(this,t),this.g_proxy.removeBrowser(t)},t.prototype.UpdateTabToolbar=function(t,o,r,i){try{this.g_proxy.updateToolbarPosition(t,o)}catch(t){e("UpdateTabToolbar",t)}},t.prototype.OnSettingChanged=function(t){var e=t.section,o=t.name,r=t.value;if("nm-settings"==e||"internal"==e)switch(o){case"toolbar":r=1==r,this.g_bToolbarVisible=r,this.ShowRoboFormToolbar(r,!1);break;case"popup-windows-toolbar":r=1==r,this.ShowRoboFormToolbar(r,!0);break;case"popup":r=1==r,this.EnableBrowserActionPopup(r);break;case"open-startpage-on-empty-tabs":this.UpdateBrowserAction();break;default:return}},t.prototype.ShowRoboFormToolbar=function(t,e){e?this.g_proxy.setToolbarForPopupVisible(t):this.g_proxy.setToolbarVisible(t),e||this.ShowToolbarStatus(t)},t.prototype.EnableBrowserActionPopup=function(t){this.g_proxy&&void 0!==this.g_proxy.setPopupToolbar&&this.g_proxy.setPopupToolbar(t)},t.prototype.UpdateBrowserAction=function(t){},t.prototype.OnButtonClicked=function(){if(GetSetting("nm-settings","popup")){if(!g_issafari)return"remote-service-missing"!=this.g_service_status&&"user-data-missing"!=this.g_service_status&&"login-required"!=this.g_service_status||this.g_proxy.onActionButtonClick(),void(this.g_show_startpage_on_browser_action&&GetSetting("nm-settings","open-startpage-on-empty-tabs")&&GetSelectedTab(null,function(t){browser.tabs.update(t.id,{url:RF_ROBOFORM_STARTPAGE_URL})}));if("remote-service-missing"==this.g_service_status||"user-data-missing"==this.g_service_status||"login-required"==this.g_service_status)return void this.g_proxy.onActionButtonClick()}this.g_bToolbarVisible=!this.g_bToolbarVisible,this.ShowRoboFormToolbar(this.g_bToolbarVisible,!1),PutSetting("nm-settings","toolbar",this.g_bToolbarVisible),PutSettingNotify("nm-settings","toolbar",this.g_bToolbarVisible),this.g_bToolbarVisible&&!g_issafari&&this.g_show_startpage_on_browser_action&&GetSetting("nm-settings","open-startpage-on-empty-tabs")&&GetSelectedTab(null,function(t){browser.tabs.update(t.id,{url:RF_ROBOFORM_STARTPAGE_URL})})},t.prototype.ClosePopupToolbar=function(){this.g_popup_active&&this.g_proxy.onUIEvent(JSON.stringify({type:"close-popup"})),this.g_popup_active=!1},t.prototype.ShowToolbarStatus=function(t){},t.prototype.OnUnload=function(t){this.base.OnUnload.call(this,t);try{this.g_proxy.Uninitialize()}catch(t){e("OnUnload",t)}this.g_proxy=void 0},t.prototype.UICommand=function(t,e,o,r){return r.unshift(o),r.unshift(t),new Promise(function(t,e){getProxyRfo().sendMessage("UICommand",r,function(e){t(e)})})},t.prototype.LoadFillerRulesJSON=function(t,e,o,r){var i=[];t&&i.push("filler-rules"),e&&i.push("filler-localization"),getRF().g_proxy.getProp(i,function(t){var e=t["filler-rules"];e&&(g_sFillerRulesJSON=e);var i=t["filler-localization"];i&&(g_sLanguage=o,g_sFillerLocalizationJSON=i),r(g_sFillerRulesJSON,g_sFillerLocalizationJSON,g_sLanguage)})},t}();function Configure_CBrowserNM(){CBrowser.prototype.addFrame=function(t){this.m_tab_id,t.m_id,t.m_url,t.m_bRemoved=!1,this.m_bDisableStartPage=!1,this.m_frames[t.m_id]=t,t.m_is_top&&(this.m_main_frame_id=t.m_id,this.m_url=t.m_url),getRF().g_proxy.addFrame(this.m_tab_id,t.m_id,t.m_is_top,t.m_url,t.m_status,t)},CBrowser.prototype.removeFrame=function(t,e){this.m_tab_id,e?(this.m_main_frame_id==t&&(this.m_main_frame_id=void 0),delete this.m_frames[t]):this.m_frames[t]&&(this.m_frames[t].m_bRemoved=!0);try{getRF().g_proxy.removeFrame(this.m_tab_id,t,e)}catch(t){log("CBrowser::removeFrame",t)}},CBrowser.prototype.disableStartPage=function(){for(var t in this.m_tab_id,this.m_frames)this.m_frames.hasOwnProperty(t)&&this.m_frames[t]&&(this.m_frames[t].m_bDisableStartPage=!0)},CBrowser.prototype.cleanupRemovedFrames=function(){for(var t in this.m_tab_id,this.m_frames)if(this.m_frames.hasOwnProperty(t)&&this.m_frames[t].m_bRemoved){try{getRF().g_proxy.removeFrame(this.m_tab_id,t,!0)}catch(t){log("CBrowser::cleanupRemovedFrames",t)}delete this.m_frames[t]}},CBrowser.prototype.OnShowToolbar=function(t){this.DoShowToolbar(t)},CBrowser.prototype.ShowToolbar=function(t){this.DoShowToolbar(t)},CBrowser.prototype.ClosePopup=function(){g_roboform.ClosePopupToolbar()},CBrowser.prototype.OnUpdateMatchBar=function(t){this.m_tab_id,UpdateMatchBar(this.m_tab_id,this.m_window_id,t)},CBrowser.prototype.SetBasicAuthPrompt=function(t){this.ReleaseBasicAuthPrompt(),this.m_pBasicAuthPrompt=t,getRF().g_proxy.onMessage(this.m_tab_id,this.m_main_frame_id,"FirefoxBAOnPromptOpened","")},CBrowser.prototype.ReleaseBasicAuthPrompt=function(){this.m_pBasicAuthPrompt&&this.m_pBasicAuthPrompt.Detach(),this.m_pBasicAuthPrompt=void 0},CBrowser.prototype.SearchHighlight=function(t){this.m_nHighlightedWords=0;var e=this;this.m_search_is_highlighted_enum.start({browser:this,frame_msg:"SearchIsHighlighted",end_func:function(){e.m_search_highlight_enum.start({browser:e,frame_msg:"SearchHighlight",end_func:function(){roboform.onMessageFromBG({name:"SearchHighlight",window_id:e.m_window_id,highlighted:e.m_nHighlightedWords})},ctx:t}),e.m_search_highlight_enum.next()}}),this.m_search_is_highlighted_enum.next()},CBrowser.prototype.UpdateSelectionSearch=function(){this.m_update_selection_search_enum.start({browser:this,frame_msg:"UpdateSelectionSearch"}),this.m_update_selection_search_enum.next()},CBrowser.prototype.GetFirefoxBasicAuthInfo=function(){var t={};return t.requested_url=this.m_pBasicAuthPrompt.GetUrl(),t.password=this.m_pBasicAuthPrompt.GetField("password1"),t.login=this.m_pBasicAuthPrompt.GetField("login"),t},CBrowser.prototype.FirefoxBASave=function(){if(this.m_pBasicAuthPrompt){var t=this.GetFirefoxBasicAuthInfo(),e=this;SetTimeout(function(){getRF().g_proxy.onMessage(e.m_tab_id,e.m_main_frame_id,"FirefoxBASave",JSON.stringify(t))},1)}},CBrowser.prototype.FirefoxBAFindFill=function(t){if(this.m_pBasicAuthPrompt){var e=ParseJSON(t),o=this.GetFirefoxBasicAuthInfo();for(var r in e)e.hasOwnProperty(r)&&(o[r]=e[r]);var i=this;SetTimeout(function(){getRF().g_proxy.onMessage(i.m_tab_id,i.m_main_frame_id,"FirefoxBAFindFill",JSON.stringify(o))},1)}},CBrowser.prototype.FirefoxBAFill=function(t){if(this.m_pBasicAuthPrompt){var e=ParseJSON(t);for(var o in e)if(e.hasOwnProperty(o))if("submit"!=o||1!=e[o]){var r=e[o];this.m_pBasicAuthPrompt.PutField(o,r)}else this.m_pBasicAuthPrompt.Accept()}}}function Configure_CFrameNM(){CFrame.prototype.update=function(t,e){t&&(this.m_url=t,this.m_is_top&&(this.m_pBrowser.m_url=t)),e&&(this.m_status=e),getRF().g_proxy.updateFrame(this.m_tab_id,this.m_id,t,e)},CFrame.prototype.OnMessage=function(t){try{var e=(t="string"==typeof t?JSON.parse(t):t).chunk;if(e){var o=e.index;0==o&&(this.m_chunks.length=0),this.m_chunks.push(e);e.count;var r=e.last;if(!r)return;for(var i="",s=0;s<this.m_chunks.length;s++)i+=this.m_chunks[s].data;this.m_chunks.length=0,t=JSON.parse(i)}t.name,this.m_tab_id,this.m_id;var a=void 0,n=this;switch(t.name){case"unload":return void(this.m_is_top||this.OnDisconnect());case"ping":return void this.postMessageToCS({name:"pong"});case"status":this.m_content_loaded=!0,g_isfirefox&&"complete"==t.status&&this.m_pBrowser.m_url&&"about:"==this.m_pBrowser.m_url.substr(0,6)?SetTimeout(function(){n.m_bRemoved||n.update(t.url,t.status)},2e3):this.update(t.url,t.status);break;case"AutoSave":t.data&&(t.data.m_sGotoURL&&""!=t.data.m_sGotoURL||(t.data.m_sGotoURL=this.m_pBrowser.m_url),this.m_pBrowser&&this.m_pBrowser.m_sFavIconURL&&(t.data.favIconUrl=this.m_pBrowser.m_sFavIconURL),a=JSON.stringify(t.data)),getRF().g_proxy.onMessage(this.m_tab_id,this.m_id,t.name,a);break;case"GetScreenRect":a=JSON.stringify(t.data),getRF().g_proxy.onMessage(this.m_tab_id,this.m_id,t.name,a);break;case"SaveForms":if(t.data){t.data.m_sGotoURL=this.m_pBrowser.m_url,this.m_pBrowser&&this.m_pBrowser.m_sFavIconURL&&(t.data.favIconUrl=this.m_pBrowser.m_sFavIconURL),a=JSON.stringify(t.data),getRF().g_proxy.onMessage(this.m_tab_id,this.m_id,t.name,a);break}this.SaveNextUnsavedFrame();break;case"FillSubmit":getRF().g_proxy.onMessage(this.m_tab_id,this.m_id,t.name,t.data),this.m_pBrowser&&this.m_pBrowser.FillSubmitNextFrame();break;case"FillFormsInWindow_CallContent":return t.data?this.m_pBrowser?(this.m_pBrowser.m_FillFormsInWindowCtx.m_Args=t.data,this.m_pBrowser.m_FillFormsInWindowCtx.m_sRules=void 0,void this.m_pBrowser.FillFormsInWindow_Resume()):void log("FillFormsInWIndow_CallContent : no browser"):void log("FillFormsInWIndow_CallContent : something died in the content");case"SearchHighlight":if(!t.data)return void log("SearchHighlight : no responce data");if(!this.m_pBrowser)return void log("SearchHighlight : no browser");this.m_pBrowser.m_nHighlightedWords+=t.data.highlighted,this.m_pBrowser.m_search_highlight_enum.next();break;case"SearchUnhighlight":if(!this.m_pBrowser)return void log("SearchUnhighlight : no browser");this.m_pBrowser.m_search_highlight_enum.next();break;case"SearchIsHighlighted":if(!t.data)return void log("SearchIsHighlighted : no responce data");if(!this.m_pBrowser)return void log("SearchIsHighlighted : no browser");if(t.data.highlighted){return this.m_pBrowser.m_search_is_highlighted_enum.stop(),this.m_pBrowser.m_search_highlight_enum.start({browser:this.m_pBrowser,frame_msg:"SearchUnhighlight",end_func:function(){roboform.onMessageFromBG({name:"SearchHighlight",window_id:this.m_pBrowser.m_window_id,highlighted:0})}}),void this.m_pBrowser.m_search_highlight_enum.next()}this.m_pBrowser.m_search_is_highlighted_enum.next();break;case"UpdateSelectionSearch":if(!t.data)return void log("UpdateSelectionSearch : no responce data");if(!this.m_pBrowser)return void log("UpdateSelectionSearch : no browser");""!=t.data.text&&(this.m_pBrowser.m_update_selection_search_enum.stop(),roboform.onMessageFromBG({name:"UpdateSelectionSearch",window_id:this.m_pBrowser.m_window_id,text:t.data.text})),this.m_pBrowser.m_update_selection_search_enum.next();break;default:t.data&&(a="string"==typeof t.data?t.data:JSON.stringify(t.data)),getRF().g_proxy.onMessage(this.m_tab_id,this.m_id,t.name,a)}}catch(t){log("OnMessage",t),OnError(kInternalError,t)}},CFrame.prototype.FillFormsInWindow_CallDll=function(t){if(this.m_pBrowser){var e=this.m_pBrowser.m_FillFormsInWindowCtx.m_Args.m_pIdentity;this.m_pBrowser.m_FillFormsInWindowCtx.m_Args=JSON.parse(t),this.m_pBrowser.m_FillFormsInWindowCtx.m_Args.m_pIdentity=e,this.m_pBrowser.FillFormsInWindow_Resume()}else log("CFrame.FillFormsInWindow_CallDll() : no browser")},CFrame.prototype.ClosePopup=function(){g_roboform.ClosePopupToolbar()},CFrame.prototype.ScheduleGetScreenRect=function(){this.postMessageToCS({name:"GetScreenRect"})}}function Configure_ClassesNM(){CEnumFrames.prototype.ProcessEndMessage=function(t,e,o,r){getRF().g_proxy.onMessage(t,e,o,r)},Configure_CFrameNM(),Configure_CBrowserNM()}
//# sourceMappingURL=background-nm.js.map