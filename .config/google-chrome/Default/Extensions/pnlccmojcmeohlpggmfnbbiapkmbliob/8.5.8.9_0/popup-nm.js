// Copyright (C) 1999-2019 Siber Systems Inc. All Rights Reserved.
var PopupNM=function(){function t(){PopupBase.call(this),this.g_is_V8=!0,this.kMouseEvents=["click","mousedown","mouseup","mouseover","mousemove","mouseout","mousewheel"],this.base=PopupBase.prototype,window.oncontextmenu=function(){return!1},this.m_current_generation=0,this.InitInterfaceStyleHandlers()}t.prototype=Object.create(PopupBase.prototype),t.prototype.OnLoad=function(){this.base.OnLoad.call(this),this.LoadTemplates();try{g_bg_connector.setPopupActive(!0),(g_ischrome||g_isopera)&&g_bg_connector.onActionButtonClick(),g_bg_connector.initUI();var t=this;g_bg_connector.getRfVersion(function(e){e&&(t.g_rf_version=e),GetSelectedTab(null,function(e){e&&e.id&&g_bg_connector.SetChromeV8Style(function(){t.InitPopup(e.id)})}),browser.runtime.onMessage.addListener(function(e,n,o){switch(e.name){case"update-match":return t.m_tab_id=e.tab_id,e.path&&g_bg_connector.GetVar("selected_matchings",function(t){t||(t={}),t[e.tab_id]=e.path,g_bg_connector.PutVar("selected_matchings",t)}),void g_bg_connector.SetChromeV8Style(function(){t.UpdateMatch(e.tab_id)});case"close-popup":return void window.close();case"putSetting":return;case"service-status-changed":return void GetSelectedTab(null,function(e){e&&e.id&&g_bg_connector.SetChromeV8Style(function(){t.InitPopup(e.id)})})}})})}catch(t){e(t),this.OnError(kCannotLoadExtension,t)}},t.prototype.OnUnload=function(){g_bg_connector.setPopupActive(!1),this.base.OnUnload.call(this)},t.prototype.OnBlur=function(){g_issafari&&(g_bg_connector.onUIEvent(JSON.stringify({type:"close-popup"})),g_bg_connector.setPopupActive(!1)),this.base.OnBlur.call(this)},t.prototype.InitPopup=function(t){if(t){g_bg_connector.setCurrentBrowser(t);var e=this;g_bg_connector.GetServiceStatus(function(t){(g_ischrome||g_isopera||g_issafari_appext)&&"normal"!=t?e.ShowLoadingView():(e.ShowStartPage(),document.body.addEventListener("mousemove",function(t){e.setupClientToScreenOffsetFromEvent(t)},!1),setTimeout(function(){document.body.addEventListener("mouseup",function(t){e.OnUIEvent(t)},!1),g_bg_connector.onUIEvent(JSON.stringify({type:"init-popup"})),setInterval(function(){g_bg_connector.CheckUptodate(e.m_current_generation,!g_isedge,function(t){t.uptodate||(t.isFullUpdateNeeded?e.UpdateUI():(t.changes,e.UpdateUI()),e.m_current_generation=t.currentGenerationNumber)})},3e3)},10),g_isfirefox&&GetSetting("nm-settings","focus")&&setTimeout(function(){var t=e.GetSearchEditBox();t&&t.focus()},200))})}},t.prototype.ShowStartPage=function(){RemoveClass(document.body,"small-body"),RemoveClass($("mainscreen"),"small-body"),this.SetStartPageAppearanceWithSelectedInterfaceStyle(),this.base.ShowStartPage.call(this)},t.prototype.ShowLoadingView=function(){AddClass(document.body,"small-body"),AddClass($("mainscreen"),"small-body");var t=new ViewItem("nm_loading_div",void 0,"dialog"),e=this.CreateUIItem(t);this.m_navigator.Navigate({name:"Loading Screen",views:[e],skip_navigation:!0})},t.prototype.SetupAutoFocus=function(t){GetSetting("nm-settings","focus")&&t.setAttribute("autofocus","")},t.prototype.UpdateMatch=function(t){g_bg_connector.setCurrentBrowser(t),this.UpdateUI()};function e(){console_output("PT: "+format_log_args(e.caller,arguments))}return t.prototype.UpdateUI=function(){var t=this;EnUsageInfoList.usiRecentlyUsedList,EnRfDataItemType.RfItemType_Login;g_bg_connector.GetVar("selected_matchings",function(e){var n;e&&t.m_tab_id&&(n=e[t.m_tab_id]),g_bg_connector.GetMatchingData(function(e){var o=e[0][ITEMS_PROPERTY],r=e[1],i=e[2][ITEMS_PROPERTY],a=t.SortMatchingsList(o,i,n),s=[];if(a.length>0){for(var c={},l=0;l<a.length&&l<4;l++){var d=a[l],u=getTextForItem(d).toLowerCase();c[u]?c[u]++:c[u]=1}for(l=0;l<a.length&&l<4;l++){var p;d=a[l],c[(u=getTextForItem(d)).toLowerCase()]>1&&(u=GetDisplayPath(d.path)),p=d.gotoUrl&&(m=d.gotoUrl.match(new RegExp("^http(s)?://([^/:]+)")))?GetSetting("internal","active-server")+"/icons/?domain="+m[2]+"&def=rfp.ico":MATCHLOGINS_IMAGE,s.push(new ViewItem(MENU_MATCHLOGINS+l,0,"button",u,"match","Fill Forms from "+u,p,d))}a.length>4&&s.push(new ViewItem(MENU_MATCHLOGINS_MORE,0,"button",format(localeString("Editor_Indicator_Show_NMatch"),a.length),"match_new","Show more matches"))}if(0===r.length)s.push(new ViewItem(ID_IDENTITY_CREATE,0,"button",localeString("Toolbar_Identity_Create_Flat"),"new-identity",localeString("Toolbar_Identity_Create_Tip"),"identity.svg"));else{for(l=0;l<r.length&&l<2;l++){var _=r[l];s.push(new ViewItem(ID_IDENTITY_MATCH_FIRST+l,0,"button",getTextForItem(_),"identity",localeString("Toolbar_Identity_Fill_HelpMsg_HeaderText"),"identity.svg",_))}if(r.length>2)CompareVersions(t.g_rf_version,"8-4-6-6","-")>0&&s.push(new ViewItem(ID_IDENTITY_SELECT_COMBINED,0,"button",format(localeString("Editor_Indicator_Show_AllIdentities"),r.length),"identities_new",void 0,void 0,r))}var g=t.BuildItemsView(s);RemoveChilds("active-items-container"),t.AppendItemsView(g,$("active-items-container"));var h=g_is_mac?"click":"mousedown";for(l=0;l<a.length&&l<4;l++)!function(){var e=a[l];$(MENU_MATCHLOGINS+l).addEventListener(h,function(n){2!=n.button&&(n.preventDefault(),n.stopPropagation(),t.MatchingPasscardClick(e.path))},!1)}();if(g_is_mac){for(l=0;l<r.length&&l<2;l++)!function(){var e=r[l];$(ID_IDENTITY_MATCH_FIRST+l).addEventListener(h,function(n){2!=n.button&&(n.preventDefault(),n.stopPropagation(),t.MatchingPasscardClick(e.path))},!1)}();t.SetLoadedItemsAppearanceWithInterfaceStyle()}a.length>4&&$(MENU_MATCHLOGINS_MORE).addEventListener(h,function(e){e.preventDefault(),e.stopPropagation(),t.ShowMatchingLoginsDialog(e,a)},!1),$(ID_IDENTITY_SELECT_COMBINED)&&$(ID_IDENTITY_SELECT_COMBINED).addEventListener("click",function(e){e.preventDefault(),e.stopPropagation();var n=t.getElementRect($(ID_IDENTITY_SELECT_COMBINED)),o=t.getElementRect(document.body),r=t.makeScreenRect(o);g_bg_connector.onUIEvent(JSON.stringify({id:ID_IDENTITY_SELECT_COMBINED,type:"show-menu",item_rect:n,toolbar_rect:o,toolbar_screen_rect:r}))},!1),AdjustPopupSize()})})},t.prototype.OnHomeButtonClick=function(){g_bg_connector.OpenStartPage()},t.prototype.OnSettingsButtonClick=function(){var t=this.getElementRect($("chrome_settings_id"));g_bg_connector.onUIEvent(JSON.stringify({type:"chrome-settings",left:t.left,top:t.top,right:t.right,bottom:t.bottom}))},t.prototype.OnMatch=function(t,e,n){var o,r=n.m_nID,i=n.m_oItemInfo,a=this;e.appendChild(o=this.createElement("div",{class:"toolbar-minidialog-icon-V8"})),o.addEventListener("click",function(t){g_is_mac&&(t.preventDefault(),t.stopPropagation()),i&&i.type===EnRfDataItemType.RfItemType_Login?a.ShowMatchingLoginsDialog(t,[i]):g_is_mac?a.ShowMatchingIdentityDialog(t,i):g_bg_connector.onUIEvent(JSON.stringify({type:"chrome-minidialog",id:r}))},!1),this.kMinidialogButtonMouseEvents.forEach(function(t){o.addEventListener(t,function(t){t.stopImmediatePropagation()},!1)}),o.addEventListener("mouseover",function(){RemoveClass(e,"toolbar-button-V8-hover")},!1),o.addEventListener("mouseout",function(){AddClass(e,"toolbar-button-V8-hover")},!1)},t.prototype.OnIdMatch=function(t,e,n){this.OnMatch(t,e,n)},t.prototype.AddSearchListeners=function(t){var e=this;t.addEventListener("paste",function(){e.ScheduleUpdateSearchList(!0,100)},!1)},t.prototype.SetupSearchPlaceholder=function(t){g_bg_connector.getProp("IDS_Toolbar_Search_Flat",function(e){t.placeholder=e})},t.prototype.PostUIEvent=function(t){g_bg_connector.onUIEvent(JSON.stringify(t))},t.prototype.OnUIEvent=function(t){this.base.OnUIEvent.call(this,t)},t.prototype.OnSearchBarBlur=function(){var t=this;this.IsSearchListFocused(function(e){e||t.ScheduleUpdateSearchList(!1)})},t.prototype.OnSearchBarMouseDown=function(){this.UpdateSelectionSearch()},t.prototype.OnSearchBarEnter=function(t){var e=this;this.IsSearchListVisible(function(n){n?t.blur():e.ScheduleUpdateSearchList(!0)})},t.prototype.OnSearchBarEscape=function(){g_bg_connector.closePopupToolbar()},t.prototype.IsSearchListVisible=function(t){g_bg_connector.getProp("search-list-visible",function(e){t("true"==e)})},t.prototype.IsSearchListFocused=function(t){g_bg_connector.getProp("search-list-focused",function(e){t("true"==e)})},t.prototype.UpdateSearchList=function(){var t=this.GetSearchEditBox(),e=this.getElementRect(document.body),n=this.makeScreenRect(e);g_bg_connector.onUIEvent(JSON.stringify({id:this.g_search_box_id,type:"search",value:t.value,item_rect:this.GetSearchBoxRect(),toolbar_rect:e,toolbar_screen_rect:n}))},t.prototype.HideSearchList=function(){g_bg_connector.onUIEvent(JSON.stringify({id:this.g_search_box_id,type:"hide-search"}))},t.prototype.setupClientToScreenOffsetFromEvent=function(t){g_isopera||g_issafari_appext||void 0!==t.screenX&&void 0!==t.screenY&&void 0!==t.clientX&&void 0!==t.clientY&&0!=t.screenX&&0!=t.screenY&&(this.g_clientToScreenOffsetX=t.screenX-t.clientX,this.g_clientToScreenOffsetY=t.screenY-t.clientY)},t.prototype.InitMainScreen=function(t){this.base.InitMainScreen.call(this,t);g_bg_connector.GetOption([{section:"CONFIG",name:"DisableSaveForms",default_value:!1},{section:"CONFIG",name:"DisableLogoff",default_value:!1},{section:"",name:"SyncIsOn",default_value:!0},{section:"OPTIONS",name:"ShowBookmarksAndLoginsTogether",default_value:!1}],function(t){var e=t[0],n=t[1],o=t[2],r=t[3],i=($(ID_PASSCARD_SELECT_COMBINED),$(ID_BOOKMARK_SELECT_COMBINED)),a=($(ID_SAFENOTE_SELECT_COMBINED),$(ID_SAVE_FORMS));r&&(i.style.display="none"),e&&(a.style.display="none");$(ID_FillGenPassword);var s=$(ID_Cmd_Sync);o||(s.style.display="none");$(ID_CMD_PASSWORD_AUDIT_RUN);var c=$(ID_Cmd_Logoff);n&&(c.style.display="none")})},t.prototype.CreateInlineButtonsWrapper=function(){var t=[];return t.push(this.CreateUIItem(new ViewItem(ID_SAVE_FORMS,0,"inline-button",localeString("Cmd_SaveForms_Flat"),"save","Save Login","save.svg"))),t.push(this.CreateUIItem(new ViewItem(ID_FillGenPassword,0,"inline-button",localeString("Cmd_RunPassGen_Flat"),"generate","Generate new Password","generate.svg"))),t.push(this.CreateUIItem(new ViewItem(ID_Cmd_Sync,0,"inline-button",localeString("Cmd_ToolBarSync"),"sync",localeString("Cmd_Sync_Tip"),"sync.svg"))),t.push(this.CreateUIItem(new ViewItem(ID_CMD_PASSWORD_AUDIT_RUN,0,"inline-button",localeString("Cmd_PasswordAuditRun_Key"),"generate",localeString("Cmd_PasswordAuditRun_Tip"),"security_center.svg"))),this.createElement("table",{id:"inline-buttons-wrapper",class:"inline-buttons-wrapper"},this.CreateInlineButtonsRows(t))},t.prototype.OnNavigatedToMainScreen=function(t){this.UpdateUI()},t.prototype.MatchingPasscardClick=function(t){var e={type:"matching-passcard-click",path:t};g_bg_connector.onUIEvent(JSON.stringify(e))},t.prototype.ShowMatchingLoginsDialog=function(t,e){if(!(e.length<0)){var n=t.target;HasClass(n,"toolbar-minidialog-icon-V8")&&(n=n.parentElement);for(var o,r=this.getElementRect(n),i=this.getElementRect(document.body),a=this.makeScreenRect(i),s=new CRfPasscardMatchList,c=0;c<e.length;c++)o=e[c],s.AddMatch(new CRfPasscardMatch(o.level,o.path,o.type,!1,o.isMainFrame,RfFieldCompare.RfFieldsNotMatch,!1));var l=this;g_bg_connector.GetVar("selected_matchings",function(t){var n=s.GetUnsorted(),o=e[0].path;if(t&&l.m_tab_id){var c=t[l.m_tab_id];c&&n[c]&&(o=c)}var d={type:"show-minidialog",path:o,matches:JSON.stringify(s.GetUnsorted())};d.item_rect=r,d.toolbar_rect=i,d.toolbar_screen_rect=a,g_bg_connector.onUIEvent(JSON.stringify(d))})}},t.prototype.ShowMatchingIdentityDialog=function(t,e){if(e&&e.path){var n=t.target;HasClass(n,"toolbar-minidialog-icon-V8")&&(n=n.parentElement);var o=this.getElementRect(n),r=this.getElementRect(document.body),i=this.makeScreenRect(r),a={type:"chrome-minidialog",path:e.path};a.item_rect=o,a.toolbar_rect=r,a.toolbar_screen_rect=i,g_bg_connector.onUIEvent(JSON.stringify(a))}},t.prototype.InitInterfaceStyleHandlers=function(){this.OnInterfaceStyle(function(e){if("Dark"==e){t.prototype.DARK_MASK="dark-appearance";var n=function(e){return[e,t.prototype.DARK_MASK].join("-")},o=function(t){return n("toolbar-button-icon-"+t)};t.prototype.darkCssClass=n;var r={add:function(t){var e=document.createElement("style");e.appendChild(document.createTextNode(t)),document.getElementsByTagName("head")[0].appendChild(e)},find:function(t){for(var e=0;e<document.styleSheets.length;e++){var n=document.styleSheets[e];if(n.href.endsWith("popup.css"))for(var o=0;o<n.cssRules.length;o++){var r=n.cssRules[o];if(t(r))return r}}return null},setHover:function(t){this.add("."+t.className+":hover { background-color: "+t.backgroundColor+"; } ")},copyBackgroundImage:function(t){var e=t.srcClassName,n=t.dstClassName,o=this.find(function(t){return-1!=t.cssText.indexOf(e)}),r=this.find(function(t){return-1!=t.cssText.indexOf(n)&&t.style.backgroundColor});r&&(r.style.backgroundImage=o.style.backgroundImage)}};g_popup&&(g_popup.getBlurBorderColor=function(){var t=r.find(function(t){return-1!=t.cssText.indexOf(n("toolbar-search-edit-inactive-border"))});return t?t.style.backgroundColor:null}),t.prototype.cssRules=r;var i=function(){for(var t=0;t<this.idArray.length;t++)for(var e=this.idArray[t],n=$(e).getElementsByClassName("toolbar-button-icon"),o=0;o<n.length;o++)if(n[o].src){var r=this.darkCssClassForId(e);AddClass(n[o],r)}};t.prototype.staticButtons={idArray:[ID_PASSCARD_SELECT_COMBINED,ID_BOOKMARK_SELECT_COMBINED,ID_SAFENOTE_SELECT_COMBINED,ID_Cmd_Logoff,ID_SAVE_FORMS,ID_FillGenPassword,ID_Cmd_Sync,ID_CMD_PASSWORD_AUDIT_RUN],darkCssClassForId:function(t){return o(t)},addDarkCssClasses:i},t.prototype.matchingButtons=function(){for(var t=[],e=ID_IDENTITY_MATCH_FIRST;;e++){if(!$(e))break;t.push(e)}return{idArray:t,darkCssClassForId:function(t){return o(ID_IDENTITY_MATCH_FIRST)},addDarkCssClasses:i}}}})},t.prototype.SetStartPageAppearanceWithSelectedInterfaceStyle=function(){this.OnInterfaceStyle(function(e){if("Dark"==e){var n=t.prototype.darkCssClass;AddClass(document.body,n("body-V8"));for(var o=t.prototype.cssRules,r=["toolbar-home-icon-V8","toolbar-main-settings-icon-V8","toolbar-button-menu-icon-V8","toolbar-minidialog-icon-V8","toolbar-search-icon-V8","toolbar-title-text-V8","separator-V8","toolbar-search-pane-V8","toolbar-search-edit-V8"],i=0;i<r.length;i++){var a=r[i],s=document.getElementsByClassName(a);if(0!=s.length)for(var c=0;c<s.length;c++)AddClass(s[c],n(a));else o.copyBackgroundImage({srcClassName:n(a),dstClassName:a})}t.prototype.staticButtons.addDarkCssClasses();var l=o.find(function(e){return-1!=e.cssText.indexOf(t.prototype.DARK_MASK+"-hover")});if(l){var d=["toolbar-button-V8-hover","toolbar-title-icon-V8","toolbar-minidialog-icon-V8"];for(i=0;i<d.length;i++)o.setHover({className:d[i],backgroundColor:l.style.backgroundColor})}var u=o.find(function(t){return-1!=t.cssText.indexOf("toolbar-minidialog-icon-V8")&&-1==t.cssText.indexOf(":hover")&&t.style.backgroundColor});u&&(u.style.backgroundColor="transparent"),o.add("::placeholder { color: rgb(160, 160, 160); opacity: 1; } ")}})},t.prototype.SetLoadedItemsAppearanceWithInterfaceStyle=function(){this.OnInterfaceStyle(function(e){"Dark"==e&&t.prototype.matchingButtons().addDarkCssClasses()})},t.prototype.OnInterfaceStyle=function(t){g_is_mac&&g_bg_connector.getProp("apple-interface-style",t)},t}();
//# sourceMappingURL=popup-nm.js.map