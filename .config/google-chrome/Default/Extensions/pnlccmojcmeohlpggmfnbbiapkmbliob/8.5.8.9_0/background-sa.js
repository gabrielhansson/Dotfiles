// Copyright (C) 1999-2019 Siber Systems Inc. All Rights Reserved.
var RoboFormStandalone=function(){function e(){RoboFormBase.call(this),this.base=RoboFormBase.prototype}return e.prototype=Object.create(RoboFormBase.prototype),e.prototype.OnConnect=function(e,a,o,t,r,i){this.base.OnConnect.apply(this,arguments),o&&"complete"==i&&Bg_OnNewWebPageLoaded(e,a,r)},e.prototype.OnSettingChanged=function(e){},e.prototype.UICommand=function(e,a,o,t){switch(e){case EnCommandType.AskPasswordForItem:return new Promise(function(e,a){browser.runtime.sendMessage({name:"AskPasswordForItem",params:t},function(o){"ok"==o.result?e(o):a(o.error)})});case EnCommandType.MsgBoxSensitiveFieldsFilled:return new Promise(function(r,i){var s=g_roboform.FindTabBrowser(o);if(s){var n=s.m_frames[s.m_main_frame_id],l={};l.command=e,l.data=t,contentMsgBoxData[o]=l,n.postMessageToCS({name:"ShowMessageBox",data:l}),SensitiveFieldsMsgBoxResolve=r}else r(a)});default:return new Promise(function(e,o){e(a)})}},e.prototype.LoadFillerRulesJSON=function(e,a,o,t){e&&(g_sFillerRulesJSON=JSON.stringify(IDENTITY_RESOURCES)),a&&(g_sLanguage=o,g_sFillerLocalizationJSON="{}"),t(g_sFillerRulesJSON,g_sFillerLocalizationJSON,g_sLanguage)},e}();function Configure_CBrowserStandalone(){CBrowser.prototype.addFrame=function(e){this.m_tab_id,e.m_id,e.m_url,e.m_bRemoved=!1,this.m_bDisableStartPage=!1,this.m_frames[e.m_id]=e,e.m_is_top&&(this.m_main_frame_id=e.m_id,this.m_url=e.m_url)},CBrowser.prototype.removeFrame=function(e,a){this.m_tab_id,a?(this.m_main_frame_id==e&&(this.m_main_frame_id=void 0),delete this.m_frames[e]):this.m_frames[e]&&(this.m_frames[e].m_bRemoved=!0)},CBrowser.prototype.cleanupRemovedFrames=function(){for(var e in this.m_tab_id,this.m_frames)this.m_frames.hasOwnProperty(e)&&this.m_frames[e].m_bRemoved&&delete this.m_frames[e]}}var SensitiveFieldsMsgBoxResolve=void 0;function Configure_CFrameStandalone(){CFrame.prototype.update=function(e,a){e&&(this.m_url=e,this.m_is_top&&(this.m_pBrowser.m_url=e)),a&&(this.m_status=a)},CFrame.prototype.OnMessage=function(e){try{var a=(e="string"==typeof e?JSON.parse(e):e).chunk;if(a){var o=a.index;0==o&&(this.m_chunks.length=0),this.m_chunks.push(a);a.count;var t=a.last;if(!t)return;for(var r="",i=0;i<this.m_chunks.length;i++)r+=this.m_chunks[i].data;this.m_chunks.length=0,e=JSON.parse(r)}e.name,this.m_tab_id,this.m_id;var s=void 0;switch(e.name){case"status":this.m_content_loaded=!0,this.update(e.url,e.status),"complete"==e.status&&this.m_is_top&&Bg_ProcessMessageFromCS(this.m_tab_id,this.m_id,e.name,e.url);break;case"AutoSave":e.data&&(e.data.m_sGotoURL&&""!=e.data.m_sGotoURL||(e.data.m_sGotoURL=this.m_pBrowser.m_url),this.m_pBrowser&&this.m_pBrowser.m_sFavIconURL&&(e.data.favIconUrl=this.m_pBrowser.m_sFavIconURL),s=JSON.stringify(e.data)),Bg_ProcessMessageFromCS(this.m_tab_id,this.m_id,e.name,s);break;case"MessageBoxDialogClosed":Bg_ProcessMessageFromCS(this.m_tab_id,this.m_id,e.name,s);break;case"FillSensitiveFields":SensitiveFieldsMsgBoxResolve(!0);break;case"MessageBoxDialogInit":case"AutoSaveDialogInit":this.m_is_rf_frame=!0,Bg_ProcessMessageFromCS(this.m_tab_id,this.m_id,e.name,e);break;case"AutoSaveDialogSaveLogin":case"AutoSaveDialogCreateFolder":case"AutoSaveDialogClosed":case"AutoSaveGetFolderContent":Bg_ProcessMessageFromCS(this.m_tab_id,this.m_id,e.name,e);break;case"GetScreenRect":break;case"SaveForms":if(e.data){e.data.m_sGotoURL=this.m_pBrowser.m_url,this.m_pBrowser&&this.m_pBrowser.m_sFavIconURL&&(e.data.favIconUrl=this.m_pBrowser.m_sFavIconURL),Bg_ProcessMessageFromCS(this.m_tab_id,this.m_id,e.name,e),this.SaveNextUnsavedFrame();break}this.SaveNextUnsavedFrame();break;case"FillSubmit":this.m_pBrowser&&this.m_pBrowser.FillSubmitNextFrame();break;case"FillFormsInWindow_CallContent":return e.data?this.m_pBrowser?this.m_pBrowser.m_FillFormsInWindowCtx?(this.m_pBrowser.m_FillFormsInWindowCtx.m_Args=e.data,this.m_pBrowser.m_FillFormsInWindowCtx.m_sRules=void 0,void this.m_pBrowser.FillFormsInWindow_Resume()):void log("FillFormsInWIndow_CallContent : no context"):void log("FillFormsInWIndow_CallContent : no browser"):void log("FillFormsInWIndow_CallContent : something died in the content");case"SearchHighlight":if(!e.data)return void log("SearchHighlight : no responce data");if(!this.m_pBrowser)return void log("SearchHighlight : no browser");this.m_pBrowser.m_nHighlightedWords+=e.data.highlighted,this.m_pBrowser.m_search_highlight_enum.next();break;case"SearchUnhighlight":if(!this.m_pBrowser)return void log("SearchUnhighlight : no browser");this.m_pBrowser.m_search_highlight_enum.next();break;case"SearchIsHighlighted":if(!e.data)return void log("SearchIsHighlighted : no responce data");if(!this.m_pBrowser)return void log("SearchIsHighlighted : no browser");if(e.data.highlighted){return this.m_pBrowser.m_search_is_highlighted_enum.stop(),this.m_pBrowser.m_search_highlight_enum.start({browser:this.m_pBrowser,frame_msg:"SearchUnhighlight",end_func:function(){roboform.onMessageFromBG({name:"SearchHighlight",window_id:this.m_pBrowser.m_window_id,highlighted:0})}}),void this.m_pBrowser.m_search_highlight_enum.next()}this.m_pBrowser.m_search_is_highlighted_enum.next();break;case"UpdateSelectionSearch":if(!e.data)return void log("UpdateSelectionSearch : no responce data");if(!this.m_pBrowser)return void log("UpdateSelectionSearch : no browser");""!=e.data.text&&(this.m_pBrowser.m_update_selection_search_enum.stop(),roboform.onMessageFromBG({name:"UpdateSelectionSearch",window_id:this.m_pBrowser.m_window_id,text:e.data.text})),this.m_pBrowser.m_update_selection_search_enum.next();break;case"Pressed":Bg_ProcessMessageFromCS(this.m_tab_id,this.m_id,e.name,e.data)}}catch(e){log("OnMessage",e),OnError(kInternalError,e)}}}function Configure_PrototypesStandalone(){CEnumFrames.prototype.ProcessEndMessage=function(e,a,o,t){Bg_ProcessMessageFromCS(e,a,o,t)},Configure_CFrameStandalone(),Configure_CBrowserStandalone()}function Bg_OnNewWebPageLoaded(e,a,o){var t=g_policySet.IsRoboFormEnabledOnUrl(o);if(setTimeout(function(){g_is_sa_starting&&t&&Bg_GetGoFillCachedLogin(e,o)},2e3),t){var r=!getProxyRfo().m_bCompanyAdmin&&g_policySet.GetConfigValue(ConfigDisableCreateLogins),i=!getProxyRfo().m_bCompanyAdmin&&g_policySet.GetConfigValue(ConfigDisableCreateBookmarks),s=g_policySet.GetOptionsValue(OptionsAutoSaveEnable);if(!(-1!=s&&1!=s||r&&i))autoSaveLogins[e]&&setTimeout(function(){Bg_PrepareAutoSaveBar(e)},1500);var n=g_roboform.FindTabBrowser(e);if(n){var l=n.m_frames[a];if(l){if(g_policySet.GetOptionsValue(OptionsConfirmAutoFillEnable)){var _=getProxyRfo().GetCachedDomainLogins(o);if(_&&Array.isArray(_)&&1==_.length)return void f(_[0]);var m={};m.url=o,getDomainLogins_async(m,function(e){_=e,getProxyRfo().SetCachedDomainLogins(o,_),_&&Array.isArray(_)&&1==_.length&&f(_[0])},function(e,a){})}}else log("!!! no frame")}else log("!!! no browser")}function f(e){var a={};a.item_info=JSON.stringify(e);var o=JSON.stringify(a);getProxyRfo().GetDataItem(o,function(e){var a=JSON.parse(e);if(!a[JSON_MSG_ERROR]){var o=a.context.item_info,t=(JSON.parse(o),RfMakeFillerDataJSON(null,a.item_data,!0,!1,!1,!1,!0,!0,!0)),r=JSON.stringify(t);l.FillFormsInFrame(r)}})}}function broadcast_message_to_auto_save_dialog(e){var a=g_roboform.g_browsers;for(var o in a)if(a.hasOwnProperty(o)){var t=a[o];if(!t)return void log("!!! no browser");var r=t.m_autosave_dialog_frame_id;if(r){var i=t.m_frames[r];if(!i){log("!!! no frame");continue}i.postMessageToCS(e)}}}function Bg_PrepareAutoSaveBar(e){var a=g_roboform.FindTabBrowser(e);if(a){var o=a.m_main_frame_id,t=a.m_frames[o];if(t)if(g_issafari)try{var r=autoSaveLogins[e];gManualSavedData=JSON.parse(r),Bg_PrepareManualSavedLogin(e,o),safari.extension.toolbarItems.forEach(function(a,o,t){GetTabIdFromSafariBrowserTab(a.browserWindow.activeTab)==e&&(a.popover.contentWindow.addEventListener("unload",function(a){delete autoSaveLogins[e]},!0),m_popup_vars.need_autosave=!0,a.showPopover())})}catch(e){log("failed to show autosave",e)}else t.postMessageToCS({name:"ShowAutosaveBar"});else log("!!! no frame")}else log("!!! no browser")}function get_all_folders(){return new Promise(function(e,a){var o=getProxyRfo().GetCachedFoldersList();if(o)e(o);else{var t={path:"",type:EnRfDataItemType.RfItemType_Folder,deep:!0};getItemsInfoList_async(t,function(a){getProxyRfo().SetCachedFoldersList(a),e(a)},function(e,o,t){var r=new Error;r.description=o,r.code=e,a(r)})}})}function get_matches(e){return new Promise(function(a,o){var t=getProxyRfo().GetCachedDomainLogins(e);if(t)a(t);else{var r={url:e,bExcludeShared:!0,type:[EnRfDataItemType.RfItemType_Login,EnRfDataItemType.RfItemType_Bookmark]};getDomainLogins_async(r,function(o){getProxyRfo().SetCachedDomainLogins(e,o),a(o)},function(e,a){var t=new Error;t.description=a,t.code=e,o(t)})}})}function post_message_to_auto_save_dialog(e,a){var o=g_roboform.FindTabBrowser(a);if(o){var t=o.m_autosave_dialog_frame_id,r=o.m_frames[t];r?r.postMessageToCS(e):log("!!! no frame")}else log("!!! no browser")}function GetLoginSuggestionFromUrl(e){var a=RfUtils.DomainFromUrl(e,!1,!1,!0);return a&&"(file)"!==a&&"(unparseable)"!==a||(a="Passcard"),a}function SendMessageBoxDialogData(e){var a=contentMsgBoxData[e];a&&(getProxyRfo().g_username&&post_message_to_auto_save_dialog({name:"MessageBoxInitResponse",command:a.command,data:a.data},e))}function SendAutoSaveDialogData(e){var a=autoSaveLogins[e];if(a){var o,t=JSON.parse(a),r=t.m_sMatchURL,i=!1;if(!0===t.m_bForcedSave&&(i=!0===t.m_bPressKey?GetSetting("sa-auto-save","rf_shift_enter_forces_autosave",!0):GetSetting("sa-auto-save","rf_alt_click_forces_autosave",!0)),getProxyRfo().g_username)getProxyRfo().CheckUserStatus().then(function(e){var a=JSON.parse(e);return o=a.accountInfo,Promise.all([get_all_folders(),get_matches(r)])}).then(function(a){for(var r=a[0],s=a[1],n=[],l=0;l<s.length;++l){var _=new Promise(function(e,a){s[l].level=4,s[l].allFields=!0,s[l].pwd=getProxyRfo().g_masterpwd,ComparePasscards(s[l],t,e,a)});n.push(_)}function m(a){var n=GetLoginSuggestionFromUrl(t.m_sMatchURL),l=[MakeUniqueName(n,s)],_=t.possible_login_name;if(_&&_.length<=20){var m=SibMakeValidFileName(n+"("+_+")");m&&l.push(MakeUniqueName(m,s))}var f=SibMakeValidFileName(t.title);f&&l.push(MakeUniqueName(f,s));var d=CheckIsCompanyAdmin(o),g=!d&&g_policySet.GetConfigValue(ConfigDisableCreateLogins),u=!d&&g_policySet.GetConfigValue(ConfigDisableCreateBookmarks),c={name:"AutoSaveDialogInitResponse",name_suggestions:l,replace_items:s,folders:r,disableLogins:g,disableBookmarks:u,bForcedSave:i,path_to_replace:a,sDomainUrl:RfUtils.DomainFromUrl(t.m_sMatchURL,!0,!0,!0)};post_message_to_auto_save_dialog(c,e)}Promise.all(n).then(function(e){m()}).catch(function(a){a&&a.error?delete autoSaveLogins[e]:a&&a.path_to_replace&&(i?m(a.path_to_replace):delete autoSaveLogins[e])})}).catch(function(a){post_message_to_auto_save_dialog({name:"AutoSaveDialogInitResponse",error:a},e)})}}function AutoSaveLogin(e,a,o){var t=autoSaveLogins[e],r={};r.item=RfMakePasscardFromJSON(JSON.parse(t)),r.type=o.bIsBookmark?EnRfDataItemType.RfItemType_Bookmark:EnRfDataItemType.RfItemType_Login;var i=RfapiJS.utils.FileTypeToExt(r.type);function s(a,o){var t={};t.description=o,t.code=a,post_message_to_auto_save_dialog({name:"AutoSaveDialogSaveLoginResponse",error:t},e)}function n(){putDataItem_async(r,function(){var a=GetParentFolderPath(r.path),o=getProxyRfo().GetCachedRootFolder(),t=getProxyRfo().GetCachedFolderByPath(o,a,RF_ROOT_FOLDER_URL);t&&delete t.c,getProxyRfo().ClearCachedSearchList(),r.type==EnRfDataItemType.RfItemType_Login&&getProxyRfo().ClearCachedDomainLogins(r.item.m_sGotoURL),delete autoSaveLogins[e],post_message_to_auto_save_dialog({name:"AutoSaveDialogSaveLoginResponse"},e)},function(e,a){s(e,a)})}r.path=o.item_info.path+i,r.bNewItem=o.bNewItem,r.used=o.used,r.bNewItem&&getProxyRfo().m_bOneFile?getProxyRfo().m_bCompanyAdmin?n():g_jsApiMgr.GetAccountInfo(getProxyRfo().g_username,function(e){var a;if(g_policySet.ParseBlob(e.policies),!(r.type==EnRfDataItemType.RfItemType_Login&&g_policySet.GetConfigValue(ConfigDisableCreateLogins)||r.type==EnRfDataItemType.RfItemType_Bookmark&&g_policySet.GetConfigValue(ConfigDisableCreateBookmarks)))return getProxyRfo().CheckDisableNonGroupData()?(a=GetParentFolderPath(r.path),void g_jsApiMgr.GetItemInfo(a,function(e){IsItemFromGroup(e)?n():s(ERR_NOT_ALLOWED,localeString("Policy_DisableNonGroupData_Message"))},function(e){s(e.Code,e.Description)},EnRfDataItemType.RfItemType_Folder,void 0,void 0)):void n();s(ERR_NOT_ALLOWED,localeString("Policy_CommandDisabled_Message"))},function(e){s(e.Code,e.Description)}):n()}function CreateFolder(e,a,o){var t=JSON.stringify({path:o.path});getProxyRfo().CreateFolder(t,function(a){var t=JSON.parse(a),r={name:"AutoSaveDialogCreateFolderResponse",path:o.path,folder_name:o.folder_name},i=t[JSON_MSG_ERROR];if(i){var s={};s[JSON_MSG_DESCRIPTION]=i[JSON_MSG_DESCRIPTION],s[JSON_MSG_CODE]=i[JSON_MSG_CODE],r.error=s}post_message_to_auto_save_dialog(r,e)})}function Bg_ProcessMessageFromCS(e,a,o,t){switch(o){case"ping":return void this.postMessageToCS({name:"pong"});case"status":Bg_OnNewWebPageLoaded(e,a,t);break;case"EndSaveForms":Bg_PrepareManualSavedLogin(e,a);break;case"SaveForms":Bg_CollectManualSavedFrameData(e,a,t);break;case"AutoSave":if(t){if(!(d=g_roboform.FindTabBrowser(e)))return void log("!!! no browser");var r=d.m_url;if(!g_policySet.IsRoboFormEnabledOnUrl(r))break;var i=JSON.parse(t),s=GetSetting("sa-auto-save","rf_show_autosavebar",!0),n=g_policySet.GetOptionsValue(OptionsAutoSaveEnable),l=!1;if(!0===i.m_bForcedSave&&(l=!0===i.m_bPressKey?GetSetting("sa-auto-save","rf_shift_enter_forces_autosave",!0):GetSetting("sa-auto-save","rf_alt_click_forces_autosave",!0)),!s&&!l&&-1==n)break;if(g_policySet.GetConfigValue(ConfigDisableCreateLogins)&&!getProxyRfo().m_bCompanyAdmin)break;if(s&&!l){var _=GetSetting("sa-auto-save","blocking",[]),m=RfUtils.DomainFromUrl(i.m_sMatchURL,!0,!0,!0);if(_.indexOf(m)>=0)break}if(!n&&!l)break;autoSaveLogins[e]=t,setTimeout(function(){Bg_PrepareAutoSaveBar(e)},0)}break;case"MessageBoxDialogInit":if(!(d=g_roboform.FindTabBrowser(e)))return void log("!!! no browser");d.m_autosave_dialog_frame_id=a,SendMessageBoxDialogData(e);break;case"AutoSaveDialogInit":if(!(d=g_roboform.FindTabBrowser(e)))return void log("!!! no browser");d.m_autosave_dialog_frame_id=a,SendAutoSaveDialogData(e);break;case"AutoSaveDialogSaveLogin":AutoSaveLogin(e,a,t);break;case"AutoSaveDialogCreateFolder":CreateFolder(e,a,t);break;case"AutoSaveGetFolderContent":var f={path:t.path,type:[EnRfDataItemType.RfItemType_Login,EnRfDataItemType.RfItemType_Bookmark]};getProxyRfo().GetItemsForFolder(JSON.stringify(f),function(a){(a=JSON.parse(a))&&a.items&&post_message_to_auto_save_dialog({name:"AutoSaveGetFolderContentResponse",data:Array.from(a.items,function(e){return e.path})},e)});break;case"MessageBoxDialogClosed":if(SensitiveFieldsMsgBoxResolve(!1),delete contentMsgBoxData[e],!(d=g_roboform.FindTabBrowser(e)))return void log("!!! no browser");delete d.m_autosave_dialog_frame_id;break;case"AutoSaveDialogClosed":var d;if(delete autoSaveLogins[e],!(d=g_roboform.FindTabBrowser(e)))return void log("!!! no browser");delete d.m_autosave_dialog_frame_id;break;case"Pressed":BG_CheckKeyboardShortcuts(e,a,t)}}function BG_CheckKeyboardShortcuts(e,a,o){if(GetSetting("keyboard","allow-shortcuts")){var t=o.keyCode,r=o.altKey,i=o.shiftKey,s=o.ctrlKey,n=(o.metaKey,o.location,o.key),l=GetSetting("keyboard","shortcuts"),_=GetSetting("keyboard","alt-key"),m=GetSetting("keyboard","ctrl-key"),f=GetSetting("keyboard","shift-key");GetSetting("keyboard","right-alt");g_isfirefox&&(i?(173==t&&"_"==n&&(t=189),61==t&&"+"==n&&(t=187)):(173==t&&"-"==n&&(t=189),61==t&&"="==n&&(t=187)));for(var d=void 0,g=0;g<l.length;g++){var u=l[g];u.checked&&(u.code==t&&r==_&&i==f&&s==m&&(d=u.name))}if(d)switch(d){case"show-options":getProxyRfo().OpenPage({url:GetLocalURL("options.html"),bNewWindow:!0,bActivateIfExists:!0});break;case"reset-fields":getProxyRfo().ResetFields();break;case"set-fields":getProxyRfo().SetFields();break;case"clear-fields":getProxyRfo().ClearFields()}}}function Bg_OpenPage(e,a,o){try{if(g_ischrome||g_isopera||g_isfirefox||g_isedge)a?o?FindTabWithUrl(e,function(a){a?ActivateTab(a):browser.tabs.create({url:e},null)}):browser.tabs.create({url:e},null):GetSelectedTab(null,function(a){browser.tabs.update(a.id,{url:e})});else if(g_issafari){if(a)safari.application.activeBrowserWindow.openTab().url=e;else safari.application.activeBrowserWindow.activeTab.url=e}else if(g_ismaxthon){if(a)window.external.mxGetRuntime().create("mx.browser").tabs.newTab({url:e,activate:!0,position:"last"});else window.external.mxGetRuntime().create("mx.browser").tabs.getCurrentTab().navigate(e)}}catch(e){log("EXCEPTION in Bg_OpenPage:"+e.toString())}}function Bg_GetGoFillCachedLogin(e,a){var o={};getProxyRfo().GetCachedGoFillGlobal(o);var t=o.bSubmit,r=o.sUrl;if(o.bGoFill&&RfapiJS.utils.isUrlDomainsMatch(r,a)){var i=RfMakeFillerDataJSON(null,o.item_data,!0,!1,!1,t,!0,!0,!0);!function(e){GetSelectedTab(null,function(a){var o=a.id,t=g_roboform.FindTabBrowser(o);t?t.forEachGoodFrame(function(a){a.FillFormsInFrame(e)}):log("!!! no browser")})}(JSON.stringify(i)),getProxyRfo().ClearCachedGoFillGlobal()}}function RfMakeFillerDataJSON(e,a,o,t,r,i,s,n,l,_){var m={};if(m.bActuallyFill=o,m.m_nStopAfterMatchingFields=t,m.bSubmit=i,m.bFillInvisibleFields=l,m.m_bUseEnglishSelectValues=n,m.m_bCountFields=r,m.m_bFillNonemptyFields=!s,m.m_bHighLightFields=GetSetting("sa-settings","rf_highlight_filledflds_chk"),a)m.m_pPasscard=RfMakePasscardJSON(a);else{if(!e)return;m.m_pIdentity=RfMakeIdentityJSON(e,_)}return m}function RfMakePasscardJSON(e){var a={};a.m_sGotoURL=e[RfapiJS.ITEM_GOTOURL_PROP]?e[RfapiJS.ITEM_GOTOURL_PROP]:"",a.m_sMatchURL=e[RfapiJS.ITEM_MATCHURL_PROP]?e[RfapiJS.ITEM_MATCHURL_PROP]:"";var o=[],t=e[RfapiJS.ITEMDATA_FIELDS_PROP];if(Array.isArray(t))for(var r=0;r<t.length;r++){var i=t[r],s={};s.m_sName=i[RfapiJS.ITEM_NAME_PROP]?i[RfapiJS.ITEM_NAME_PROP]:"",s.m_nOrderIndex=i.i?i.i:"",s.m_field_type=i[RfapiJS.FIELD_TYPE_PROP]?i[RfapiJS.FIELD_TYPE_PROP]:"",s.m_bDefaultValue=i[RfapiJS.ITEM_ISDEFAULT_PROP]?i[RfapiJS.ITEM_ISDEFAULT_PROP]:"",s.m_sCaption=i[RfapiJS.FIELD_CAPTION_PROP]?i[RfapiJS.FIELD_CAPTION_PROP]:"",s.m_sId=i.id?i.id:"",s.m_sValue=i[RfapiJS.FIELD_VALUE_PROP]?i[RfapiJS.FIELD_VALUE_PROP]:"",o.push(s)}return a.m_lFields=o,a}function RfMakeIdentityJSON(e,a){var o={},t=e[RfapiJS.ID_OPTIONS_PROP],r={};for(var i in t)t.hasOwnProperty(i)&&(r[i]=t[i]);o.m_mOptionValues=r;var s=e[RfapiJS.ID_GROUPS_PROP],n=[];if(Array.isArray(s))for(var l=0;l<s.length;l++){var _=s[l],m=_[RfapiJS.ID_INSTANCES_PROP],f={};if(Array.isArray(m)&&m.length>0){var d=m[0];if(!d[RfapiJS.ITEM_ISDEFAULT_PROP])for(var g=1;g<m.length;g++){var u=m[g];if(u[RfapiJS.ITEM_ISDEFAULT_PROP]){d=u;break}}var c=_[RfapiJS.ITEM_NAME_PROP];if(f.m_sName="Main",f.m_sType=c,m.length>1&&a)for(var p=0;p<a.length;p++){var v=a[p];for(var h in v)if(c==h)for(var S=0;S<m.length;S++){var R=m[S];if(v[h]==R[RfapiJS.ITEM_NAME_PROP]){d=R;break}}}var F=d[RfapiJS.ITEMDATA_FIELDS_PROP],b=[];if(Array.isArray(F)&&F.length>0)for(var y=0;y<F.length;y++){var P=F[y],C={};C.m_sName=P[RfapiJS.ITEM_NAME_PROP],C.m_sValue=P[RfapiJS.FIELD_VALUE_PROP],"Custom"==f.m_sType&&P.o&&(C.m_sMatches=P.o),b.push(C)}f.m_lFields=b,n.push(f)}}return o.m_lGroups=n,o}function CheckForNameExistence(e,a){for(var o=0;o<a.length;++o){var t=a[o][PATH_PROPERTY];if(t=(t=t.substring(t.lastIndexOf("/")+1)).substr(0,t.lastIndexOf(".")),e.toLowerCase()==t.toLowerCase())return!0}return!1}function MakeUniqueName(e,a){for(var o=a.length+1,t=e,r=0;r<o&&(r>0&&(t=e+" - "+r),CheckForNameExistence(t,a));++r);return t}function Bg_CollectManualSavedFrameData(e,a,o){if(o){var t=o.data;if(t){var r=g_roboform.FindTabBrowser(e);if(r){var i=r.m_frames[a];if(i){gManualSavedData=gManualSavedData||{},i.m_is_top&&(gManualSavedData.m_sGotoURL=t.m_sGotoURL,gManualSavedData.m_sMatchURL=t.m_sMatchURL,gManualSavedData.title=t.title,gManualSavedData.m_sNote=t.m_sNote);var s=t.m_lFields;if(s){gManualSavedData.m_lFields||(gManualSavedData.m_lFields=[]);for(var n=0;n<s.length;n++)gManualSavedData.m_lFields.push(s[n])}}else log("no frame with this id")}else log("no browser")}}}function Bg_PrepareManualSavedLogin(e,a,o){if(gManualSave_Callback&&gManualSavedData){if(!gManualSavedData.m_sGotoURL){var t=g_roboform.FindTabBrowser(e);if(t){var r=t.m_frames[a];r&&(gManualSavedData.m_sGotoURL=gManualSavedData.m_sMatchURL=r.m_url)}}var i,s=gManualSavedData,n=s.m_sMatchURL;getProxyRfo().g_username&&getProxyRfo().CheckUserStatus().then(function(e){var a=JSON.parse(e);return i=a.accountInfo,Promise.all([get_all_folders(),get_matches(n)])}).then(function(e){var a=e[0],o=e[1],t=GetLoginSuggestionFromUrl(s.m_sMatchURL),r=[MakeUniqueName(t,o)],n=s.possible_login_name;if(n&&n.length<=20){var l=SibMakeValidFileName(t+"("+n+")");l&&r.push(MakeUniqueName(l,o))}var _=s.title;if(_){var m=SibMakeValidFileName(_);m&&r.push(MakeUniqueName(m,o))}var f=CheckIsCompanyAdmin(i),d=!f&&g_policySet.GetConfigValue(ConfigDisableCreateLogins),g=!f&&g_policySet.GetConfigValue(ConfigDisableCreateBookmarks),u={item_data:RfMakePasscardFromJSON(s),name_suggestions:r,replace_items:o,folders:a,disableLogins:d,disableBookmarks:g,sDomainUrl:RfUtils.DomainFromUrl(s.m_sMatchURL,!0,!0,!0)};"function"==typeof gManualSave_Callback&&gManualSave_Callback(u),gManualSave_Callback=void 0,gManualSavedData=void 0}).catch(function(e){})}}function RfMakePasscardFromJSON(e){var a={};a[ISPROTECTED_PROPERTY]=!0,a[PWD_GEN_PWD_PROPERTY]=getProxyRfo().g_masterpwd,a[RfapiJS.ITEM_NOTE_PROP]=void 0===e.m_sNote?"":e.m_sNote,a[RfapiJS.ITEM_GOTOURL_PROP]=e.m_sGotoURL,a[RfapiJS.ITEM_MATCHURL_PROP]=e.m_sMatchURL,a[RfapiJS.ITEMDATA_FIELDS_PROP]=[];var o=e.m_lFields;if(o)for(var t=0;t<o.length;t++){var r=o[t],i={};void 0!==r.m_sName&&(i.n=r.m_sName),void 0!==r.m_sCaption&&(i.c=r.m_sCaption),void 0!==r.m_bDefaultValue&&(i.d=r.m_bDefaultValue),void 0!==r.m_nOrderIndex&&(i.i=r.m_nOrderIndex),void 0!==r.m_field_type&&(i.t=r.m_field_type),void 0!==r.m_sValue&&(i.v=r.m_sValue),void 0!==r.m_sId&&(i.id=r.m_sId),a[RfapiJS.ITEMDATA_FIELDS_PROP].push(i)}return a}var contentMsgBoxData={},autoSaveLogins={},gManualSave_Callback=void 0,gManualSavedData=void 0;function Proxy_SaveItemManualy(e){gManualSave_Callback=e,GetSelectedTab(null,function(e){var a=e.id,o=g_roboform.FindTabBrowser(a);if(o){var t=o.m_url;g_policySet.IsRoboFormEnabledOnUrl(t)&&(gManualSavedData=void 0,o.SaveFormsInWindow(),window.setTimeout(function(){Bg_PrepareManualSavedLogin(a,o.m_main_frame_id,!0)},4e3))}else log("!!! no browser")})}function Bg_SaveMasterPassword(e){getProxyRfo().g_masterpwd=e;var a=GetSetting("sa-settings","rf_cachemp_onbrowser_close_chk");PutSetting("sa-user","rf_masterpwd",a?encryptAccountPwd(e,getProxyRfo().g_username):"")}function Bg_SaveAccountPassword(e){getProxyRfo().g_accountpwd=e;var a=GetSetting("sa-settings","rf_cachemp_onbrowser_close_chk");PutSetting("sa-user","rf_accpwd",a?encryptAccountPwd(e,getProxyRfo().g_username):"")}function RfCanFillAllInField(e,a,o){var t=!1;o.value=!1;for(var r=0;r<e.m_lFields.length;r++){var i=e.m_lFields[r];i.m_sName.length>2&&"$"==i.m_sName[0]&&"$"==i.m_sName[i.m_sName.length-1]||a.m_sName==i.m_sName&&(t=!0,("$AnyValueHere$"==i.m_sValue||i.m_sValue==a.m_sValue||"$DefaultValue$"==i.m_sValue&&a.m_bDefaultValue)&&(o.value=!0))}return t}function RfCanFillAllIn(e,a,o,t,r,i,s){o.value=0,t.value=0,r.value=0,i.value=0,s.value=0;for(var n=[],l=0;l<a.m_lFields.length;l++){var _=a.m_lFields[l];if(_.m_field_type==RfFieldType.RfFieldText||_.m_field_type==RfFieldType.RfFieldPassword){var m={value:!1},f=RfCanFillAllInField(e,_,m);if(!f){if(_.m_field_type==RfFieldType.RfFieldPassword)_.m_sName="Password$";else if(_.m_field_type==RfFieldType.RfFieldText&&l+1<a.m_lFields.length){if(a.m_lFields[l+1].m_field_type==RfFieldType.RfFieldPassword)_.m_sName="User ID$";else for(var d=l+1;d<a.m_lFields.length;d++){var g=a.m_lFields[d];if(g.m_field_type==RfFieldType.RfFieldPassword){_.m_sName="User ID$";break}if(g.m_field_type==RfFieldType.RfFieldText)break}}f=RfCanFillAllInField(e,_,m)}f?(t.value++,_.m_field_type==RfFieldType.RfFieldPassword&&(r.value++,m.value||i.value++),m.value||o.value++,n.push(_.m_sName)):s.value++}else n.push(_.m_sName)}var u=RfFieldCompare.RfFieldsNotMatch;if(t.value>0)u=0==s.value?0==o.value?RfFieldCompare.RfFieldsMatchNamesAndValues:RfFieldCompare.RfFieldsMatchNames:RfFieldCompare.RfFieldsMatchSome;else if(0==s.value){var c=0;for(l=0;l<e.m_lFields.length;l++){var p=e.m_lFields[l];p.m_field_type!=RfFieldType.RfFieldText&&p.m_field_type!=RfFieldType.RfFieldPassword||c++}u=0==c?RfFieldCompare.RfFieldsMatchNamesAndValues:RfFieldCompare.RfFieldsNotMatch}else u=RfFieldCompare.RfFieldsNotMatch;return u}function ComparePasscards(e,a,o,t){getProxyRfo().RfApiGetDataItem(e).then(function(r){if(RfCanFillAllIn(r.data,a,{},{},{},{},{})===RfFieldCompare.RfFieldsMatchNamesAndValues)return void t({path_to_replace:e.path});o()},function(e){return void t({error:e})})}
//# sourceMappingURL=background-sa.js.map