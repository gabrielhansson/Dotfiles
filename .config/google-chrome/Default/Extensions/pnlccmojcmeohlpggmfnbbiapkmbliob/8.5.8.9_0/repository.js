// Copyright (C) 1999-2019 Siber Systems Inc. All Rights Reserved.
var RfapiJS=RfapiJS||{};(function(){var e=RfapiJS.traceJS,t=RfapiJS.traceLevel,i=RfapiJS.RfApiError,a=RfapiJS.EnDataItemInfoParts,R=RfapiJS.RfErrType,_=RfapiJS.HTTP_Status_Code_OK,P=(RfapiJS.RfUrlMatchLevel,RfapiJS.EnRfDataItemType),r=RfapiJS.utils,f=RfapiJS.UserDataFiles,p=RfapiJS.EnUsageInfoList,I=(RfapiJS.UTF8,RfapiJS.logJS),o="repository.js",n=["United States","Afganistan","Andorra","Argentina","Armenia","Australia","Austria","Belarus","Belgium","Bolivia","Bosnia And Herzegovina","Brazil","Bulgaria","Canada","Chile","China","Colombia","Costa Rica","Croatia","Cyprus","Czech Republic","Denmark","Egypt","Estonia","Finland","France","Gabon","Germany","Gibraltar","Greece","Greenland","Haiti","Hungary","Hong Kong","Iceland","India","Indonesia","Iran","Iraq","Ireland","Israel","Italy","Jamaica","Japan","Kazakhstan","Korea","Latvia","Liechtenstein","Lithuania","Luxembourg","Macedonia","Malaysia","Malta","Mexico","Moldova","Monaco","Montenegro","Morocco","Namibia","Netherlands","New Zealand","Nigeria","Norway","Pakistan","Panama","Paraguay","Peru","Philippines","Poland","Portugal","Qatar","Romania","Russia","San Marino","Saudi Arabia","Serbia","Singapore","Slovakia","Slovenia","South Africa","Spain","Sweden","Switzerland","Taiwan","Thailand","Turkey","Ukraine","United Kingdom","Venezuela","Vietnam"];RfapiJS.ITEMINFO_MODTIME_PROP="mod",RfapiJS.ITEMINFO_CREATETIME_PROP="cre",RfapiJS.ITEMINFO_SIZE_PROP="size",RfapiJS.ITEMINFO_PATH_PROP="path",RfapiJS.ITEMINFO_TYPE_PROP="type",RfapiJS.ITEM_ISDEFAULT_PROP="d",RfapiJS.FIELD_CAPTION_PROP="c",RfapiJS.FIELD_VALUE_PROP="v",RfapiJS.FIELD_TYPE_PROP="t",RfapiJS.ITEM_GOTOURL_PROP="g",RfapiJS.ID_OPTIONS_PROP="o",RfapiJS.ID_GROUPS_PROP="g",RfapiJS.ID_INSTANCES_PROP="i",RfapiJS.ITEM_NAME_PROP="n",RfapiJS.ITEM_NOTE_PROP="n",RfapiJS.ITEMDATA_FIELDS_PROP="f",RfapiJS.ITEMDATA_BLOCK_PROP="b",RfapiJS.ITEM_INFO_PROP="i",RfapiJS.ITEM_ISFOLDER_PROP="F",RfapiJS.ITEM_BODY_PROP="b",RfapiJS.ITEM_CHILDS_PROP="c",RfapiJS.ITEM_CRETIME_PROP="c",RfapiJS.ITEM_MODTIME_PROP="m",RfapiJS.ITEM_MATCHURL_PROP="m",RfapiJS.ITEM_ENCODED_PROP="e",RfapiJS.ITEM_SHAREDFILEID_PROP="s",RfapiJS.ITEM_SHARED_PROP="Shared",RfapiJS.ROOT_NODE="root",RfapiJS.ACCOUNT_ID_PROP="accountId",RfapiJS.NAME_PROP="name",RfapiJS.SENDER_PROP="sender",RfapiJS.SENDERNAME_PROP="senderName",RfapiJS.ACCOUNTINFO_PROP="accountInfo";var s="[R] Invalid path: ",O="undefined",S=[P.RfItemType_Login,P.RfItemType_Bookmark,P.RfItemType_SearchCard,P.RfItemType_BlockingPasscard,P.RfItemType_Identity,P.RfItemType_Contact,P.RfItemType_Safenote,P.RfItemType_Folder],E="s",T="",M="CreateFolder";function J(){this.m_ReceivedAccounts=null,this.m_ReceivedFiles=[],this.m_GrantedFiles=[],this.m_AcceptPendingFiles=[],this.m_AccountsData={},this.m_AllAccountsTree={},this.m_AuthUser="",this.m_show_all_groups=!1}J.prototype.Reset=function(){this.m_ReceivedAccounts=null,this.m_AccountsData={},this.m_AllAccountsTree={},this.m_AuthUser="",this.m_ReceivedFiles=[],this.m_GrantedFiles=[],this.m_AcceptPendingFiles=[],this.m_show_all_groups=!1},J.prototype.setUser=function(e){this.m_AuthUser=e},J.prototype.getDataByAccountId=function(e,t){return this.m_AccountsData[t]?this.m_AccountsData[t][e]:null},J.prototype.setData=function(i,a,R){e("Repository.setData ->  accId='"+R+"'",o,t.SPECIAL_CASE),this.resetAccountData(R,a);var _=[];if(this.m_AccountsData[R]||(this.m_AccountsData[R]={}),this.m_AccountsData[R][a]=i,"user-data.rfo"==a)if(this.m_AuthUser==R){var P=i[RfapiJS.ITEM_CHILDS_PROP];if(!P)throw"Wrong user account data format[1]: Account='"+R+"'  [i]='"+i[RfapiJS.ITEM_INFO_PROP]+"' [c]='"+i[RfapiJS.ITEM_CHILDS_PROP]+"'";for(var f=null,p=0;p<P.length;p++)if(P[p][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]==RfapiJS.ROOT_NODE){f=P[p];break}if(!f){var I={};I[RfapiJS.ITEM_ISFOLDER_PROP]=!0,I[RfapiJS.ITEM_NAME_PROP]=RfapiJS.ROOT_NODE,(f={})[RfapiJS.ITEM_INFO_PROP]=I,f[RfapiJS.ITEM_CHILDS_PROP]=[],P.push(f)}if(typeof f[RfapiJS.ITEM_CHILDS_PROP]==O&&(f[RfapiJS.ITEM_CHILDS_PROP]=[]),this.m_AllAccountsTree[RfapiJS.ITEM_INFO_PROP]||this.createRoot(),this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP])for(var n=0;n<this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP].length;n++)this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP][n][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP]||(this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP].splice(n,1),n--);if(typeof f[RfapiJS.ITEM_CHILDS_PROP]!=O)for(p=0;p<f[RfapiJS.ITEM_CHILDS_PROP].length;p++){var s=f[RfapiJS.ITEM_CHILDS_PROP][p],S=this.checkDuplicateFoldersNames(s);for(var E in S)_[E]=S[E];r.insertToSortedArray(s,this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP],[RfapiJS.ITEM_INFO_PROP,RfapiJS.ITEM_NAME_PROP],0)}}else{var T=i[RfapiJS.ITEM_CHILDS_PROP];if(T||(i[RfapiJS.ITEM_CHILDS_PROP]=[],T=i[RfapiJS.ITEM_CHILDS_PROP]),!i[RfapiJS.ITEM_INFO_PROP]){var M={};M[RfapiJS.ITEM_ISFOLDER_PROP]=!0,i[RfapiJS.ITEM_INFO_PROP]=M}var J=null;for(p=0;p<T.length;p++)if(T[p][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]==RfapiJS.ROOT_NODE){J=T[p];break}if(!J){var c={};c[RfapiJS.ITEM_ISFOLDER_PROP]=!0,c[RfapiJS.ITEM_NAME_PROP]=RfapiJS.ROOT_NODE,(J={})[RfapiJS.ITEM_INFO_PROP]=c,J[RfapiJS.ITEM_CHILDS_PROP]=[],T.push(J)}this.m_AllAccountsTree[RfapiJS.ITEM_INFO_PROP]||this.createRoot();for(var l=0;l<this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP].length;l++){var d=this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP][l];if(d[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP]&&d[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.ACCOUNT_ID_PROP]==R){d[RfapiJS.ITEM_CHILDS_PROP]=typeof J[RfapiJS.ITEM_CHILDS_PROP]==O?[]:J[RfapiJS.ITEM_CHILDS_PROP];break}}}return _},J.prototype.getAccountData=function(e){if(!e)return this.m_AllAccountsTree;for(var t=null,i=this.getDataByAccountId(f.USER_DATA,e)[RfapiJS.ITEM_CHILDS_PROP],a=0;a<i.length;a++)if(i[a][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]==RfapiJS.ROOT_NODE){t=i[a];break}return t},J.prototype.syncChanges=function(e){var t=this.getAccountData()[RfapiJS.ITEM_CHILDS_PROP],i=this.getAccountData(e);if(i[RfapiJS.ITEM_CHILDS_PROP]=[],t)for(var a=0;a<t.length;a++){var R=t[a],_=R[RfapiJS.ITEM_INFO_PROP];if(e==this.m_AuthUser){if(_[RfapiJS.ITEM_SHARED_PROP])continue;i[RfapiJS.ITEM_CHILDS_PROP].push(R)}else{if(!_[RfapiJS.ITEM_SHARED_PROP]||e!=_[RfapiJS.ITEM_SHARED_PROP][RfapiJS.ACCOUNT_ID_PROP])continue;for(var P=0;P<R[RfapiJS.ITEM_CHILDS_PROP].length;P++)i[RfapiJS.ITEM_CHILDS_PROP].push(R[RfapiJS.ITEM_CHILDS_PROP][P])}}},J.prototype.checkDuplicateFoldersNames=function(i){for(var a=1,R=[],_=0;_<this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP].length;_++){var P=this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP][_];if(P[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP]){var r=P[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP];if(i[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP]){if(i[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.NAME_PROP]==P[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.NAME_PROP]){var f=i[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.SENDERNAME_PROP]?i[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.SENDERNAME_PROP]:i[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.SENDER_PROP]?i[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.SENDER_PROP]:this.m_AuthUser,p=P[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.SENDERNAME_PROP]?P[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.SENDERNAME_PROP]:P[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.SENDER_PROP]?P[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.SENDER_PROP]:this.m_AuthUser;if(f!=p){var I=i[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.NAME_PROP]+" ("+f+")";i[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.NAME_PROP]=i[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]=i[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.ACCOUNTINFO_PROP][RfapiJS.NAME_PROP]=I;var n=P[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.NAME_PROP]+" ("+p+")";P[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.NAME_PROP]=P[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]=P[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.ACCOUNTINFO_PROP][RfapiJS.NAME_PROP]=n,e("Repository.checkDuplicateFoldersNames. #1.1# Change name FROM='"+P[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]+"'  TO='"+n+"'",o,t.SPECIAL_CASE),e("Repository.checkDuplicateFoldersNames. #2.1# Change name FROM='"+i[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]+"'  TO='"+I+"'",o,t.SPECIAL_CASE),R[P[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP].accountId]=n,R[i[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP].accountId]=I}else{I=i[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.NAME_PROP]+" ("+f+")["+a+"]";i[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.NAME_PROP]=i[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]=i[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.ACCOUNTINFO_PROP][RfapiJS.NAME_PROP]=I,a++;n=P[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.NAME_PROP]+" ("+f+")["+a+"]";P[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.NAME_PROP]=P[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]=P[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.ACCOUNTINFO_PROP][RfapiJS.NAME_PROP]=n,e("Repository.checkDuplicateFoldersNames. #1.2# Change name FROM='"+P[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]+"'  TO='"+n+"'",o,t.SPECIAL_CASE),e("Repository.checkDuplicateFoldersNames. #2.2# Change name FROM='"+i[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]+"'  TO='"+I+"'",o,t.SPECIAL_CASE),R[P[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP].accountId]=n,R[i[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP].accountId]=I}}}else if(i[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]==r[RfapiJS.NAME_PROP]&&i[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]==P[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]){var s=r[RfapiJS.SENDERNAME_PROP]?r[RfapiJS.SENDERNAME_PROP]:r[RfapiJS.SENDER_PROP]?r[RfapiJS.SENDER_PROP]:this.m_AuthUser,O=P[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]+" ("+s+")";e("Repository.checkDuplicateFoldersNames. Change name FROM='"+P[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]+"'  TO='"+O+"'",o,t.SPECIAL_CASE),P[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]=P[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.NAME_PROP]=P[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.ACCOUNTINFO_PROP][RfapiJS.NAME_PROP]=O,R[P[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP].accountId]=O}}else if(i[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP]&&i[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.NAME_PROP]==P[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]){s=(r=i[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP])[RfapiJS.SENDERNAME_PROP]?r[RfapiJS.SENDERNAME_PROP]:r[RfapiJS.SENDER_PROP]?r[RfapiJS.SENDER_PROP]:this.m_AuthUser,O=P[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]+" ("+s+")";e("Repository.checkDuplicateFoldersNames.  #3.1# Change name FROM='"+P[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]+"'  TO='"+O+"'",o,t.SPECIAL_CASE),i[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]=i[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.NAME_PROP]=i[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.ACCOUNTINFO_PROP][RfapiJS.NAME_PROP]=O,R[i[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP].accountId]=O}}return R},J.prototype.resetAccountData=function(i,a){if(e("Repository.resetAccountData ->  accId='"+i+"'",o,t.SPECIAL_CASE),this.m_AccountsData[i]&&delete this.m_AccountsData[i][a],a==f.USER_DATA){var R=this.getAccountData()[RfapiJS.ITEM_CHILDS_PROP];if(R)for(var _=0;_<R.length;_++){var P=R[_],r=P[RfapiJS.ITEM_INFO_PROP];if(i==this.m_AuthUser){if(r[RfapiJS.ITEM_SHARED_PROP])continue;R.splice(_,1),_--}else{if(!r[RfapiJS.ITEM_SHARED_PROP]||i!=r[RfapiJS.ITEM_SHARED_PROP][RfapiJS.ACCOUNT_ID_PROP])continue;delete P[RfapiJS.ITEM_CHILDS_PROP]}}}},J.prototype.getGrantorForFileId=function(e){for(var t=0;t<this.m_ReceivedFiles.length;t++){var i=this.m_ReceivedFiles[t];if(e==i.id)return i.grantor}},J.prototype.GetSharedFiles=function(){if(this.m_AccountsData[this.m_AuthUser]&&this.m_AccountsData[this.m_AuthUser]["user-data.rfo"]){var e=this.GetFolderByPath2(this.getAccountData(),T,T),t=[];this.GetSharedItems(T,e,t,!1);var i=[];return this.GetSharedItems(T,e,i,!0),{received:t,granted:i}}},J.prototype.setSharedFiles=function(e,t){this.m_ReceivedFiles=e,this.m_GrantedFiles=t},J.prototype.setSharedAccounts=function(i){var a=i.accounts,R=i.accountId,_=i.showAllGroups,P=[];if(this.m_ReceivedAccounts=a,!this.m_ReceivedAccounts.length){for(var f in this.m_AccountsData)f!=this.m_AuthUser&&delete this.m_AccountsData[f];if(this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP])for(var p=0;p<this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP].length;p++)this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP][p][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP]&&(this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP].splice(p,1),p--);return P}try{for(var n=0;n<this.m_ReceivedAccounts.length;n++){var s=this.m_ReceivedAccounts[n],S=s[RfapiJS.ACCOUNT_ID_PROP],E=s.accepted,T=s.sender,M=s.senderName,J=s.disabled;s.mp;if(d=s.name)if(typeof E!=O&&0!=E)if("AdSyncGroup"!=d)if(!J||_){var c=s.accountInfo;if(c){var l=c.name;if(l){if(e("Repository.setSharedAccounts. display_name='"+d+"'  accountInfoName='"+l+"'",o,t.SPECIAL_CASE),d!=l){M||(T||this.m_AuthUser);if(0!=d.indexOf(l)){"]"==d.substr(d.length-1,1)&&"["==d.substr(d.length-3,1)&&")"==d.substr(d.length-4,1)&&(P[S]=l,s.name=l);continue}" "==d.substr(l.length,1)&&"("==d.substr(l.length+1,1)&&(P[S]=l,s.name=l)}}else e("Repository.setSharedAccounts. accountInfo[name] is empty. accId='"+S+"'",o,t.SPECIAL_CASE)}else e("Repository.setSharedAccounts. accountInfo is empty. accId='"+S+"'",o,t.SPECIAL_CASE)}else e("Repository.setSharedAccounts. DISABLED. accId='"+S+"'  or 'AdSyncGroup' ",o,t.SPECIAL_CASE);else e("Repository.setSharedAccounts. accId='"+S+"'  or 'AdSyncGroup' ",o,t.SPECIAL_CASE);else e("Repository.setSharedAccounts. Not accepted account yet. accId='"+S+"'",o,t.SPECIAL_CASE);else e("Repository.setSharedAccounts. display_name is empty. accId='"+S+"'",o,t.SPECIAL_CASE)}}catch(e){I("Repository.setSharedAccounts. Error, while getting diff names for ='"+S+"' display_name='"+d+"' accountInfoName='"+l+"'",o)}for(n=0;n<this.m_ReceivedAccounts.length;n++){var d=(w=this.m_ReceivedAccounts[n]).name;E=w.accepted,J=w.disabled,w.mp;if(R){S=w[RfapiJS.ACCOUNT_ID_PROP];var u=!0;typeof E!=O&&0!=E||(u=!1),(N=this.m_AccountsData[S])&&!u?delete this.m_AccountsData[S]:N&&J?delete this.m_AccountsData[S]:!N&&u&&(this.m_AccountsData[S]={}),this.m_AllAccountsTree[RfapiJS.ITEM_INFO_PROP]||this.createRoot();for(var h=-1,A=0;A<this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP].length;A++)if(this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP][A][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP]&&this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP][A][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.ACCOUNT_ID_PROP]==S){h=A;break}if(-1==h||u){if(-1!=h&&J)this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP].splice(h,1);else if(-1==h&&u){F=this.getSharedAccountById(S,!0),H=this.checkDuplicateFoldersNames(F);for(var m in H)P[m]=H[m];r.insertToSortedArray(F,this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP],[RfapiJS.ITEM_INFO_PROP,RfapiJS.ITEM_NAME_PROP],0)}}else this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP].splice(h,1)}else{var N,S=w[RfapiJS.ACCOUNT_ID_PROP];if(typeof E==O||0==E)continue;if(J&&!_||"AdSyncGroup"==d){e("Repository.setSharedAccounts. DISABLED. accId='"+S+"'",o,t.SPECIAL_CASE);var y=-1;if(this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP])for(var D=0;D<this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP].length;D++)if(this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP][D][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP]&&this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP][D][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.ACCOUNT_ID_PROP]==S){y=D;break}-1!=y&&this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP].splice(y,1);continue}(N=this.m_AccountsData[S])||(this.m_AccountsData[S]={}),this.m_AllAccountsTree[RfapiJS.ITEM_INFO_PROP]||this.createRoot();for(var F=this.getSharedAccountById(S,!0),v=-1,C=0;C<this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP].length;C++)if(this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP][C][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP]&&this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP][C][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.ACCOUNT_ID_PROP]==S){v=C;break}var g=void 0;if(-1!=v){this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP][v][RfapiJS.ITEM_INFO_PROP]=F[RfapiJS.ITEM_INFO_PROP];var L=this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP].splice(v,1);if(L&&L.length&&(g=L[0]),g){var H=this.checkDuplicateFoldersNames(g);for(var b in H)P[b]=H[b];this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP].splice(v,0,g)}}else{var H=this.checkDuplicateFoldersNames(F);for(var b in H)P[b]=H[b];r.insertToSortedArray(F,this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP],[RfapiJS.ITEM_INFO_PROP,RfapiJS.ITEM_NAME_PROP],0)}}}if(R&&R!=this.m_AuthUser){var U=!1;for(n=0;n<this.m_ReceivedAccounts.length;n++){var w;if((S=(w=this.m_ReceivedAccounts[n])[RfapiJS.ACCOUNT_ID_PROP])==R&&!w.disabled){U=!0;break}}if(!U){this.m_AllAccountsTree[RfapiJS.ITEM_INFO_PROP]||this.createRoot();for(h=-1,A=0;A<this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP].length;A++)if(this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP][A][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP]&&this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP][A][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.ACCOUNT_ID_PROP]==R){h=A;break}-1!=h&&this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP].splice(h,1)}}return P},J.prototype.createRoot=function(){this.m_AllAccountsTree[RfapiJS.ITEM_INFO_PROP]={},this.m_AllAccountsTree[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_ISFOLDER_PROP]=!0,this.m_AllAccountsTree[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]=RfapiJS.ROOT_NODE,this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP]=[]},J.prototype.getAcceptedAccounts=function(){var e=[];if(!this.m_ReceivedAccounts)return e;for(var t=0;t<this.m_ReceivedAccounts.length;t++){var i=this.m_ReceivedAccounts[t],a=i.accepted;typeof a!=O&&0!=a&&e.push(i)}return e},J.prototype.renameSharedAccount=function(e,t){for(var i=0;i<this.m_ReceivedAccounts.length;i++)if(this.m_ReceivedAccounts[i][RfapiJS.ACCOUNT_ID_PROP]==e){this.m_ReceivedAccounts[i][RfapiJS.ACCOUNTINFO_PROP][RfapiJS.NAME_PROP]=t,this.m_ReceivedAccounts[i][RfapiJS.NAME_PROP]=t;break}if(this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP])for(i=0;i<this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP].length;i++)if(this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP][i][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP]&&this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP][i][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.ACCOUNT_ID_PROP]==e){this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP][i][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]=t,this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP][i][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.ACCOUNTINFO_PROP][RfapiJS.NAME_PROP]=t,this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP][i][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.NAME_PROP]=t;break}},J.prototype.getAccountIdFromName=function(e){for(var t=0;t<this.m_ReceivedAccounts.length;t++){var i=this.m_ReceivedAccounts[t];if(i[RfapiJS.NAME_PROP]==e)return i[RfapiJS.ACCOUNT_ID_PROP]}return""},J.prototype.getSharedAccountById=function(e,t){for(var i=0;i<this.m_ReceivedAccounts.length;i++){var a=this.m_ReceivedAccounts[i];if(a[RfapiJS.ACCOUNT_ID_PROP]==e){var R={};for(var _ in R[RfapiJS.ITEM_INFO_PROP]={},R[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_ISFOLDER_PROP]=!0,R[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_CRETIME_PROP]=0,R[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_MODTIME_PROP]=0,R[RfapiJS.ITEM_INFO_PROP][E]=0,R[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP]={},R[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]=a[RfapiJS.NAME_PROP],a)R[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][_]=a[_];return R}}return null},J.prototype.stopSharingAccount=function(e){for(var t=0;t<this.m_ReceivedAccounts.length;t++){if(this.m_ReceivedAccounts[t][RfapiJS.ACCOUNT_ID_PROP]==e){this.m_ReceivedAccounts.splice(t,1);break}}if(delete this.m_AccountsData[e],!this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP])return!1;var i=void 0;for(t=0;t<this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP].length;t++)if(this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP][t][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP]&&this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP][t][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.ACCOUNT_ID_PROP]==e){delete this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP][t][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP],i=this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP][t],this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP].splice(t,1);break}if(i){var a=this.getTime();i[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_MODTIME_PROP]=a,i[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_CRETIME_PROP]=a,r.insertToSortedArray(i,this.m_AllAccountsTree[RfapiJS.ITEM_CHILDS_PROP],[RfapiJS.ITEM_INFO_PROP,RfapiJS.ITEM_NAME_PROP],0)}return this.syncChanges(this.m_AuthUser),!0},J.prototype.getPrivateKey=function(){var e=null,t=this.getDataByAccountId(f.USER_DATA,this.m_AuthUser);if(!t)return I("Repository.getPrivateKey: Cannot get OFS root folder for user='"+this.m_AuthUser+"'",o),e;var i=t[RfapiJS.ITEM_CHILDS_PROP];if(!i)return I("Repository.getPrivateKey: Cannot get childs of the root folder for user='"+this.m_AuthUser+"'",o),e;for(var a=0;a<i.length;a++)if("private-key.pem"==i[a][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]){e=i[a][RfapiJS.ITEM_BODY_PROP];break}return e},J.prototype.setPrivateKey=function(e){var t=Math.round(new Date/1e3),i=this.getDataByAccountId(f.USER_DATA,this.m_AuthUser)[RfapiJS.ITEM_CHILDS_PROP],a={};a[RfapiJS.ITEM_BODY_PROP]=e,a[RfapiJS.ITEM_INFO_PROP]={},a[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_CRETIME_PROP]=t,a[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_MODTIME_PROP]=t,a[RfapiJS.ITEM_INFO_PROP][E]=e.length,a[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]="private-key.pem",i.unshift(a)};J.prototype.UpdateMRU=function(e,t,a){var R=this.getMRU(this.m_AuthUser),_=e.list,P=(e.action,e.item.path);e.item.newPath,e.item.type;if(!R)return typeof a!=O&&a(new i(void 0,"[R] Item not found:  mru.rfo",void 0,void 0,"NotFound")),!1;var r=JSON.parse(R.b);if(!r)return typeof a!=O&&a(new i(void 0,"Cannot parse mru.rfo",void 0,void 0,"NotFound")),!1;if(_==p.usiRecentlyUsedList){var f=this.updateListMru(r,"usageCounters",e),I=this.updateListMru(r,"recentlyUsed",e);return(f||I)&&(R.b=JSON.stringify(r)),void(typeof t!=O&&t(f||I))}if(_==p.identitiesGroupInstances){var o=this.updateGroupInstances(r,e);return o&&(R.b=JSON.stringify(r)),void(typeof t!=O&&t(o))}if(_==p.usiFavouritesList){r.favorites5.timestamp=this.getTime();for(var n=-1,s=0;s<r.favorites5.list.length;s++){if(_[s]==P){n=s;break}}-1==n&&(5==r.favorites5.list.length&&r.favorites5.list.pop(),r.favorites5.list.push(P)),R.b=JSON.stringify(r)}},J.prototype.checkForValidListMru=function(i,a){var R=!1;if(!i[a])return R;for(var _="identitiesGroupInstances"==a?i[a]:i[a].list,P=0;P<_.length;P++){var r=_[P],f=typeof r.path==O?r:r.path,p={request:{}};p.request[RfapiJS.ITEMINFO_PATH_PROP]=f,this.GetItemInfo(p,function(e){},function(i){e("checkForValidListMru ->  notfound path ='"+f+"'  listName="+a,o,t.SPECIAL_CASE),_.splice(P,1),R=!0})}return R},J.prototype.updateGroupInstances=function(e,t){var i=!1,a=t.item.path,R=t.action,_=(t.item.newPath,t.item.groups);if(!e.identitiesGroupInstances)return i;var P=e.identitiesGroupInstances;if(1==R){i=!0;for(var r,f=-1,p=0;p<P.length;p++){var I=P[p];if((typeof I.path==O?I:I.path)==a){f=p;break}}for(var o in-1==f?(r={}).path=a:r=P[f],r.list=[],_){var n={};n.group=o,n.timestamp=this.getTime(),n.instance=_[o],r.list.push(n)}}var s=this.checkForValidListMru(e,"identitiesGroupInstances");return i||s},J.prototype.updateListMru=function(e,t,i){var a=!1,R=i.item.path,_=i.action,f=i.item.newPath,p=i.item.type;e[t]||(e[t]=new Object,e[t].list=[]);var I=e[t].list,o=-1;if(2==_){for(var n=[],s=0;s<I.length;s++){var S=typeof(T=I[s]).path==O?T:T.path;p==P.RfItemType_Folder?S.startsWith(R)?n.push(T):a=!0:S!=R?n.push(T):a=!0}e[t].list=n}else if(1==_){a=!0;for(s=0;s<I.length;s++){if((S=typeof(T=I[s]).path==O?T:T.path)==R){o=s;break}}if(-1==o){var E={};E.path=R,E.timestamp=this.getTime(),"usageCounters"==t&&(E.usageCounter=1),I.push(E)}else"usageCounters"==t&&I[o].usageCounter++,I[o].timestamp=this.getTime(),I[o].path=R;e[t].list=I}else if(3==_){for(s=0;s<I.length;s++){S=typeof(T=I[s]).path==O?T:T.path;p==P.RfItemType_Folder?S.startsWith(R+"/")&&(a=!0,T.path=T.path.replace(R,f)):S==R&&(a=!0,T.timestamp=this.getTime(),T.path=f)}e[t].list=I}else if(4==_){for(n=[],s=0;s<I.length;s++){var T,M=(S=typeof(T=I[s]).path==O?T:T.path).substr(S.lastIndexOf("."));l(p,r.FileExtToType(M))?a=!0:n.push(T)}e[t].list=n}var J=this.checkForValidListMru(e,t);return a||J},J.prototype.getMRU=function(e){var t=null,i=this.m_AccountsData[e][f.APP_DATA];typeof i[RfapiJS.ITEM_CHILDS_PROP]==O&&(i[RfapiJS.ITEM_CHILDS_PROP]=[]);for(var a=i[RfapiJS.ITEM_CHILDS_PROP],R=0;R<a.length;R++)if("mru.rfo"==a[R][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]){t=a[R];break}if(!t){var _=Math.round(new Date/1e3),P={recentlyUsed:{list:[]},favorites5:{},recentlyViewed:{list:[]},usageCounters:{list:[]}},r={i:{c:_,m:_,f:!0,s:0,n:"mru.rfo"},b:P=JSON.stringify(P)};a.push(r);for(R=0;R<a.length;R++)if("mru.rfo"==a[R][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]){t=a[R];break}}return t},J.prototype.GetUsageInfo=function(e,t,a){var R=e.request.list,_=e.request.type,P=this.getMRU(this.m_AuthUser);if(P){var f=JSON.parse(P.b);if(f){var I=[];R==p.usiRecentlyUsedList?I=typeof f.recentlyUsed!=O?f.recentlyUsed:[]:R==p.usiFavouritesList?I=typeof f.favorites5!=O?f.favorites5:[]:R==p.usiRecentlyViewedList?I=typeof f.recentlyViewed!=O?f.recentlyViewed:[]:R==p.usiMostPopularList?I=typeof f.usageCounters!=O?f.usageCounters:[]:R==p.identitiesGroupInstances&&(I=typeof f.identitiesGroupInstances!=O?f.identitiesGroupInstances:[]);var o=[],n=R==p.identitiesGroupInstances?I:I.list;if(n)for(var s=0;s<n.length;s++){var S=n[s],E=typeof S.path==O?S:S.path,T=E.substr(E.lastIndexOf(".")),M=r.FileExtToType(T);_&&!l(_,M)||(S.type=M,o.push(S))}typeof t!=O&&t(o,!1,[])}else typeof a!=O&&a(new i(void 0,"Cannot parse mru.rfo",void 0,void 0,"NotFound"))}else typeof a!=O&&a(new i(void 0,"[R] Item not found:  mru.rfo",void 0,void 0,"NotFound"))},J.prototype.GetFile=function(e,t,a){var _=e.request[RfapiJS.ITEMINFO_PATH_PROP];if(this.checkValidPath(_,!0)){var P=_.substr(_.lastIndexOf(".")),f=r.FileExtToType(P),p=this.FindItemByName(_,f,a);if(!p)return!1;var I=typeof p[RfapiJS.ITEM_ENCODED_PROP]!=O&&1==p[RfapiJS.ITEM_ENCODED_PROP],o=p[RfapiJS.ITEM_BODY_PROP];return I&&(o=this.base64Decode(_,o)),typeof t!=O&&t(o,!1,[]),!0}typeof a!=O&&a(new i(R.RfErr_InvalidPath,s+_))},J.prototype.Search=function(e,t,i){var a=this,R=e.request.search;e={request:{function:"search",path:"",type:e.request[RfapiJS.ITEMINFO_TYPE_PROP],parts:e.request.parts,deep:e.request.deep}};a.GetItemsList(e,function(e){for(var i=[],_=0;_<e.length;_++){var r=e[_],f=r[RfapiJS.ITEMINFO_PATH_PROP],p=(f=f.toLowerCase()).substr(f.lastIndexOf("/")+1);if(r[RfapiJS.ITEMINFO_TYPE_PROP]!=P.RfItemType_Folder&&(p=p.substr(0,p.lastIndexOf("."))),!(R.length>2&&-1==p.lastIndexOf(R))){if(R.length<=2){if(-1==p.lastIndexOf(R))continue;if(0!=p.indexOf(R))continue}var I=a.getAccountIdNameFromPath(r.path,r.type);r.isShared=I.isShared,r.readOnly=I.readOnly,r.showPasswords=I.showPasswords,r.disabled=I.disabled,r.isAdmin=I.isAdmin,r.isManager=I.isManager,r.licenseExpired=I.licenseExpired,r.isAllowedIP=I.isAllowedIP,typeof I.sender!=O&&(r.sender=I.sender),typeof I.senderEmail!=O&&(r.senderEmail=I.senderEmail),typeof I.senderName!=O&&(r.senderName=I.senderName),typeof I.company!=O&&(r.company=I.company),r.id=I.id,i.push(r)}}typeof t!=O&&t(i,!1,[])},i)},J.prototype.GetItemsCount=function(e,t,_){var P=e.request[RfapiJS.ITEMINFO_PATH_PROP];if(this.checkValidPath(P,!1)){var r=this.GetFolderByPath2(this.getAccountData(),P,T);if(r){var f=typeof e.request.parts==O?a.enNothing:e.request.parts;f=parseInt(f);var p=[],I=0,o=0,n=0,E={};if(E[RfapiJS.ITEMINFO_SIZE_PROP]=I,E.count=0,r[RfapiJS.ITEM_CHILDS_PROP]){var M={};if(M[RfapiJS.ITEM_INFO_PROP]=r[RfapiJS.ITEM_INFO_PROP],M[RfapiJS.ITEM_CHILDS_PROP]=[],e.request.bExcludeShared)for(var J=0;J<r[RfapiJS.ITEM_CHILDS_PROP].length;J++)r[RfapiJS.ITEM_CHILDS_PROP][J][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP]||M[RfapiJS.ITEM_CHILDS_PROP].push(r[RfapiJS.ITEM_CHILDS_PROP][J]);else M[RfapiJS.ITEM_CHILDS_PROP]=r[RfapiJS.ITEM_CHILDS_PROP];if(M[RfapiJS.ITEM_CHILDS_PROP].length){var c=typeof e.request.deep!=O&&e.request.deep,l=typeof e.request[RfapiJS.ITEMINFO_TYPE_PROP]==O?"":e.request[RfapiJS.ITEMINFO_TYPE_PROP];if(""!=l)if("object"==typeof l)var u=l;else{var h=JSON.parse(l);u="number"==typeof h?[h]:h}else u=S;this.GetItemsForFolder(P,M,u,c,f,!1,p,!0,!1),E.count=p.length;for(var A=0;A<p.length;A++){I+=typeof p[A][RfapiJS.ITEMINFO_SIZE_PROP]==O?0:p[A][RfapiJS.ITEMINFO_SIZE_PROP];var m=typeof p[A][d]!=O&&p[A][d];o+=1==m?1:0,n+=1==m?0:1}E[RfapiJS.ITEMINFO_SIZE_PROP]=I}f&a.enFlags&&(E[d]=o,E.unprotected=n),typeof t!=O&&t(E,!1,[])}else typeof t!=O&&t(E,!1,[])}else typeof _!=O&&_(new i(void 0,"[R] Folder not found: '"+P+"'",void 0,void 0,"NotFound"))}else typeof _!=O&&_(new i(R.RfErr_InvalidPath,s+P))},J.prototype.GetMatchingPasscards=function(e,t,i){var R;R="object"==typeof e.request.url?e.request.url:[e.request.url];var _=this,f=typeof e.request.parts==O?a.enNothing:e.request.parts;f=f|a.enUrls|a.enFlags;for(var p=[],I=0;I<R.length;I++){var o=new Promise(function(t,i){var a=R[I],p={request:{}};p.request[RfapiJS.ITEMINFO_TYPE_PROP]=e.request[RfapiJS.ITEMINFO_TYPE_PROP],p.request.url=a,_.GetDomainPasscards(p,function(R){for(var p=R.items,o=[],n=0;n<p.length;n++){var s=_.FindItemByName(p[n][RfapiJS.ITEMINFO_PATH_PROP],p[n][RfapiJS.ITEMINFO_TYPE_PROP],function(e){i(e)});if(s){var O,S=_.ConvertFromOFS(s,p[n][RfapiJS.ITEMINFO_PATH_PROP],p[n][RfapiJS.ITEMINFO_TYPE_PROP],f,!1,!1);switch(p[n][RfapiJS.ITEMINFO_TYPE_PROP]){case P.RfItemType_Bookmark:case P.RfItemType_SearchCard:O=S.gotoUrl;break;default:O=S.matchUrl}if(O){var E=r.CompareUrls(a,O);E<=e.request.matchLevelMin||E>e.request.matchLevelMax||(S.level=E,S.isMainFrame=0==I,E==RfapiJS.RfUrlMatchLevel.RF_MATCH_TYPE_URL_EXACT?o.unshift(S):o.push(S))}}}t(o)},function(e){i(e)})});p.push(o)}Promise.all(p).then(function(e){for(var i=[],a=0;a<e.length;a++)for(var R=0;R<e[a].length;R++)i.push(e[a][R]);typeof t!=O&&t({status:"ok",items:i},!1,[])}).catch(function(e){typeof i!=O&&i(e)})},J.prototype.GetDomainPasscards=function(e,t,R){var _=T,f=this.GetFolderByPath2(this.getAccountData(),_,T);if(f){var p=e.request.url,n=typeof e.request[RfapiJS.ITEMINFO_TYPE_PROP]==O?"":e.request[RfapiJS.ITEMINFO_TYPE_PROP],s=null;if(""==n)s=[P.RfItemType_Login];else if("object"==typeof n)s=n;else{var S=JSON.parse(n);s="number"==typeof S?[S]:S}var E=a.enUrls|a.enFlags,M=[];this.GetItemsForFolder(_,f,s,!0,E,!1,M,!1,!1);var J=[],c=(p=p.toLowerCase(),r.DomainFromUrl(p));if(c)for(var l=0;l<M.length;l++)try{var d,u=M[l];switch(u[RfapiJS.ITEMINFO_TYPE_PROP]){case P.RfItemType_Bookmark:case P.RfItemType_SearchCard:d=u.gotoUrl;break;default:d=u.matchUrl}if(d)if(d=d.toLowerCase(),d=decodeURIComponent(d),c==r.DomainFromUrl(d)||d.startsWith(p)){var h={};h[RfapiJS.ITEMINFO_TYPE_PROP]=u[RfapiJS.ITEMINFO_TYPE_PROP],h[RfapiJS.ITEMINFO_PATH_PROP]=u[RfapiJS.ITEMINFO_PATH_PROP],u.readOnly&&(h.readOnly=u.readOnly),u[RfapiJS.ITEM_SHAREDFILEID_PROP]&&(h[RfapiJS.ITEM_SHAREDFILEID_PROP]=u[RfapiJS.ITEM_SHAREDFILEID_PROP]),u.received&&(h.received=u.received),u.isShared&&(h.isShared=u.isShared),typeof u.isDefault!=O&&(h.isDefault=u.isDefault),J.push(h)}}catch(e){I("Repository.GetDomainCards. Error, while comparing url's  index ='"+l+"'  err="+e,o)}typeof t!=O&&t({status:"ok",items:J},!1,[])}else typeof R!=O&&R(new i(void 0,"[R] Folder not found: ",void 0,void 0,"NotFound"))},J.prototype.GetItemsCount2=function(e,t,R,_){var r,f=t.c;if(f){for(var p=0;p<f.length;p++)if(f[p][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]==RfapiJS.ROOT_NODE){r=f[p];break}if(r){var I=e.request[RfapiJS.ITEMINFO_PATH_PROP],o=this.GetFolderByPath2(r,I,T);if(o){var n={loginsCount:0,identitiesCount:0,contactsCount:0,safenotesCount:0,bookmarksCount:0,searchCardsCount:0,blockingCardsCount:0,allItemsCount:0},s=o[RfapiJS.ITEM_CHILDS_PROP];if(s){if(s.length){var E=typeof e.request.parts==O?a.enNothing:e.request.parts;E=parseInt(E);var M=typeof e.request.deep!=O&&e.request.deep,J=typeof e.request[RfapiJS.ITEMINFO_TYPE_PROP]==O?"":e.request[RfapiJS.ITEMINFO_TYPE_PROP];if(""!=J)if("object"==typeof J)var c=J;else{var l=JSON.parse(J);c="number"==typeof l?[l]:l}else c=S;var d=[];this.GetItemsForFolder(I,o,[1,2,3,4,5,6,7],M,E,!1,d,!0,!1),n.allItemsCount=d.length;var u=e.request.countGrantedFiles,h=e.request.countReceivedFiles;for(p=0;p<c.length;p++){var A=c[p];d=[];this.GetItemsForFolder(I,o,[A],M,E,!1,d,!0,!1,!0);for(var m=d.length,N=0;N<d.length;N++){var y=d[N];(y.received&&!h||y.granted&&!u)&&m--}switch(A){case P.RfItemType_Login:n.loginsCount=m;break;case P.RfItemType_Bookmark:n.bookmarksCount=m;break;case P.RfItemType_SearchCard:n.searchCardsCount=m;break;case P.RfItemType_BlockingPasscard:n.blockingCardsCount=m;break;case P.RfItemType_Identity:n.identitiesCount=m;break;case P.RfItemType_Contact:n.contactsCount=m;break;case P.RfItemType_Safenote:n.safenotesCount=m}}}typeof R!=O&&R(n)}else typeof R!=O&&R(n)}else typeof _!=O&&_(new i(void 0,"[R] Folder not found: ",void 0,void 0,"NotFound"))}else typeof _!=O&&_(new i(void 0,"[R] Folder not found: ",void 0,void 0,"There is no root"))}else typeof _!=O&&_(new i(void 0,"[R] Folder not found: ",void 0,void 0,"There are no childs items"))},J.prototype.GetItemsList2=function(e,t,R,_,P){var r,f=t.c;if(f){for(var p=0;p<f.length;p++)if(f[p][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]==RfapiJS.ROOT_NODE){r=f[p];break}if(r){var I=e.request[RfapiJS.ITEMINFO_PATH_PROP],o=this.GetFolderByPath2(r,I,T);if(o){var n=[],s=o[RfapiJS.ITEM_CHILDS_PROP];if(s){if(s.length){var E=typeof e.request.iconMime!=O&&e.request.iconMime,M=typeof e.request.deep!=O&&e.request.deep,J=typeof e.request[RfapiJS.ITEMINFO_TYPE_PROP]==O?"":e.request[RfapiJS.ITEMINFO_TYPE_PROP],c=typeof e.request.bBody!=O&&e.request.bBody;if(""!=J)if("object"==typeof J)var l=J;else{var d=JSON.parse(J);l="number"==typeof d?[d]:d}else l=S;var u=typeof e.request.parts==O?a.enNothing:e.request.parts;this.GetItemsForFolder(I,o,l,M,u,E,n,!1,c,e.request.otherInfo)}if(typeof R!=O){if(P)for(p=0;p<n.length;p++)n[p].accountInfo=P;R(n)}}else typeof R!=O&&R(n)}else typeof _!=O&&_(new i(void 0,"[R] Folder not found: ",void 0,void 0,"NotFound"))}else typeof _!=O&&_(new i(void 0,"[R] Folder not found: ",void 0,void 0,"There is no root"))}else typeof _!=O&&_(new i(void 0,"[R] Folder not found: ",void 0,void 0,"There are no childs items"))},J.prototype.GetItemsList=function(e,t,_,P,r){var f=e.request[RfapiJS.ITEMINFO_PATH_PROP];if(this.checkValidPath(f,!1)){var p=this.GetFolderByPath2(this.getAccountData(),f,T);if(p){var I=[],o=p[RfapiJS.ITEM_CHILDS_PROP];if(o){if(o.length){var n=typeof e.request.iconMime!=O&&e.request.iconMime,E=typeof e.request.deep!=O&&e.request.deep,M=typeof e.request[RfapiJS.ITEMINFO_TYPE_PROP]==O?"":e.request[RfapiJS.ITEMINFO_TYPE_PROP],J=typeof e.request.bBody!=O&&e.request.bBody;if(""!=M)if("object"==typeof M)var c=M;else{var l=JSON.parse(M);c="number"==typeof l?[l]:l}else c=S;var d=typeof e.request.parts==O?a.enNothing:e.request.parts;this.GetItemsForFolder(f,p,c,E,d,n,I,!1,J)}typeof t!=O&&t(I,!1,[])}else typeof t!=O&&t(I,!1,[])}else typeof _!=O&&_(new i(void 0,"[R] Folder not found: ",void 0,void 0,"NotFound"))}else typeof _!=O&&_(new i(R.RfErr_InvalidPath,s+f))},J.prototype.GetDataItem=function(e,t,_,r,f){var p=e.request[RfapiJS.ITEMINFO_PATH_PROP];if(this.checkValidPath(p,!0)){var I=e.request[RfapiJS.ITEMINFO_TYPE_PROP],o=this.FindItemByName(p,I,_);if(!o)return!1;var n=this.getAccountIdNameFromPath(p,I);if(!n)return typeof _!=O&&_(new i(R.RfErr_InvalidPath,"Cannot determine account name.")),!1;var S=a.enAll;if(typeof t!=O){var E=this.ConvertFromOFS(o,p,I,S,!0,!1);I==P.RfItemType_Login&&(void 0===n.showPasswords||n.showPasswords||(E.showPasswords=!1)),t(E,!1,[])}return!0}typeof _!=O&&_(new i(R.RfErr_InvalidPath,s+p))},J.prototype.PutDataItem=function(e,t,a,f,p){var I=this,o=e.request[RfapiJS.ITEMINFO_PATH_PROP];if(o=o.trim(),this.checkValidPath(o,!0)){var n=e.request[RfapiJS.ITEMINFO_TYPE_PROP];if((n=parseInt(n))<P.RfItemType_Login||n>P.RfItemType_Safenote)return typeof a!=O&&a(new i(R.RfErr_WrongParams,"Wrong item type:"+n)),!1;var S=this.getAccountIdNameFromPath(o,n);if(!S)return typeof a!=O&&a(new i(R.RfErr_InvalidPath,"Cannot determine account name.")),!1;if(S.readOnly)return typeof a!=O&&a(new i(R.RfErr_PermissionDenied,"You have no rights to do this operation")),!1;S[RfapiJS.NAME_PROP];var M=!1,J=this.getTime(),c=this.FindItemByName(o,n,void 0,!0);if(!c){M=!0;var l=o.substr(0,o.lastIndexOf("/")+1);l.endsWith("/")&&(l=l.substr(0,l.length-1)),"/"==l&&(l=T);var d=this.FindItemByName(l,P.RfItemType_Folder,a);if(!d)return!1;(c=new Object)[RfapiJS.ITEM_INFO_PROP]=new Object,c[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_CRETIME_PROP]=J;var u=o.substr(o.lastIndexOf("/")+1);c[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]=u;var h=new Object,A=JSON.stringify(h);c[RfapiJS.ITEM_BODY_PROP]=A,c[RfapiJS.ITEM_INFO_PROP][E]=A.length}if(c&&typeof c[RfapiJS.ITEM_CHILDS_PROP]!=O)return typeof a!=O&&a(new i(R.RfErr_WrongParams,"Folder with the same name already exists")),!1;var m=e.request.data;c[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_MODTIME_PROP]=J;var N=typeof c[RfapiJS.ITEM_ENCODED_PROP]!=O&&1==c[RfapiJS.ITEM_ENCODED_PROP],y=c[RfapiJS.ITEM_BODY_PROP];N&&(y=this.base64Decode(o,y));var D=typeof y==O?{}:JSON.parse(y);if(typeof m.p!=O&&typeof m.pwd!=O?(D.p=!0,D.pwd=m.pwd):(delete D.p,delete D.pwd),n==P.RfItemType_Login)D[RfapiJS.ITEM_NOTE_PROP]=m[RfapiJS.ITEM_NOTE_PROP],D[RfapiJS.ITEM_GOTOURL_PROP]=m[RfapiJS.ITEM_GOTOURL_PROP],D[RfapiJS.ITEM_MATCHURL_PROP]=m[RfapiJS.ITEM_MATCHURL_PROP],D[RfapiJS.ITEMDATA_FIELDS_PROP]=m[RfapiJS.ITEMDATA_FIELDS_PROP];else if(n==P.RfItemType_Bookmark)D[RfapiJS.ITEM_NOTE_PROP]=m[RfapiJS.ITEM_NOTE_PROP],D[RfapiJS.ITEM_GOTOURL_PROP]=m[RfapiJS.ITEM_GOTOURL_PROP];else if(n==P.RfItemType_SearchCard)D[RfapiJS.ITEM_NOTE_PROP]=m[RfapiJS.ITEM_NOTE_PROP],D[RfapiJS.ITEM_GOTOURL_PROP]=m[RfapiJS.ITEM_GOTOURL_PROP],D[RfapiJS.ITEM_MATCHURL_PROP]=m[RfapiJS.ITEM_MATCHURL_PROP],D[RfapiJS.ITEMDATA_FIELDS_PROP]=m[RfapiJS.ITEMDATA_FIELDS_PROP];else if(n==P.RfItemType_BlockingPasscard)D[RfapiJS.ITEM_NOTE_PROP]=m[RfapiJS.ITEM_NOTE_PROP],D[RfapiJS.ITEM_MATCHURL_PROP]=m[RfapiJS.ITEM_MATCHURL_PROP],D[RfapiJS.ITEMDATA_BLOCK_PROP]=m[RfapiJS.ITEMDATA_BLOCK_PROP];else if(n==P.RfItemType_Safenote)D[RfapiJS.ITEM_NOTE_PROP]=m[RfapiJS.ITEM_NOTE_PROP];else if(n==P.RfItemType_Contact||n==P.RfItemType_Identity){if(M){var F=this.ProposeFirstLastNameIdentity(o),v=new RfapiJS.CIdentity(m[RfapiJS.ID_OPTIONS_PROP]),C=v.getFields();v.AddStandardFieldValue("First Name",F["First Name"],"Main","Person"),v.AddStandardFieldValue("Middle Initial",F["Middle Initial"],"Main","Person"),v.AddStandardFieldValue("Last Name",F["Last Name"],"Main","Person"),m[RfapiJS.ID_GROUPS_PROP]=m[RfapiJS.ID_GROUPS_PROP]?m[RfapiJS.ID_GROUPS_PROP]:[];for(var g=C.m_lStandardGroups,L=0;L<g.length;L++){var H=g[L];if("Person"==H.m_sName){var b=new Object;b[RfapiJS.ITEM_NAME_PROP]=H.m_sName,b[RfapiJS.ID_INSTANCES_PROP]=[];var U=new Object;U[RfapiJS.ITEM_NAME_PROP]="Main",U[RfapiJS.ITEM_ISDEFAULT_PROP]=!0,U[RfapiJS.ITEMDATA_FIELDS_PROP]=[];for(var w=0;w<H.m_lFields.length;++w){var k=H.m_lFields[w],B=C.LookupStandard(k);if(B){var q=B.m_FieldFormat;if("Location"==H.m_sName&&"Country"==k);else if(q.GetComputable())continue;if("First Name"==k||"Middle Initial"==k||"Last Name"==k){var G=new Object;if(G[RfapiJS.ITEM_NAME_PROP]=k,1==q.m_VType){G[RfapiJS.ID_OPTIONS_PROP]=[];for(var x=0;x<q.m_lOptions.length;x++)G[RfapiJS.ID_OPTIONS_PROP].push(q.m_lOptions[x].m_sMainValue)}var Y=B.GetValue(C,"Main");G[RfapiJS.FIELD_VALUE_PROP]=Y,U[RfapiJS.ITEMDATA_FIELDS_PROP].push(G)}}}b[RfapiJS.ID_INSTANCES_PROP].push(U),m[RfapiJS.ID_GROUPS_PROP].push(b)}}}D[RfapiJS.ID_GROUPS_PROP]=m[RfapiJS.ID_GROUPS_PROP],D[RfapiJS.ID_OPTIONS_PROP]=m[RfapiJS.ID_OPTIONS_PROP]}e.request.shared&&(c[RfapiJS.ITEM_SHAREDFILEID_PROP]=e.request.shared);var j=JSON.stringify(D);this.JsonCheckBinaryValueNeedBase64Encoding(j,o)?(c[RfapiJS.ITEM_ENCODED_PROP]=!0,this.base64EncodeAsync(o,j,function(e){V(e)})):(delete c[RfapiJS.ITEM_ENCODED_PROP],V(j))}else typeof a!=O&&a(new i(R.RfErr_InvalidPath,s+o));function V(e){c[RfapiJS.ITEM_BODY_PROP]=e,c[RfapiJS.ITEM_INFO_PROP][E]=e.length,M&&(d[RfapiJS.ITEM_CHILDS_PROP]||(d[RfapiJS.ITEM_CHILDS_PROP]=[]),r.insertToSortedArray(c,d[RfapiJS.ITEM_CHILDS_PROP],[RfapiJS.ITEM_INFO_PROP,RfapiJS.ITEM_NAME_PROP],0));var i=[],a=S.id;return I.syncChanges(a),i.push(a),typeof t!=O&&t(_,!0,i),!0}},J.prototype.CreateDataItem=function(e,t,a,_,r){var f=e.request[RfapiJS.ITEMINFO_TYPE_PROP];if(!f)return typeof a!=O&&a(new i(R.RfErr_WrongParams,"Wrong item type:"+f)),!1;if(f<P.RfItemType_Login||f>P.RfItemType_Safenote)return typeof a!=O&&a(new i(R.RfErr_WrongParams,"Wrong item type:"+f)),!1;if(f==P.RfItemType_BlockingPasscard)return(p=new Object)[RfapiJS.ITEM_NOTE_PROP]="",p[RfapiJS.ITEM_MATCHURL_PROP]="",p[RfapiJS.ITEMDATA_BLOCK_PROP]=0,typeof t!=O&&t(p),!0;if(f==P.RfItemType_SearchCard)return(p=new Object)[RfapiJS.ITEM_NOTE_PROP]="",p[RfapiJS.ITEM_GOTOURL_PROP]="",p[RfapiJS.ITEM_MATCHURL_PROP]="",p[RfapiJS.ITEMDATA_FIELDS_PROP]=[],typeof t!=O&&t(p),!0;if(f==P.RfItemType_Safenote)return(p=new Object)[RfapiJS.ITEM_NOTE_PROP]="",typeof t!=O&&t(p),!0;if(f==P.RfItemType_Bookmark)return(p=new Object)[RfapiJS.ITEM_NOTE_PROP]="",p[RfapiJS.ITEM_GOTOURL_PROP]="",typeof t!=O&&t(p),!0;if(f==P.RfItemType_Login)return(p=new Object)[RfapiJS.ITEM_NOTE_PROP]="",p[RfapiJS.ITEM_GOTOURL_PROP]="",p[RfapiJS.ITEM_MATCHURL_PROP]="",p[RfapiJS.ITEMDATA_FIELDS_PROP]=[],typeof t!=O&&t(p),!0;if(f==P.RfItemType_Contact||f==P.RfItemType_Identity){var p,I;if((p=new Object)[RfapiJS.ID_OPTIONS_PROP]={},p[RfapiJS.ID_OPTIONS_PROP]["Use for Form Filling"]=f==P.RfItemType_Contact?"":"+",f==P.RfItemType_Identity&&typeof e.request.appUpload!=O&&1==e.request.appUpload&&(p[RfapiJS.ID_OPTIONS_PROP]["App Upload"]="+"),typeof e.request.phonePrefixMode!=O){var o=parseInt(e.request.phonePrefixMode);1!=o&&2!=o||(p[RfapiJS.ID_OPTIONS_PROP]["Phone prefix mode"]=o)}typeof e.request.country!=O?(I=e.request.country,l(n,I)||(I="United States")):I="United States",p[RfapiJS.ID_OPTIONS_PROP]["World Regions"]=I;var s={};s["World Regions"]=I,s["Use for Form Filling"]=p[RfapiJS.ID_OPTIONS_PROP]["Use for Form Filling"],f==P.RfItemType_Identity&&typeof p[RfapiJS.ID_OPTIONS_PROP]["App Upload"]!=O&&(s["App Upload"]="+"),p[RfapiJS.ID_GROUPS_PROP]=[];for(var S=new RfapiJS.CIdentity(s).getFields(),E=S.m_lStandardGroups,T=0;T<E.length;T++){var M=E[T],J=new Object;J[RfapiJS.ITEM_NAME_PROP]=M.m_sName,J[RfapiJS.ID_INSTANCES_PROP]=[];var c=new Object;c[RfapiJS.ITEM_NAME_PROP]="Main",c[RfapiJS.ITEM_ISDEFAULT_PROP]=!0,c[RfapiJS.ITEMDATA_FIELDS_PROP]=[];for(var d=0;d<M.m_lFields.length;++d){var u=M.m_lFields[d],h=S.LookupStandard(u);if(h){var A=h.m_FieldFormat;if("Location"==M.m_sName&&"Country"==u);else if(A.GetComputable())continue;var m=new Object;if(m[RfapiJS.ITEM_NAME_PROP]=u,1==A.m_VType){m[RfapiJS.ID_OPTIONS_PROP]=[];for(var N=0;N<A.m_lOptions.length;N++)m[RfapiJS.ID_OPTIONS_PROP].push(A.m_lOptions[N].m_sMainValue)}var y=h.GetValue(S,"Main");m[RfapiJS.FIELD_VALUE_PROP]=y,c[RfapiJS.ITEMDATA_FIELDS_PROP].push(m)}}J[RfapiJS.ID_INSTANCES_PROP].push(c),p[RfapiJS.ID_GROUPS_PROP].push(J)}return typeof t!=O&&t(p),!0}},J.prototype.GetItemInfo=function(e,t,_,f,p){var I=e.request[RfapiJS.ITEMINFO_PATH_PROP];if(this.checkValidPath(I,!1)){var o=I.substring(I.lastIndexOf("/")+1),n=e.request[RfapiJS.ITEMINFO_TYPE_PROP],S=null;if(typeof n==O||""==n){var E=o.lastIndexOf(".");if(S=this.FindItemByName(I,P.RfItemType_Folder),-1==E){if(!S)return typeof _!=O&&_(new i(void 0,"[R] Item not found: "+I+" Type:"+P.RfItemType_Folder,void 0,void 0,"NotFound")),!1;n=P.RfItemType_Folder}else if(S)n=P.RfItemType_Folder;else{var T=o.substr(E);if(n=r.FileExtToType(T),!(S=this.FindItemByName(I,n,_)))return!1}}else if(!(S=this.FindItemByName(I,n,_)))return!1;var M=typeof e.request.parts==O?a.enNothing:e.request.parts,J=typeof e.request.iconMime!=O&&(""!=e.request.iconMime&&e.request.iconMime);if(typeof t!=O)t(this.ConvertFromOFS(S,I,n,M,!1,J),!1,[]);return!0}typeof _!=O&&_(new i(R.RfErr_InvalidPath,s+I))},J.prototype.CopyObject=function(e,t,i,a,R){this.MoveObject(e,t,i,a,R,!0)},J.prototype.MoveObject=function(e,t,a,f,p,I){var o=e.request.from[RfapiJS.ITEMINFO_PATH_PROP];if(this.checkValidPath(o,!0)){var n=e.request.from[RfapiJS.ITEMINFO_TYPE_PROP];if(typeof n!=O){var S=this.getAccountIdNameFromPath(o,n);if(!S)return typeof a!=O&&a(new i(R.RfErr_InvalidPath,"Cannot determine account name[from].")),!1;if(S.readOnly)return typeof a!=O&&a(new i(R.RfErr_PermissionDenied,"You have no rights to do this operation")),!1;var M=S[RfapiJS.NAME_PROP],J=e.request.to[RfapiJS.ITEMINFO_PATH_PROP];if(this.checkValidPath(J,!0)){var c=e.request.to[RfapiJS.ITEMINFO_TYPE_PROP];if(typeof c!=O){var l=this.getAccountIdNameFromPath(J,c);if(!l)return typeof a!=O&&a(new i(R.RfErr_InvalidPath,"Cannot determine account name[to].")),!1;if(l.readOnly)return typeof a!=O&&a(new i(R.RfErr_PermissionDenied,"You have no rights to do this operation")),!1;var d=l[RfapiJS.NAME_PROP];if(n==c)if(n!=P.RfItemType_Folder||o!=J){var u,h=null,A=null,m=null;if(!(u=this.FindItemByName(o,n,a)))return!1;if(u&&u[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP])typeof a!=O&&a(new i(R.RfErr_WrongParams," Cannot move shared folder"));else{if(!(h=this.FindItemParentByName(o,n,a)))return!1;if(n==P.RfItemType_Folder){if((A=this.GetFolderByPath2(this.getAccountData(),J,T))&&A[RfapiJS.ITEM_CHILDS_PROP]&&A[RfapiJS.ITEM_CHILDS_PROP].length>0)return void(typeof a!=O&&a(new i(void 0,"Cannot move file: Directory not empty: "+J,void 0,void 0,"LocalErr")));var N=J.lastIndexOf("/");"/"==(y=J.substr(0,N))&&(y=T),m=this.GetFolderByPath2(this.getAccountData(),y,T)}else if(n==P.RfItemType_Login||n==P.RfItemType_Bookmark||n==P.RfItemType_Identity||n==P.RfItemType_Contact||n==P.RfItemType_Safenote||n==P.RfItemType_SearchCard||n==P.RfItemType_BlockingPasscard){var y=this.GetParentFolderPath(J);m=this.GetFolderByPath2(this.getAccountData(),y,T)}if(m){var D="",F=m[RfapiJS.ITEM_CHILDS_PROP];F||(m[RfapiJS.ITEM_CHILDS_PROP]=F=[]);var v=h[RfapiJS.ITEM_CHILDS_PROP];if(v||(h[RfapiJS.ITEM_CHILDS_PROP]=v=[]),c==P.RfItemType_Folder)D=A?A[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]:J.substr(J.lastIndexOf("/")+1);else D=J.substring(J.lastIndexOf("/")+1);var C=!1,g=this.FindChildItemIndex(D,c,F,!0),L=g.index,H=g.type;if(-1==L)c==P.RfItemType_Folder&&(C=!0);else if(c!=H&&H==P.RfItemType_Folder)return typeof a!=O&&a(new i(R.RfErr_WrongParams,"Folder with the same name already exists in destination path")),!1;var b=this.FindChildItemIndex2(u,n,h);if(-1!=b){var U=!0;if(c==P.RfItemType_Folder){if(C){var w=new Object;w[RfapiJS.ITEM_CHILDS_PROP]=[],w[RfapiJS.ITEM_INFO_PROP]={},w[RfapiJS.ITEM_INFO_PROP][E]=0,w[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_ISFOLDER_PROP]=!0,w[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]=D;var k=this.getTime();if(w[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_MODTIME_PROP]=k,w[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_CRETIME_PROP]=k,u[RfapiJS.ITEM_CHILDS_PROP]){var B=r.CopyObjectDeep(u);(I||S.id!=l.id)&&this.RemoveSharedAttribute(B);for(var q=B[RfapiJS.ITEM_CHILDS_PROP],G=0;G<q.length;G++)r.insertToSortedArray(q[G],w[RfapiJS.ITEM_CHILDS_PROP],[RfapiJS.ITEM_INFO_PROP,RfapiJS.ITEM_NAME_PROP],0)}r.insertToSortedArray(w,m[RfapiJS.ITEM_CHILDS_PROP],[RfapiJS.ITEM_INFO_PROP,RfapiJS.ITEM_NAME_PROP],0)}else if(u[RfapiJS.ITEM_CHILDS_PROP]){B=r.CopyObjectDeep(u);(I||S.id!=l.id)&&this.RemoveSharedAttribute(B);for(q=B[RfapiJS.ITEM_CHILDS_PROP],G=0;G<q.length;G++)r.insertToSortedArray(q[G],A[RfapiJS.ITEM_CHILDS_PROP],[RfapiJS.ITEM_INFO_PROP,RfapiJS.ITEM_NAME_PROP],0)}}else if(-1==L){var x=new Object;x[RfapiJS.ITEM_BODY_PROP]=u[RfapiJS.ITEM_BODY_PROP],typeof u[RfapiJS.ITEM_ENCODED_PROP]!=O&&(x[RfapiJS.ITEM_ENCODED_PROP]=u[RfapiJS.ITEM_ENCODED_PROP]),I||typeof u[RfapiJS.ITEM_SHAREDFILEID_PROP]==O||S.id!=l.id||(x[RfapiJS.ITEM_SHAREDFILEID_PROP]=u[RfapiJS.ITEM_SHAREDFILEID_PROP]),x[RfapiJS.ITEM_INFO_PROP]={},x[RfapiJS.ITEM_INFO_PROP][E]=u[RfapiJS.ITEM_INFO_PROP][E],x[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]=D,r.insertToSortedArray(x,m[RfapiJS.ITEM_CHILDS_PROP],[RfapiJS.ITEM_INFO_PROP,RfapiJS.ITEM_NAME_PROP],0)}else F[L][RfapiJS.ITEM_BODY_PROP]=u[RfapiJS.ITEM_BODY_PROP],F[L][RfapiJS.ITEM_INFO_PROP][E]=u[RfapiJS.ITEM_INFO_PROP][E],F[L][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]=D,U=!1;var Y=[];!I&&U&&(b=this.FindChildItemIndex2(u,n,h),v.splice(b,1),d!=M&&(this.syncChanges(S.id),Y.push(S.id))),this.syncChanges(l.id),Y.push(l.id),typeof t!=O&&t(_,!0,Y)}else typeof a!=O&&a(new i(void 0,"[R] Item not found: "+o,void 0,void 0,"NotFound"))}else typeof a!=O&&a(new i(void 0,"[R] Parent folder not found: ",void 0,void 0,"NotFound"))}}else typeof a!=O&&a(new i(R.RfErr_WrongParams,"Cannot move/copy folder to itself Type="+n+" Path:'"+o+"'"));else typeof a!=O&&a(new i(R.RfErr_WrongParams,"Wrong types: From="+n+" To:"+c))}else typeof a!=O&&a(new i(R.RfErr_WrongParams,"[R] Wrong parameter: "+c))}else typeof a!=O&&a(new i(R.RfErr_InvalidPath,s+J))}else typeof a!=O&&a(new i(R.RfErr_WrongParams,"[R] Wrong parameter: "+n))}else typeof a!=O&&a(new i(R.RfErr_InvalidPath,s+o))},J.prototype.RemoveSharedAttribute=function(e){var t=e[RfapiJS.ITEM_CHILDS_PROP];if(t)for(var i=0;i<t.length;i++){var a=t[i];a[RfapiJS.ITEM_CHILDS_PROP]?this.RemoveSharedAttribute(a):delete a[RfapiJS.ITEM_SHAREDFILEID_PROP]}},J.prototype.DeleteObject=function(e,t,a,r,f){var p=e.request[RfapiJS.ITEMINFO_PATH_PROP];if(this.checkValidPath(p,!0)){var I=e.request[RfapiJS.ITEMINFO_TYPE_PROP];if(typeof I!=O);else if(I!=P.RfItemType_Login&&I!=P.RfItemType_Bookmark&&I!=P.RfItemType_Identity&&I!=P.RfItemType_Contact&&I!=P.RfItemType_Safenote&&I!=P.RfItemType_SearchCard&&I!=P.RfItemType_BlockingPasscard)return void(typeof a!=O&&a(new i(R.RfErr_WrongParams," Invalid type:"+I)));var o=this.FindItemByName(p,I);if(!o){if(I==P.RfItemType_Folder)return typeof t!=O&&t(_,!1,[]),!0;if(I==P.RfItemType_Login||I==P.RfItemType_Bookmark||I==P.RfItemType_Identity||I==P.RfItemType_Contact||I==P.RfItemType_Safenote||I==P.RfItemType_SearchCard||I==P.RfItemType_BlockingPasscard)return typeof a!=O&&a(new i(void 0,"[R] Item not found: "+p,void 0,void 0,"NotFound")),!1}if(o&&I==P.RfItemType_Folder&&o[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP])typeof a!=O&&a(new i(R.RfErr_WrongParams," Cannot delete shared folder"));else{var n=this.FindItemParentByName(p,I,a);if(!n)return!1;var S=this.getAccountIdNameFromPath(p,I);if(!S)return typeof a!=O&&a(new i(R.RfErr_InvalidPath,"Cannot determine account name.")),!1;if(S.readOnly)return typeof a!=O&&a(new i(R.RfErr_PermissionDenied,"You have no rights to do this operation")),!1;S[RfapiJS.NAME_PROP];var E=this.FindChildItemIndex2(o,I,n);if(-1!=E){n[RfapiJS.ITEM_CHILDS_PROP].splice(E,1),this.syncChanges(S.id);var T=[];T.push(S.id),typeof t!=O&&t(_,!0,T)}else I==P.RfItemType_Folder?typeof t!=O&&t(_,!1,[]):typeof a!=O&&a(new i(void 0,"[R] Item not found: "+p,void 0,void 0,"NotFound"))}}else typeof a!=O&&a(new i(R.RfErr_InvalidPath,s+p))},J.prototype.DeleteAllObjects=function(e,t,i,a,R){var P=this.getAccountData()[RfapiJS.ITEM_CHILDS_PROP];if(P)for(var r=0;r<P.length;r++){P[r][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP]||(P.splice(r,1),r--)}this.syncChanges(this.m_AuthUser);var f=[];return f.push(this.m_AuthUser),typeof t!=O&&t(_,!0,f),!0};var c=99;J.prototype[M]=function(a,f,p,I,n){var S=this,T=a.request.folder;!function(){if(!S.checkValidPath(T,!0))return typeof p!=O&&p(new i(R.RfErr_InvalidPath,s+T)),!1;if(T.match(new RegExp("/","g")).length>c)return typeof p!=O&&p(new i(R.RfErr_InvalidPath,"Creation of more than 99 subfolders is prohibited")),!1;var a=S.getAccountIdNameFromPath(T,P.RfItemType_Folder);if(!a)return typeof p!=O&&p(new i(R.RfErr_InvalidPath,"Cannot determine account name.")),!1;if(a.readOnly)return typeof p!=O&&p(new i(R.RfErr_PermissionDenied,"You have no rights to do this operation")),!1;a[RfapiJS.NAME_PROP];var I=S.FindItemParentByName(T,P.RfItemType_Folder,p,!0);I?function(i,a){var R=T.substring(T.lastIndexOf("/")+1),P=i[RfapiJS.ITEM_CHILDS_PROP];P||(i[RfapiJS.ITEM_CHILDS_PROP]=P=[]);for(var p=!1,I=0;I<P.length;I++)if(P[I][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP].toLowerCase()==R.toLowerCase()){p=!0;break}if(p)return e("Repository.CreateFolder. File/Folder already exists '"+T+"'",o,t.SPECIAL_CASE),void(typeof f!=O&&f(_,!1,[]));var n=new Object;n[RfapiJS.ITEM_CHILDS_PROP]=[],n[RfapiJS.ITEM_INFO_PROP]={},n[RfapiJS.ITEM_INFO_PROP][E]=0,n[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_ISFOLDER_PROP]=!0,n[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]=R;var s=S.getTime();n[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_MODTIME_PROP]=s,n[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_CRETIME_PROP]=s,i[RfapiJS.ITEM_CHILDS_PROP]=r.insertToSortedArray(n,i[RfapiJS.ITEM_CHILDS_PROP],[RfapiJS.ITEM_INFO_PROP,RfapiJS.ITEM_NAME_PROP],0),S.syncChanges(a.id);var M=[];M.push(a.id),typeof f!=O&&f(_,!0,M)}(I,a):function(e,t){for(var a=e.split("/"),_=a.length-1,P=0,r=2;r<=a.length;r++){var I=a.slice(0,r).join("/");if(!I)return void(typeof p!=O&&p(new i(R.RfErr_InvalidPath,s+I)));var o={request:{}};o.request.function="createfolder",o.request.folder=I,S[M](o,function(e,t,i){++P==_&&typeof f!=O&&f(e,!0,i)},function(e){r=a.length,p(e)})}}(T)}()};function l(e,t){for(var i=0;i<e.length;i++)if(e[i]==t)return!0}J.prototype.PutDataToFolder=function(i,a,R,f,p){var I=this,n=i.request.folder,s=i.request.data,S=!1,E=0,J=0;function c(i,P){var r={request:{}};r.request.function="createfolder",r.request.folder=i,I[M](r,function(a,R,_){if(S=S||R,e("createInnerFolder  created="+R+" folder='"+i+"'",o,t.FUNC_INOUT),P)for(var r=0;r<P.length;r++){var f=P[r],p=l(f,i+"/"+f[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP],!0);e("PutItemToRepo  result1="+p,o,t.FUNC_INOUT)}},function(e){if(e&&6==e.Code){var t=[];S&&I.syncChanges(I.m_AuthUser),t.push(I.m_AuthUser),typeof a!=O&&a(_,S,t)}else R(e)})}function l(i,a,R){var _=i[RfapiJS.ITEM_CHILDS_PROP];if(_)if(R)c(a,_);else for(var f=0;f<_.length;f++){var p=_[f],n=l(p,a+"/"+p[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP],!0);e("PutItemToRepo  result = "+n,o,t.FUNC_INOUT)}else if(R)if(i[RfapiJS.ITEM_INFO_PROP].F)c(a,_);else{typeof i[RfapiJS.ITEM_ENCODED_PROP]!=O&&1==i[RfapiJS.ITEM_ENCODED_PROP]&&(i[RfapiJS.ITEM_BODY_PROP]=I.base64Decode(i[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP],i[RfapiJS.ITEM_BODY_PROP]));var s=i[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP],T=s.substr(s.lastIndexOf(".")),M=r.FileExtToType(T),d=I.FindItemByName(a,M,void 0);if(d&&d[RfapiJS.ITEM_BODY_PROP]!=i[RfapiJS.ITEM_BODY_PROP]&&(d[RfapiJS.ITEM_BODY_PROP]=i[RfapiJS.ITEM_BODY_PROP],S=!0),d)switch(d[RfapiJS.ITEM_BODY_PROP]=i[RfapiJS.ITEM_BODY_PROP],M){case P.RfItemType_Bookmark:J++;break;case P.RfItemType_Login:0}else{switch(M){case P.RfItemType_Bookmark:E++;break;case P.RfItemType_Login:0}var u=I.FindItemParentByName(a,P.RfItemType_Folder,void 0);u[RfapiJS.ITEM_CHILDS_PROP]||(u[RfapiJS.ITEM_CHILDS_PROP]=[]),r.insertToSortedArray(i,u[RfapiJS.ITEM_CHILDS_PROP],[RfapiJS.ITEM_INFO_PROP,RfapiJS.ITEM_NAME_PROP],0),S=!0,e("PutItemToRepo  put item='"+a+"'",o,t.FUNC_INOUT)}}return!0}!function(){if(n==T){l(s,n,!1);var e=[];return S&&I.syncChanges(I.m_AuthUser),e.push(I.m_AuthUser),void(typeof a!=O&&a(_,S,e,{BookmarksAdded:E,BookmarksExists:J}))}var t={request:{}};t.request.function="createfolder",t.request.folder=n,I[M](t,function(e,t,i){S=S||t,l(s,n,!1);var R=[];S&&I.syncChanges(I.m_AuthUser),R.push(I.m_AuthUser),typeof a!=O&&a(_,S,R,{BookmarksAdded:E,BookmarksExists:J})},function(e){R(e)})}()},J.prototype.addItemtoJSON=function(e,t,a){var f=e.request.item,p=f[RfapiJS.ITEMINFO_PATH_PROP];if(!this.checkValidPath(p,!0))return typeof a!=O&&a(new i(R.RfErr_InvalidPath,s+p)),!1;var I=f[RfapiJS.ITEMINFO_TYPE_PROP],o=null;if(8==(I=parseInt(I)))o=this.FindItemParentByName(p,P.RfItemType_Folder,a);else{var n=p.substr(0,p.lastIndexOf("/")+1);n.endsWith("/")&&(n=n.substr(0,n.length-1)),"/"==n&&(n=""),o=this.FindItemByName(n,P.RfItemType_Folder,a)}if(!o)return!1;var S=p.substring(p.lastIndexOf("/")+1),T=new Object;T[RfapiJS.ITEM_INFO_PROP]={},T[RfapiJS.ITEM_INFO_PROP][E]=f[RfapiJS.ITEMINFO_SIZE_PROP],T[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]=S,T[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_MODTIME_PROP]=f[RfapiJS.ITEMINFO_MODTIME_PROP],T[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_CRETIME_PROP]=f[RfapiJS.ITEMINFO_CREATETIME_PROP],8==I?(T[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_ISFOLDER_PROP]=!0,T[RfapiJS.ITEM_CHILDS_PROP]=[]):T[RfapiJS.ITEM_BODY_PROP]=JSON.stringify(e.request.data),r.insertToSortedArray(T,o[RfapiJS.ITEM_CHILDS_PROP],[RfapiJS.ITEM_INFO_PROP,RfapiJS.ITEM_NAME_PROP],0);var M=[];M.push(this.m_AuthUser),typeof t!=O&&t(_,!0,M)},J.prototype.getAccountIdNameFromPath=function(e,t){e.startsWith("/")&&(e=e.substr(1));var i=e.indexOf("/"),a="";if(-1==i){if(t!=P.RfItemType_Folder)return{id:this.m_AuthUser,name:this.m_AuthUser,isShared:!1,readOnly:!1,showPasswords:!0,disabled:!1,isManager:!1,isAdmin:!1,licenseExpired:!1,isAllowedIP:!0};a=e}else a=e.substr(0,i);var R=this.getAccountData()[RfapiJS.ITEM_CHILDS_PROP];if(typeof R==O)return{id:this.m_AuthUser,name:this.m_AuthUser,isShared:!1,readOnly:!1,showPasswords:!0,disabled:!1,isManager:!1,isAdmin:!1,licenseExpired:!1,isAllowedIP:!0};for(var _=0;_<R.length;_++){var r=R[_];if(r[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]==a){if(typeof r[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP]==O)return{id:this.m_AuthUser,name:this.m_AuthUser,isShared:!1,readOnly:!1,showPasswords:!0,disabled:!1,isManager:!1,isAdmin:!1,licenseExpired:!1,isAllowedIP:!0};var f=typeof r[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP].disabled!=O&&r[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP].disabled,p=typeof r[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP].showPasswords!=O&&r[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP].showPasswords,I=typeof r[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP].readOnly!=O&&r[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP].readOnly,o=typeof r[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP].isManager!=O&&r[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP].isManager,n=typeof r[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP].isAdmin!=O&&r[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP].isAdmin,s=typeof r[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP].licenseExpired!=O&&r[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP].licenseExpired,S=typeof r[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.ACCOUNTINFO_PROP].isAllowedIP==O||r[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.ACCOUNTINFO_PROP].isAllowedIP,E=typeof r[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP].sender==O?"":r[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP].sender,T=typeof r[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP].senderEmail==O?"":r[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP].senderEmail,M=typeof r[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP].senderName==O?"":r[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP].senderName,J={id:r[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP][RfapiJS.ACCOUNT_ID_PROP],name:r[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP],isShared:!0,showPasswords:p,disabled:f,readOnly:I,isManager:o,isAdmin:n,licenseExpired:s,isAllowedIP:S,sender:E,senderEmail:T,senderName:M};return r[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP].company&&(J.company=r[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP].company),J}}return{id:this.m_AuthUser,name:this.m_AuthUser,isShared:!1,readOnly:!1,showPasswords:!0,disabled:!1,isManager:!1,isAdmin:!1,licenseExpired:!1,isAllowedIP:!0}},J.prototype.GetSharedItems=function(e,t,i,a){var R=t[RfapiJS.ITEM_CHILDS_PROP];if(R)for(var _=0;_<R.length;_++){var P=R[_],f=P[RfapiJS.ITEM_INFO_PROP],p=!(typeof f[RfapiJS.ITEM_ISFOLDER_PROP]!=O&&1==f[RfapiJS.ITEM_ISFOLDER_PROP]),I=f[RfapiJS.ITEM_NAME_PROP];if(p&&P[RfapiJS.ITEM_SHAREDFILEID_PROP]){var o;if(a&&"G"==P[RfapiJS.ITEM_SHAREDFILEID_PROP].substr(0,1))(o=r.CopyObjectDeep(P)).path=e,i.push(o);if(!a&&"R"==P[RfapiJS.ITEM_SHAREDFILEID_PROP].substr(0,1))(o=r.CopyObjectDeep(P)).path=e,i.push(o)}if(typeof P[RfapiJS.ITEM_CHILDS_PROP]!=O){var n=e+"/"+I;this.GetSharedItems(n,P,i,a)}}},J.prototype.GetItemsForFolder=function(e,t,i,a,R,_,f,p,I,o){for(var n=0;n<t[RfapiJS.ITEM_CHILDS_PROP].length;n++){var s=t[RfapiJS.ITEM_CHILDS_PROP][n],S=s[RfapiJS.ITEM_INFO_PROP],E=typeof S[RfapiJS.ITEM_ISFOLDER_PROP]!=O&&1==S[RfapiJS.ITEM_ISFOLDER_PROP],T=!E,M=S[RfapiJS.ITEM_NAME_PROP];if(T){M.lastIndexOf(".");var J=M.substr(M.lastIndexOf(".")),c=r.FileExtToType(J);if(l(i,c)){var d=this.ConvertFromOFS(s,e+"/"+M,c,R,I,_,o);f.push(d)}}else if(E&&l(i,P.RfItemType_Folder)){d=this.ConvertFromOFS(s,e+"/"+M,P.RfItemType_Folder,R,I,_,o);f.push(d)}if(a&&typeof s[RfapiJS.ITEM_CHILDS_PROP]!=O){var u=e+"/"+M;this.GetItemsForFolder(u,s,i,a,R,_,f,p,I,o)}}},J.prototype.GetFolderByPath2=function(e,t,i){if(i.toLowerCase()==t.toLowerCase())return e;if(!e[RfapiJS.ITEM_CHILDS_PROP])return null;var a=e[RfapiJS.ITEM_CHILDS_PROP].length;if(a){for(var R=null,_=0;null==R&&_<a;_++){var P=e[RfapiJS.ITEM_CHILDS_PROP][_];if(P[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_ISFOLDER_PROP]){var r=i+"/"+P[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP];R=this.GetFolderByPath2(P,t,r)}}return R}return null},J.prototype.GetParentFolderPath=function(e){var t=e.lastIndexOf("/");return 0==t?T:e.substring(0,e.lastIndexOf("/"))},J.prototype.checkValidPath=function(e,t){var i=e.length;return(e!=T||!t)&&((!e.startsWith("/")||1!=i)&&(!(!e.startsWith("/")&&i>1)&&!e.endsWith("/")))},J.prototype.FindItemParentByName=function(e,t,a,R){if(t==P.RfItemType_Folder){var _=e.substr(0,e.lastIndexOf("/")+1);return _.endsWith("/")&&(_=_.substr(0,_.length-1)),"/"==_&&(_=T),this.GetFolderByPath2(this.getAccountData(),_,T)||(typeof a!=O&&(R||a(new i(void 0,"[R] Parent folder not found: ",void 0,void 0,"NotFound"))),null)}var r=this.GetParentFolderPath(e);return this.GetFolderByPath2(this.getAccountData(),r,T)||(typeof a!=O&&a(new i(void 0,"[R] Parent folder not found: ",void 0,void 0,"NotFound")),null)},J.prototype.FindItemByName=function(e,t,a,R){var _=e.substring(e.lastIndexOf("/")+1);if(t==P.RfItemType_Folder){var r=this.GetFolderByPath2(this.getAccountData(),e,T);return r||(typeof a!=O&&a(new i(void 0,"[R] Item not found: "+e+" Type:"+t,void 0,void 0,"NotFound")),null)}var f;if(!(f=this.GetFolderByPath2(this.getAccountData(),this.GetParentFolderPath(e),T)))return typeof a!=O&&a(new i(void 0,"[R] Item not found: "+e,void 0,void 0,"NotFound")),null;var p=typeof f[RfapiJS.ITEM_CHILDS_PROP]==O?[]:f[RfapiJS.ITEM_CHILDS_PROP],I=this.FindChildItemIndex(_,t,p,R).index;return-1==I?(typeof a!=O&&a(new i(void 0,"[R] Item not found: "+e+" Type:"+t,void 0,void 0,"NotFound")),null):f[RfapiJS.ITEM_CHILDS_PROP][I]},J.prototype.FindChildItemIndex2=function(e,t,i){var a=e[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP],R=i[RfapiJS.ITEM_CHILDS_PROP],_=-1;if(R)for(var P=0;P<R.length;P++){if(R[P][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]==a){_=P;break}}return _},J.prototype.FindChildItemIndex=function(e,t,i,a){var R=-1,_=-1,f=typeof a!=O&&a;e=f?e.toLowerCase():e;for(var p=0;p<i.length;p++){var I=i[p],o=f?I[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP].toLowerCase():I[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP];if(o==e){if(R=p,typeof I[RfapiJS.ITEM_CHILDS_PROP]!=O||typeof I[RfapiJS.ITEM_INFO_PROP].Shared!=O||I[RfapiJS.ITEM_INFO_PROP].F)_=P.RfItemType_Folder;else{var n=o.substr(o.lastIndexOf("."));_=r.FileExtToType(n)}break}}return{index:R,type:_}};var d="protected";J.prototype.ConvertFromOFS=function(e,t,i,R,_,r,f){var p=this;var n=new Object;try{var s=e[RfapiJS.ITEM_INFO_PROP];if(!_){n[RfapiJS.ITEMINFO_CREATETIME_PROP]=typeof s[RfapiJS.ITEM_CRETIME_PROP]!=O?s[RfapiJS.ITEM_CRETIME_PROP]:0,n[RfapiJS.ITEMINFO_MODTIME_PROP]=typeof s[RfapiJS.ITEM_MODTIME_PROP]!=O?s[RfapiJS.ITEM_MODTIME_PROP]:0,n[RfapiJS.ITEMINFO_SIZE_PROP]=typeof s[E]!=O?s[E]:0,n[RfapiJS.ITEMINFO_TYPE_PROP]=i,n[RfapiJS.ITEMINFO_PATH_PROP]=t,typeof s[RfapiJS.ITEM_SHARED_PROP]!=O&&(n[RfapiJS.ITEM_SHARED_PROP]=s[RfapiJS.ITEM_SHARED_PROP]);var S=this.getAccountIdNameFromPath(t,i);if(S.isShared&&(n.isShared=S.isShared),S.readOnly&&(n.readOnly=S.readOnly),S.isManager&&(n.isManager=S.isManager),S.isAdmin&&(n.isAdmin=S.isAdmin),S.company&&(n.company=S.company),typeof e[RfapiJS.ITEM_SHAREDFILEID_PROP]!=O){var T=e[RfapiJS.ITEM_SHAREDFILEID_PROP].substr(0,1),M=e[RfapiJS.ITEM_SHAREDFILEID_PROP].substr(1),J="R"==T;(function(e){for(var t=!1,i=!1,a=0;a<p.m_GrantedFiles.length;a++){var R=p.m_GrantedFiles[a];if(R.id==e&&(t=!0,R.hash)){i=!0;break}}return t&&!i})(M)&&(n.sendOnly=!0),J?n.received=n.readOnly=!0:n.granted=!0,n[RfapiJS.ITEM_SHAREDFILEID_PROP]=e[RfapiJS.ITEM_SHAREDFILEID_PROP],n.isManager=!J}}if(R>1||r){var c=typeof e[RfapiJS.ITEM_ENCODED_PROP]!=O&&1==e[RfapiJS.ITEM_ENCODED_PROP],l=e[RfapiJS.ITEM_BODY_PROP],d=null;if(typeof l!=O){if(R&a.enFlags){c&&(n[RfapiJS.ITEM_ENCODED_PROP]=!0,l=this.base64Decode(t,l)),typeof(d=JSON.parse(l))[RfapiJS.ITEM_ISDEFAULT_PROP]!=O&&(n.isDefault=d[RfapiJS.ITEM_ISDEFAULT_PROP])}if(R&a.enUrls){if(i==P.RfItemType_Bookmark||i==P.RfItemType_Login||i==P.RfItemType_SearchCard)d||(c&&(n[RfapiJS.ITEM_ENCODED_PROP]=!0,l=this.base64Decode(t,l)),d=JSON.parse(l)),n[0==_?"matchUrl":RfapiJS.ITEM_MATCHURL_PROP]=typeof d[RfapiJS.ITEM_MATCHURL_PROP]!=O?d[RfapiJS.ITEM_MATCHURL_PROP]:"",n[0==_?"gotoUrl":RfapiJS.ITEM_GOTOURL_PROP]=typeof d[RfapiJS.ITEM_GOTOURL_PROP]!=O?d[RfapiJS.ITEM_GOTOURL_PROP]:"";if(i==P.RfItemType_BlockingPasscard)d||(c&&(n[RfapiJS.ITEM_ENCODED_PROP]=!0,l=this.base64Decode(t,l)),d=JSON.parse(l)),n[0==_?"matchUrl":RfapiJS.ITEM_MATCHURL_PROP]=typeof d[RfapiJS.ITEM_MATCHURL_PROP]!=O?d[RfapiJS.ITEM_MATCHURL_PROP]:""}if(R&a.enUnprotData){if(d||(c&&(n[RfapiJS.ITEM_ENCODED_PROP]=!0,l=this.base64Decode(t,l)),d=JSON.parse(l)),i==P.RfItemType_BlockingPasscard)n[RfapiJS.ITEMDATA_BLOCK_PROP]=typeof d[RfapiJS.ITEMDATA_BLOCK_PROP]!=O?d[RfapiJS.ITEMDATA_BLOCK_PROP]:0;if(i==P.RfItemType_SearchCard){n.s=typeof d.s!=O?d.s:0}}if(a.enUsageInfo,_&&R&a.enAll){if(d||(c&&(n[RfapiJS.ITEM_ENCODED_PROP]=!0,l=this.base64Decode(t,l)),d=JSON.parse(l)),i!=P.RfItemType_Bookmark&&i!=P.RfItemType_Login&&i!=P.RfItemType_BlockingPasscard&&i!=P.RfItemType_Safenote&&i!=P.RfItemType_SearchCard||(n[RfapiJS.ITEM_NOTE_PROP]=typeof d[RfapiJS.ITEM_NOTE_PROP]!=O?d[RfapiJS.ITEM_NOTE_PROP]:""),i!=P.RfItemType_Contact&&i!=P.RfItemType_Identity||(n[RfapiJS.ID_OPTIONS_PROP]=typeof d[RfapiJS.ID_OPTIONS_PROP]!=O?d[RfapiJS.ID_OPTIONS_PROP]:{},n[RfapiJS.ID_GROUPS_PROP]=typeof d[RfapiJS.ID_GROUPS_PROP]!=O?d[RfapiJS.ID_GROUPS_PROP]:[]),typeof d[RfapiJS.ITEMDATA_FIELDS_PROP]!=O){n[RfapiJS.ITEMDATA_FIELDS_PROP]=[];for(var u=0;u<d[RfapiJS.ITEMDATA_FIELDS_PROP].length;u++)n[RfapiJS.ITEMDATA_FIELDS_PROP].push(d[RfapiJS.ITEMDATA_FIELDS_PROP][u])}if(f){if(typeof e[RfapiJS.ITEM_SHAREDFILEID_PROP]!=O)(J="R"==e[RfapiJS.ITEM_SHAREDFILEID_PROP].substr(0,1))?n.received=!0:n.granted=!0;n[RfapiJS.ITEMINFO_CREATETIME_PROP]=typeof s[RfapiJS.ITEM_CRETIME_PROP]!=O?s[RfapiJS.ITEM_CRETIME_PROP]:0,n[RfapiJS.ITEMINFO_MODTIME_PROP]=typeof s[RfapiJS.ITEM_MODTIME_PROP]!=O?s[RfapiJS.ITEM_MODTIME_PROP]:0,n[RfapiJS.ITEMINFO_PATH_PROP]=t}}}}return n}catch(e){var h=l?l.substr(0,10):"",A=h?e.toString()+" [file="+h+"]":e.toString();return I("EXCEPTION in Repo.ConvertFromOFS  path='"+t+"' objType='"+i+"'  parts='"+R+"'  ERROR="+A,o),n.error=A,n}},J.prototype.ParseRFObjects=function(e){var t=e[RfapiJS.ITEM_CHILDS_PROP];if(t)for(var i=0;i<t.length;i++){var a=t[i];if(a[RfapiJS.ITEM_CHILDS_PROP])this.ParseRFObjects(a);else if(a[RfapiJS.ITEM_BODY_PROP]){typeof a[RfapiJS.ITEM_ENCODED_PROP]!=O&&1==a[RfapiJS.ITEM_ENCODED_PROP]&&(a[RfapiJS.ITEM_BODY_PROP]=this.base64Decode(a[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP],a[RfapiJS.ITEM_BODY_PROP])),delete a[RfapiJS.ITEM_SHAREDFILEID_PROP]}}},J.prototype.base64EncodeAsync=function(e,t,i,a){try{function R(e){var t=RfapiJS.Base64.ArrayBuffertoBase64(e);return t=(t=(t=t.replace(new RegExp("=","g"),"")).replace(new RegExp("\\+","g"),"-")).replace(new RegExp("/","g"),"_"),i&&i(t),t}!FileReader.prototype.readAsArrayBuffer||a?R(RfapiJS.UTF8.stringToBytes(t)):RfapiJS.StringConverter.StringToBytes(t,function(e){R(e)},function(a){return I("ERROR in Repository.base64EncodeAsync while encode fileName='"+e+"' itemBody='"+t+"'  error="+a.toString(),o),i&&i(""),""})}catch(a){return I("EXCEPTION in Repo.base64EncodeAsync while [en]decode fileName='"+e+"' itemBody='"+t+"'  ERROR="+a.toString(),o),i&&i(""),""}},J.prototype.base64Decode=function(e,t){var i="{}";try{t=(t=t.replace(new RegExp("\\-","g"),"+")).replace(new RegExp("_","g"),"/"),i=RfapiJS.Base64.Base64ToString(t)}catch(a){I("EXCEPTION in Repo.base64Decode [Base64.Base64ToString] while decode fileName='"+e+"' itemBody='"+t+"'  ERROR="+a.toString(),o),i="{}"}return i},J.prototype.getTime=function(){return Math.round(new Date/1e3)};var u=[34,34,47,47,92,92,8,98,12,102,10,110,13,114,9,116];J.prototype.JsonCheckBinaryValueNeedBase64Encoding=function(e,t){try{for(var i=0,a=e.length,R=e.length,_=0;_<a;_++){if(i>R/2)return!0;var P,r=e[_].charCodeAt(0);for(P=0;P<u.length;P+=2)if(r==u[P]){i++;break}if(!(P<u.length))if(60==r||62==r||r<32)i+=5;else if(r<=127);else if(r<194)i+=5;else{var f;if(r<=223)f=2;else if(r<=239)f=3;else{if(!(r<=244)){i+=5;continue}f=4}i+=5,_+=f-1}}return!1}catch(e){return I("EXCEPTION in Repo.JsonCheckBinaryValueNeedBase64Encoding while [en]decode fileName='"+t+"'  ERROR="+e.toString(),o),!1}},J.prototype.ProposeFirstLastNameIdentity=function(e,t){var i=(e=e.substring(e.lastIndexOf("/")+1)).substr(0,e.lastIndexOf(".")),a=i.split(new RegExp("[\\s+/]")),R=a[0],_="",P="";switch(a.length){case 1:break;case 2:P=a[1];break;case 3:_=a[1],P=a[2];break;default:_=a[1],P=(i=(i=i.substr(i.indexOf(R)+(R.length+1))).substr(i.indexOf(_)+(_.length+1))).trimLeft().trimRight()}return{"First Name":R,"Middle Initial":_,"Last Name":P}},String.prototype.startsWith||(String.prototype.startsWith=function(e){return this.match("^"+e)==e}),String.prototype.endsWith||(String.prototype.endsWith=function(e){return this.match(e+"$")==e}),String.prototype.trimLeft||(String.prototype.trimLeft=function(){return this.replace(new RegExp("^\\s+"),"")}),String.prototype.trimRight||(String.prototype.trimRight=function(){return this.replace(new RegExp("\\s+$"),"")}),String.prototype.trim||(String.prototype.trim=function(){return this.trimLeft().trimRight()}),RfapiJS.Repository=J}).apply(RfapiJS);
//# sourceMappingURL=repository.js.map