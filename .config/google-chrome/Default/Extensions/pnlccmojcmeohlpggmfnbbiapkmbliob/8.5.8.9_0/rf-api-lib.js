// Copyright (C) 1999-2019 Siber Systems Inc. All Rights Reserved.
var RfapiJS=RfapiJS||{};(function(){var t=RfapiJS.utils,r=RfapiJS.UTF8,a=RfapiJS.RF_RSA,n=RfapiJS.Binary,s=RfapiJS.SecurityScore,o=RfapiJS.StringConverter,i=(new Date).getTime(),c={INFO:0,FUNC_INOUT:1,SPECIAL_CASE:2,EXCEPTION:3},f=c.INFO,u=!1,p="rf-api-lib.js",l="March 20, 2019",_="undefined",d=!1,S=!1,y=!1,R=!1,U=!1,h=!1;window.navigator.appVersion.indexOf("Edge"),typeof chrome!=_&&(d=!0,-1!=window.navigator.appVersion.indexOf("OPR")&&(y=!0,d=!1)),typeof mx!=_&&(U=!0),(-1!==navigator.userAgent.indexOf("MSIE")||navigator.appVersion.indexOf("Trident/")>0)&&(h=!0),navigator.userAgent.indexOf("Firefox")>0&&(R=!0),navigator.vendor&&navigator.vendor.indexOf("Apple")>-1&&navigator.userAgent&&navigator.userAgent.indexOf("Safari")>-1&&-1==navigator.userAgent.indexOf("Chrome")&&(S=!0);var I=null,O={SibTErr_None:0,SibTErr_ProxyAuthBad:1,SibTErr_AuthRejected:2,SibTErr_AuthNeedOTP:3,SibTErr_Connectivity:4,SibTErr_SocketClosed:5,SibTErr_LocalErr:6,SibTErr_AccessDenied:7,SibTErr_LockedFile:8,SibTErr_ServerErr:9,SibTErr_DiskFull:10,SibTErr_MemoryFull:11,SibTErr_MustRetry:12,SibTErr_UserStop:13,SibTErr_Disconnected:14,SibTErr_BadServerErr:15,SibTErr_NotInCache:16,SibTerr_NotFound:17,SibTerr_NotReady:18,SibTErr_EndOfFile:19,SibTErr_CatchedException:20,SibTErr__Last:1e3},m={EMPTY:0,OFS:1,MULTIFILE:2},C={enNothing:0,enFileInfo:1,enFlags:2,enUrls:4,enIcon:8,enUnprotData:16,enUsageInfo:32,enAll:63},v={RfItemType_Undefined:0,RfItemType_Login:1,RfItemType_Bookmark:2,RfItemType_SearchCard:3,RfItemType_BlockingPasscard:4,RfItemType_Identity:5,RfItemType_Contact:6,RfItemType_Safenote:7,RfItemType_Folder:8,RfItemType_Generic:9,RfItemType_Max:100},E=[v.RfItemType_Login,v.RfItemType_Bookmark,v.RfItemType_SearchCard,v.RfItemType_BlockingPasscard,v.RfItemType_Identity,v.RfItemType_Contact,v.RfItemType_Safenote],N={RfErr_None:0,RfErr_AuthRejected:1,RfErr_PermissionDenied:2,RfErr_BadRequest:3,RfErr_BadData:4,RfErr_WrongParams:5,RfErr_InvalidPath:6,RfErr_UnknownFunction:7,RfErr_FileVsFolderConflict:8,RfErr_NotImplemented:9,RfErr_NotLoggedIn:10,RfErr_NeedToConfirmChanges:11,RfErr_CannotSyncOneFileWithMultifile:12,RfErr_NeedToConfirmReceivedItems:14,RfErr_AccountExists:100,RfErr_FolderExists:101},T={usiRecentlyUsedList:0,usiFavouritesList:1,usiRecentlyViewedList:2,usiMostPopularList:3,identitiesGroupInstances:4},A="LoginToAccount_Scram",g="LogOffAccount",F="GetAccountInfo",P="SetAccountInfo",D="PostTrustedUsers",k="UpdateTrustedUsers",b="GetTrustedUsers",M="RecoverMemberPassword",w="GetRecipients",L="GetReceivedAccountsFiles",x="GetSharedAcctInfo",J="SetSharedAcctInfo",G="GetPublicKey",B="PutPublicKey",H="GetCompanyUsers",q="GrantAccount",K="RevokeAccount",V="RejectSharedAccount",W="UpdateRecievedAccountList",j="DeleteSharedAccount",X="GrantSharedFile",Y="RevokeSharedFile",Q="RejectSharedFile",Z="GetSharedFiles",z="GetReceivedFileBodies",$="UpdateSharedFiles",ee="GetSharedFileUsersInfo",te="CheckoutFile",re="UpdateUsageInfo",ae="GetUsageInfo",ne="PutOFSFile",se="GetOFSFile",oe="CheckOFSFileETag",ie="PutOFS_WithCheckMerge",ce="GetOFSWitheTagCheck",fe="GetMatchingPasscards",ue="GetDomainPasscards",pe="GetItemsCount",le="GetItemInfo",_e="GetFile",de="Search",Se="GetItemsList",ye="GetDataItem",Re="PutDataItem",Ue="CreateFolder",he="DeleteObject",Ie="MoveObject",Oe="getMasterPwd",me="setMasterPwd",Ce="setAccountPwd",ve="Repository returned null [R]",Ee=200,Ne=401,Te=404,Ae=412,ge=500,Fe="-> ",Pe="<- ",De=100,ke=48,be=4096,Me=4096,we="fileId",Le="type",xe="path",Je="name",Ge="function",Be="request",He="deep",qe="parts",Ke="from",Ve="to",We="status",je="response",Xe="recipient",Ye="body",Qe="isManager",Ze="readOnly",ze="showPasswords",$e="serverOnly",et="company";function tt(e,t,r,a,n){typeof e!=_&&(this.Code=typeof e!=_?e:-1),typeof n!=_&&(this.sibErr=typeof n!=_?n:-1),this.Description=typeof t!=_?t:"",typeof r!=_&&(this.oException=r),typeof a!=_&&(this.HttpRequest=a)}tt.prototype.toString=function(){var e="{";return typeof this.HttpRequest!=_&&(e+=" HTTPStatus="+this.HttpRequest.status+" "),typeof this.Code!=_&&(e+=" rfApiCode="+this.Code+" "),typeof this.sibErr!=_&&(e+=" sibErr="+this.sibErr+" "),e+='  Description="'+this.Description+'" }'};var rt={APP_DATA:"app-data.rfo",SYNC_DATA:"sync-data.rfo",USER_DATA:"user-data.rfo"};function at(){this.m_nId=Math.floor(10001*Math.random()),St(Fe+"RfDataManager ctor. ID=["+this.m_nId+"] build="+l,p,c.FUNC_INOUT),this.m_nAccountMode=-1,this.m_sServerUrl="",this.m_sUserId="",this.m_sAccountPwd="",this.m_sMasterPwd="",this.m_sBrowserParam="",this.m_sExtensionParams={},this.m_show_all_groups=!1,this.m_eTag_RecievedList="",this.m_eTags={},this.m_EventsMap={},this.m_LastError={},this.m_OFSMgr=new RfapiJS.CRfOneFileSys,I=new RfapiJS.Repository}at.prototype.GetVersion=function(){return St("[ID:"+this.m_nId+"]. RfDataManager.GetVersion  ->  ",p,c.FUNC_INOUT),"1.19.3.20 , "+l},at.prototype.SetRfoOptions=function(e){St("[ID:"+this.m_nId+"]. RfDataManager.SetRfoUIOptions->",p,c.FUNC_INOUT),this.m_show_all_groups=typeof e.showAllGroups!=_&&e.showAllGroups},at.prototype.SetServerUrl=function(e){St("[ID:"+this.m_nId+"]. RfDataManager.SetServerUrl  ->  '"+e+"'",p,c.FUNC_INOUT),this.m_sServerUrl=e},at.prototype.GetServerUrl=function(){return St("RfDataManager.GetServerUrl  ->  '"+this.m_sServerUrl+"'",p,c.FUNC_INOUT),this.m_sServerUrl},at.prototype.SetUserID=function(e){St("[ID:"+this.m_nId+"]. RfDataManager.SetUserID  ->  '"+e+"'",p,c.FUNC_INOUT),this.m_sUserId=e,I.setUser(e)},at.prototype.GetUserID=function(){return St("RfDataManager.GetUserID  ->  '"+this.m_sUserId+"'",p,c.FUNC_INOUT),this.m_sUserId},at.prototype.isSharedAccountId=function(e){return this.m_sUserId!=e},at.prototype[Ce]=function(e){St("[ID:"+this.m_nId+"]. RfDataManager.setAccountPwd  ->  '"+e+"'",p,c.FUNC_INOUT),this.m_sAccountPwd=e},at.prototype.getAccountPwd=function(){return St("RfDataManager.getAccountPwd  ->  '"+this.m_sAccountPwd+"'",p,c.FUNC_INOUT),this.m_sAccountPwd};at.prototype.internal_isPasswordCorrect=function(e,t,r){var a=e.length;if(a<nt||a>st)return St("Account password is incorrect (8-80 symbols). Return false",p,c.SPECIAL_CASE),typeof r!=_&&r(De),typeof t!=_&&t(new tt(N.RfErr_WrongParams,"Account password is incorrect (8-80 symbols)")),!1;for(var n=0,s=0;s<a;s++)e[s]>="0"&&e[s]<="9"&&n++;return!(a-n<4)||(St("Account password is incorrect(Minimum of 4 characters must be non-numerical).  Return false",p,c.SPECIAL_CASE),typeof r!=_&&r(De),typeof t!=_&&t(new tt(N.RfErr_WrongParams,"Account password is incorrect (Minimum of 4 characters must be non-numerical)")),!1)},at.prototype.internal_getBrowserLang=function(){var e=2,t="en";var r,a=window.navigator&&(window.navigator.browserLanguage||window.navigator.language||window.navigator.systemLanguage||window.navigator.userLanguage||t);return(r=a).length==e?r:r.length<e?t:r.substr(0,e)},at.prototype.setAccountMode=function(e){St(e==m.OFS?"[ID:"+this.m_nId+"]. RfDataManager.setAccountMode  ->  OFS[1]":e==m.MULTIFILE?"[ID:"+this.m_nId+"]. RfDataManager.setAccountMode  ->  MULTIFILE[2]":"[ID:"+this.m_nId+"]. RfDataManager.setAccountMode  -> "+e,p,c.FUNC_INOUT),this.m_nAccountMode=e},at.prototype.getAccountMode=function(){return St("RfDataManager.getAccountMode  ->  "+this.m_nAccountMode,p,c.FUNC_INOUT),this.m_nAccountMode},at.prototype[me]=function(e){St("[ID:"+this.m_nId+"]. RfDataManager.setMasterPwd  ->  '"+e+"'",p,c.FUNC_INOUT),this.m_sMasterPwd=e},at.prototype[Oe]=function(){return St("RfDataManager.getMasterPwd  ->  '"+this.m_sMasterPwd+"'",p,c.FUNC_INOUT),this.m_sMasterPwd},at.prototype.setBrowserParam=function(e){St("[ID:"+this.m_nId+"]. RfDataManager.setBrowserParam  ->  '"+e+"'",p,c.FUNC_INOUT),this.m_sBrowserParam=e},at.prototype.getBrowserParam=function(){return this.m_sBrowserParam},at.prototype.setExtensionParams=function(e){St("[ID:"+this.m_nId+"]. RfDataManager.setExtensionParams  ->  '"+JSON.stringify(e)+"'",p,c.FUNC_INOUT),this.m_sExtensionParams=e},at.prototype.getExtensionParams=function(){return this.m_sExtensionParams?this.m_sExtensionParams:{}},at.prototype.ResetOFSCache=function(e,t){var r=this;r.Clear(),r[W](r.m_sUserId,function(a){r[$](function(t){typeof e!=_&&e(t)},t)},t)},at.prototype.Clear=function(){I&&I.Reset(),this.m_OFSMgr=new RfapiJS.CRfOneFileSys,this.m_eTag_RecievedList="",this.m_eTags={}},at.prototype.GetLastError=function(){return this.m_LastError},at.prototype.internal_setLastError=function(e){this.m_LastError=e},at.prototype.misc_checkJSONResponse=function(e,t,r,a){if(this.misc_checkHttpResponse(e,t,a))if(e.status!=Te){var n=JSON.parse(e.responseText);if(n&&typeof n[je]!=_){if("error"!=(n=n[je])[We])return n;typeof a!=_&&(typeof n.code!=_?a(new tt(n.code,n.description)):typeof n.sibError!=_?a(new tt(void 0,n.description,void 0,void 0,n.sibError)):a(new tt(O.SibTErr_ServerErr,JSON.stringify(n),void 0,n,void 0)))}else typeof a!=_&&a(new tt(void 0,"Error while parsing JSON.",void 0,void 0,"LocalErr"))}else typeof a!=_&&a(new tt(Te,e.responseText));else St("RfDataManager."+r+" (MULTI) checkHttpResponse failed. Return false.",p,c.SPECIAL_CASE)},at.prototype.misc_checkHttpResponse=function(e,t,r,a){if(!e)return St("RfDataManager.misc_checkHttpResponse. Connection error or RoboForm server is offline. Return false.",p,c.SPECIAL_CASE),typeof r!=_&&r(new tt(void 0,"Connection error or RoboForm server is offline",void 0,void 0,"Connectivity")),!1;if(0==e.readyState)return St("RfDataManager.misc_checkHttpResponse. Return false. readyState is 0. statusCode is 0. Status Text: '"+e.statusText+"'",p,c.SPECIAL_CASE),typeof r!=_&&r(t),!1;if(0==e.status)return St("RfDataManager.misc_checkHttpResponse. Connection error or RoboForm server is offline. Return false.",p,c.SPECIAL_CASE),typeof r!=_&&(a||setTimeout(function(){r(new tt(503,"Connection error or RoboForm server is offline",void 0,e,"Connectivity"))},3e3)),!1;if(503==e.status)return St("RfDataManager.misc_checkHttpResponse. Return false. StatusCode is NOT ok! (HTTP_Status_Service_Unavailable=503). statusText: '"+e.statusText+"'",p,c.INFO),typeof r!=_&&r(new tt(503,"Service Unavailable",void 0,e,void 0)),!1;if(403==e.status){St("RfDataManager.misc_checkHttpResponse. Return false. StatusCode is NOT ok! (HTTP_Status_Code_Forbidden =403). statusText: '"+e.statusText+"'",p,c.INFO);var n=typeof e.getResponseHeader("reason")!=_?e.getResponseHeader("reason"):"Forbidden";return typeof r!=_&&r(new tt(403,n,void 0,e,void 0)),!1}if(400==e.status){if(St("RfDataManager.misc_checkHttpResponse. Return false. StatusCode is NOT ok! (HTTP_Status_Code_BadRequest = 400). statusText: '"+e.statusText+"'",p,c.INFO),typeof r!=_){var s="arraybuffer"==e.responseType?e.statusText:e.responseText;r(new tt(400,s,void 0,e,void 0))}return!1}if(e.status==Ne){St("RfDataManager.misc_checkHttpResponse. Return false. StatusCode is NOT ok! (HTTP_Status_Code_Unauthorized =401). statusText: '"+e.statusText+"'",p,c.INFO);var o=e.getResponseHeader("x-sib-auth-alt-otp");if(o&&("email"==o||"phone"==o||"sms"==o||"totp"==o))return typeof r!=_&&r(new tt(410,"Otp is required. otp="+o,void 0,e)),!1;var i=e.getResponseHeader("x-sib-auth-alt-channel");return i?(typeof r!=_&&r(new tt(411,"Otp channels="+i,void 0,e)),!1):(St("RfDataManager.misc_checkHttpResponse. Return false. headers: '"+e.getAllResponseHeaders()+"'",p,c.INFO),typeof r!=_&&r(new tt(Ne,"Enter Correct UserID and Password for Realm RoboForm Online Server",void 0,e,void 0)),this.Clear(),!1)}return!0},at.prototype.internal_catchedException=function(e,t,r){Rt("EXCEPTION in "+e+": "+(typeof t.stack!=_?t.stack:t.toString()),p),r(new tt(void 0,t.toString(),t,void 0,"CatchedException"))},at.prototype.internal_AddClientTypeHeader=function(e){var t=this.getBrowserParam();t&&(e["x-sib-client-type"]=t);var r=this.getExtensionParams();r&&r.id&&(e["x-sib-ext-id"]=r.id),r&&r.version&&(e["x-sib-ext-ver"]=r.version)},at.prototype.internal_CreateHeaders=function(e){var t=e?"application/octet-stream":"application/json",r={};return r["Content-type"]=t,this.internal_AddClientTypeHeader(r),r},at.prototype.internal_PutFileTag=function(e,t,r){this.m_eTags[t]||(this.m_eTags[t]={}),this.m_eTags[t][r]=e},at.prototype.internal_GetFileTag=function(e,t){return this.m_eTags[e]?this.m_eTags[e][t]:""},at.prototype.decodeAccountPwd=function(e){var r=I.getSharedAccountById(e,!0),n=I.getPrivateKey(),s=r[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP].mp;if(!s)return"";var o=t.base64ToBytes(s),i=t.bytesToHex(o),c=new RSAKey,f=a.GetHexFromPEM(n,!1);return c.setPrivateEx(f.modulus,f.exponent,f.privateexp,f.P,f.Q,f.DP,f.DQ,f.InverseQ),c.decrypt(i)},at.prototype.internal_CreateRequestUrl=function(e){var t=this.m_sServerUrl+"/rf-api/"+encodeURI(this.m_sUserId);return typeof e!=_&&(t+=e),t},at.prototype.getAccountsFromParams=function(e,t,r,a,n,s){var o=[],i=!1;if(s)return o.push(this.m_sUserId),void a({list:o,bAll:i});if(e){if(!I.checkValidPath(e,!1))return void(typeof n!=_&&n(new tt(N.RfErr_InvalidPath,"Invalid path = '"+e+"'")));var c=I.getAccountIdNameFromPath(e,r);o.push(c.id)}else t?i=!0:o.push(this.m_sUserId);a({list:o,bAll:i})},at.prototype.internal_updateAppData=function(e,t,r,a){var n=this,s="internal_updateAppData",o=rt.APP_DATA;St(Fe+s+" action='"+t+"'",p,c.FUNC_INOUT);var i=e[Be].used,f=e[Be].favorite;if(f||i||t!=Re&&t!=ye){var u=t==Ie?e[Be].from[xe]:e[Be][xe],l=t==Ie?e[Be].from.type:e[Be].type,d=t==Ie?e[Be].to[xe]:void 0,S=t==he?2:t==Ie?3:t==re?4:1,y=i||f||e[Be].list!=T.identitiesGroupInstances?T.usiRecentlyUsedList:T.identitiesGroupInstances;I.getDataByAccountId(o,n.m_sUserId)?R():n[se](function(e){if(St("RfDataManager."+s+"."+t+".  STEP 1. GET from server OFS='"+o+"'  Account='"+n.m_sUserId+"'  Status='"+e+"' ->",p,c.FUNC_INOUT),404==e){var r=Math.round(new Date/1e3),a={recentlyUsed:{list:[]},favorites5:{},recentlyViewed:{list:[]},usageCounters:{list:[]}},i={i:{F:!0},c:[{i:{c:r,m:r,f:!0,s:0,n:"mru.rfo"},b:a=JSON.stringify(a)}]};return I.setData(i,o,n.m_sUserId),void R()}e!=Ee||R()},function(e){},o,n.m_sUserId),St(Pe+s+" action='"+t+"'",p,c.FUNC_INOUT)}function R(){St(Fe+s+" .updateRepositoryMru action='"+t+"'",p,c.FUNC_INOUT);var i={};i.list=y,i.item={},y==T.identitiesGroupInstances?(i.action=e[Be].action,i.item.path=e[Be].item.path,i.item.type=e[Be].item.type,i.item.groups=e[Be].item.groups):(i.action=S,i.item.path=u,i.item.type=l,i.item.newPath=d),I.UpdateMRU(i,function(e){e&&n[ie](o,n.m_sUserId,function(e){return St("RfDataManager."+s+"."+t+". save_OK ->",p,c.FUNC_INOUT),typeof r!=_&&r(200),!0},function(e){return St("RfDataManager."+s+"."+t+". save_Error ->",p,c.FUNC_INOUT),typeof a!=_&&a(e),!1},!0)},function(e){}),St(Pe+s+" .updateRepositoryMru action='"+t+"'",p,c.FUNC_INOUT)}},at.prototype.internal_RepositoryAction=function(e,r,a,n,s,o,i){var f="RfDataManager.internal_RepositoryAction";try{var u,l=!1,d=[],S=this,y=typeof s!=_?s:rt.USER_DATA,R=[];function U(){St(f+"."+r+".  STEP 2. Call repo function ->",p,c.FUNC_INOUT),I[r](e,function(t,i,u,y){try{if(l&&S.FireEvent("OnAccountChanged",{accounts:d}),!t)return St(f+"."+r+". RepoAnswerCallBack. Repository returned NULL. Return",p,c.FUNC_INOUT),void(typeof n!=_&&n(new tt(void 0,ve,void 0,void 0,"NotFound")));if(St(f+"."+r+". RepoAnswerCallBack. Repository returned result="+t+" NeedToSave="+i+" savedAccounts='"+u.join()+"'",p,c.FUNC_INOUT),i)for(var R=u.length,U=0,h=0;h<u.length;h++)S[ne](function(t,n){if(St(f+"."+r+". putOFS_AnswerCallback -> counter="+ ++U+" all="+R,p,c.FUNC_INOUT),U==R&&(typeof a!=_&&(St(f+"."+r+". ***putOFS_AnswerCallback*** ->",p,c.FUNC_INOUT),a(t.status,y)),r!=Re&&r!=he&&r!=Ie||S.internal_updateAppData(e,r),r==Re||r==Ue||r==he||r==Ie)){var s=I.getSharedAccountById(n);if(s&&s.i&&s.i.Shared&&s.i.Shared.company){var o="",i="",u="";switch(r){case Ie:o="Move",i=e.request.from.path,u=e.request.to.path;break;case he:o="Delete",i=e.request.path;break;case Re:o=e.request.newItem?"Create":"Edit",i=e.request.path;break;case Ue:o="CreateFolder",i=e.request.folder}S[_t]({accountId:n,operation:o,path:i,pathTo:u,operation_type:"Access"})}}},function(e){U++,St(f+"."+r+". ***putOFS_ErrorCallback*** ->",p,c.FUNC_INOUT),typeof n!=_&&n(e)},s,u[h],o);else if(r==fe||r==ue||r==pe||r==le)typeof a!=_&&(St(f+"."+r+". RepoAnswerCallBack. ***AnswerCallBack*** ->",p,c.FUNC_INOUT),a(t));else if(r==ye){typeof a!=_&&a(t,Ee),S.internal_updateAppData(e,r);var O=I.getAccountIdNameFromPath(e.request.path,e.request.type);O&&O.isShared&&O.company&&S[_t]({accountId:O.id,operation:"Access",path:e.request.path,operation_type:"Access"})}else r==_e?(typeof a!=_&&a(t,Ee),S.internal_updateAppData(e,r)):r==ae||r==de||r==Se||r==re?typeof a!=_&&a(t,Ee):r==it?typeof a!=_&&a(Ee,y):typeof a!=_&&a(Ee);return}catch(e){S.internal_catchedException(f+":RepoAnswerCallBack. Action='"+r+"'",e,n)}},function(e){l&&S.FireEvent("OnAccountChanged",{accounts:d}),typeof n!=_&&n(e)},o,i)}function h(){try{St(f+"."+r+".  #STEP 1.1# GET shared accounts from server(if needed)  ->",p,c.FUNC_INOUT);var e=I.getAcceptedAccounts();if(!e.length)return void U();for(var t=e.length,a=0,s=0;s<e.length;s++){var i=e[s];if(I.getDataByAccountId(y,i[RfapiJS.ACCOUNT_ID_PROP]))St(f+"."+r+".  #STEP 1.1#. IN MEMORY: sharedAccount='"+i[RfapiJS.ACCOUNT_ID_PROP]+"' n_counter="+a+" all="+t+"->",p,c.FUNC_INOUT),S[ce](function(e,r,n){St(f+".getSharedWithCheck_OkCallBack. n_counter="+ ++a+" all="+t+" changed="+n+" acct_Inner="+r,p,c.INFO),n&&(l=!0,d.push(r),St(f+".getSharedWithCheck_OkCallBack. CHANGED_OUTSIDE='"+r+"'",p,c.INFO)),a==t&&U()},function(e){a++,Rt("ERROR in "+f+".getSharedWithCheck_ErrorCallBack  "+e.Description,p),a==t&&U()},y,i[RfapiJS.ACCOUNT_ID_PROP]);else{if(St(f+"."+r+".  #STEP 1.1#. Need to get FROM SERVER: sharedAccount='"+i[RfapiJS.ACCOUNT_ID_PROP]+"' ->",p,c.FUNC_INFO),i.licenseExpired){St(f+"."+r+".  #STEP 1.1#. LICENCE IS EXPIRED!!! sharedAccount='"+i[RfapiJS.ACCOUNT_ID_PROP]+"' ->",p,c.FUNC_INFO),++a==t&&U();continue}if(typeof i.accountInfo.isAllowedIP==_||0==i.accountInfo.isAllowedIP){St(f+"."+r+".  #STEP 1.1#. IP IS NOT ALLOWED!!! sharedAccount='"+i[RfapiJS.ACCOUNT_ID_PROP]+"' ->",p,c.FUNC_INFO),++a==t&&U();continue}S[se](function(e,n){if(St(f+"."+r+".getShared_OkCallBack.  STEP 1. GET from server OFS='"+y+"'  status='"+e+"' ->",p,c.FUNC_INOUT),e!=Ee)return a++,St(f+"."+r+".getShared_OkCallBack. HttpStatus for account("+n+") is="+e,p,c.INFO),void(a==t&&U());St(f+"."+r+". getShared_OkCallBack. n_counter="+ ++a+" all="+t,p,c.INFO),a==t&&U()},function(e){St(f+"."+r+".getShared_ErrorCallBack.  STEP 1. OFS='"+y+"'  Account='"+i[RfapiJS.ACCOUNT_ID_PROP]+" ->",p,c.FUNC_INOUT),a++,Rt("ERROR in "+f+".getShared_ErrorCallBack1.  "+e.Description,p),a==t&&U()},y,i[RfapiJS.ACCOUNT_ID_PROP],o)}}return void St(" <- "+f+"."+r+".  #STEP 1.1# GET shared accounts from server(if needed)",p,c.FUNC_INOUT)}catch(e){S.internal_catchedException(f+":getSharedAccounts. Action='"+r+"'",e,n)}}function O(){function e(){St(f+".getAccounts.funcStep2  ->",p,c.FUNC_INOUT);for(var e=R.length,t=0,s=0;s<R.length;s++){var i=R[s];I.getDataByAccountId(y,i)?(St(f+".getAccounts.funcStep2. Check eTag...",p,c.FUNC_INOUT),S[oe](function(r,a,n){return St(f+".get_eTag  get_eTag_AnswerCallback. funcStep2. #STEP 1(b)#.  serverTag='"+r+"' acct_Inner="+n,p,c.FUNC_INOUT),r?S.internal_GetFileTag(n,y)==r?(St(f+".get_eTag  get_eTag_AnswerCallback. funcStep2.  #STEP 1(b)#. eTags are equal. Call Repository function(if last)",p,c.FUNC_INFO),void(++t==e&&U())):(St(f+".get_eTag  get_eTag_AnswerCallback. funcStep2. #STEP 1(b)#. eTags are NOT equal. GET NEW VERSION FROM SERVER",p,c.FUNC_INFO),I.resetAccountData(n,y),l=!0,d.push(n),void O()):(St(f+".get_eTag  get_eTag_AnswerCallback. funcStep2. #STEP 1(b)#. There is no file on server. Call Repository function(if last)",p,c.FUNC_INFO),void(++t==e&&U()))},function(e){return St(f+".get_eTag  get_eTag_ErrorCallback. funcStep2.",p,c.FUNC_INOUT),t++,typeof n!=_&&n(e),!1},y,i)):S[se](function(s,o){if(St(f+"."+r+" getAccount_OkCallBack. funcStep2. GET from server OFS='"+y+"'  status='"+s+"' ->",p,c.FUNC_INOUT),s!=Ee)return t++,St(f+"."+r+". getAccount_OkCallBack. funcStep2. HttpStatus for account("+o+") is="+s,p,c.INFO),void(t==e&&(r==ae&&s!=Ee?typeof a!=_&&a([],s):1==e?s==Te?typeof n!=_&&n({Code:s,Description:y+" not found."}):typeof n!=_&&n({Code:s,Description:"Server error"}):U()));St(f+"."+r+". getAccount_OkCallBack. funcStep2. n_counter="+ ++t+" all="+e,p,c.INFO),t==e&&(r==ae&&s!=Ee?typeof a!=_&&a([],s):U())},function(e){St(f+"."+r+". getAccount_ErrorCallBack. funcStep2. STEP 1. OFS='"+y+"' ->",p,c.FUNC_INOUT),t++,typeof n!=_&&n(e)},y,i,o)}St(f+".getAccounts.funcStep2 <-",p,c.FUNC_INOUT)}St(f+".getAccounts. #STEP 1(b)#  ->",p,c.FUNC_INOUT),St(f+".getAccounts. funcStep1  ->",p,c.FUNC_INOUT),1==R.length&&y==rt.USER_DATA?I.getDataByAccountId(rt.USER_DATA,S.m_sUserId)?e():S[se](function(t,a){St(f+"."+r+" getAccount_OkCallBack. funcStep1. GET from server OFS='"+rt.USER_DATA+"'  status='"+t+"' ->",p,c.FUNC_INOUT),t!=Ee?t==Te?typeof n!=_&&n({Code:t,Description:rt.USER_DATA+" not found."}):typeof n!=_&&n({Code:t,Description:"Server error"}):e()},function(e){St(f+"."+r+". getAccount_ErrorCallBack. funcStep1. STEP 1. OFS='"+rt.USER_DATA+"' for auth user. ->",p,c.FUNC_INOUT),typeof n!=_&&n(e)},rt.USER_DATA,S.m_sUserId,o):e(),St(" <- "+f+".getAccounts. #STEP 1(b)#",p,c.FUNC_INOUT)}St("-> "+f+" ACTION="+r,p,c.FUNC_INOUT);var m="",C=!1,E=!1;if(r==Se)m=e[Be][xe],C=e[Be][He],u=v.RfItemType_Folder,E=typeof e[Be].bExcludeShared!=_&&e[Be].bExcludeShared;else{if(r==Ie){m=e[Be][Ve][xe],u=e[Be][Ve][Le];var N=I.getAccountIdNameFromPath(m,u);R.push(N.id);var T=e[Be][Ke][xe],A=I.getAccountIdNameFromPath(T,u);return N.id!=A.id&&R.push(A.id),void O()}if("CopyObject"==r)m=e[Be][Ve][xe],u=e[Be][Ve][Le];else if(r==he)m=e[Be][xe],u=e[Be][Le];else if(r==Re||r==ye)m=e[Be][xe],u=e[Be][Le];else if(r==_e){var g=(m=e[Be][xe]).substr(m.lastIndexOf("."));u=t.FileExtToType(g)}else if(r==le){g=(m=e[Be][xe]).substr(m.lastIndexOf("."));u=t.FileExtToType(g)}else if(r==pe){if(m=e[Be][xe],C=e[Be][He],E=e[Be].bExcludeShared,u=v.RfItemType_Folder,E)return R.push(S.m_sUserId),void O()}else if(r==ue||r==fe)C=!0,u=v.RfItemType_Folder,E=typeof e[Be].bExcludeShared!=_&&e[Be].bExcludeShared;else if(r==de)C=e[Be][He],u=v.RfItemType_Folder;else{if(r!=Ue)return r==it?(R.push(S.m_sUserId),void O()):r==re?void S.internal_updateAppData(e,r,a,n):"DeleteAllObjects"==r||r==ae?(R.push(S.m_sUserId),void O()):void 0;m=e[Be].folder,u=v.RfItemType_Folder;var F=m;if(F.startsWith("/")&&(F=F.substr(1)),-1==F.indexOf("/"))return R.push(S.m_sUserId),void O()}}return St(f+" ACTION="+r+" STEP 1. Get needed accounts names...",p,c.FUNC_INOUT),S.getAccountsFromParams(m,C,u,function(e){R=e.list,1==e.bAll?(St(f+".getAllAccounts. #STEP 1(a)#  ->",p,c.FUNC_INOUT),I.getDataByAccountId(y,S.m_sUserId)?S[ce](function(e,t,r){St(f+".getUserData_OkCallBack.  changed="+r+" -> ",p,c.INFO),r&&(l=!0,d.push(t),St(f+".getUserData_OkCallBack. CHANGED_OUTSIDE='"+t+"'",p,c.INFO)),h()},n,y,S.m_sUserId):S[se](function(e){St(f+"."+r+".  STEP 1(a). GET from server OFS='"+y+"'  Account='"+S.m_sUserId+"'  Status='"+e+"' ->",p,c.FUNC_INOUT),r==ae&&e!=Ee?typeof a!=_&&a([],e):h()},n,y,S.m_sUserId,o),St(" <- "+f+".getAllAccounts. #STEP 1(a)#",p,c.FUNC_INOUT)):O()},function(e){typeof n!=_&&n(e)},E),void St("<- "+f+" ACTION="+r,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(f+"-"+r,e,n)}},at.prototype.internal_RequestAsync=function(e,r,a,n,s,o,i,f,u,l,d,S){var y=this;St("-> RfDataManager.internal_RequestAsync. Command='"+e+"'. Make ASYNC "+s+" request to "+r,p,c.INFO),y.makeRequestAsync(r,a,n,s,o,i,function(a,n){try{if(St("-> RfDataManager.makeRequestAsync.callback Command='"+e+"'",p,c.FUNC_INOUT),!y.misc_checkHttpResponse(a,n,d,S))return St("RfDataManager Command='"+e+"' checkHttpResponse failed. Return false.",p,c.SPECIAL_CASE),!1;if(f){var s=y.misc_checkJSONResponse(a,n,e,d);if(!s)return St("RfDataManager Command='"+e+"' checkHttpResponse failed. Return false.",p,c.SPECIAL_CASE),!1}if(a.status==Ee){if(St("RfDataManager.makeRequestAsync.callback Command='"+e+"'. HttpResponse=OK.",p,c.INFO),"GetCompanies"==e||e==Z||e==le||e==H||"GetCompanyGroups"==e||e==ee||"GetCompanyInfo"==e||"GetAllCompanies"==e){if(typeof l!=_){var o=JSON.parse(a.responseText);l(o,Ee)}return}if(e==w){var i=(N=r).substr(N.lastIndexOf("/")+1);if(i.lastIndexOf("?")>0&&(i=i.substr(0,i.lastIndexOf("?"))),typeof l!=_){o=JSON.parse(a.responseText);l(o,Ee,i)}return}if("GenerateTOTPKey"==e){if(typeof l!=_){o=JSON.parse(a.responseText);l(o)}return}if("GetLicensingUrlFromServer"==e){if(typeof l!=_){o=JSON.parse(a.responseText);l(o)}return}if("InviteEmergencyContact"==e||"UpdateEmergencyContactInfo"==e||"RevokeEmergencyContact"==e)return void(typeof l!=_&&l(Ee,a));if("DoGetServers"==e){if(typeof l!=_){o=JSON.parse(a.responseText);l(o)}return}if("GetEmergencyContacts"==e||"GetTestators"==e||"GetAccountDataBackups"==e){if(typeof l!=_){o=JSON.parse(a.responseText);l(o)}return}if("ConvertCompanyMemberToPersonal"==e)return void(typeof l!=_&&l(Ee));if(e==Ue||e==he||"UpdateCompanyMemberInfo"==e||"CopyObject"==e||e==Ie||e==Re||"UpdateCompanyProperties"==e||"UpdateStatus"==e||"CacheMasterPassword"==e||"ChangePassword"==e||"DeleteAllDevices"==e||"RejectEmergencyContactInvitation"==e||"AcceptEmergencyContactInvitation"==e||"RequestEmergencyAccess"==e||"RejectEmergencyAccess"==e||"SendVerificationCode"==e||"RevokeEmergencyAccess"==e||"GrantEmergencyAccess"==e||e==D||"DeleteAccountDataBackup"==e)return void(typeof l!=_&&l(Ee));if(e==pe){if(typeof l!=_){o=JSON.parse(a.responseText);l(o.response)}return}if(e==b){if(typeof l!=_){o=JSON.parse(a.responseText);l(o)}return}if(e==Se){var R=s.items;return void(typeof l!=_&&l(R,Ee))}if(e==g)return y.Clear(),void(typeof l!=_&&l(Ee));if("GetOptions"==e){if(typeof l!=_){var U=s.options;l(U,Ee)}return}if(e==_e)return void(typeof l!=_&&l(window.atob(s.content),Ee));if(e==ae)return void(typeof l!=_&&l(s.items,Ee));if(e==fe||e==ue)return void(typeof l!=_&&l(s,Ee));if(e==L){var h=a.getResponseHeader("eTag");St("RfDataManager.makeRequestAsync.callback Command='"+e+"'. headerAccountListTag="+h,p,c.INFO),y.m_eTag_RecievedList=h;o=JSON.parse(a.responseText);return void(typeof l!=_&&(St("RfDataManager.makeRequestAsync.callback Command='"+e+"'.  Try to parse responseText...",p,c.INFO),St("RfDataManager.makeRequestAsync.callback Command='"+e+"'. Call answerCallback with JSONResp='"+o+"'",p,c.INFO),l(o,Ee)))}if("CreateDataItem"==e||e==ye){var m=s.data;return void(typeof l!=_&&l(m,Ee))}if(e==J)return void(typeof l!=_&&l(Ee));if(e==_t)return void(typeof l!=_&&l(Ee));if(e==P)return void(typeof l!=_&&l(Ee));if(e==x){if(typeof l!=_){o=JSON.parse(a.responseText);l(o,Ee)}return}if("GetUserKnownRecipients"==e){if(typeof l!=_){o=JSON.parse(a.responseText);l(o)}return}if("CreateCompany"==e){if(a.status==Ee){if(a.responseText)try{var C=JSON.parse(a.responseText),E=C[je][We];if("error"==E)return St("RfDataManager Command='"+e+". Server returns status=error.",p,c.SPECIAL_CASE),void(typeof d!=_&&d(new tt(O.SibTErr_ServerErr,"Server returns status=error."+a.responseText,C[je])));if("ok"==E)return void(typeof l!=_&&l(a.responseText,Ee))}catch(t){return St("RfDataManager Command='"+e+". Error while parsing JSON response",p,c.SPECIAL_CASE),void(typeof d!=_&&d(new tt(O.SibTErr_ServerErr,"Error Parsing JSON response")))}}else typeof d!=_&&d(new tt(a.status,a.statusText,void 0,a,void 0));return}if(e==B||"LeaveCompany"==e||"CheckPwd"==e||e==X||"AcceptSharedAccount"==e||e==V||e==j||e==K||e==q||"DeleteCompany"==e||"JoinCompany"==e||"CompanyAddUser"==e||"CreateCompanyMember"==e||"CompanyRemoveUser"==e)return void(typeof l!=_&&l(a.responseText,Ee));if(e==G){var N,T=(N=r).substr(N.lastIndexOf("/")+1);return T=T.substr(0,T.lastIndexOf("?")),void(typeof l!=_&&l(a.responseText,Ee,T))}if(e==Q||e==Y||"AcceptSharedFile"==e)return void(typeof l!=_&&l(Ee));if(e==z){if(typeof l!=_){o=JSON.parse(a.responseText);l(o)}return}if(e==F){o=JSON.parse(a.responseText);if(u.getUserInfo)return void(typeof l!=_&&l(o));var A=o.oneFile;if(A=typeof A!=_&&A,y.setAccountMode(A?1:2),y.SetUserID(u.userId),A){function M(t){o.updateTrustedUsers&&y[k](function(t){St("RfDataManager Command='"+e+"._Ok : Trusted user's password were updated...",p,c.SPECIAL_CASE)},function(t){St("RfDataManager Command='"+e+"._Error: while updating trusted user's passwords.",p,c.SPECIAL_CASE)}),typeof l!=_&&(o.receivedData=t,l(o))}y[L](function(t,r){St("-> RfDataManager. "+e+".GetAccounts_AnswerCallBack. shared.length="+t.accounts.length,p,c.FUNC_INOUT),function(e,t){var r=0;for(var a in e)r++;if(r)for(var a in e){var n=a,s=e[a];y[J](n,function(){--r||M(t)},function(){--r||M(t)},s,void 0,void 0,void 0,y.m_sUserId,void 0)}else M(t)}(I.setSharedAccounts({accounts:t.accounts,showAllGroups:y.m_show_all_groups}),t),y[$](function(e){},function(e){return typeof d!=_&&d(e),!1})},function(e){return typeof d!=_&&d(e),!1})}else y[L](function(t,r){St("-> RfDataManager. "+e+".GetReceivedDataMulti_AnswerCallBack",p,c.FUNC_INOUT),o.receivedData=t,typeof l!=_&&l(o)},function(e){return typeof d!=_&&d(e),!1}),St("RfDataManager Command='"+e+"' <-",p,c.FUNC_INOUT);return}if("GetDataStatus"==e){if("ok"==s[We]){St("RfDataManager Command='"+e+"'. JSONResponse=OK",p,c.INFO);var W=parseInt(s.dataStatus);if(y.setAccountMode(W),y.SetUserID(u.userId),0==W)typeof l!=_&&l(W);else if(1==W){y[L](function(t,r){St("-> RfDataManager. "+e+".GetAccounts_AnswerCallBack. shared.length="+t.accounts.length,p,c.FUNC_INOUT),function(e,t){var r=0;for(var a in e)r++;if(r)for(var a in e){var n=a,s=e[a];y[J](n,function(){--r||typeof l!=_&&l(t)},function(){--r||typeof l!=_&&l(t)},s,void 0,void 0,void 0,y.m_sUserId,void 0)}else typeof l!=_&&l(t)}(I.setSharedAccounts({accounts:t.accounts,showAllGroups:y.m_show_all_groups}),W)},function(e){return typeof d!=_&&d(e),!1})}else typeof l!=_&&l(W)}return}if(e==de){for(var te=u.filter,re=(R=s.items,[]),ne=0;ne<R.length;ne++){var se=R[ne],oe=se[xe],ie=(oe=oe.toLowerCase()).substr(oe.lastIndexOf("/")+1);if(se[Le]!=v.RfItemType_Folder&&(ie=ie.substr(0,ie.lastIndexOf("."))),!(te.length>2&&-1==ie.lastIndexOf(te))){if(te.length<=2){if(-1==ie.lastIndexOf(te))continue;if(0!=ie.indexOf(te)&&0==t.filterPartOfStr(ie,te," ")&&0==t.filterPartOfStr(ie,te,".")&&0==t.filterPartOfStr(ie,te,"-")&&0==t.filterPartOfStr(ie,te,"_"))continue}re.push(se)}}return void(typeof l!=_&&l(re,Ee))}}if(typeof d!=_){var ce=a.responseText?a.responseText:a.statusText;return d(new tt(a.status,ce,void 0,a,void 0)),!1}return St("RfDataManager Command='"+e+"' <-",p,c.FUNC_INOUT),!0}catch(e){y.internal_catchedException("RfDataManager.makeRequestAsync.callback",e,d)}})},at.prototype.misc_checkParameters=function(e,t){for(var r in e)if("ACCOUNT_MODE"==r){if(-1==e[r])return St("RfDataManager.misc_checkParameters. '"+r+"' is undefined. Return false.",p,c.SPECIAL_CASE),typeof t!=_&&t(new tt(void 0,r+" is empty or undefined.",void 0,void 0,"LocalErr")),!1}else if(!e[r])return St("RfDataManager.misc_checkParameters. '"+r+"' is undefined. Return false.",p,c.SPECIAL_CASE),typeof t!=_&&t(new tt(void 0,r+" is empty or undefined.",void 0,void 0,"LocalErr")),!1;return!0},at.prototype.makeSyncRequest=function(e,t,r,a,n){try{var s=!1;for(var o in window.XMLHttpRequest?s=new XMLHttpRequest:window.ActiveXObject&&(s=new ActiveXObject("Microsoft.XMLHTTP")),s.open(a,e,!1),n&&s.overrideMimeType("text/plain; charset=x-user-defined"),r)s.setRequestHeader(o,r[o]);return s.send(t),s.status==Ee?s:null}catch(e){return St("ERROR in RfDataManager.makeSyncRequest: "+e.toString(),p,c.EXCEPTION),null}},at.prototype.makeRequestAsync=function(e,t,r,a,n,s,o,i){try{var f=null;for(var u in typeof i==_?window.XMLHttpRequest?f=new XMLHttpRequest:window.ActiveXObject&&(f=new ActiveXObject("Microsoft.XMLHTTP")):f=i,f.open(a,e,!0),s&&(f.responseType="arraybuffer"),f.onreadystatechange=function(){4===f.readyState&&(St("RfDataManager.makeRequestAsync. Changes to readyState="+f.readyState+"  Status="+f.status,p,c.INFO),o(f,null))},n&&f.overrideMimeType&&f.overrideMimeType("text/plain; charset=x-user-defined"),r)f.setRequestHeader(u,r[u]);S&&s&&t&&t.buffer?f.send(t.buffer):f.send(t)}catch(e){St("ERROR in RfDataManager.makeRequestAsync: "+e.toString(),p,c.EXCEPTION),o(f,new tt(void 0,e.toString(),e,f,"CatchedException"))}},at.prototype.convertFromArrayBuffer=function(e){var t=new Uint8Array(e);if(h){for(var r=[],a=0;a<t.length;a++)r.push(t[a]);return r}return t},at.prototype.convertUTF8Strings=function(e,t){!function e(r){if(r[RfapiJS.ITEM_INFO_PROP]&&r[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]){var a=r[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP];try{var n=t?decodeURIComponent(escape(a)):unescape(encodeURIComponent(a));r[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]=n}catch(e){Rt("EXCEPTION in convertUTF8Strings while decode filename='"+a+"'.  ERROR='"+e.toString(),p)}}var s=r[RfapiJS.ITEM_BODY_PROP],o=typeof r[RfapiJS.ITEM_ENCODED_PROP]!=_&&1==r[RfapiJS.ITEM_ENCODED_PROP];if(typeof s!=_&&!o)try{var i=t?decodeURIComponent(escape(s)):unescape(encodeURIComponent(s));r[RfapiJS.ITEM_INFO_PROP]&&r[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP],r[RfapiJS.ITEM_BODY_PROP]=i}catch(e){Rt("EXCEPTION in convertUTF8Strings while decode BODY for filename='"+r[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]+"'.  ERROR='"+e.toString(),p)}var c=r.c;if(c)for(var f=0;f<c.length;f++)e(c[f])}(e)},at.prototype.ObjectOFSToBytes=function(e,t,a){St("RfDataManager.ObjectOFSToBytes  ->",p,c.FUNC_INOUT);var n=JSON.stringify(e);if(FileReader.prototype.readAsArrayBuffer)o.StringToBytes(n,function(e){St("ObjectOFSToBytes StringConverter - FINISH! length="+e.byteLength,p,c.FUNC_INOUT),t(e)},function(e){St("ObjectOFSToBytes <- onFail error="+e,p,c.FUNC_INOUT),a(e)});else{var s=r.stringToBytes(n);St("RfDataManager.ObjectOFSToBytes stringToBytes - FINISH. length="+s.length,p,c.FUNC_INOUT),t(s)}},at.prototype.ParseOneFileDataString=function(e,t,r){St("ParseOneFileDataString -> fileName='"+t+"' accountId='"+r+"'",p,c.INFO);var a=this;St("ParseOneFileDataString Json.parse - START",p,c.INFO);var n=JSON.parse(e);St("ParseOneFileDataString Json.parse - FINISH",p,c.INFO),FileReader.prototype.readAsText||(a.convertUTF8Strings(n,!0),St("ParseOneFileDataString convertUTF8Strings - FINISH",p,c.INFO));var s=I.setData(n,t,r);St("ParseOneFileDataString -> changedNames='"+s+"'",p,c.INFO),r==a.m_sUserId&&t==rt.USER_DATA&&(!function(e){var t=0;for(var r in e)t++;if(t)for(var r in e){var n=r,s=e[r];a[J](n,function(){t--},function(){t--},s,void 0,void 0,void 0,a.m_sUserId,void 0)}}(s),a[$](),a[W](void 0,void 0,void 0,!0))},at.prototype.DecodeOFSFile=function(e,t,r,a,n,s,o){var i=this,f=typeof e.byteLength!=_?i.convertFromArrayBuffer(e):e;St("RfDataManager. DecodeOFSFile  File='"+t+"' for account='"+n+"' current='"+i.m_sUserId+"' (convert to Uint8Array) Length="+f.length,p,c.INFO);var u=null!=i.m_OFSMgr?i.m_OFSMgr:new RfapiJS.CRfOneFileSys,l=typeof n==_?i.m_sUserId:n,d=l==i.m_sUserId?i[Oe]():s;u.DecodeUnZipOFSBytes(f,t,l,d,!0,function(e,n){St("RfDataManager.DecodeOFSFile. Ok_CallBack. Fill Repository with items!",p,c.INFO);try{i.ParseOneFileDataString(n,t,l)}catch(e){return typeof a!=_&&a({Code:O.SibTErr_LocalErr,Description:"[DECODE_OFSFILE_FUNC] Exception while ParseOneFileDataString: "+e.toString()+".  End of data:  ..."+n.substring(n.length-20)}),!1}typeof r!=_&&r(e,l)},function(e){if(St("RfDataManager.DecodeOFSFile. Error_CallBack.",p,c.INFO),e.Code==N.RfErr_AuthRejected){if(typeof a!=_)return a(new tt(N.RfErr_AuthRejected,"Wrong Master Password.")),!1}else if(typeof a!=_)return a(new tt(e.Code,e.Description)),!1;return!1},o)},at.prototype[ie]=function(e,t,r,a,n){var s="RfDataManager."+ie;try{var o=this;function i(){St(s+".put_OFS ->  ##STEP 4##  file='"+e+"'  accountId='"+t+"'",p,c.FUNC_INOUT),o[ne](function(e){return St(s+".put_OFS  put_OFS_OKCallback. #STEP 4#",p,c.FUNC_INOUT),typeof r!=_&&r(e),!0},function(e){return St(s+".put_OFS  put_OFS_ErrorCallback. #STEP 4#",p,c.FUNC_INOUT),typeof a!=_&&a(e),!1},e,t),St(s+".put_OFS <-  ##STEP 4##  file='"+e+"'  accountId='"+t+"'",p,c.FUNC_INOUT)}function f(r){if(St(s+".get_ServerVersion ->  ##STEP 2##  file='"+e+"'  accountId='"+t+"'",p,c.FUNC_INOUT),e==rt.USER_DATA&&t==o.m_sUserId){var n=e,i=t,f=o.m_sServerUrl+"/rf-api/"+encodeURI(t)+"/"+n;St(s+".get_ServerVersion  file='"+n+"' for account='"+i+"' . Current auth user is ='"+o.m_sUserId+"'. Make request *GET* to "+f,p,c.INFO);var u=o.internal_CreateHeaders();o.makeRequestAsync(f,null,u,"GET",!0,!0,function(r,n){if(St(s+".get_ServerVersion. makeRequestAsync callback ->",p,c.FUNC_INOUT),!o.misc_checkHttpResponse(r,n,a))return St(s+". checkHttpResponse failed. Return false.",p,c.SPECIAL_CASE),!1;var i=f,u=i.substr(i.lastIndexOf("/")+1),l=(i=i.substr(0,i.lastIndexOf("/"))).substr(i.lastIndexOf("/")+1);if(r.status==Ee){St(s+" Return true. StatusCode is 200. File='"+u+"' for account='"+l+"' current='"+o.m_sUserId+"'",p,c.INFO);var d=r.response,S=o[Oe](),y=o.convertFromArrayBuffer(d);(null!=o.m_OFSMgr?o.m_OFSMgr:new RfapiJS.CRfOneFileSys).DecodeUnZipOFSBytes(y,u,l,S,!0,function(r,n){St(s+". decode_Ok_CallBack ->",p,c.INFO);try{var o=JSON.parse(n)}catch(e){return typeof a!=_&&a({Code:O.SibTErr_LocalErr,Description:"Exception while JSON.Parse: "+e.toString()+".  End of data:  ..."+n.substring(n.length-20)}),!1}var i;i=o,St(s+".merge_OFS ->  ##STEP 3##  file='"+e+"'  accountId='"+t+"'",p,c.FUNC_INOUT),I.getDataByAccountId(e,t)[RfapiJS.ITEM_CHILDS_PROP],i[RfapiJS.ITEM_CHILDS_PROP][1][RfapiJS.ITEM_CHILDS_PROP],St(s+".merge_OFS <-  ##STEP 3##  file='"+e+"'  accountId='"+t+"'",p,c.FUNC_INOUT)},function(e){if(St(s+". decode_Error_CallBack.",p,c.INFO),e.Code==N.RfErr_AuthRejected){if(typeof a!=_)return a(new tt(N.RfErr_AuthRejected,"Wrong Master Password.")),!1}else if(typeof a!=_)return a(new tt(e.Code,e.Description)),!1;return!1})}})}St(s+".get_ServerVersion <-  ##STEP 2##  file='"+e+"'  accountId='"+t+"'",p,c.FUNC_INOUT)}return St(Fe+s+" fileName='"+e+"'  accountId='"+t+"'",p,c.FUNC_INOUT),n?(St(s+".get_eTag ->  ##STEP 1##  file='"+e+"'  accountId='"+t+"'",p,c.FUNC_INOUT),o[oe](function(r,a){return St(s+".get_eTag  get_eTag_AnswerCallback. #STEP 1#  serverTag='"+r+"'",p,c.FUNC_INOUT),r?o.internal_GetFileTag(t,e)==r?(St(s+".get_eTag  get_eTag_AnswerCallback. eTags are equal. Just save it.",p,c.FUNC_INOUT),void i()):void f():(St(s+".get_eTag  get_eTag_AnswerCallback. There is no file on server-> just save it.",p,c.FUNC_INOUT),void i())},function(e){return St(s+".get_eTag  get_eTag_ErrorCallback. #STEP 1#",p,c.FUNC_INOUT),typeof a!=_&&a(e),!1},e,t),St(s+".get_eTag <-  ##STEP 1##  file='"+e+"'  accountId='"+t+"'",p,c.FUNC_INOUT)):i(),St(Pe+s,p,c.FUNC_INOUT),!0}catch(e){this.internal_catchedException(s,e,a)}},at.prototype[te]=function(e,t,r,a){var n=te,s=this;if(!s.misc_checkParameters({SERVER_URL:s.m_sServerUrl,USER_ID:s.m_sUserId},t))return St("RfDataManager."+n+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var o=typeof r==_?rt.USER_DATA:r,i=typeof a==_?s.m_sUserId:a,f=s.m_sServerUrl+"/rf-api/"+encodeURI(i)+"/"+o;St("RfDataManager. "+n+" file='"+o+"' for account='"+i+"' . Current auth user is ='"+s.m_sUserId+"'. Make request *GET* to "+f,p,c.INFO);var u=s.internal_CreateHeaders();s.makeRequestAsync(f,null,u,"GET",!0,!0,function(r,a){if(St("RfDataManager. "+n+". makeRequestAsync callback ->",p,c.FUNC_INOUT),!s.misc_checkHttpResponse(r,a,t,!0))return St("RfDataManager. "+n+". checkHttpResponse failed. Return false.",p,c.SPECIAL_CASE),!1;var o=f,i=o.substr(o.lastIndexOf("/")+1);i.lastIndexOf("?")>0&&(i=i.substr(0,i.lastIndexOf("?")));var u=(o=o.substr(0,o.lastIndexOf("/"))).substr(o.lastIndexOf("/")+1);if(r.status==Te)return St("RfDataManager. "+n+" StatusCode is "+r.status+". file ='"+i+"' for account='"+u+"' current='"+s.m_sUserId+"'",p,c.INFO),typeof e!=_&&e(r.status,i,u,null),!0;if(r.status==Ee){St("RfDataManager. "+n+" StatusCode is "+r.status+". file ='"+i+"' for account='"+u+"' current='"+s.m_sUserId+"'",p,c.INFO);var l=typeof r.response!=_?r.response:r.responseText,d=r.getResponseHeader("eTag");return typeof e!=_&&e(r.status,i,u,d,l),!0}return St("RfDataManager. "+n+" Return false. StatusCode is ='"+r.status+"'  File='"+i+"' for account='"+u+"' current='"+s.m_sUserId+"'",p,c.INFO),typeof t!=_&&t(new tt(-1,"HttpStatus error="+r.status+" while getting file='"+i+"' for  account=["+u+"]")),!1})},at.prototype[se]=function(e,t,r,a,n){var s=se,o=this;if(!o.misc_checkParameters({SERVER_URL:o.m_sServerUrl,USER_ID:o.m_sUserId},t))return St("RfDataManager."+s+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;n&&n(1);var i=typeof r==_?rt.USER_DATA:r,f=typeof a==_?o.m_sUserId:a,u=o.m_sServerUrl+"/rf-api/"+encodeURI(f)+"/"+i;St("RfDataManager. "+s+" file='"+i+"' for account='"+f+"' . Current auth user is ='"+o.m_sUserId+"'. Make request *GET* to "+u,p,c.INFO);var l=o.internal_CreateHeaders();o.makeRequestAsync(u,null,l,"GET",!0,!0,function(r,a){if(St("RfDataManager. "+s+". makeRequestAsync callback ->",p,c.FUNC_INOUT),!o.misc_checkHttpResponse(r,a,t,!0))return St("RfDataManager. "+s+". checkHttpResponse failed. Return false.",p,c.SPECIAL_CASE),!1;var f=u,l=f.substr(f.lastIndexOf("/")+1);l.lastIndexOf("?")>0&&(l=l.substr(0,l.lastIndexOf("?")));var d=(f=f.substr(0,f.lastIndexOf("/"))).substr(f.lastIndexOf("/")+1);if(r.status==Te)return St("RfDataManager. "+s+" StatusCode is 404. file not found='"+l+"' for account='"+d+"' current='"+o.m_sUserId+"'",p,c.INFO),i!=rt.USER_DATA||o.isSharedAccountId(d)||o.setAccountMode(m.MULTIFILE),o.isSharedAccountId(d)?typeof e!=_&&e(Te,null,null,d):typeof e!=_&&e(Te),!0;if(r.status==Ee){St("RfDataManager. "+s+" Return true. StatusCode is 200. File='"+l+"' for account='"+d+"' current='"+o.m_sUserId+"'",p,c.INFO);var S,y=typeof r.response!=_,R=y?r.response:r.responseText,U=r.getResponseHeader("eTag");if(o.isSharedAccountId(d)){if(!(S=o.decodeAccountPwd(d)))return typeof t!=_&&t(new tt(-1,"Cannot decrypt MasterPassword of shared account=["+d+"]  with user RSA Private Key. ")),!1}else if(!(S=o[Oe]()))return typeof t!=_&&t(new tt(-1,"Empty password='"+S+"' for accountName='"+d+"' IsByteArray="+y+" headerTag="+U+" fileName='"+l+"'")),!1;o.isSharedAccountId(d)||(I.setUser(o.m_sUserId),o.setAccountMode(m.OFS)),o.internal_PutFileTag(U,d,l);var h=y?R.byteLength:R.length;return St("RfDataManager. "+s+"  File='"+l+"' for account='"+d+"' current='"+o.m_sUserId+"' BYTES="+h,p,c.INFO),n&&n(5),o.DecodeOFSFile(R,l,e,t,d,S,n),!0}})},at.prototype[ne]=function(e,t,r,a,n){var s="RfDataManager."+ne;try{var o=this;if(St(Fe+s+" fileName='"+r+"'  accountId='"+a+"'",p,c.FUNC_INOUT),!o.misc_checkParameters({SERVER_URL:o.m_sServerUrl,USER_ID:o.m_sUserId},t))return St(s+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var i=typeof r==_?rt.USER_DATA:r,f=typeof a==_?o.m_sUserId:a,u=null!=o.m_OFSMgr?o.m_OFSMgr:new RfapiJS.CRfOneFileSys,l=I.getDataByAccountId(i,f),d="";if(f==o.m_sUserId)d=o[Oe]();else{var S=o.decodeAccountPwd(f);if(!S)return void(typeof t!=_&&t(new tt(-1,"Cannot decrypt account("+f+") Master Password.")));d=S}return o.ObjectOFSToBytes(l,function(r){u.EncodeZipOFSBytes(r,i,f,d,4096,!0,function(r){St(s+". encrypt_Ok callback ->",p,c.FUNC_INOUT);var a=new Uint8Array(r),n=o.internal_GetFileTag(f,i),u=o.internal_CreateHeaders(!0);n?u["If-Match"]=n:u["If-None-Match"]="*";var l=o.m_sServerUrl+"/rf-api/"+encodeURI(f)+"/"+i;St(s+". SAVE OFS "+l,p,c.INFO),o.makeRequestAsync(l,a,u,"POST",!1,!0,function(r,a){return St(s+". makeRequestAsync.saveOFS_callback ->",p,c.FUNC_INOUT),o.misc_checkHttpResponse(r,a,t)?r.status==Ae?(typeof t!=_&&t(new tt(r.status,r.statusText,void 0,r,void 0)),!1):r.status==ge?(typeof t!=_&&t(new tt(r.status,r.statusText,void 0,r,void 0)),!1):(o.internal_PutFileTag(r.getResponseHeader("eTag"),f,i),void(typeof e!=_&&e(r,f))):(St(s+". makeRequestAsync.saveOFS_callback failed. Return false.",p,c.SPECIAL_CASE),!1)})},function(e,r){St(s+". encrypt_Error callback ->",p,c.FUNC_INOUT),typeof t!=_&&t(e),r&&(r.function=s,o.internal_setLastError(r))},void 0,void 0,n)},function(e){typeof t!=_&&t(e)}),St(Pe+s,p,c.FUNC_INOUT),!0}catch(e){this.internal_catchedException(s,e,t)}},at.prototype.CreateEmptyOFS_RSAKeys=function(e,t,r,n){St("RfDataManager.CreateEmptyOFS_RSAKeys ->",p,c.FUNC_INOUT);var s=a.GenerateKeysWithCheck(1024),o=s.Public_Pem,i=s.Private_Pem,f=Math.round(new Date/1e3),u={i:{F:!0},c:[{b:i,i:{n:"private-key.pem",c:f,m:f,s:i.length,f:!0}},{i:{F:!0,n:"root"},c:[]}]};n||r!=this.m_sUserId||I.setData(u,rt.USER_DATA,r),this[B](o,function(t){return typeof e!=_&&e(t),!0},function(e){return typeof t!=_&&t(e),!1},r),St("RfDataManager.CreateEmptyOFS_RSAKeys <-",p,c.FUNC_INOUT)},at.prototype[ce]=function(e,t,r,a){var n=this,s="RfDataManager."+ce;St(Fe+s+" fileName='"+r+"'  accountId='"+a+"'",p,c.FUNC_INOUT),n[oe](function(a,o,i){return St(s+".  get_eTag_AnswerCallback. serverTag='"+a+"' accId='"+i+"'",p,c.FUNC_INOUT),a?n.internal_GetFileTag(i,r)==a?(St(s+". get_eTag_AnswerCallback.  eTags are equal. Return OK. accId='"+i+"'",p,c.FUNC_INFO),void(typeof e!=_&&e(200,i,!1))):(St(s+". get_eTag_AnswerCallback. eTags are NOT equal. GET NEW VERSION FROM SERVER. accId='"+i+"'",p,c.FUNC_INFO),I.resetAccountData(i,r),St(s+".  getNewOFSFromServer. *Step 2* file='"+(u=r)+"' accId='"+(f=i)+"'  ->",p,c.FUNC_INOUT),n[se](function(t,r){if(St(s+".getAccount_OkCallBack. *Step 2* GOT from server OFS='"+u+"'  status='"+t+"' ->",p,c.FUNC_INOUT),t!=Ee)return St(s+"getAccount_OkCallBack. HttpStatus for account("+r+") is="+t,p,c.INFO),void(typeof e!=_&&e(t,f,!0));typeof e!=_&&e(t,f,!0)},function(e){St(s+".getAccount_ErrorCallBack.  *Step 2* OFS='"+u+"'  accId='"+f+" ->",p,c.FUNC_INOUT),typeof t!=_&&t(e)},u,f),void St(" <- "+s+".  getNewOFSFromServer. *Step 2* file='"+u+"' accId='"+f+"'",p,c.FUNC_INOUT)):(St(s+". get_eTag_AnswerCallback. There is no file on server. Return OK. accId='"+i+"'",p,c.FUNC_INFO),void(typeof e!=_&&e(200,i,!1)));var f,u},function(e){return typeof t!=_&&t(e),!1},r,a)};at.prototype[oe]=function(e,t,r,a){St("CheckOFSFileETag ->",p,c.INFO);var n=this,s=oe,o=typeof r==_?rt.USER_DATA:r,i=typeof a==_?n.m_sUserId:a;if(!n.misc_checkParameters({SERVER_URL:n.m_sServerUrl,USER_ID:i},t))return St("RfDataManager."+s+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var f=n.m_sServerUrl+"/rf-api/"+encodeURI(i)+"/"+o;St("CheckOFSFileETag. UserId='"+i+"'  Make request *HEAD* to "+f,p,c.INFO);var u=n.internal_CreateHeaders();n.makeRequestAsync(f,null,u,"HEAD",!1,!1,function(r,a){St("RfDataManager."+s+". makeRequestAsync callback ->",p,c.FUNC_INOUT);var u=f,l=u.substr(u.lastIndexOf("/")+1);l.lastIndexOf("?")>0&&(l=l.substr(0,l.lastIndexOf("?")));var d=(u=u.substr(0,u.lastIndexOf("/"))).substr(u.lastIndexOf("/")+1);if(!n.misc_checkHttpResponse(r,a,t))return St("RfDataManager."+s+" checkHttpResponse failed. Return false.",p,c.SPECIAL_CASE),!1;if(r.status==Te)return St("RfDataManager."+s+" StatusCode is 404. file not found='"+o+"' for account='"+i+"'",p,c.INFO),typeof e!=_&&e(null,Te,d),!0;if(r.status==Ee){var S=r.getResponseHeader("eTag");return St("RfDataManager."+s+" Return true. StatusCode is 200. eTag="+S+" accountId="+d,p,c.INFO),typeof e!=_&&e(S,Ee,d),!0}})},at.prototype.SetEventListener=function(e,t){var r="RfDataManager.SetEventListener";try{return St(Fe+r+" eventName='"+e+"'",p,c.FUNC_INOUT),e?(typeof this.m_EventsMap[e]==_?(this.m_EventsMap[e]=[],this.m_EventsMap[e].push(t)):this.m_EventsMap[e].push(t),St(Pe+r,p,c.FUNC_INOUT),!0):(St(r+". EventName is empty. Return false.",p,c.SPECIAL_CASE),!1)}catch(e){this.internal_catchedException(r,e,ErrorCallBack)}},at.prototype.FireEvent=function(e,t){var r="RfDataManager.FireEvent";try{if(St(Fe+r+" eventName='"+e+"'",p,c.FUNC_INOUT),typeof this.m_EventsMap[e]==_)return St(Fe+r+" There is no callback for event='"+e+"'",p,c.FUNC_INOUT),!1;for(var a=this.m_EventsMap[e],n=0;n<a.length;n++){(0,a[n])(t)}return St(Pe+r,p,c.FUNC_INOUT),!0}catch(e){this.internal_catchedException(r,e,ErrorCallBack)}},at.prototype.GetLicensingUrlFromServer=function(e,t,r){var a="GetLicensingUrlFromServer",n="RfDataManager."+a;try{St(Fe+n,p,c.FUNC_INOUT);var s,o=e.action,i=e.email;if(!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER_ID:this.m_sUserId},r))return St(n+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;switch(o){case 0:s="buy";break;case 1:s="renew";break;default:return void(typeof r!=_&&r(new tt(void 0,"Internal error",void 0,void 0,"Internal error")))}var f={};f.action=s,f.accountId=this.m_sUserId,typeof i!=_&&(f.email=i);var u=JSON.stringify(f),l=this.m_sServerUrl+"/rf-api/"+encodeURI(this.m_sUserId)+"?get-url";return this.internal_RequestAsync(a,l,u,this.internal_CreateHeaders(),"POST",!1,!1,!1,{},t,r),St(Pe+n,p,c.FUNC_INOUT),!0}catch(e){this.internal_catchedException(n,e,r)}},at.prototype[F]=function(e,t,r,a){var n=F,s="RfDataManager."+n;try{if(St(Fe+s,p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER_ID:e},r))return St(s+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var o=this.m_sServerUrl+"/rf-api/"+encodeURI(e)+"?get-account-info";return this.internal_RequestAsync(n,o,null,this.internal_CreateHeaders(),"POST",!1,!1,!1,{userId:e,getUserInfo:a},t,r,!0),St(Pe+s,p,c.FUNC_INOUT),!0}catch(e){this.internal_catchedException(s,e,r)}},at.prototype[P]=function(e,t,r,a,n,s,o,i,f,u,l,d,S,y,R,U,h,I,O){var m=P,C="RfDataManager."+m;try{St(Fe+C,p,c.FUNC_INOUT);var v=typeof r!=_?r:this.m_sUserId;if(!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER_ID:v},t))return St(C+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var E={};typeof a!=_&&(E.block=a),typeof n!=_&&(E.unblock=n),typeof s!=_&&(E.otpOn=s),typeof o!=_&&(E.suspend=o),typeof i!=_&&(E.securityScore=i),typeof f!=_&&(E.loginsCount=f),typeof u!=_&&(E.totpKey=u),typeof l!=_&&(E.totp=l),typeof d!=_&&(E.company=d),typeof S!=_&&(E[Je]=S),typeof y!=_&&(E.email=y),typeof R!=_&&(E.securityStats=R),typeof U!=_&&(E.enrollDevice=U),typeof h!=_&&(E.unenrollDevices=h),typeof I!=_&&(E.phone=I),typeof O!=_&&(E.verificationCode=O);var N=JSON.stringify(E),T=this.m_sServerUrl+"/rf-api/"+encodeURI(v)+"?account-info";return this.internal_RequestAsync(m,T,N,this.internal_CreateHeaders(),"POST",!1,!1,!1,{},e,t),St(Pe+C,p,c.FUNC_INOUT),!0}catch(e){this.internal_catchedException(C,e,t)}},at.prototype.SendVerificationCode=function(e,t,r){var a="RfDataManager.SendVerificationCode";try{if(St(Fe+a,p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId},r))return St(a+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var n=e.email,s=e.phone;if(!n&&!s)return St(a+". email and phone are missed. Return false",p,c.SPECIAL_CASE),typeof r!=_&&r(new tt(N.RfErr_WrongParams,"Wrong paramaters")),!1;if(n&&s)return St(a+". Wrong parameters. Return false",p,c.SPECIAL_CASE),typeof r!=_&&r(new tt(N.RfErr_WrongParams,"Wrong paramaters")),!1;var o={};typeof n!=_&&(o.email=n),typeof s!=_&&(o.phone=s);var i=JSON.stringify(o),f=this.m_sServerUrl+"/rf-api/"+encodeURI(this.m_sUserId)+"?send-verification-code";return this.internal_RequestAsync("SendVerificationCode",f,i,this.internal_CreateHeaders(),"POST",!1,!1,!1,void 0,t,r),St(Pe+a,p,c.FUNC_INOUT),!0}catch(e){this.internal_catchedException(a,e,r)}},at.prototype.GenerateTOTPKey=function(e,t){var r="RfDataManager.GenerateTOTPKey";try{if(St(Fe+r,p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId},t))return St(r+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var a=this.m_sServerUrl+"/rf-api/?generate-totp-key";return this.internal_RequestAsync("GenerateTOTPKey",a,void 0,this.internal_CreateHeaders(),"POST",!1,!1,!1,void 0,e,t),St(Pe+r,p,c.FUNC_INOUT),!0}catch(e){this.internal_catchedException(r,e,t)}},at.prototype.GetDataStatus=function(e,t,r,a){var n="RfDataManager.GetDataStatus";try{if(St(Fe+n+" accountId='"+e+"'",p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER_ID:e},r))return St(n+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var s={};s[Be]={},s[Be][Ge]="getdatastatus",typeof a!=_&&(s[Be].listDir=a);var o=JSON.stringify(s);return this.internal_RequestAsync("GetDataStatus",this.internal_CreateRequestUrl(),o,this.internal_CreateHeaders(),"POST",!1,!1,!0,{userId:e},t,r),St(Pe+n,p,c.FUNC_INOUT),!0}catch(e){this.internal_catchedException(n,e,r)}},at.prototype[A]=function(e,a,n,s,o,i,f,u,l){var d="RfDataManager."+A;try{var S=this;St(Fe+d+" userId='"+e+"'",p,c.FUNC_INOUT);var y=!1;if(window.XMLHttpRequest?y=new XMLHttpRequest:window.ActiveXObject&&(y=new ActiveXObject("Microsoft.XMLHTTP")),!S.misc_checkParameters({SERVER_URL:S.m_sServerUrl,USER_ID:e,USER_PWD:a},u))return St(d+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var R=S.internal_CreateHeaders();if(R["x-sib-session-timeout"]=n,typeof s!=_&&(R["x-sib-auth-alt-otp"]=s),typeof o!=_&&(R["x-sib-auth-alt-memorize"]=o),typeof i!=_&&(R["x-sib-auth-alt-channel"]=i),typeof l!=_){var U=r.stringToBytes(l),h=t.bytesToBase64(U);R["x-sib-auth-computerdescr"]=h}typeof s==_&&typeof o==_&&typeof i==_&&(R["x-sib-auth-alt-channel"]="-");var I=new RfapiJS.SibHttpScramAuthClient;I.SetRealm("RoboForm Online Server");var O=I.GetAuthRequestHeader(e,a);R.Authorization=O;var m=S.m_sServerUrl+"/rf-api/"+encodeURI(e)+"?login";return S.makeRequestAsync(m,null,R,"POST",!1,!1,function(t,r){if(St(d+". makeRequestAsync ->",p,c.FUNC_INOUT),t.status!=Ne){if(t.status==Ee){if(St(d+". Log In: SUCCESSFUL!!!  user='"+e+"'",p,c.INFO),typeof f!=_){var n=JSON.parse(t.responseText);f(Ee,n)}return!0}if(typeof u!=_)return u(new tt(t.status,t.statusText,void 0,t,void 0)),!1}else{var s=t.getResponseHeader("WWW-Authenticate");if(s){var o=RfapiJS.SibHttpGetAuthMethod(s);I.ParseServerResponse(o)&&(O=I.GetAuthRequestHeader(e,a),R.Authorization=O,S.makeRequestAsync(m,null,R,"POST",!1,!1,function(t,r){if(St(d+". SECOND makeRequestAsync callback2->",p,c.FUNC_INOUT),!S.misc_checkHttpResponse(t,r,u))return St(d+". checkHttpResponse failed. Return false.",p,c.SPECIAL_CASE),!1;if(t.status==Ee){St(d+". Log In: SUCCESSFUL!!!  user='"+e+"'",p,c.INFO);var n=JSON.parse(t.responseText);return n.disabled?(typeof f!=_&&f(Ee,n),St(d+". Account was disabled. Return",p,c.SPECIAL_CASE),!1):(S.Clear(),S.SetUserID(e),S[Ce](a),S[me](a),typeof f!=_&&f(Ee,n),!0)}if(typeof u!=_)return u(new tt(t.status,t.statusText,void 0,t,void 0)),!1;St(d+". makeRequestAsync callback <-",p,c.FUNC_INOUT)},y))}}},y),St(Pe+d,p,c.FUNC_INOUT),!0}catch(e){this.internal_catchedException(d,e,u)}},at.prototype[g]=function(e,t,r){var a=g,n="RfDataManager."+a;try{if(St(Fe+n,p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER_ID:this.m_sUserId},r))return St(n+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var s=4==e?"?logoutall":2==e?"?logoutdevice":"?logout";return this.internal_RequestAsync(a,this.internal_CreateRequestUrl(s),null,this.internal_CreateHeaders(),"POST",!1,!1,!1,{},t,r),St(Pe+n,p,c.FUNC_INOUT),!0}catch(e){this.internal_catchedException(n,e,r)}};var nt=8,st=80;at.prototype.CreateAccount=function(e,n,s,o,i,f,u,l,d,S,y,R,U,h,I,C,v){var E="RfDataManager.CreateAccount";d||(d=function(e){});try{!1;var T=this;if(St(Fe+E+"  accountLogin ='"+e+"'",p,c.FUNC_INOUT),!T.m_sServerUrl)return St(E+". Server Url is undefined. Return false",p,c.SPECIAL_CASE),typeof u!=_&&u(new tt(N.RfErr_WrongParams,"Server URL is not defined")),d(De),!1;if(!e)return St(E+". User login is undefined. Return false",p,c.SPECIAL_CASE),typeof u!=_&&u(new tt(N.RfErr_WrongParams,"UserId is not defined")),d(De),!1;if(e.length<6||e.length>80)return St(E+". Account login is incorrect (6-80 symbols). Return false",p,c.SPECIAL_CASE),typeof u!=_&&u(new tt(N.RfErr_WrongParams,"Account login is incorrect (6-80 symbols)")),d(De),!1;if(typeof s!=_&&""!=s&&(s.length<2||s.length>60))return St(E+". Account name is incorrect (2-60 symbols). Return false",p,c.SPECIAL_CASE),typeof u!=_&&u(new tt(N.RfErr_WrongParams,"Account name is incorrect (2-60 symbols)")),d(De),!1;if(!o)return St(E+". User email is undefined. Return false",p,c.SPECIAL_CASE),typeof u!=_&&u(new tt(N.RfErr_WrongParams,"User email is empty.")),d(De),!1;if(o.length<6||o.length>80)return St(E+". Account email is incorrect (6-50 symbols). Return false",p,c.SPECIAL_CASE),typeof u!=_&&u(new tt(N.RfErr_WrongParams,"Account email is incorrect (6-50 symbols)")),d(De),!1;if(!n)return St(E+". Account password is undefined. Return false",p,c.SPECIAL_CASE),typeof u!=_&&u(new tt(N.RfErr_WrongParams,"Password cannot be empty")),d(De),!1;if(!T.internal_isPasswordCorrect(n,u,d))return!1;if(typeof i!=_&&""!=i&&(i.length<7||i.length>20))return St(E+". Account phone is incorrect (7-20 symbols). Return false",p,c.SPECIAL_CASE),typeof u!=_&&u(new tt(N.RfErr_WrongParams,"Account phone is incorrect (7-20 symbols)")),d(De),!1;I||T.setAccountMode(m.OFS);var g={};function F(r){St(E+". createOFS. Step 3 ->",p,c.INFO),d(45);var a=Math.round(new Date/1e3),s={i:{F:!0},c:[{b:r,i:{n:"private-key.pem",c:a,m:a,s:r.length,f:!0}},{i:{F:!0,n:"root"},c:[]}]},o=new RfapiJS.CRfOneFileSys;T.ObjectOFSToBytes(s,function(r){d(55),o.EncodeZipOFSBytes(r,rt.USER_DATA,e,n,4096,!0,function(r){St(E+".[createOFS] encrypt_Ok callback ->",p,c.FUNC_INOUT);var a=new Uint8Array(r),s=t.bytesToBase64(a);g.files={},g.files["user-data.rfo"]=s,function(){St(E+". createAccount. Step 4 ->",p,c.INFO),d(65);var t=JSON.stringify(g),r=T.internal_CreateHeaders();I||(r["x-sib-auth-alt-memorize"]=1);var a=T.m_sServerUrl+"/rf-api?createaccount";St(E+". Make ASYNC POST request to "+a,p,c.INFO),T.makeRequestAsync(a,t,r,"POST",!1,!1,function(t,r){if(St(E+".createAccount makeRequestAsync ->",p,c.FUNC_INOUT),d(90),!T.misc_checkHttpResponse(t,r,u))return St(E+".createAccount checkHttpResponse failed. Return false.",p,c.SPECIAL_CASE),d(De),!1;if(t.status==Ee){if(St(E+".createAccount Status code=OK. Need to parse response for errors. RESPONSE  = "+t.responseText,p,c.INFO),t.responseText)try{var a=JSON.parse(t.responseText),s=a[je][We];if("error"==s)return St(E+".createAccount Server returns status=error.",p,c.SPECIAL_CASE),typeof u!=_&&u(new tt(O.SibTErr_ServerErr,"Server returns status=error",a[je])),d(De),!1;if("ok"==s){if(I)return d(De),typeof f!=_&&f(t.status,a.response),!0;T.m_sUserId=e,T[me](n),T[A](T.m_sUserId,n,1440,void 0,void 0,void 0,function(e,t){St(E+".createAccount login_Ok_Callback. makeRequestAsync ->",p,c.FUNC_INOUT),d(De),typeof f!=_&&f(e,t)},function(e){return St(E+".createAccount login_Err_Callback. makeRequestAsync ->",p,c.FUNC_INOUT),typeof u!=_&&u(e),d(De),!1},l)}}catch(e){return St(E+".createAccount Error while parsing JSON response",p,c.SPECIAL_CASE),typeof u!=_&&u(new tt(O.SibTErr_ServerErr,"Error Parsing JSON response")),d(De),!1}return!0}return typeof u!=_&&u(new tt(t.status,t.statusText,void 0,t,void 0)),d(De),!1}),St(E+". <- createAccount. Step 4",p,c.INFO)}()},function(e){St(E+".[createOFS] encrypt_Error callback ->",p,c.FUNC_INOUT),typeof u!=_&&u(e)})},function(e){typeof u!=_&&u(e)}),St(E+". <- createOFS. Step 3",p,c.INFO)}return g[Je]=s,g.login=e,g.email=o,typeof h!=_&&(g.enterprise=h),typeof S!=_&&(g.acceptCode=S),typeof y!=_&&(g.passwordExpires=y),typeof R!=_&&(g.passwordExpiresInDays=R),typeof i!=_&&(g.phone=i),typeof C!=_&&(g.affId=C),typeof v==_&&(v=T.internal_getBrowserLang()),g.lang=v,function(){St(E+". createSaltHash. Step 1 ->",p,c.INFO),d(20);for(var e=t.randomBytes(16),s=(new RfapiJS.SibScramAuthClient).CalcStoredInfo(r.stringToBytes(n),e,Me),o=s.item2,i=s.item3,f=0;f<i.length;f++)o.push(i[f]);var u=t.bytesToBase64(o);u=u.replace(new RegExp("=","g"),""),e=(e=t.bytesToBase64(e)).replace(new RegExp("=","g"),""),g.method="SCRAM-SHA-256",g.iterations=Me,g.salt=e,g.hash=u,St(E+". <- createSaltHash. Step 1",p,c.INFO),function(){St(E+". createRSAKeys. Step 2 ->",p,c.INFO),d(30);var e=a.GenerateKeysWithCheck(1024),t=e.Public_Pem,r=e.Private_Pem;g.publicKey=t,St(E+". <- createRSAKeys. Step 2",p,c.INFO),F(r)}()}(),void St(Pe+E,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(E,e,u),d(De)}},at.prototype.ChangeAccountPwd=function(s,o,i,f,u){var l="RfDataManager.ChangeAccountPwd";u||(u=function(e){});try{var d=this;St(Fe+l+" newPwd='"+s+"'",p,c.FUNC_INOUT);var S=d.getAccountMode();if(!d.misc_checkParameters({SERVER_URL:d.m_sServerUrl,USER_ID:d.m_sUserId,NEW_PASSWORD:s,OLD_PASSWORD:o},f))return St(l+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),u(De),!1;if(!d.internal_isPasswordCorrect(s,f,u))return!1;if(u(15),S==m.MULTIFILE){St(l+" # MULTIFILE pwd change -> #",p,c.FUNC_INOUT);var y=CryptoJS.MD5(o);y=y.toString();var R=CryptoJS.MD5(s),U={"Content-type":"application/x-www-form-urlencoded","x-sib-auth-old-pwd":y,"x-sib-auth-new-pwd":R=R.toString()};u(50);var h=d.m_sServerUrl+"/rf-api/"+encodeURI(d.m_sUserId)+"?setaccountpwd";return d.makeRequestAsync(h,null,U,"POST",!1,!1,function(e,t){if(403==e.status&&typeof f!=_){u(100);var r=e.responseText?e.responseText:"Wrong old Password.";return f(new tt(N.RfErr_AuthRejected,r)),!1}return d.misc_checkHttpResponse(e,t,f)?e.status==Ee?(St(l+". SUCCESSFUL!!!",p,c.INFO),d[Ce](s),d[me](s),u(De),void(typeof i!=_&&i(Ee))):void 0:(St(l+". checkHttpResponse failed. Return false.",p,c.SPECIAL_CASE),u(De),!1)}),void St(l+" # MULTIFILE pwd change <- #",p,c.FUNC_INOUT)}{for(var C=t.randomBytes(16),v=(new RfapiJS.SibScramAuthClient).CalcStoredInfo(r.stringToBytes(s),C,Me),E=v.item2,T=v.item3,A=0;A<T.length;A++)E.push(T[A]);var g=t.bytesToBase64(E);g=g.replace(new RegExp("=","g"),"");var F=CryptoJS.MD5(CryptoJS.enc.Latin1.parse(n.bytesToString(C))).toString(CryptoJS.enc.hex),P=t.bytesToBase64(C);P=P.replace(new RegExp("=","g"),"");var D=null!=d.m_OFSMgr?d.m_OFSMgr:new RfapiJS.CRfOneFileSys;function k(e){St(l+" changePwdWithOldPwdCheck  #STEP 5 #",p,c.FUNC_INOUT),u(90);var t=new RfapiJS.SibHttpScramAuthClient;t.SetRealm("RoboForm Online Server");var r=t.GetAuthRequestHeader(d.m_sUserId,o),a=d.internal_CreateHeaders();a.Authorization=r;var n={method:"SCRAM-SHA-256"};n.iterations=Me,n.salt=P,n.hash=g,e&&e.length&&(n.trustedUsers=e);var S=JSON.stringify(n);u(95);var y=d.m_sServerUrl+"/rf-api/"+encodeURI(d.m_sUserId)+"?setaccountpwd";d.makeRequestAsync(y,S,a,"POST",!1,!1,function(e,n){if(St(l+". makeRequestAsync ->",p,c.FUNC_INOUT),e.status==Ne){var R=e.getResponseHeader("WWW-Authenticate");if(R){u(99);var U=RfapiJS.SibHttpGetAuthMethod(R);t.ParseServerResponse(U)&&(r=t.GetAuthRequestHeader(d.m_sUserId,o),a.Authorization=r,d.makeRequestAsync(y,S,a,"POST",!1,!1,function(e,t){return St(l+". SECOND makeRequestAsync callback2->",p,c.FUNC_INOUT),401==e.status&&typeof f!=_?(u(De),f(new tt(N.RfErr_AuthRejected,"Wrong Password.")),!1):d.misc_checkHttpResponse(e,t,f)?e.status==Ee?(St(l+". CHECK OLD PWD(change to new complete): SUCCESSFUL!!!",p,c.INFO),d[Ce](s),d[me](s),u(De),void(typeof i!=_&&i(Ee))):void 0:(St(l+". checkHttpResponse failed. Return false.",p,c.SPECIAL_CASE),u(De),!1)}))}}}),St(l+" changePwdWithOldPwdCheck  # end of STEP 5#",p,c.FUNC_INOUT)}function M(){St(l+". getTrustedUsersList. Step 3. -> ",p,c.INFO),d[b](function(r){St(l+". getTrusted_Ok. Step 3. -> ",p,c.INFO);var n=r.trustedUsers;if(!n.length)return k(),void St(l+". getTrusted_Ok. Step 3. No trusted users. Goto Step 5.. <-",p,c.INFO);!function(r){try{St(l+". encryptNewPasswordByUserPublicKey. Step 4. ->",p,c.INFO);for(var n=s,o=[],i=0;i<r.length;i++){var u=r[i],d=u.publicKey,S=CryptoJS.MD5(d).toString(CryptoJS.enc.hex),y=new RSAKey,R=a.GetHexFromPEM(d,!0);y.setPublic(R.modulus,R.exponent);var U=y.encrypt(n),h=t.bytesToBase64(t.hexToBytes(U)),I={};I.accountId=u.accountId,I.mp=h,I.publicKeyHash=S,o.push(I)}k(o),St(l+". encryptNewPasswordByUserPublicKey. Step 4. <-",p,c.INFO)}catch(t){Rt("EXCEPTION in "+l+".encryptNewPasswordByUserPublicKey: "+e.toString(),p),typeof f!=_&&f({Code:O.SibTErr_LocalErr,Description:"EXCEPTION in encryptNewPasswordByUserPublicKey:"+e.toString()})}}(n),St(l+". getTrusted_Ok. Step 3. users="+n.length+" <-",p,c.INFO)},function(e){St(l+". getTrusted_Error. Step 3. -> ",p,c.INFO),typeof f!=_&&f(e)}),St(l+". getTrustedUsersList. Step 3. <- ",p,c.INFO)}!function(){function e(e,t,r){u(25),St(l+".upload_UserDataRFO.  #STEP 1.2# file='"+t+"' account='"+r+"'",p,c.FUNC_INOUT),d.ObjectOFSToBytes(e,function(e){D.ofs_ClearCacheForAccount(r,t),D.EncodeZipOFSBytes(e,t,r,s,be,!0,function(e){St(l+". Step 1  encrypt_Ok callback ->",p,c.FUNC_INOUT);var a=D.ofs_GetData(rt.USER_DATA,r,s);u(45);var n=new Uint8Array(e),o=d.internal_CreateHeaders(!0);o["x-sib-new-pwd-id"]=F;var i=d.internal_GetFileTag(r,t);i?o["If-Match"]=i:o["If-None-Match"]="*";var S=d.m_sServerUrl+"/rf-api/"+encodeURI(r)+"/"+t;d.makeRequestAsync(S,n,o,"POST",!1,!0,function(e,n){return St(l+".upload_UserDataRFO -> upLoadOFS_callback",p,c.FUNC_INOUT),u(55),d.misc_checkHttpResponse(e,n,f)?e.status==Ae?(typeof f!=_&&f(new tt(e.status,e.statusText,void 0,e,void 0)),u(De),!1):e.status==ge?(typeof f!=_&&f(new tt(e.status,e.statusText,void 0,e,void 0)),u(De),!1):(d.internal_PutFileTag(e.getResponseHeader("eTag"),r,t),void function(e){var t=[];t.push(rt.APP_DATA),t.push(rt.SYNC_DATA);var r=t.length;function a(t,a,n){if(St(l+".upload_AppSyncRFO.  #STEP 2.2# file='"+a+"' account='"+n+"'",p,c.FUNC_INOUT),!t)return u(45+20*(2- --r)),void(r||M());d.ObjectOFSToBytes(t,function(t){D.ofs_ClearCacheForAccount(n,a),D.ofs_SetData(e.salt,e.key,e.iterations,a,n,s),D.EncodeZipOFSBytes(t,a,n,s,be,!0,function(e){St(l+". Step 2.2  encrypt_Ok callback ->",p,c.FUNC_INOUT);var t=new Uint8Array(e),s=d.internal_CreateHeaders(!0);s["x-sib-new-pwd-id"]=F;var o=d.internal_GetFileTag(n,a);o?s["If-Match"]=o:s["If-None-Match"]="*";var i=d.m_sServerUrl+"/rf-api/"+encodeURI(n)+"/"+a;d.makeRequestAsync(i,t,s,"POST",!1,!0,function(e,t){return St(l+".upload_AppSyncRFO 2.2 -> upLoadOFS_callback",p,c.FUNC_INOUT),u(45+20*(2- --r)),d.misc_checkHttpResponse(e,t,f)?e.status==Ae?(u(De),typeof f!=_&&f(new tt(e.status,e.statusText,void 0,e,void 0)),!1):e.status==ge?(u(De),typeof f!=_&&f(new tt(e.status,e.statusText,void 0,e,void 0)),!1):(d.internal_PutFileTag(e.getResponseHeader("eTag"),n,a),void(r||M())):(St(l+".upload_AppSyncRFO 2.2 -> upLoadOFS_callback failed. Return false.",p,c.SPECIAL_CASE),u(De),!1)})},function(e){St(l+". Step 2.2  encrypt_Error callback ->",p,c.FUNC_INOUT),typeof f!=_&&f(e)})},function(e){typeof f!=_&&f(e)}),St(l+" upload_AppSyncRFO  # end of STEP 2.2 #",p,c.FUNC_INOUT)}function n(e){var t=d.m_sUserId;St(l+".get_AppSyncRFO.  #STEP 2.1# file='"+e+"' account='"+t+"'",p,c.FUNC_INOUT);var r=I.getDataByAccountId(e,t);r?(St(l+".get_AppSyncRFO #STEP 2.1# got JSON data from repo file='"+e+"' account='"+t+"'",p,c.FUNC_INOUT),a(r,e,t)):d[se](function(r){if(St(l+".get_AppSyncRFO. GetOFS_CallBack. #STEP 2.1# file='"+e+"' account='"+t+"' status="+r,p,c.FUNC_INOUT),r==Ee)a(I.getDataByAccountId(e,t),e,t);else if(404==r)return St(l+".get_AppSyncRFO. GetOFS_CallBack. NO FILE ON SERVER->return. #STEP 2.1# file='"+e+"' account='"+t+"' status="+r,p,c.FUNC_INOUT),void a(null,e,t)},f,e,t),St(l+" get_AppSyncRFO  # end of STEP 2.1 #",p,c.FUNC_INOUT)}for(var o=0;o<t.length;o++)n(t[o])}(a)):(St(l+".upload_UserDataRFO -> upLoadOFS_callback failed. Return false.",p,c.SPECIAL_CASE),u(De),!1)})},function(e){St(l+". Step 1  encrypt_Error callback ->",p,c.FUNC_INOUT),typeof f!=_&&f(e)})},function(e){typeof f!=_&&f(e)}),St(l+" upload_UserDataRFO  # end of STEP 1.2#",p,c.FUNC_INOUT)}function a(){var t=d.m_sUserId,r=rt.USER_DATA;St(l+".get_UserDataRFO.  #STEP 1.1# file='"+r+"' account='"+t+"'",p,c.FUNC_INOUT);var a=I.getDataByAccountId(r,t);a?(St(l+".get_UserDataRFO #STEP 1.1# got JSON data from repo file='"+r+"' account='"+t+"'",p,c.FUNC_INOUT),e(a,r,t)):d[se](function(a){if(St(l+".get_UserDataRFO. GetOFS_CallBack. #STEP 1.1# file='"+r+"' account='"+t+"' status="+a,p,c.FUNC_INOUT),a==Ee)e(I.getDataByAccountId(r,t),r,t);else if(404==a)return St(l+".get_UserDataRFO. GetOFS_CallBack. NO FILE ON SERVER->return. #STEP 1.1# file='"+r+"' account='"+t+"' status="+a,p,c.FUNC_INOUT),typeof f!=_&&(u(De),f(new tt(N.RfErr_BadData,"user-data.rfo is missing"))),!1},f,r,t),St(l+" get_UserDataRFO  # end of STEP 1.1#",p,c.FUNC_INOUT)}!function(){var e=d.m_sUserId,s=rt.USER_DATA;St(l+".check_OldPwd ->  ##STEP 1##  file='"+s+"'  user='"+e+"'",p,c.FUNC_INOUT);var i=d.m_sServerUrl+"/rf-api/"+encodeURI(e)+"/"+s,S=new RfapiJS.SibHttpScramAuthClient;S.SetRealm("RoboForm Online Server");var y=S.GetAuthRequestHeader(e,o),R=d.internal_CreateHeaders();R.Authorization=y;for(var U=t.randomBytes(16),h=(new RfapiJS.SibScramAuthClient).CalcStoredInfo(r.stringToBytes(o),U,Me),I=h.item2,O=h.item3,m=0;m<O.length;m++)I.push(O[m]);var C=t.bytesToBase64(I);C=C.replace(new RegExp("=","g"),""),CryptoJS.MD5(CryptoJS.enc.Latin1.parse(n.bytesToString(U))).toString(CryptoJS.enc.hex);var v=t.bytesToBase64(U);v=v.replace(new RegExp("=","g"),"");var E={method:"SCRAM-SHA-256"};E.iterations=Me,E.salt=v,E.hash=C;var T=JSON.stringify(E);d.makeRequestAsync(i,T,R,"HEAD",!1,!1,function(e,t){if(St(l+".check_OldPwd ->  makeRequestAsync callback ->",p,c.FUNC_INOUT),u(20),e.status==Ne){var r=e.getResponseHeader("WWW-Authenticate");if(!r)return;var n=RfapiJS.SibHttpGetAuthMethod(r);S.ParseServerResponse(n)&&(y=S.GetAuthRequestHeader(d.m_sUserId,o),R.Authorization=y,u(22),d.makeRequestAsync(i,T,R,"HEAD",!1,!1,function(e,t){return St(l+".check_OldPwd. SECOND makeRequestAsync callback2->",p,c.FUNC_INOUT),u(24),401==e.status?(typeof f!=_&&(u(De),f(new tt(N.RfErr_AuthRejected,"Wrong Old Password"))),!1):d.misc_checkHttpResponse(e,t,f)?void(e.status==Ee&&a()):(St(l+".check_OldPwd.. checkHttpResponse failed. Return false.",p,c.SPECIAL_CASE),u(De),!1)}))}else if(e.status==Ee)a();else if(u(21),!d.misc_checkHttpResponse(e,t,f))return St(l+".check_OldPwd.. checkHttpResponse failed. Return false.",p,c.SPECIAL_CASE),u(De),!1})}()}()}return void St(Pe+l,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(l,e,f),u(De)}},at.prototype.SetTemporaryPassword=function(s,o,i,f,u){var l="RfDataManager.SetTemporaryPassword";u||(u=function(e){});try{var d=this;St(Fe+l+" target_account_id='"+s+"'  newPwd='"+o+"'",p,c.FUNC_INOUT);d.getAccountMode();if(!d.misc_checkParameters({SERVER_URL:d.m_sServerUrl,USER_ID:d.m_sUserId,ACCOUNT:s,NEW_PASSWORD:o},f))return St(l+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),u(De),!1;if(!d.internal_isPasswordCorrect(o,f,u))return!1;u(5);for(var S=t.randomBytes(16),y=(new RfapiJS.SibScramAuthClient).CalcStoredInfo(r.stringToBytes(o),S,Me),R=y.item2,U=y.item3,h=0;h<U.length;h++)R.push(U[h]);var m=t.bytesToBase64(R);m=m.replace(new RegExp("=","g"),"");var C=CryptoJS.MD5(CryptoJS.enc.Latin1.parse(n.bytesToString(S))).toString(CryptoJS.enc.hex),v=t.bytesToBase64(S);v=v.replace(new RegExp("=","g"),"");var E=null!=d.m_OFSMgr?d.m_OFSMgr:new RfapiJS.CRfOneFileSys;function T(e,r,n,o){St(l+". reGrantGroupsforTargetAccount. Step 9. ->",p,c.INFO),u(95);for(var S=r.length,y=0;y<r.length;y++){for(var R=r[y],U=R[RfapiJS.ACCOUNT_ID_PROP],h=!1,I=0;I<n.length;I++)if(U==n[I].accountId){h=!0;break}if(h){var O=R.mp,m=t.base64ToBytes(O),C=t.bytesToHex(m),v=new RSAKey,E=a.GetHexFromPEM(o,!1);v.setPrivateEx(E.modulus,E.exponent,E.privateexp,E.P,E.Q,E.DP,E.DQ,E.InverseQ);var T=v.decrypt(C);if(!T)return typeof f!=_&&f(new tt(N.RfErr_BadData,"Decrypted password is empty")),!1;var A=a.GetHexFromPEM(e,!0),g=new RSAKey;g.setPublic(A.modulus,A.exponent);var F=g.encrypt(T),P=t.bytesToBase64(t.hexToBytes(F)),D={};D[Xe]=s,D.mp=P;var k=JSON.stringify(D),b=d.m_sServerUrl+"/rf-api/"+encodeURI(U)+"?grantaccount";d.internal_RequestAsync(q,b,k,d.internal_CreateHeaders(),"POST",!1,!1,!1,{},function(e){return St(l+". grant_OKCallBack.inner_OK Step 9. -> ResponseText='"+e+"'",p,c.INFO),--S||(u(De),i(200)),!0},function(e){return St(l+". grant_ErrorCallBack.inner_Error Step 9. -> ",p,c.INFO),S--,typeof f!=_&&(f(e),u(De)),!1})}else S--}S||(u(De),i(200)),St(l+". reGrantGroupsforTargetAccount. Step 9. ->",p,c.INFO)}function A(e,t,r){if(St(l+". getAdminPrivateKey. Step 8. ->",p,c.INFO),u(90),!r||!r.length)return u(De),void i(200);if(I.getDataByAccountId(rt.USER_DATA,d.m_sUserId)){St(l+".getAdminPrivateKey. Step 8. got private key from repo",p,c.FUNC_INOUT);var a=I.getPrivateKey();T(e,t,r,a)}else d[se](function(a){var n=I.getPrivateKey();T(e,t,r,n)},f)}function g(e){St(l+". uploadPublicKey. Step 6. -> ",p,c.INFO),d[B](e,function(t){var r;return St(l+". uploadPublicKey.inner_OK Step 6. -> ResponseText='"+t+"'",p,c.INFO),u(85),r=e,St(l+". getChangedUserAccountInfo. Step 7. ->",p,c.INFO),u(86),d[L](function(e,t){St(l+".GetAccounts_AnswerCallBack -> Step 7. HttpStatus="+t,p,c.FUNC_INOUT);var a=e.accounts;if(!a||!a.length)return u(De),void i(200);for(var n=a.length,o=[],S=0;S<a.length;S++){var y=a[S].accountId;d[w](y,function(e,t,i){St(l+". getRecipients_Ok Step 7. -> responseAccountId="+i,p,c.INFO),n--;for(var f=e.accounts,u=0;u<f.length;u++){var _=f[u];if(_.accountId==s){o.push({accountId:i,isManager:_.isManager,readOnly:_.readOnly,showPasswords:_.showPasswords,serverOnly:_.serverOnly});break}}n||A(r,a,o)},function(){return St(l+". getRecipients_Error Step 7. -> ",p,c.INFO),n--,typeof f!=_&&(f(errObject),u(De)),!1})}},function(e){return typeof f!=_&&f(e),!1}),St(l+". getCompanyMemberAccountInfo. Step 7. ->",p,c.INFO),!0},function(e){return St(l+". uploadPublicKey.inner_Error Step 6. -> ",p,c.INFO),typeof f!=_&&(f(e),u(De)),!1},s),St(l+". uploadPublicKey. Step 6. <- ",p,c.INFO)}function F(e){var t;St(l+". uploadOFS. Step 4. -> ",p,c.INFO),u(35);var r=[];r.push(rt.USER_DATA),r.push(rt.APP_DATA),r.push(rt.SYNC_DATA);var n,i=r.length;function S(r,n,S){var y;if(St(l+".upload_AppSyncUserRFO.  #STEP 4.2# file='"+r+"' account='"+n+"' eTag="+S,p,c.FUNC_INOUT),r==rt.APP_DATA||r==rt.SYNC_DATA)y={};else if(r==rt.USER_DATA){var R=a.GenerateKeysWithCheck(1024);t=R.Public_Pem;var U=R.Private_Pem,h=Math.round(new Date/1e3);y={i:{F:!0},c:[{b:U,i:{n:"private-key.pem",c:h,m:h,s:U.length,f:!0}},{i:{F:!0,n:"root"},c:[]}]}}d.ObjectOFSToBytes(y,function(a){E.ofs_ClearCacheForAccount(n,r),E.EncodeZipOFSBytes(a,r,n,o,be,!0,function(a){St(l+". Step 4. encrypt_Ok callback ->",p,c.FUNC_INOUT);var o=new Uint8Array(a),y=d.internal_CreateHeaders(!0);y["x-sib-new-pwd-id"]=C,S?y["If-Match"]=S:y["If-None-Match"]="*";var R=d.m_sServerUrl+"/rf-api/"+encodeURI(n)+"/"+r;d.makeRequestAsync(R,o,y,"POST",!1,!0,function(r,a){return St(l+".upload_AppSyncUserRFO 4.2 -> upLoadOFS_callback",p,c.FUNC_INOUT),u(40+20*(2- --i)),d.misc_checkHttpResponse(r,a,f)?r.status==Ae?(u(De),typeof f!=_&&f(new tt(r.status,r.statusText,void 0,r,void 0)),!1):r.status==ge?(u(De),typeof f!=_&&f(new tt(r.status,r.statusText,void 0,r,void 0)),!1):void(i||function(e,t){St(l+". changeOneFileAccountPassword. Step 5. -> ",p,c.INFO),u(81);var r={method:"SCRAM-SHA-256"};r.iterations=Me,r.salt=v,r.hash=m,e&&e.length&&(r.trustedUsers=e);var a=JSON.stringify(r),n=d.m_sServerUrl+"/rf-api/"+encodeURI(s)+"?set-account-pwd",o=3;!function e(r,a,n){if(St(l+" changeOneFileAccountPassword. tryToLogin->  nCounter="+--o,p,c.FUNC_INOUT),!o)return u(De),typeof f!=_&&f(new tt(401,"Cannot auth to account "+s,void 0,void 0,void 0)),!1;var i=new RfapiJS.SibHttpScramAuthClient;i.SetRealm("RoboForm Online Server");var S=i.GetAuthRequestHeader(d.m_sUserId,d.m_sMasterPwd),y=d.internal_CreateHeaders();y.Authorization=S,d.makeRequestAsync(r,a,y,n,!1,!1,function(s,_){if(St(l+" changeOneFileAccountPassword. FIRST makeRequestAsync callBack_First->",p,c.FUNC_INOUT),s.status==Ne){var S=s.getResponseHeader("WWW-Authenticate");if(S){var R=RfapiJS.SibHttpGetAuthMethod(S);if(i.ParseServerResponse(R)){var U=i.GetAuthRequestHeader(d.m_sUserId,d.m_sMasterPwd);y.Authorization=U,u(83),d.makeRequestAsync(r,a,y,n,!1,!1,function(s,i){if(St(l+".changeOneFileAccountPassword. SECOND makeRequestAsync callBack_Second->  status="+s.status,p,c.FUNC_INOUT),s.status==Ee)return St(l+". changeOneFileAccountPassword (change to new complete): SUCCESSFUL!!!",p,c.INFO),u(84),o=0,void g(t);s.status!=Ne||e(r,a,n)})}}}else if(s.status==Ee)o=0,g(t);else if(u(99),!d.misc_checkHttpResponse(s,_,f))return St(l+".changeOneFileAccountPassword. checkHttpResponse failed. Return false.",p,c.SPECIAL_CASE),u(De),!1})}(n,a,"POST"),St(l+". changeOneFileAccountPassword. Step 5. <- ",p,c.INFO)}(e,t)):(St(l+".upload_AppSyncUserRFO 4.2 -> upLoadOFS_callback failed. Return false.",p,c.SPECIAL_CASE),u(De),!1)})},function(e){St(l+". Step 4. encrypt_Error callback ->",p,c.FUNC_INOUT),typeof f!=_&&f(e)})},function(e){typeof f!=_&&f(e)}),St(l+" upload_AppSyncUserRFO  # end of STEP 4.2 #",p,c.FUNC_INOUT)}for(var y=0;y<r.length;y++)n=r[y],St(l+".get_AppSyncUserRFO.  #STEP 4.1# file='"+n+"' account='"+s+"'",p,c.FUNC_INOUT),d[te](function(e,t,r,a){St(l+".get_AppSyncUserRFO. CheckoutOFS_CallBack. #STEP 4.1# file='"+t+"' account='"+r+"' status="+e+" eTag="+a,p,c.FUNC_INOUT),S(t,r,a)},f,n,s),St(l+" get_AppSyncUserRFO  # end of STEP 4.1 #",p,c.FUNC_INOUT);St(l+". uploadOFS. Step 4. <- ",p,c.INFO)}function P(e){u(30),St(l+". eraseTargetUserPublicKey. Step 3. -> ",p,c.INFO),d[B]("",function(t,r){St(l+". erasePublicKey_Ok. Step 3. -> ",p,c.INFO),F(e),St(l+". erasePublicKey_Ok. Step 3. Goto step 4.. <-",p,c.INFO)},function(e){St(l+". erasePublicKey_Error. Step 3. -> ",p,c.INFO),typeof f!=_&&f(e)},s),St(l+". eraseTargetUserPublicKey. Step 3. <- ",p,c.INFO)}u(10),St(l+". getTrustedUsersList. Step 1. -> ",p,c.INFO),u(15),d[b](function(r){St(l+". getTrusted_Ok. Step 1. -> ",p,c.INFO);var n=r.trustedUsers;if(!n||!n.length)return P([]),void St(l+". getTrusted_Ok. Step 1. No trusted users. Goto Step 3.. <-",p,c.INFO);!function(r){try{u(25),St(l+". encryptNewPasswordByUserPublicKey. Step 2. ->",p,c.INFO);for(var n=o,s=[],i=0;i<r.length;i++){var d=r[i],S=d.publicKey,y=CryptoJS.MD5(S).toString(CryptoJS.enc.hex),R=new RSAKey,U=a.GetHexFromPEM(S,!0);R.setPublic(U.modulus,U.exponent);var h=R.encrypt(n),I=t.bytesToBase64(t.hexToBytes(h)),m={};m.accountId=d.accountId,m.mp=I,m.publicKeyHash=y,s.push(m)}P(s),St(l+". encryptNewPasswordByUserPublicKey. Step 2. Goto Step 3...<-",p,c.INFO)}catch(t){Rt("EXCEPTION in "+l+".encryptNewPasswordByUserPublicKey: "+e.toString(),p),typeof f!=_&&f({Code:O.SibTErr_LocalErr,Description:"EXCEPTION in encryptNewPasswordByUserPublicKey:"+e.toString()})}}(n),St(l+". getTrusted_Ok. Step 1. Goto Step 2. users="+n.length+" <-",p,c.INFO)},function(e){St(l+". getTrusted_Error. Step 1. -> ",p,c.INFO),typeof f!=_&&f(e)},s),St(l+". getTrustedUsersList. Step 1. <- ",p,c.INFO)}catch(e){this.internal_catchedException(l,e,f),u(De)}},at.prototype.ResetAccountPwd=function(e,n,s,o,i,f,u){var l="RfDataManager.ResetAccountPwd";u||(u=function(e){});try{var d=this;if(St(Fe+l+" newPwd='"+n+"' for account='"+s+"'",p,c.FUNC_INOUT),!d.misc_checkParameters({SERVER_URL:d.m_sServerUrl,PVC_CODE:e,NEW_PASSWORD:n},f))return St(l+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),u(De),!1;if(!d.internal_isPasswordCorrect(n,f,u))return!1;function S(e,t){St(l+".MakeKeysUploadOFS #STEP 4#",p,c.FUNC_INOUT),u(75);var r=a.GenerateKeysWithCheck(1024),o=r.Public_Pem,S=r.Private_Pem,y=Math.round(new Date/1e3),R={i:{F:!0},c:[{b:S,i:{n:"private-key.pem",c:y,m:y,s:S.length,f:!0}},{i:{F:!0,n:"root"},c:[]}]};u(80),s==d.m_sUserId&&(I.Reset(),I.setUser(d.m_sUserId));var U=null!=d.m_OFSMgr?d.m_OFSMgr:new RfapiJS.CRfOneFileSys,h=rt.USER_DATA;d.ObjectOFSToBytes(R,function(t){U.ofs_ClearCacheForAccount(s),U.EncodeZipOFSBytes(t,h,s,n,be,!0,function(t){St(l+". MakeKeysUploadOFS #STEP 4#  encrypt_Ok callback ->",p,c.FUNC_INOUT);var r=new Uint8Array(t),a=d.internal_CreateHeaders(!0);e?a["If-Match"]=e:a["If-None-Match"]="*";var n=d.m_sServerUrl+"/rf-api/"+encodeURI(s)+"/"+h;d.makeRequestAsync(n,r,a,"POST",!1,!0,function(e,t){return St(l+". makeRequestAsync.saveOFS_callback ->",p,c.FUNC_INOUT),d.misc_checkHttpResponse(e,t,f)?e.status==Ae?(typeof f!=_&&f(new tt(e.status,e.statusText,void 0,e,void 0)),u(De),!1):e.status==ge?(typeof f!=_&&f(new tt(e.status,e.statusText,void 0,e,void 0)),u(De),!1):(d.internal_PutFileTag(e.getResponseHeader("eTag"),s,h),s==d.m_sUserId&&I.setData(R,rt.USER_DATA,d.m_sUserId),void d[B](o,function(e){return St(l+".logOffAfterReset #STEP 5#",p,c.FUNC_INOUT),u(95),d[g](1,function(e){return typeof i!=_&&(i(e),u(De)),!0},function(e){return typeof f!=_&&(f(e),u(De)),!1}),St(l+".logOffAfterReset #END OF STEP 5#",p,c.FUNC_INOUT),!0},function(e){return typeof f!=_&&(f(e),u(De)),!1},s)):(St(l+". makeRequestAsync.saveOFS_callback failed. Return false.",p,c.SPECIAL_CASE),u(De),!1)})},function(e){St(l+". MakeKeysUploadOFS #STEP 4#  encrypt_Error callback ->",p,c.FUNC_INOUT),typeof f!=_&&f(e)})},function(e){typeof f!=_&&f(e)}),St(l+".MakeKeysUploadOFS #END OF STEP 4#",p,c.FUNC_INOUT)}function y(){St(l+".getOFSeTag #STEP 3#",p,c.FUNC_INOUT),u(60),d[oe](function(e,t){St(l+".getOFSeTag  getETag_AnswerCallback. #STEP 3#",p,c.FUNC_INOUT),S(e)},function(e){return St(l+".getOFSeTag  getETag_ErrorCallback. #STEP 3#",p,c.FUNC_INOUT),typeof f!=_&&(f(e),u(De)),!1},rt.USER_DATA,s),St(l+".getOFSeTag #END OF STEP 3#",p,c.FUNC_INOUT)}return u(10),o?(u(30),function(){St(l+".resetPwd # STEP 1# (MULTI)",p,c.FUNC_INOUT),u(45);var t=CryptoJS.MD5(n).toString(CryptoJS.enc.hex),r={};r.code=e,r.password=t;var a=JSON.stringify(r),s=d.m_sServerUrl+"/rf-api/?resetpwd",o=d.internal_CreateHeaders();u(80),d.makeRequestAsync(s,a,o,"POST",!1,!1,function(e,t){if(St(l+".resetPwd resetPwd_callback.  #STEP 1# ",p,c.FUNC_INOUT),u(De),!d.misc_checkHttpResponse(e,t,f))return St(l+".resetPwd resetPwd_callback failed. Return false.",p,c.SPECIAL_CASE),!1;typeof i!=_&&i(e.status)}),St(l+".resetPwd # END OF STEP 1# (MULTI)",p,c.FUNC_INOUT)}()):(u(15),function(){St(l+".makeSaltHashKeys #STEP 1#",p,c.FUNC_INOUT);for(var a=t.randomBytes(16),o=(new RfapiJS.SibScramAuthClient).CalcStoredInfo(r.stringToBytes(n),a,Me),i=o.item2,S=o.item3,R=0;R<S.length;R++)i.push(S[R]);var U=t.bytesToBase64(i);U=U.replace(new RegExp("=","g"),"");var h=t.bytesToBase64(a);h=h.replace(new RegExp("=","g"),"");var I={method:"SCRAM-SHA-256"};I.iterations=Me,I.salt=h,I.hash=U,I.code=e,u(25);var O=new RfapiJS.CRfOneFileSys;d.ObjectOFSToBytes({i:{F:!0},c:[{i:{F:!0,n:"root"},c:[]}]},function(e){O.ofs_ClearAccountsCache(),O.EncodeZipOFSBytes(e,rt.USER_DATA,void 0,n,be,!0,function(e){St(l+". Step 1  encrypt_Ok callback ->",p,c.FUNC_INOUT);var r=new Uint8Array(e),a=t.bytesToBase64(r);I.emptyOneFile=a,u(35);var o=JSON.stringify(I),i=d.m_sServerUrl+"/rf-api/?resetpwd",S=d.internal_CreateHeaders();d.makeRequestAsync(i,o,S,"POST",!1,!1,function(e,t){if(St(l+".makeSaltHashKeys resetPwd_callback.  #STEP 1# ",p,c.FUNC_INOUT),!d.misc_checkHttpResponse(e,t,f))return St(l+".makeSaltHashKeys resetPwd_callback failed. Return false.",p,c.SPECIAL_CASE),u(De),!1;var r=JSON.parse(e.responseText);s=r.email,St(l+".logintoAccount #STEP 2#",p,c.FUNC_INOUT),u(40),d[A](s,n,20,void 0,void 0,void 0,function(e,t){t&&t.updateTrustedUsers?d[k](function(e){St(l+".logintoAccount  updateTrustedUsers. OK_callback #STEP 2#",p,c.FUNC_INOUT),y()},function(e){return St(l+".logintoAccount  updateTrustedUsers. Error_callback #STEP 2#",p,c.FUNC_INOUT),typeof f!=_&&(f(e),u(De)),!1}):y()},function(e){return St(l+".logintoAccount  login_ErrorCallback. #STEP 2#",p,c.FUNC_INOUT),typeof f!=_&&(f(e),u(De)),!1}),St(l+".logintoAccount #END OF STEP 2#",p,c.FUNC_INOUT)})},function(e){St(l+". Step 1. encrypt_Error callback ->",p,c.FUNC_INOUT),typeof f!=_&&f(e)})},function(e){typeof f!=_&&f(e)}),St(l+".makeSaltHashKeys # END OF STEP 1#",p,c.FUNC_INOUT)}()),void St(Pe+l,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(l,e,f),u(De)}},at.prototype.GetConsumerServers=function(e,t){var r="RfDataManager.GetConsumerServers";if(St(Fe+r,p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl},t))return St(r+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;this.DoGetServers("/servers",e,t),St(Pe+r,p,c.FUNC_INOUT)},at.prototype.GetBusinessServers=function(e,t){var r="RfDataManager.GetBusinessServers";if(St(Fe+r,p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl},t))return St(r+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;this.DoGetServers("/servers?business-servers",e,t),St(Pe+r,p,c.FUNC_INOUT)},at.prototype.GetAllServers=function(e,t){var r="RfDataManager.GetAllServers";if(St(Fe+r,p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl},t))return St(r+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;this.DoGetServers("/servers?all-servers",e,t),St(Pe+r,p,c.FUNC_INOUT)},at.prototype.DoGetServers=function(e,t,r){try{var a=this.m_sServerUrl+e;this.internal_RequestAsync("DoGetServers",a,null,this.internal_CreateHeaders(),"GET",!1,!1,!1,{},t,r)}catch(e){this.internal_catchedException("RfDataManager.DoGetServers",e,r)}},at.prototype[Se]=function(e,t,r,a,n,s,o,i,f,u){var l=Se,d="RfDataManager."+l;try{St(Fe+d+" path='"+e+"'",p,c.FUNC_INOUT);var S=this.getAccountMode();if(!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER_ID:this.m_sUserId,ACCOUNT_MODE:S},r))return St(d+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var y={};if(y[Be]={},y[Be][Ge]="list",y[Be][xe]=e,typeof n!=_&&""!=n&&(y[Be][qe]=parseInt(n)),typeof a!=_&&""!=a&&(y[Be][Le]=a),typeof s!=_&&1==s&&(y[Be][He]=s),typeof o!=_&&1==o&&(y[Be].iconMime="x-icon"),S==m.OFS)typeof i!=_&&(y[Be].bExcludeShared=i),typeof f!=_&&(y[Be].bBody=f),this.internal_RepositoryAction(y,l,t,r,rt.USER_DATA,u);else if(S==m.MULTIFILE){var R=JSON.stringify(y);this.internal_RequestAsync(l,this.internal_CreateRequestUrl(),R,this.internal_CreateHeaders(),"POST",!1,!1,!0,{},t,r)}return void St(Pe+d,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(d,e,r)}},at.prototype[le]=function(e,t,r,a,n,s){var o=le,i="RfDataManager."+o;try{St(Fe+i+" path='"+e+"'",p,c.FUNC_INOUT);var f=this.getAccountMode();if(!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER_ID:this.m_sUserId,ACCOUNT_MODE:f},r))return St(i+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;St(i+". path='"+e+"' parts='"+(n=typeof n==_?0:""==n?0:parseInt(n))+"' type='"+a+"' iconMime='"+(s=typeof s==_?"":1==s?"x-icon":"")+"'",p,c.INFO);var u={};if(u[Be]={},u[Be][Ge]="getinfo",u[Be][xe]=e,u[Be][qe]=n,typeof a!=_&&(u[Be][Le]=a),typeof s!=_&&(u[Be].iconMime=s),f==m.MULTIFILE){var l=JSON.stringify(u);this.internal_RequestAsync(o,this.internal_CreateRequestUrl(),l,this.internal_CreateHeaders(),"POST",!1,!1,!0,{},t,r)}else f==m.OFS&&this.internal_RepositoryAction(u,o,t,r,rt.USER_DATA);St(Pe+i,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(i,e,r)}},at.prototype[pe]=function(e,t,r,a,n,s,o){var i=pe,f="RfDataManager."+i;try{St(Fe+f+" path='"+e+"'  bExcludeShared='"+o+"' bDeep='"+s+"'",p,c.FUNC_INOUT);var u=this.getAccountMode();if(!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER_ID:this.m_sUserId,ACCOUNT_MODE:u},r))return St(f+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var l={};if(l[Be]={},l[Be][Ge]="count",l[Be][xe]=e,typeof a!=_&&(l[Be][Le]=a),typeof n!=_&&(l[Be][qe]=n),typeof s!=_&&(l[Be][He]=s),typeof o!=_&&o&&(l[Be].bExcludeShared=o),u==m.OFS)this.internal_RepositoryAction(l,i,t,r,rt.USER_DATA);else if(u==m.MULTIFILE){var d=JSON.stringify(l);this.internal_RequestAsync(i,this.internal_CreateRequestUrl(),d,this.internal_CreateHeaders(),"POST",!1,!1,!0,{},t,r)}return void St(Pe+f,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(f,e,r)}},at.prototype[ue]=function(e,t,r,a,n){var s=ue,o="RfDataManager."+s;try{St(Fe+o+" URL='"+e+"'",p,c.FUNC_INOUT);var i=this.getAccountMode();if(!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER_ID:this.m_sUserId,ACCOUNT_MODE:i,URL:e},r))return St(o+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var f={};if(f[Be]={},f[Be][Ge]="getdomainpasscards",f[Be].url=e,typeof a!=_&&(f[Be][Le]=a),i==m.OFS)typeof n!=_&&(f[Be].bExcludeShared=n),this.internal_RepositoryAction(f,s,t,r,rt.USER_DATA);else if(i==m.MULTIFILE){var u=JSON.stringify(f);this.internal_RequestAsync(s,this.internal_CreateRequestUrl(),u,this.internal_CreateHeaders(),"POST",!1,!1,!0,{},t,r)}St(Pe+o,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(o,e,r)}},at.prototype[fe]=function(e,t,r,a,n,s,o){var i=fe,f="RfDataManager."+i;try{St(Fe+f+" URL='"+e+"'",p,c.FUNC_INOUT);var u=this.getAccountMode();if(!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER_ID:this.m_sUserId,ACCOUNT_MODE:u,URL:e},r))return St("RfDataManager."+i+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var l={};if(l[Be]={},l[Be][Ge]="getmatchingpasscards",l[Be].url=e,typeof a!=_&&(l[Be][Le]=a),typeof n!=_&&(l[Be].matchLevelMin=n),typeof s!=_&&(l[Be].matchLevelMax=s),typeof o!=_&&(l[Be][qe]=o),u==m.OFS)this.internal_RepositoryAction(l,i,t,r,rt.USER_DATA);else if(u==m.MULTIFILE){var d=JSON.stringify(l);this.internal_RequestAsync(i,this.internal_CreateRequestUrl(),d,this.internal_CreateHeaders(),"POST",!1,!1,!0,{},t,r)}return void St(Pe+f,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(f,e,r)}},at.prototype.DeleteAllObjects=function(e,t){var r="RfDataManager.DeleteAllObjects";try{St(Fe+r,p,c.FUNC_INOUT);var a=this.getAccountMode();if(!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER_ID:this.m_sUserId},t))return St(r+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;if(a!=m.OFS)return St(r+". MODE IS NOT OFS. Return false.",p,c.INFO),!1;var n={};return n[Be]={},n[Be][Ge]="deleteall",this.internal_RepositoryAction(n,"DeleteAllObjects",e,t,rt.USER_DATA),void St(Pe+r,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(r,e,t)}},at.prototype[he]=function(e,t,r,a,n,s){var o=he,i="RfDataManager."+o;try{St(Fe+i,p,c.FUNC_INOUT);var f=this,u=f.getAccountMode();if(!f.misc_checkParameters({SERVER_URL:f.m_sServerUrl,USER_ID:f.m_sUserId,PATH:e,ACCOUNT_MODE:u},a))return St(i+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var l={};if(l[Be]={},l[Be][Ge]="delete",l[Be][xe]=e,typeof t!=_&&""!=t&&(l[Be][Le]=t),u==m.OFS)return void I[le](l,function(e){if(e[RfapiJS.ITEM_SHARED_PROP])e.isAdmin||e.isManager?function(e){function t(){f[ne](function(e){St(i+"._resaveOFS. putOFS_AnswerCallback ->",p,c.FUNC_INOUT),typeof r!=_&&(St(i+"._resaveOFS. ***putOFS_AnswerCallback*** ->",p,c.FUNC_INOUT),r(e.status))},function(e){St(i+"._resaveOFS. ***putOFS_ErrorCallback*** ->",p,c.FUNC_INOUT),typeof a!=_&&a(e)})}function o(e,t,r,a){f[K](e,t,function(e){r(e)},function(e){a(e)})}function u(e,t){s?l(e,t):I.getDataByAccountId(rt.USER_DATA,e)?l(e,t):f[se](function(r,n){St(i+"._getSharedAccountData.getAccount_OkCallBack.",p,c.FUNC_INOUT),r!=Ee?r==Te?typeof a!=_&&a({Code:r,Description:rt.USER_DATA+" for '"+n+"' not found."}):typeof a!=_&&a({Code:r,Description:"Server error"}):l(e,t)},function(e){a(e)},rt.USER_DATA,e,n)}function l(e,n){St("->"),s||I.stopSharingAccount(e),n?f[j](e,function(e,a){St("->",p,c.FUNC_INOUT),s?typeof r!=_&&r(e,a):t()},function(e){a(e)}):f[V](e,function(e,a){St("->",p,c.FUNC_INOUT),s?typeof r!=_&&r(e,a):t()},function(e){a(e)})}f[w](e.accountId,function(t,r,a){var n=t.accounts,s=!0,i=e.company;if(!i)for(var c=0;c<n.length;c++)if(!n[c].current&&n[c].accepted&&n[c].isManager){s=!1;break}for(var f=n.length,p=0;p<n.length;p++){var l=n[p],_=(l.recipientName,l.recipientEmail,l.accountId);l.current?--f||u(e.accountId,s):s?i?--f||u(e.accountId,s):o(e.accountId,_,function(t){--f||u(e.accountId,s)},function(t){--f||u(e.accountId,s)}):--f||u(e.accountId,s)}},function(e){return typeof a!=_&&a(e),!1})}(e[RfapiJS.ITEM_SHARED_PROP]):f[V](e[RfapiJS.ITEM_SHARED_PROP][RfapiJS.ACCOUNT_ID_PROP],r,a);else if(e.s){var t="G"!=e.s.substr(0,1),u=e.s.substr(1);t?function(e){var t=I.getGrantorForFileId(e);f[Q](t,e,function(e){f.internal_RepositoryAction(l,o,function(e){f[$](function(e){typeof r!=_&&r(e)},a)},a,rt.USER_DATA,n)},function(e){typeof a!=_&&a(e)},void 0,!0)}(u):function(e){function t(e,t,r,a){f[Y](e,t,function(e){r(e)},function(e){a(e)},!0)}f[ee](e,function(s,i){for(var c=s.grantedFiles,u=c.length,p=0;p<c.length;p++)t(c[p][Xe],e,function(e){--u||f.internal_RepositoryAction(l,o,function(){f[$](function(e){typeof r!=_&&r(e)},a)},a,rt.USER_DATA,n)},function(e){--u||f.internal_RepositoryAction(l,o,function(){f[$](function(e){typeof r!=_&&r(e)},a)},a,rt.USER_DATA,n)})},function(e){return typeof a!=_&&a(e),!1})}(u)}else f.internal_RepositoryAction(l,o,r,a,rt.USER_DATA,n)},function(e){typeof a!=_&&a(e)});if(u==m.MULTIFILE){var d=JSON.stringify(l);f.internal_RequestAsync(o,f.internal_CreateRequestUrl(),d,f.internal_CreateHeaders(),"POST",!1,!1,!0,{},r,a)}return void St(Pe+i,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(i,e,a)}},at.prototype[Ie]=function(e,t,r,a,n,s,o){var i=Ie,f="RfDataManager."+i;try{St(Fe+f+" FROM_path='"+e+"'  TO_path='"+r+"'",p,c.FUNC_INOUT);var u=this,l=u.m_nAccountMode;if(!u.misc_checkParameters({SERVER_URL:u.m_sServerUrl,USER_ID:u.m_sUserId,FROM_Path:e,TO_Path:r,ACCOUNT_MODE:l},s))return St(f+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;t=parseInt(t),a=parseInt(a);var d={};function S(l){if(St(f+". _MoveFile. Step 2.2. ->",p,c.INFO),l.s){var S=I.getAccountIdNameFromPath(e,t),y=I.getAccountIdNameFromPath(r,a);if(S.id!=y.id){var R="G"!=l.s.substr(0,1),U=l.s.substr(1);R?function(e){St(f+". _RejectGrantorForSharedFile. Step 3a. -> fileId='"+e+"'",p,c.INFO);var t=I.getGrantorForFileId(e);u[Q](t,e,function(e){St(f+". rejectSharedFile_OkCallback. Step 3a. ->",p,c.INFO),u.internal_RepositoryAction(d,i,n,s,rt.USER_DATA,o)},function(e){typeof s!=_&&s(e)},void 0,!0)}(U):function(e){function t(e,t,r,a){u[Y](e,t,function(e){r(e)},function(e){a(e)},!0)}u[ee](e,function(r,a){for(var c=r.grantedFiles,f=c.length,p=0;p<c.length;p++)t(c[p][Xe],e,function(e){--f||u.internal_RepositoryAction(d,i,n,s,rt.USER_DATA,o)},function(e){--f||u.internal_RepositoryAction(d,i,n,s,rt.USER_DATA,o)})},function(e){return typeof s!=_&&s(e),!1})}(U),St(f+". _MoveFile. Step 2.2. ->",p,c.INFO)}else u.internal_RepositoryAction(d,i,n,s,rt.USER_DATA,o)}else u.internal_RepositoryAction(d,i,n,s,rt.USER_DATA,o)}if(d[Be]={},d[Be][Ge]="move",d[Be][Ke]={},d[Be][Ke][xe]=e,d[Be][Ke][Le]=t,d[Be][Ve]={},d[Be][Ve][xe]=r,d[Be][Ve][Le]=a,l==m.MULTIFILE){var y=JSON.stringify(d);u.internal_RequestAsync(i,u.internal_CreateRequestUrl(),y,u.internal_CreateHeaders(),"POST",!1,!1,!0,{},n,s)}else l==m.OFS&&function(){St(f+". _GetItemInfoFrom. Step 1. ->",p,c.INFO);var a={request:{}};a.request.path=e,a.request.type=t,I[le](a,function(e){St(Fe+f+" .Answer_GetItemInfo_From ->",p,c.FUNC_INOUT),t==v.RfItemType_Folder?function(e){if(St(f+". _MoveFolder. Step 2.1. ->",p,c.INFO),e[RfapiJS.ITEM_SHARED_PROP]){St(Fe+f+" . Answer_GetItemInfo_From-> *SHARED*",p,c.FUNC_INOUT);var t=e[RfapiJS.ITEM_SHARED_PROP][RfapiJS.ACCOUNT_ID_PROP];return r.startsWith("/")&&(r=r.substr(1)),void u[J](t,n,s,r,void 0,void 0,void 0,(e.isAdmin||e.isManager)&&e.company?void 0:u.m_sUserId,void 0)}St(Fe+f+" . Answer_GetItemInfo_From-> *FOLDER*",p,c.FUNC_INOUT);var a={request:{}};a.request.path=r,I[le](a,function(e){St(Fe+f+" . Answer_GetItemInfo_To-> ",p,c.FUNC_INOUT),typeof s!=_&&s(new tt(N.RfErr_WrongParams,"File/Folder with the same name:'"+r+"' already exists"))},function(e){St(Fe+f+" . Error_GetItemInfo_To-> ",p,c.FUNC_INOUT),"NotFound"!=e.sibErr?typeof s!=_&&s(e):u.internal_RepositoryAction(d,i,n,s,rt.USER_DATA,o)})}(e):S(e)},function(e){typeof s!=_&&s(e)}),St(f+". _GetItemInfoFrom. Step 1. <-",p,c.INFO)}();return void St(Pe+f,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(f,e,s)}},at.prototype.CopyObject=function(e,t,r,a,n,s,o){var i="RfDataManager.CopyObject";try{St(Fe+i+" FROM_path='"+e+"'  TO_path='"+r+"'",p,c.FUNC_INOUT);var f=this.getAccountMode();if(!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER_ID:this.m_sUserId,OLD_PATHNAME:e,NEW_PATHNAME:r,ACCOUNT_MODE:f},s))return St(i+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;t=parseInt(t),a=parseInt(a);var u={};if(u[Be]={},u[Be][Ge]="copy",u[Be][Ke]={},u[Be][Ke][xe]=e,u[Be][Ke][Le]=t,u[Be][Ve]={},u[Be][Ve][xe]=r,u[Be][Ve][Le]=a,f==m.MULTIFILE){var l=JSON.stringify(u);this.internal_RequestAsync("CopyObject",this.internal_CreateRequestUrl(),l,this.internal_CreateHeaders(),"POST",!1,!1,!0,{},n,s)}else f==m.OFS&&this.internal_RepositoryAction(u,"CopyObject",n,s,rt.USER_DATA,o);return void St(Pe+i,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(i,e,s)}},at.prototype[Ue]=function(e,t,r,a){var n=Ue,s="RfDataManager."+n;try{St(Fe+s+" path='"+e+"'",p,c.FUNC_INOUT);var o=this.getAccountMode();if(!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER_ID:this.m_sUserId,PATH:e,ACCOUNT_MODE:o},r))return St(s+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;e=e.trim();var i={};if(i[Be]={},i[Be][Ge]="createfolder",i[Be].folder=e,o==m.OFS)this.internal_RepositoryAction(i,n,t,r,rt.USER_DATA,a);else if(o==m.MULTIFILE){var f=JSON.stringify(i);this.internal_RequestAsync(n,this.internal_CreateRequestUrl(),f,this.internal_CreateHeaders(),"POST",!1,!1,!0,{},t,r)}return void St(Pe+s,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(s,e,r)}},at.prototype[_e]=function(e,t,r,a,n){var s=_e,o="RfDataManager."+s;try{St(Fe+o+" path='"+e+"'",p,c.FUNC_INOUT);var i=this.getAccountMode();if(!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER_ID:this.m_sUserId,ACCOUNT_MODE:i,PATH:e},r))return St(o+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var f={};if(f[Be]={},f[Be][Ge]="getfile",f[Be][xe]=e,typeof a!=_&&(f[Be].used=a),typeof n!=_&&(f[Be].favorite=n),i==m.OFS)this.internal_RepositoryAction(f,s,t,r,rt.USER_DATA);else if(i==m.MULTIFILE){var u=JSON.stringify(f);this.internal_RequestAsync(s,this.internal_CreateRequestUrl(),u,this.internal_CreateHeaders(),"POST",!1,!1,!0,{},t,r)}return void St(Pe+o,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(o,e,r)}},at.prototype[ye]=function(e,t,r,a,n,s,o,i,f,u){var l=ye,d="RfDataManager."+l;try{St(Fe+d+" path='"+e+"' objType='"+t+"'",p,c.FUNC_INOUT);var S=this.getAccountMode();if(!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER_ID:this.m_sUserId,PATH:e,ACCOUNT_MODE:S},a))return St(d+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;t=parseInt(t);var y={};if(y[Be]={},y[Be][Ge]="getdataitem2",y[Be][xe]=e,y[Be][Le]=t,typeof n!=_&&""!=n&&(y[Be].level=parseInt(n)),typeof s!=_&&(y[Be].pwd=s),typeof o!=_&&(y[Be].allFields=o),typeof i!=_&&(y[Be].options=i),typeof f!=_&&(y[Be].used=f),typeof u!=_&&(y[Be].favorite=u),S==m.OFS)this.internal_RepositoryAction(y,l,r,a,rt.USER_DATA);else if(S==m.MULTIFILE){var R=JSON.stringify(y);this.internal_RequestAsync(l,this.internal_CreateRequestUrl(),R,this.internal_CreateHeaders(),"POST",!1,!1,!0,{},r,a)}return void St(Pe+d,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(d,e,a)}},at.prototype[Re]=function(e,t,r,a,n,s,o,i,f){var u=Re,l=this,d="RfDataManager."+u;try{St(Fe+d,p,c.FUNC_INOUT);var S=l.getAccountMode();if(!l.misc_checkParameters({SERVER_URL:l.m_sServerUrl,USER_ID:this.m_sUserId,ITEM:r,ACCOUNT_MODE:S,PATH:e},n))return St(d+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;e=e.trim(),t=parseInt(t);var y={};if(y[Be]={},y[Be][Ge]="putdataitem",y[Be][xe]=e,y[Be][Le]=t,S==m.OFS&&(delete r.p,delete r.pwd),y[Be].data=r,typeof s!=_&&(y[Be].used=s),typeof o!=_&&(y[Be].favorite=o),typeof i!=_&&(y[Be].s=i),S==m.OFS)!function(){St(d+". _GetItemInfo. Step 1. ->",p,c.INFO);var s={};s[Be]={},s[Be][xe]=e,s[Be][Le]=t,I[le](s,function(t){if(t.s){var s="G"!=t.s.substr(0,1),o=t.s.substr(1);s?l.internal_RepositoryAction(y,u,a,n,rt.USER_DATA,f):function(t){function s(t,a,n,s){l[X]({recipient:t,fileName:e,fileId:a,fileContent:JSON.stringify(r)},function(e){n(e)},function(e){s(e)},!0)}St(d+". _ReGrantFileToRecipients. Step 2. ->",p,c.INFO),l[ee](t,function(e,r){for(var o=e.grantedFiles,i=o.length,c=0;c<o.length;c++)s(o[c][Xe],t,function(e){--i||l.internal_RepositoryAction(y,u,function(){l[$](function(e){typeof a!=_&&a(e)},n)},n,rt.USER_DATA,f)},function(e){--i||l.internal_RepositoryAction(y,u,function(){l[$](function(e){typeof a!=_&&a(e)},n)},n,rt.USER_DATA,f)})},function(e){return typeof n!=_&&n(e),!1}),St(d+". _ReGrantFileToRecipients. Step 2. <-",p,c.INFO)}(o)}else l.internal_RepositoryAction(y,u,a,n,rt.USER_DATA,f)},function(e){y[Be].newItem=!0,l.internal_RepositoryAction(y,u,a,n,rt.USER_DATA,f)}),St(d+". _GetItemInfo. Step 1. <-",p,c.INFO)}();else if(S==m.MULTIFILE){var R=JSON.stringify(y);l.internal_RequestAsync(u,l.internal_CreateRequestUrl(),R,l.internal_CreateHeaders(),"POST",!1,!1,!0,{},a,n)}return void St(Pe+d,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(d,e,n)}},at.prototype.CreateDataItem=function(e,t,r,a,n,s){var o="RfDataManager.CreateDataItem";try{St(Fe+o+" objType='"+e+"'",p,c.FUNC_INOUT);var i=this.getAccountMode();if(!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER_ID:this.m_sUserId,ACCOUNT_MODE:i,TYPE:e},r))return St(o+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;e=parseInt(e);var f={};if(f[Be]={},f[Be][Ge]="createdataitem2",f[Be][Le]=e,typeof a!=_&&(f[Be].country=a),typeof n!=_&&(f[Be].phonePrefixMode=n),typeof s!=_&&(f[Be].appUpload=s),i==m.OFS)return void I.CreateDataItem(f,function(e){return e?(St(o+". RepAnswerCallBack. Repository returned result="+e,p,c.FUNC_INOUT),typeof t!=_&&t(e,Ee),!0):(typeof r!=_&&r(new tt(void 0,ve,void 0,void 0,"NotFound")),!1)},function(e){return typeof r!=_&&r(e),!1});if(i==m.MULTIFILE){var u=JSON.stringify(f);this.internal_RequestAsync("CreateDataItem",this.internal_CreateRequestUrl(),u,this.internal_CreateHeaders(),"POST",!1,!1,!0,{},t,r)}return void St(Pe+o,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(o,e,r)}},at.prototype.GetOptions=function(e,t){var r="RfDataManager.GetOptions";try{St(Fe+r,p,c.FUNC_INOUT);var a=this.getAccountMode();if(!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER_ID:this.m_sUserId,ACCOUNT_MODE:a},t))return St(r+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var n={};if(n[Be]={},n[Be][Ge]="getoptions",a==m.OFS)throw"Not Implemented";if(a==m.MULTIFILE){var s=JSON.stringify(n);this.internal_RequestAsync("GetOptions",this.internal_CreateRequestUrl(),s,this.internal_CreateHeaders(),"POST",!1,!1,!0,{},e,t)}return void St(Pe+r,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(r,e,t)}},at.prototype[re]=function(e,t,r){var a=re,n="RfDataManager."+a;try{var s=e.list,o=e.type,i=e.action,f=e.item;St(Fe+n+" list="+s,p,c.FUNC_INOUT);var u=this.getAccountMode();if(!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER_ID:this.m_sUserId,ACCOUNT_MODE:u},r))return St(n+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var l={};if(l[Be]={},l[Be][Ge]="updateusageinfo",l[Be].list=s,l[Be][Le]=o,l[Be].action=i,l[Be].item=f,u==m.OFS)this.internal_RepositoryAction(l,a,t,r,rt.APP_DATA);else if(typeof t!=_)return void t(200);return void St(Pe+n,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(n,e,r)}},at.prototype[ae]=function(e,t,r){var a=ae,n="RfDataManager."+a;try{var s=e.list,o=e.type;St(Fe+n+" list="+s,p,c.FUNC_INOUT);var i=this.getAccountMode();if(!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER_ID:this.m_sUserId,ACCOUNT_MODE:i},r))return St(n+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var f={};if(f[Be]={},f[Be][Ge]="getusageinfo",f[Be].list=s,f[Be][Le]=o,i==m.OFS)this.internal_RepositoryAction(f,a,t,r,rt.APP_DATA);else if(i==m.MULTIFILE){var u=JSON.stringify(f);this.internal_RequestAsync(a,this.internal_CreateRequestUrl(),u,this.internal_CreateHeaders(),"POST",!1,!1,!0,{},t,r)}return void St(Pe+n,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(n,e,r)}},at.prototype[de]=function(e,t,r,a,n,s){var o=de,i="RfDataManager."+o;try{St(Fe+i+" sFilter='"+e+"'",p,c.FUNC_INOUT);var f=this.getAccountMode();if(!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER_ID:this.m_sUserId,ACCOUNT_MODE:f,SEARCH:e},r))return St(i+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;St(i+". sFilter='"+e+"' objTypes='"+a+"' bDeep='"+n+"'",p,c.INFO),typeof a==_&&(a=E),typeof n==_&&(n=!0),e=e.toLowerCase();var u={};if(u[Be]={},u[Be][Le]=a,u[Be][qe]=C.enUrls,u[Be][He]=n,typeof s!=_&&1==s&&(u[Be].iconMime="x-icon",u[Be][qe]=C.enUrls|C.enIcon),f==m.OFS)u[Be][Ge]="search",u[Be].search=e,this.internal_RepositoryAction(u,o,t,r,rt.USER_DATA);else if(f==m.MULTIFILE){u[Be][Ge]="list",u[Be][xe]="";var l=JSON.stringify(u);this.internal_RequestAsync(o,this.internal_CreateRequestUrl(),l,this.internal_CreateHeaders(),"POST",!1,!1,!0,{filter:e},t,r)}return void St(Pe+i,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(i,e,r)}},at.prototype.UpdateStatus=function(e,t){var r="RfDataManager.UpdateStatus";try{St(Fe+r,p,c.FUNC_INOUT);var a=this.getAccountMode();if(!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER_ID:this.m_sUserId},t))return St(r+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var n={};if(n[Be]={},n[Be][Ge]="updatestatus",a==m.OFS)throw"Not Implemented";if(a==m.MULTIFILE){var s=JSON.stringify(n);this.internal_RequestAsync("UpdateStatus",this.internal_CreateRequestUrl(),s,this.internal_CreateHeaders(),"POST",!1,!1,!0,{},e,t)}return void St(Pe+r,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(r,e,t)}};at.prototype.ServerOffSessionCall=function(e,t,r,a,n,s){var o="RfDataManager.ServerOffSessionCall";try{St(Fe+o,p,c.FUNC_INOUT);var i=this;if(!i.misc_checkParameters({url:e,user:t,password:r},s))return St(o+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var f=i.internal_CreateHeaders(),u=new RfapiJS.SibHttpScramAuthClient;u.SetRealm("RoboForm Online Server");var l=u.GetAuthRequestHeader(t,r);return f.Authorization=l,i.makeRequestAsync(e,a,f,"POST",!1,!1,function(d,S){if(St(o+". makeRequestAsync ->",p,c.FUNC_INOUT),d.status!=Ne)return d.status==Ee?(St(o+". SUCCESSFUL1!!!  user='"+t+"'",p,c.INFO),typeof n!=_&&n(Ee),!0):typeof s!=_?(s(new tt(d.status,d.statusText,void 0,d,void 0)),!1):void 0;var y=d.getResponseHeader("WWW-Authenticate");if(y){var R=RfapiJS.SibHttpGetAuthMethod(y);u.ParseServerResponse(R)&&(l=u.GetAuthRequestHeader(t,r),f.Authorization=l,i.makeRequestAsync(e,a,f,"POST",!1,!1,function(e,r){return St(o+". SECOND makeRequestAsync callback2->",p,c.FUNC_INOUT),i.misc_checkHttpResponse(e,r,s)?e.status==Ee?(St(o+". SUCCESSFUL2!!!  user='"+t+"'",p,c.INFO),typeof n!=_&&n(Ee),!0):typeof s!=_?(s(new tt(e.status,e.statusText,void 0,e,void 0)),!1):void St("ServerOffSessionCall RequestAsync callback <-",p,c.FUNC_INOUT):(St(o+". checkHttpResponse failed. Return false.",p,c.SPECIAL_CASE),!1)}))}}),void St(Pe+o,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(o,e,s)}},at.prototype.GetSyncData=function(e,t){var r="RfDataManager.GetSyncData";try{var a=this;return St(Fe+r,p,c.FUNC_INOUT),a.misc_checkParameters({SERVER_URL:a.m_sServerUrl,USER_ID:a.m_sUserId},t)?(a[se](function(t){if(St(r+". HttpStatus="+t,p,c.SPECIAL_CASE),typeof e!=_)return e(I.getDataByAccountId(rt.SYNC_DATA,a.m_sUserId),t),!1},function(e){if(typeof t!=_)return t(e),!1},rt.SYNC_DATA),void St(Pe+r,p,c.FUNC_INOUT)):(St(r+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1)}catch(e){this.internal_catchedException(r,e,t)}},at.prototype.DeleteAllDevices=function(e,t,r,a,n){var s="RfDataManager.DeleteAllDevices";try{if(St(Fe+s,p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER_ID:this.m_sUserId,DEVICES:e},r))return St(s+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var o={};o.devices=e,typeof a!=_&&(o.remove=a),typeof n!=_&&(o.logout=n);var i=JSON.stringify(o);return this.internal_RequestAsync("DeleteAllDevices",this.internal_CreateRequestUrl("?deletedevices"),i,this.internal_CreateHeaders(),"POST",!1,!1,!1,{},t,r),void St(Pe+s,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(s,e,r)}},at.prototype.CacheMasterPassword=function(e,t,r){try{var a="CacheMasterPassword";if(St("RfDataManager."+a+"  ->",p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER_ID:this.m_sUserId},r))return St("RfDataManager."+a+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;if(self.m_nAccountMode!=m.MULTIFILE)return St("RfDataManager."+a+". MODE IS UNKNOWN. Return false.",p,c.INFO),!1;var n={};n[Be]={},n[Be][Ge]="cachemp",n[Be].pwd=e;var s=JSON.stringify(n);return void this.internal_RequestAsync(a,this.internal_CreateRequestUrl(),s,this.internal_CreateHeaders(),"POST",!1,!1,!0,{},t,r)}catch(e){this.internal_catchedException("RfDataManager.CacheMasterPassword",e,r)}},at.prototype.ChangePassword=function(e,t,r,a,n,s,o){try{var i="ChangePassword";if(St("RfDataManager."+i+" ->",p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER_ID:this.m_sUserId,PATH:e,ACCOUNT_MODE:this.m_nAccountMode},s))return St("RfDataManager."+i+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;if(self.m_nAccountMode!=m.MULTIFILE)return St("RfDataManager."+i+". MODE IS UNKNOWN. Return false.",p,c.INFO),!1;var f={};f[Be]={},f[Be][Ge]="changepwd",f[Be][xe]=e,f[Be][Ke]=r,f[Be][Ve]=a,typeof t!=_&&(f[Be][Le]=t),typeof o!=_&&(f[Be].dp=o);var u=JSON.stringify(f);return void this.internal_RequestAsync(i,this.internal_CreateRequestUrl(),u,this.internal_CreateHeaders(),"POST",!1,!1,!0,{},n,s)}catch(e){this.internal_catchedException("RfDataManager.ChangePassword",e,s)}},at.prototype.CheckPwd=function(e,t,r){var a="RfDataManager.CheckPwd";try{if(St(Fe+a+" pwd='"+e+"'",p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER_ID:this.m_sUserId,PWD:e,ACCOUNT_MODE:this.m_nAccountMode},r))return St(a+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;if(this.m_nAccountMode!=m.MULTIFILE)return St(a+". MODE IS UNKNOWN. Return false.",p,c.INFO),!1;var n={};n[Be]={},n[Be][Ge]="checkpwd",n[Be].pwd=e;var s=JSON.stringify(n);return this.internal_RequestAsync("CheckPwd",this.internal_CreateRequestUrl(),s,this.internal_CreateHeaders(),"POST",!1,!1,!0,{},t,r),void St(Pe+a,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(a,e,r)}},at.prototype.ConvertMultiFileToOFS=function(e,t,r,a){try{function n(e){St("RfDataManager.ConvertMultiFileToOFS. Convert_SaveOFS_AnswerCallback ->",p,c.FUNC_INOUT),typeof r!=_&&r(I.getDataByAccountId(rt.USER_DATA,o.m_sUserId),100)}function s(e){St("RfDataManager.ConvertMultiFileToOFS. Convert_SaveOFS_ErrorCallback ->",p,c.FUNC_INOUT),typeof a!=_&&a(e)}St("RfDataManager.ConvertMultiFileToOFS ->",p,c.FUNC_INOUT);var o=this;if(!o.misc_checkParameters({SERVER_URL:o.m_sServerUrl,USER_ID:o.m_sUserId},a))return St("RfDataManager.ConvertMultiFileToOFS. misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;if(o.m_nAccountMode!=m.MULTIFILE)return St("RfDataManager.GetItemsList. MODE IS not MULTIFILE. Return false.",p,c.INFO),!1;var i=0,f={};f[Be]={},f[Be][Ge]="getdataitem2",f[Be].level=4,f[Be].options=!0,typeof e!=_&&(f[Be].pwd=e[i]);var u=o.internal_CreateHeaders(),l=o.internal_CreateRequestUrl();I.setData({i:{F:!0},c:[{i:{F:!0,n:"root"},c:[]}]},rt.USER_DATA,o.m_sUserId),o.GetItemsList("",function(d,S){for(var y=!0,R=0;R<d.length;){var U=d[R],h=U[xe],O=U[Le];if(8!=(O=parseInt(O))){f[Be][xe]=h,f[Be][Le]=O;var C=JSON.stringify(f),v=o.makeSyncRequest(l,C,u,"POST",!1);if(!v||v.status!=Ee){typeof a!=_&&a({Description:"server error"});break}var E=JSON.parse(v.responseText);if("error"==(E=E[je])[We])if(1==E.code){if(St("RfDataManager.GetItemsData. Password is incorrect. pwd='"+e[i]+"'  item='"+h+"'",p,c.INFO),1==e.length){typeof a!=_&&a({Description:E.description+" : Password(s) are incorrect. Set other password",HttpRequest:h});break}if(e.length==i+1){if(!y){typeof a!=_&&a({Description:E.description+" : Password(s) are incorrect. Set other password",HttpRequest:h});break}y=!1,St("RfDataManager.GetItemsData. Try (1) password='"+e[i=0]+"' for item='"+h+"'",p,c.INFO)}else St("RfDataManager.GetItemsData. Try  (2) password='"+e[++i]+"' for item='"+h+"'",p,c.INFO);f[Be].pwd=e[i]}else typeof a!=_&&a({Description:E.description}),R++;else{y=!0,R++;N={request:{item:U,data:E.data}};I.addItemtoJSON(N,function(e,a){typeof r!=_&&(R==d.length?(o[me](t),o.setAccountMode(m.OFS),o[ne](n,s,rt.USER_DATA,o.m_sUserId)):r(null,parseInt(R/d.length*100)))},function(e){typeof a!=_&&a(e)})}}else{R++;var N={request:{item:U}};I.addItemtoJSON(N,function(e,a){typeof r!=_&&(R==d.length?(o[me](t),o.setAccountMode(m.OFS),o[ne](n,s,rt.USER_DATA,o.m_sUserId)):r(null,parseInt(R/d.length*100)))},function(e){typeof a!=_&&a(e)})}}return!0},a,[1,2,3,4,5,6,7,8],0,!0,!1)}catch(e){this.internal_catchedException("RfDataManager.ConvertMultiFileToOFS",e,a)}},at.prototype.CreateAddToGroupsCompanyUsers=function(e,n,s){var o="RfDataManager.CreateAddToGroupsCompanyUsers";try{var i=this;St(Fe+o,p,c.FUNC_INOUT);var f=e.onProgress||function(){};if(f(1),void 0===s&&(s=function(){}),!i.m_sServerUrl)return St(o+". Server Url is undefined. Return false",p,c.SPECIAL_CASE),s(new tt(N.RfErr_WrongParams,"Server URL is not defined"));if(!i.m_sUserId)return St(o+". Current user is undefined. Return false",p,c.SPECIAL_CASE),s(new tt(N.RfErr_WrongParams,"User name is not defined"));if(!e||!e.companyId)return St(o+". Company is undefined. Return false",p,c.SPECIAL_CASE),s(new tt(N.RfErr_WrongParams,"Company is empty"));if(!e||!e.users||!e.users.length)return St(o+". Users are undefined. Return false",p,c.SPECIAL_CASE),s(new tt(N.RfErr_WrongParams,"Users parameter is empty"));var u=[],l=e.users,_=e.companyId,d=void 0===e.sendNotifyEmail||e.sendNotifyEmail;f(2);var S=function(e,r,a){e.accountId=e.email;var n=t.CopyObjectDeep(e),s=n.email,o={};o.user=s,o[et]=_;var c=JSON.stringify(o);i.internal_RequestAsync("CompanyAddUser",i.internal_CreateRequestUrl("?company-add-user"),c,i.internal_CreateHeaders(),"POST",!1,!1,!1,{},function(){i[G](function(e){return n.publicKey=e,r(n)},function(e){a(s,new tt(O.SibTerr_NotFound,"no RSA public key."))},s)},function(e){if(!e.HttpRequest)return a(s,e);var t=e.HttpRequest.getResponseHeader("x-sib-reason");if(!t||"already-joined"!=t)return a(s,e);i[G](function(e){return n.publicKey=e,n.joinedBefore=!0,r(n)},function(e){a(s,new tt(O.SibTerr_NotFound,"no RSA public key."))},s)})},y=function(n,s,f){var u=t.CopyObjectDeep(n),l=n.email,S=n.pwd,y=n.name;St("_CreateCompanyUser -> user='"+n.email,p,c.INFO);var R=a.GenerateKeysWithCheck(1024),U=R.Public_Pem,h=R.Private_Pem;u.privateKey=h,u.publicKey=U;var I=Math.round(new Date/1e3),m={i:{F:!0},c:[{b:h,i:{n:"private-key.pem",c:I,m:I,s:h.length}},{i:{F:!0,n:"root"},c:[]}]},C=new RfapiJS.CRfOneFileSys,v=r.stringToBytes(JSON.stringify(m));St("_CreateCompanyUser.ObjectOFSToBytes -> user='"+n.email,p,c.INFO),C.EncodeZipOFSBytes(v,rt.USER_DATA,void 0,S,be,!0,function(r){St("_CreateCompanyUser.EncodeZipOFSBytes -> user='"+n.email,p,c.INFO);var a={};void 0!==y&&(a.name=y),a.login=l,a.email=l,a.company=_,void 0!==e.passwordExpires&&(a.passwordExpires=e.passwordExpires),a.sendNotifyEmail=d,a.method="SCRAM-SHA-256",a.iterations=Me;var R=dt(S);a.salt=R.salt,a.hash=R.hash,a.pwd=S,r=new Uint8Array(r);var h=t.bytesToBase64(r);a.files={},a.files["user-data.rfo"]=h,a.publicKey=U;var I=JSON.stringify(a),m=i.internal_CreateHeaders();!function(e,t,r,a){t?(e["x-sib-auth-alt-otp"]=t,e["x-sib-auth-alt-memorize"]=r?a<=0?"1":parseInt(a+1):"0"):r&&(e["x-sib-auth-alt-memorize"]=a<=0?"1":parseInt(a+1))}(m,"",!0,0),m["Content-type"]="application/json";var C=i.m_sServerUrl+"/rf-api?create-company-member";i.makeRequestAsync(C,I,m,"POST",!1,!1,function(e,t){if(St(o+". makeRequestAsync ->",p,c.FUNC_INOUT),i.misc_checkHttpResponse(e,t,function(e){f(l,e)})){if(e.status!=Ee)return f(l,new tt(O.SibTErr_ServerErr,e.statusText));if(St(o+". Status code=OK. Need to parse response for errors. RESPONSE  = "+e.responseText,p,c.INFO),e.responseText)try{var r=JSON.parse(e.responseText);if("error"==r[je][We]){var a=r[je],n=!1,_=!1;if(a.fields&&Array.isArray(a.fields))for(var d=a.fields,S=0;S<d.length;S++){var y=a.fields[S];"object"==typeof y&&(void 0!==y.exists&&y.exists&&(n=!0),void 0!==y.anotherCompany&&y.anotherCompany&&!0,void 0!==y.companyMember&&y.companyMember&&(_=!0))}return n?_?(u.accountId=l,u.existsBefore=!0,s(u)):f(l,new tt(O.SibTErr_ServerErr,e.statusText,void 0,e,void 0)):(St(o+". Server returns status=error.",p,c.SPECIAL_CASE),f(l,new tt(O.SibTErr_ServerErr,e.statusText,void 0,e,void 0)))}var R=r[je][RfapiJS.ACCOUNT_ID_PROP];return u.accountId=R,s(u)}catch(t){St(o+". Error while parsing JSON response",p,c.SPECIAL_CASE),f(l,t)}}})},function(e){St(o+". Error in EncodeZipOFSBytes="+e,p,c.SPECIAL_CASE),f(l,e)})},R=function(e,r,n){var s=e.publicKey,o=e.accountId,c=e.groupPwd,f=e.groupId,u={};u[Xe]=o,u[Qe]=!1,u[Ze]=!1,u[ze]=!0,u[$e]=!1,u.disabled=!1;var p=a.GetHexFromPEM(s,!0),l=new RSAKey;l.setPublic(p.modulus,p.exponent);var _=l.encrypt(c),d=t.bytesToBase64(t.hexToBytes(_));u.mp=d;var S=JSON.stringify(u),y=i.m_sServerUrl+"/rf-api/"+encodeURI(f)+"?grantaccount";i.internal_RequestAsync(q,y,S,i.internal_CreateHeaders(),"POST",!1,!1,!1,{},function(){return r()},function(e){return n(o,e)})};function U(e,t,r,a){for(var n=!1,s=0;s<u.length;s++){var o=u[s];if(o.email.toLowerCase()==e.toLowerCase()){n=!0,t&&o.error.push(t),r&&(o.existsBefore=!0),a&&(o.joinedBefore=!0);break}}if(!n){var i=[];t&&i.push(t);var c={};c.email=e,c.error=i,r&&(c.existsBefore=!0),a&&(c.joinedBefore=!0),u.push(c)}}for(var h=l.length,I=48/h,m=[],C=0;C<l.length;C++){var v=l[C],E=v.action;!E||"create"!=E&&"join"!=E?(h--,f(2+I*(l.length-h)),U(v.email,new tt(O.SibTErr_LocalErr,"wrong action:"+E)),h||(f(50),T())):"create"==E?y(v,function(e){m.push(e),h--,f(2+I*(l.length-h)),h||(f(50),T())},function(e,t){h--,f(2+I*(l.length-h)),U(e,t),h||(f(50),T())}):S(v,function(e){m.push(e),h--,f(2+I*(l.length-h)),h||(f(50),T())},function(e,t){h--,f(2+I*(l.length-h)),U(e,t),h||(f(50),T())})}function T(){if(St(o+". _AddUsersToGroups-> ",p,c.INFO),f(55),!m.length)return St(o+".<- _AddUsersToGroups",p,c.INFO),f(100),n(u);for(var e=0,t=0;t<m.length;t++){(i=m[t]).joinedBefore?U(i.email,void 0,!1,!0):i.existsBefore&&U(i.email,void 0,!0,!1);var r=i.groups;e+=r.length}if(!e)return St(o+".<- _AddUsersToGroups",p,c.INFO),f(100),n(u);var a=e,s=45/e;for(t=0;t<m.length;t++){r=(i=m[t]).groups;for(var i,l=0;l<r.length;l++){var _=r[l];i.groupId=_.groupId,i.groupPwd=_.groupPwd,R(i,function(){f(55+s*(e- --a)),a||(f(100),n(u))},function(t,r){f(55+s*(e- --a)),U(t,r),a||(f(100),n(u))})}}}}catch(e){this.internal_catchedException(o,e,s)}},at.prototype.CreateCompanyGroups=function(e,r,n){var s="RfDataManager.CreateCompanyGroups";try{var o=this;if(St(Fe+s,p,c.FUNC_INOUT),!o.m_sServerUrl)return St(s+". Server Url is undefined. Return false",p,c.SPECIAL_CASE),void 0!==n&&n(new tt(N.RfErr_WrongParams,"Server URL is not defined")),!1;if(!o.m_sUserId)return St(s+". Current user is undefined. Return false",p,c.SPECIAL_CASE),void 0!==n&&n(new tt(N.RfErr_WrongParams,"User name is not defined")),!1;if(!e||!e.companyId)return St(s+". Company is undefined. Return false",p,c.SPECIAL_CASE),void 0!==n&&n(new tt(N.RfErr_WrongParams,"Company is empty")),!1;if(!e||!e.groups)return St(s+". Groups are undefined. Return false",p,c.SPECIAL_CASE),void 0!==n&&n(new tt(N.RfErr_WrongParams,"Groups parameter is empty")),!1;var i=[],f=o.m_sUserId,u=e.groups,l=e.companyId,_=void 0!==e.disable&&e.disable,d=e.onProgress||function(){};function S(e,n){St(s+". Step 3. _GrantGroupsToCompanyAdmins-> groups_created="+e.length+" admins="+n.length,p,c.INFO),d(60);var f=function(e,t,r){var a=e.id;St(s+" Get Public Key of admin='"+a+"'  ->",p,c.INFO),o[G](function(e){return t(e,a)},function(e){o._CheckRegionalServerFromHeader({request:e.HttpRequest},function(){return St(s+" No Public Key of  admin='"+admin+"' _OnSameServer ->",p,c.INFO),e&&e.Code==Te?t("",a):r(e,a)},function(e){return r(e,a)})},a)},u=function(e,r,n){var i=e.id,f=e.publicKey,u=e.groupId,l=e.groupPwd;St(s+"  _GrantAccountToRecipient. admin_id ='"+i+"' group_id='"+u+"'",p,c.INFO);var _={};_[Xe]=i,_[Qe]=!0,_[Ze]=!1,_[ze]=!0,_[$e]=!1,_.disabled=!0;var d=a.GetHexFromPEM(f,!0),S=new RSAKey;S.setPublic(d.modulus,d.exponent);var y=S.encrypt(l),R=t.bytesToBase64(t.hexToBytes(y));_.mp=R;var U=JSON.stringify(_),h=o.m_sServerUrl+"/rf-api/"+encodeURI(u)+"?grantaccount";o.internal_RequestAsync(q,h,U,o.internal_CreateHeaders(),"POST",!1,!1,!1,{},function(){return r(i,u)},function(e){return n(e,i,u)})};function l(e){for(var t=0;t<n.length;t++){var r=n[t];if(r.id==e)return r}}for(var _=n.length,S=10/_,y=[],R=0;R<n.length;R++){f({id:n[R].id},function(e,t){var r=l(t);r.publicKey=e,y.push(r),d(60+S*(n.length-_)),--_||U()},function(e,t){_--,d(60+S*(n.length-_)),_||U()})}function U(){d(70),St(s+". Step 3. _GrantGroups-> ",p,c.INFO);for(var t=y.length*e.length,a=30/t,n=0;n<y.length;n++)for(var o=y[n],f=0;f<e.length;f++){var l=e[f];o.groupId=l.id,o.groupPwd=l.pwd,u(o,function(n,s){t--,d(70+a*(y.length*e.length-t)),t||(d(100),r(i))},function(n,s,o){t--,d(70+a*(y.length*e.length-t)),t||(d(100),r(i))})}}}function y(e,n,f,u){St(s+". Step 2. _CreateGroups-> groups_to_add.length="+e.length+" admins="+f.length,p,c.INFO),d(15);for(var y=new RfapiJS.CRfOneFileSys,R=function(e,r,i){var f=e.name,d=t.generatePassword(ke),S={};S[Je]=f,S[et]=l,void 0!==e.readOnly&&(S.readOnly=e.readOnly),void 0!==e.showPasswords&&(S.showPasswords=e.showPasswords),void 0!==e.serverOnly&&(S.serverOnly=e.serverOnly),(_||void 0!==e.disabled&&e.disabled)&&(S.disabled=!0);var R=o.internal_CreateHeaders();R["x-sib-auth-alt-memorize"]=1;var U=new RSAKey,h=a.GetHexFromPEM(n,!0);U.setPublic(h.modulus,h.exponent);var I=U.encrypt(d),m=t.bytesToBase64(t.hexToBytes(I));S.mp=m;var C=dt(d),v=C.hash,E=C.salt;S.method="SCRAM-SHA-256",S.iterations=Me,S.salt=E,S.hash=v,y.EncodeZipOFSBytes(u,rt.USER_DATA,void 0,d,100,!0,function(e){e=new Uint8Array(e);var a=t.bytesToBase64(e);S.files={},S.files["user-data.rfo"]=a;var n=o.m_sServerUrl+"/rf-api?create-shared-folder",u=JSON.stringify(S);o.makeRequestAsync(n,u,R,"POST",!1,!1,function(e,t){if(St(s+". Step 2. makeRequestAsync ->",p,c.FUNC_INOUT),!o.misc_checkHttpResponse(e,t,function(e){i(f,e)}))return St(s+". Step 2. checkHttpResponse failed. Return false.",p,c.SPECIAL_CASE),!1;if(e.status==Ee){St(s+".  Step 2 .OK. Go to Step 3.",p,c.FUNC_INOUT);var a=JSON.parse(e.responseText).response[RfapiJS.ACCOUNT_ID_PROP];return r(f,a,d)}return i(f,new tt(O.SibTErr_ServerErr,e.statusText,void 0,e,void 0))})},function(e){i(f,e)})},U=e.length,h=45/U,I=[],m=0;m<e.length;m++){R(e[m],function(t,a,n){U--,d(15+h*(e.length-U)),i.push({groupName:t,groupId:a,groupPwd:n}),I.push({name:t,id:a,pwd:n}),U||(f.length?S(I,f):(d(100),r(i)))},function(t,a){U--,d(15+h*(e.length-U)),i.push({groupName:t,error:a}),U||(f.length?S(I,f):(d(100),r(i)))})}}function R(e){St(s+". Step 1. _GetCompanyGroups-> ",p,c.INFO),d(3),o[L](function(_){d(5);var S=[],R=_.accounts;if(R)for(var U=0;U<u.length;U++){var h=u[U];if(h.name){for(var I=!1,O=0;O<R.length;O++){var m=R[O];if(m.company&&(m.company==l&&m.name.toLowerCase()==h.name.toLowerCase())){I=!0;var C=t.base64ToBytes(m.mp),v=t.bytesToHex(C),E=new RSAKey,N=a.GetHexFromPEM(e,!1);E.setPrivateEx(N.modulus,N.exponent,N.privateexp,N.P,N.Q,N.DP,N.DQ,N.InverseQ);var T=E.decrypt(v);i.push({groupName:h.name,groupId:m.accountId,groupPwd:T,existsBefore:!0});break}}I||S.push(h)}}if(!S.length)return d(100),r(i);St(s+". Step 1. groups_to_add.length="+S.length,p,c.INFO),o[G](function(e){d(10),St(s+". Step 1. Got public key",p,c.INFO),o[H](l,function(t){d(15),St(s+". Step 1. Got company user",p,c.INFO);var r=[],a=t.users;if(!a.length)return y(S,e,r);for(var i=0;i<a.length;i++){var u=a[i];u.isAdmin&&(f!=u.id&&r.push(u))}o.ObjectOFSToBytes({i:{F:!0},c:[{i:{F:!0,n:"root"},c:[]}]},function(t){return y(S,e,r,t)},n)},n)},n,f)},n)}return function(){if(d(1),St(s+" #Step 1#  _GetAuthUserPrivateKey ->",p,c.INFO),I.getDataByAccountId(rt.USER_DATA,f)){St(s+"._GetAuthUserPrivateKey. Try to get private key from repo",p,c.FUNC_INOUT);var e=I.getPrivateKey();if(!e)return n(new tt(O.SibTerr_NotFound,"Auth user private key not found."));R(e)}else o[se](function(e){var t=I.getPrivateKey();if(!t)return n(new tt(O.SibTerr_NotFound,"Auth user private key not found."));R(t)},function(e){return St(s+" #Step 1#  _GetAuthUserPrivateKey._OnError ->",p,c.INFO),n(e)})}(),void St(Pe+s,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(s,e,n)}},at.prototype.CreateSharedAccount=function(e,r,n,s,o,i,f,u,l,d,S,y,R){var U="RfDataManager.CreateSharedAccount";try{var h=this;St(Fe+U,p,c.FUNC_INOUT);var m="";if(s&&s.startsWith("/")&&(m=s,s=s.substr(s.lastIndexOf("/")+1)),!h.m_sServerUrl)return St(U+". Server Url is undefined. Return false",p,c.SPECIAL_CASE),typeof r!=_&&r(new tt(N.RfErr_WrongParams,"Server URL is not defined")),!1;if(typeof n!=_&&""!=n&&((n=n.trim()).length<6||n.length>80))return St(U+" . Account login is incorrect (6-30 symbols). Return false",p,c.SPECIAL_CASE),typeof r!=_&&r(new tt(N.RfErr_WrongParams,"Account login is incorrect (6-30 symbols)")),!1;if(typeof s!=_&&""!=s&&((s=s.trim()).length<1||s.length>60)){St(U+". Account name is incorrect (1-60 symbols). Return false",p,c.SPECIAL_CASE);var C=f?"Group name is incorrect (1-60 symbols)":"Shared folder name is incorrect (1-60 symbols)";return typeof r!=_&&r(new tt(N.RfErr_WrongParams,C)),!1}if(typeof o!=_&&""!=o&&((o=o.trim()).length<6||o.length>80))return St(U+". Account email is incorrect (6-50 symbols). Return false",p,c.SPECIAL_CASE),typeof r!=_&&r(new tt(N.RfErr_WrongParams,"Account email is incorrect (6-50 symbols)")),!1;if(typeof i!=_&&""!=i&&(i.length<7||i.length>20))return St(U+". Account phone is incorrect (7-20 symbols). Return false",p,c.SPECIAL_CASE),typeof r!=_&&r(new tt(N.RfErr_WrongParams,"Account phone is incorrect (7-20 symbols)")),!1;function E(t){St(U+". #Step 3.2# updateAccountsList ->",p,c.INFO),h[W](t,function(a){f?function(t){St(U+". Step 4. getCompanyAdmins for company='"+f+"'  accountId='"+t+"'",p,c.FUNC_INOUT),h[H](f,function(a,n){try{St(U+". Step 4. companyUsers_OkCallback ->",p,c.INFO);var s=a.users;if(!s.length)return St(U+". Step 4. companyUsers_OkCallback. There are no users. Exit.",p,c.INFO),void(typeof e!=_&&e(Ee,t));for(var o=[],i=0;i<s.length;i++){var f=s[i];f.isAdmin&&h.m_sUserId!=f.id&&o.push(f.id)}if(!o.length)return St(U+". Step 4. companyUsers_OkCallback. There are no admins. Exit.",p,c.INFO),void(typeof e!=_&&e(Ee,t));for(var u=o.length,l=0;l<o.length;l++){var d=o[l];h[q](d,t,!0,!1,!0,!1,function(r){St(U+". Step 4.1. grant_OKCallBack for recipient='"+d+"'",p,c.FUNC_INOUT),--u||typeof e!=_&&e(Ee,t)},function(e){return typeof r!=_&&r(e),!1},!0,void 0)}}catch(e){Rt("EXCEPTION in "+U+".Step 4. companyUsers_OkCallback: "+e.toString(),p),typeof r!=_&&r({Code:O.SibTErr_LocalErr,Description:"EXCEPTION in "+U+" Step 4. companyUsers_OkCallback:"+e.toString()})}},function(e){return typeof r!=_&&r(e),!1}),St(U+". Step 4. getCompanyAdmins <- ",p,c.FUNC_INOUT)}(t):typeof e!=_&&e(a,t)},function(e){return typeof r!=_&&r(e),!1})}function T(e,t){try{St(U+". #Step 3# upLoadOFS_forShared ->",p,c.INFO);var a=h.internal_CreateHeaders(!0),n=rt.USER_DATA,s=h.m_sServerUrl+"/rf-api/"+encodeURI(t)+"/"+n;St(U+". Step 3. SAVE OFS "+s,p,c.INFO),h.makeRequestAsync(s,e,a,"POST",!1,!0,function(e,a){return St(U+". Step 3.  makeRequestAsync.saveOFS_callback ->",p,c.FUNC_INOUT),h.misc_checkHttpResponse(e,a,r)?e.status==Ae?(typeof r!=_&&r(new tt(e.status,e.statusText,void 0,e,void 0)),!1):e.status==ge?(typeof r!=_&&r(new tt(e.status,e.statusText,void 0,e,void 0)),!1):e.status==Ee?(St(U+". Step 3.  makeRequestAsync.saveOFS_callback. HTTP_Status_Code_OK.",p,c.FUNC_INOUT),void(m?function(e){St(U+". #Step 3.1# removePersonalFolder ->",p,c.INFO),h[he](m,v.RfItemType_Folder,function(t){E(e)},function(e){return typeof r!=_&&r(e),!1})}(t):E(t))):void(typeof r!=_&&r(new tt(e.status,e.statusText,void 0,e,void 0))):(St(U+". Step 3. makeRequestAsync.saveOFS_callback failed. Return false.",p,c.SPECIAL_CASE),!1)})}catch(e){Rt("EXCEPTION in "+U+".Step 3. upLoadOFS_forShared: "+e.toString(),p),typeof r!=_&&r({Code:O.SibTErr_LocalErr,Description:"EXCEPTION in "+U+" Step 3. upLoadOFS_forShared: "+e.toString()})}}function A(e,I){try{St(U+". Step 2. createShAccount. account='"+n+"'",p,c.INFO);var m={};void 0!==n&&(m.login=n),void 0!==s&&(m[Je]=s),void 0!==o&&(m.email=o),void 0!==i&&(m.phone=i),void 0!==f&&(m[et]=f),void 0!==u&&(m.readOnly=u),void 0!==l&&(m.showPasswords=l),void 0!==d&&(m.serverOnly=d),void 0!==S&&(m.allowedIPRanges=S),void 0!==y&&(m.policies=y),void 0!==R&&(m.disabled=R);var C=h.internal_CreateHeaders();C["x-sib-auth-alt-memorize"]=1;var v=h.m_sServerUrl+"/rf-api?create-shared-folder",E=t.generatePassword(ke);St(U+". Step 2. createShAccount. masterPwd='"+E+"'",p,c.INFO);var N=new RSAKey,A=a.GetHexFromPEM(e,!0);N.setPublic(A.modulus,A.exponent);var g=N.encrypt(E),F=t.bytesToBase64(t.hexToBytes(g));m.mp=F;var P=dt(E),D=P.hash,k=P.salt;m.method="SCRAM-SHA-256",m.iterations=Me,m.salt=k,m.hash=D;var b=JSON.stringify(m);St(U+". Make ASYNC POST request to "+v,p,c.INFO),h.makeRequestAsync(v,b,C,"POST",!1,!1,function(e,t){if(St(U+". Step 2. makeRequestAsync ->",p,c.FUNC_INOUT),!h.misc_checkHttpResponse(e,t,r))return St(U+". Step 2. checkHttpResponse failed. Return false.",p,c.SPECIAL_CASE),!1;if(e.status==Ee){if(St(U+".  Step 2 .OK. Go to Step 3.",p,c.FUNC_INOUT),!n){var a=JSON.parse(e.responseText);n=a.response[RfapiJS.ACCOUNT_ID_PROP]}return function(e,t,a){St(U+". #Step 3.a# EncryptData. pwd='"+e+"'  accountId='"+t+"'",p,c.INFO);var n=new RfapiJS.CRfOneFileSys,s={i:{F:!0},c:[{i:{F:!0,n:"root"},c:[]}]};if(a&&a.c)for(var o=s.c[0].c,i=0;i<a.c.length;i++)o.push(a.c[i]);h.ObjectOFSToBytes(s,function(a){n.EncodeZipOFSBytes(a,rt.USER_DATA,t,e,4096,!0,function(e){St(U+". Step 3.a  encrypt_Ok callback ->",p,c.FUNC_INOUT),T(new Uint8Array(e),t)},function(e){St(U+". Step 3.a  encrypt_Error callback ->",p,c.FUNC_INOUT),typeof r!=_&&r(e)})},function(e){typeof r!=_&&r(e)}),St(U+". EncryptData. Step 3.a <-",p,c.INFO)}(E,n,I),!0}return typeof r!=_&&(r(new tt(e.status,e.statusText,void 0,e,void 0)),!1)})}catch(e){Rt("EXCEPTION in "+U+".Step 2. createShAccount: "+e.toString(),p),typeof r!=_&&r({Code:O.SibTErr_LocalErr,Description:"EXCEPTION in "+U+" Step 2. createShAccount:"+e.toString()})}}function g(){try{return St(U+". Step 1. GetPublicKey-> ",p,c.INFO),h[G](function(e,t){m?function(e){var t={request:{}};t.request.path=m,t.request.type=v.RfItemType_Folder,I[le](t,function(t){if(St(Fe+U+" .Answer_GetItemInfo_From ->",p,c.FUNC_INOUT),t[RfapiJS.ITEM_SHARED_PROP])typeof r!=_&&r({Code:O.SibTErr_LocalErr,Description:"Shared folder can be created only from user personal data"});else{var a=I.FindItemByName(m,v.RfItemType_Folder,r);A(e,a)}},function(e){typeof r!=_&&r(e)})}(e):A(e)},function(e){return typeof r!=_&&r(e),!1},h.m_sUserId),void St(U+". Step 1. GetPublicKey <- ",p,c.INFO)}catch(e){Rt("EXCEPTION in "+U+".Step 1. GetPublicKey: "+e.toString(),p),typeof r!=_&&r({Code:O.SibTErr_LocalErr,Description:"EXCEPTION in "+U+" Step 1. GetPublicKey:"+e.toString()})}}function F(){St(U+".SharedFolders_CheckNames  <-",p,c.FUNC_INOUT);var e=!!f;h[L](function(t,a){try{St(U+".getSharedAccounts_AnswerCallBack  ->",p,c.FUNC_INOUT);var n=t.accounts;if(!n)return void g();for(var o=!1,i=0;i<n.length;i++){var u=n[i];if(u[Je].toLowerCase()==s.toLowerCase())if(e){if(typeof u.company!=_&&u.company==f){o=!0;break}}else o=!0}if(o){if(typeof r!=_){var l=e?"Group with the same name already exists.":"Shared folder with the same name already exists.";r(new tt(N.RfErr_AccountExists,l))}return!1}return void g()}catch(e){Rt("EXCEPTION in "+U+".getSharedAccounts_AnswerCallBack: "+e.toString(),p),typeof r!=_&&r({Code:O.SibTErr_LocalErr,Description:"EXCEPTION in "+U+" getSharedAccounts_AnswerCallBack:"+e.toString()})}},function(e){return void 0!==r&&r(e),!1}),St(U+".SharedFolders_CheckNames  <-",p,c.FUNC_INOUT)}return function(){St(U+".Folder_SharedFolder_Check  ->",p,c.FUNC_INOUT);var e=rt.USER_DATA;function t(e){try{St(U+".Folder_SharedFolder_Check.checkNames  ->",p,c.FUNC_INOUT);var t=e[RfapiJS.ITEM_CHILDS_PROP];if(!t||typeof t.length==_)return F(),void St(U+".Folder_SharedFolder_Check.checkNames  <-(1)",p,c.FUNC_INOUT);for(var a=null,n=0;n<t.length;n++){var o=t[n];if(o[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]==RfapiJS.ROOT_NODE){a=o;break}}if(!a||typeof a[RfapiJS.ITEM_CHILDS_PROP]==_)return F(),void St(U+".Folder_SharedFolder_Check.checkNames  <-(2)",p,c.FUNC_INOUT);for(var i,f=!1,u=0;u<a[RfapiJS.ITEM_CHILDS_PROP].length;u++){var l=a[RfapiJS.ITEM_CHILDS_PROP][u];if(l[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP].toLowerCase()==s.toLowerCase()&&!l[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_SHARED_PROP]&&!m){f=!0,i=l[RfapiJS.ITEM_INFO_PROP].F?"Folder":"File";break}}return f?(typeof r!=_&&r(new tt(N.RfErr_FolderExists,i+" with the same name already exists.")),!1):(F(),void St(U+".Folder_SharedFolder_Check.checkNames  <-(3)",p,c.FUNC_INOUT))}catch(e){Rt("EXCEPTION in "+U+".Folder_SharedFolder_Check.checkNames: "+e.toString(),p),typeof r!=_&&r({Code:O.SibTErr_LocalErr,Description:"EXCEPTION in Folder_SharedFolder_Check.checkNames:"+e.toString()})}}if(s){var a=I.getDataByAccountId(e,h.m_sUserId);a?t(a):h[se](function(n){if(n!=Ee)return typeof r!=_&&r(new tt(N.RfErr_BadData,"user-data.rfo is missing.")),!1;t(a=I.getDataByAccountId(e,h.m_sUserId))},r,e,h.m_sUserId),St(U+".Folder_SharedFolder_Check  <-",p,c.FUNC_INOUT)}else g()}(),void St(Pe+U,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(U,e,r)}},at.prototype[x]=function(e,t,r){var a=x,n="RfDataManager."+a;try{if(St(Fe+n+" for accountId='"+e+"'",p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,ACCOUNT_ID:e},r))return St(n+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var s=this.m_sServerUrl+"/rf-api/"+encodeURI(e)+"?sharedaccountinfo";return this.internal_RequestAsync(a,s,null,this.internal_CreateHeaders(),"GET",!1,!1,!1,{},t,r),void St(Pe+n,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(n,e,r)}},at.prototype[J]=function(e,t,r,a,n,s,o,i,f,u,l,d,S,y){var R=J,U="RfDataManager."+R;try{St(Fe+U+" for sharedaccount='"+e+"'",p,c.FUNC_INOUT);var h=this;if(!h.misc_checkParameters({SERVER_URL:h.m_sServerUrl,SHARED_ACCOUNT_ID:e},r))return St(U+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;function O(a){St(U+" postAccountInfo ->",p,c.FUNC_INOUT);var O={};typeof a!=_&&(O[Je]=a),typeof n!=_&&(O.readOnly=n),typeof f!=_&&(O.isManager=f),typeof s!=_&&(O.showPasswords=s),typeof o!=_&&(O.serverOnly=o),typeof i!=_&&(O.user=i),typeof u!=_&&(O.allowedIPRanges=u),typeof l!=_&&(O.policies=l),typeof d!=_&&(O.securityScore=d),typeof S!=_&&(O.loginsCount=S),typeof y!=_&&(O.securityStats=y);var m=JSON.stringify(O),C=h.m_sServerUrl+"/rf-api/"+encodeURI(e)+"?sharedaccountinfo";h.internal_RequestAsync(R,C,m,h.internal_CreateHeaders(),"POST",!1,!1,!1,{},function(r){if(St(U+".innerAnswerCallBack ->",p,c.FUNC_INOUT),typeof a!=_&&""!=a)I.renameSharedAccount(e,a);typeof t!=_&&t(r)},r),St(U+" postAccountInfo <-",p,c.FUNC_INOUT)}if(typeof a==_||""==a)return void O(a);var m={request:{}},C="/"+a;return m.request.path=C,I[le](m,function(t){t[RfapiJS.ITEM_SHARED_PROP]&&t[RfapiJS.ITEM_SHARED_PROP][RfapiJS.ACCOUNT_ID_PROP]==e&&t.path=="/"+a?O(a):typeof r!=_&&r(new tt(N.RfErr_WrongParams,"Object with the same name '"+a+"' already exists."))},function(e){"NotFound"!=e.sibErr?typeof r!=_&&r(e):O(a)}),void St(Pe+U,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(U,e,r)}},at.prototype.GetUserKnownRecipients=function(e,t,r){var a="RfDataManager.GetUserKnownRecipients";try{var n=e.userId?e.userId:this.m_sUserId;if(St(Fe+a+"  user='"+n+"'",p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:n},r))return St(a+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var s=this.m_sServerUrl+"/rf-api/"+encodeURI(n)+"?known-recipients",o="";if(e)for(var i in e)"userId"!=i&&(o=o+"&"+i+"="+encodeURIComponent(e[i]));return this.internal_RequestAsync("GetUserKnownRecipients",s+o,null,this.internal_CreateHeaders(),"GET",!1,!1,!1,{},t,r),void St(Pe+a,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(a,e,r)}},at.prototype[w]=function(e,t,r,a){var n=w,s="RfDataManager."+n;try{var o=a&&a.accountId?a.accountId:e;if(St(Fe+s+"  accountId='"+o+"'",p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId,SHARED_ACCOUNT:o},r))return St(s+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;if("POST"==(a&&a.method&&("GET"==a.method||"POST"==a.method)?a.method:"GET")){var i={};a&&(typeof a.sort!=_&&(i.sort=a.sort),typeof a.fields!=_&&(i.fields=a.fields),typeof a.offset!=_&&(i.offset=a.offset),typeof a.limit!=_&&(i.limit=a.limit),typeof a.filter!=_&&(i.filter=a.filter),typeof a.after!=_&&(i.after=a.after),typeof a.countOnly!=_&&(i.countOnly=a.countOnly));var f=JSON.stringify(i),u=this.m_sServerUrl+"/rf-api/"+encodeURI(o)+"?recipients";this.internal_RequestAsync(n,u,f,this.internal_CreateHeaders(),"POST",!1,!1,!1,{},t,r)}else{u=this.m_sServerUrl+"/rf-api/"+encodeURI(o)+"?recipients";var l="";if(a)for(var d in a)"accountId"!=d&&"method"!=d&&(l=l+"&"+d+"="+encodeURIComponent(a[d]));this.internal_RequestAsync(n,u+l,null,this.internal_CreateHeaders(),"GET",!1,!1,!1,{},t,r)}return void St(Pe+s,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(s,e,r)}},at.prototype._CheckRegionalServerFromHeader=function(e,t,r){var a=e.request,n=a.getResponseHeader("x-sib-reason"),s=a.getResponseHeader("reason"),o=a.getResponseHeader("location");if(n&&"redirect"==n)return r(new tt(403,s?s+" : "+o:"User account is on another server",void 0,a,void 0));t()},at.prototype[q]=function(e,r,n,s,o,i,f,u,l,d,S,y){var R="RfDataManager."+q;try{y||(y=function(e){}),St(Fe+R+"  recipient='"+e+"' granted_account_id='"+r+"'",p,c.FUNC_INOUT);var U=this;if(!U.misc_checkParameters({SERVER_URL:U.m_sServerUrl,USER:U.m_sUserId,ACCOUNT_NAME:r},u))return St(R+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;y(1);var h,m=!0;if(!S){m=!1,(S={}).recipients=[];var C={};C.recipientId=e,C.isManager=n,C.readOnly=s,C.showPasswords=o,C.serverOnly=i,C.bHide=l,C.name=d,S.recipients.push(C)}var v=[],E=S.recipients;if(!E||!E.length)return f({recipients:0,reports:v});var N=function(e,n,s){var o=e.recipientId,i=e.isManager,f=e.readOnly,u=e.showPasswords,l=e.serverOnly,d=e.bHide,S=e.name,y=e.publicKey;St(R+" #Step 4# _GrantAccountToRecipient. recipient ='"+o+"'",p,c.INFO);var I={};if(I[Xe]=o,typeof i!=_&&(I[Qe]=i),typeof f!=_&&(I[Ze]=f),typeof u!=_&&(I[ze]=u),typeof l!=_&&(I[$e]=l),typeof d!=_&&(I.disabled=d),typeof S!=_&&(I[Je]=S),y){var O=a.GetHexFromPEM(y,!0),m=new RSAKey;m.setPublic(O.modulus,O.exponent);var C=m.encrypt(h),v=t.bytesToBase64(t.hexToBytes(C));I.mp=v}else I.invite=!0;var E=JSON.stringify(I),N=U.m_sServerUrl+"/rf-api/"+encodeURI(r)+"?grantaccount";U.internal_RequestAsync(q,N,E,U.internal_CreateHeaders(),"POST",!1,!1,!1,{},function(){return n(o,!y)},function(e){return s(e,o)})},T=function(e,t,r){var a=e.recipientId;St(R+" #Step 1#  Get Public Key of  recipient='"+a+"'  ->",p,c.INFO),U[G](function(e,r,n){return t(e,a)},function(e){U._CheckRegionalServerFromHeader({request:e.HttpRequest},function(){return St(R+" #Step 1#  No Public Key of  recipient='"+a+"' _OnSameServer ->",p,c.INFO),e&&e.Code==Te?t("",a):r(e,a)},function(e){return r(e,a)})},a)};return function(e,t,r){if(St(R+" #Step 1#  _GetAuthUserPrivateKey ->",p,c.INFO),I.getDataByAccountId(rt.USER_DATA,U.m_sUserId)){St(R+"._GetAuthUserPrivateKey. Try to get private key from repo",p,c.FUNC_INOUT);var a=I.getPrivateKey();return a?t(a):r(new tt(O.SibTerr_NotFound,"Auth user private key not found."))}U[se](function(e){var a=I.getPrivateKey();return a?t(a):r(new tt(O.SibTerr_NotFound,"Auth user private key not found."))},function(e){return St(R+" #Step 1#  _GetAuthUserPrivateKey._OnError ->",p,c.INFO),r(e)})}(0,function(e){St("OnGetKey -> key='"+e+"'",p,c.FUNC_INOUT),y(5),function(e,n,s){St(R+" #Step 1#  _GetGrantedAccountPassword ->",p,c.INFO);var o=e.privateKey;if(!o)return s(new tt(O.SibTerr_NotFound,"RSA private key is empty."));U[L](function(e,i){St(R+" #Step 1#  _GetGrantedAccountPassword.OnGetPassword ->",p,c.INFO);for(var f=e.accounts,u=null,l=0;l<f.length;l++)if(f[l][RfapiJS.ACCOUNT_ID_PROP]==r){u=f[l];break}if(!u)return s(new tt(O.SibTerr_NotFound,"Granted account '"+r+"' not found."));var _=u.mp;if(!_)return s(new tt(O.SibTerr_NotFound,"Master password for account '"+r+"' not found."));var d=t.base64ToBytes(_),S=t.bytesToHex(d),y=new RSAKey,U=a.GetHexFromPEM(o,!1);y.setPrivateEx(U.modulus,U.exponent,U.privateexp,U.P,U.Q,U.DP,U.DQ,U.InverseQ);var h=y.decrypt(S);if(!h)return s(new tt(O.SibTerr_NotFound,"Decrypted password for account '"+r+"' is empty."));n(h)},function(e){return St(R+" #Step 1#  _GetGrantedAccountPassword._OnError ->",p,c.INFO),s(e)})}({privateKey:e},function(e){y(10),St("OnGetPwd -> pwd='"+e+"'",p,c.FUNC_INOUT),h=e,function(e,t){function r(e){for(var t=0;t<E.length;t++){var r=E[t];if(r.recipientId==e)return r}}for(var a=E.length,n=90/a*2,s=10,o=0;o<E.length;o++){var i=E[o];T({recipientId:i.recipientId},function(e,o){y(s+=n);var i=r(o);i.publicKey=e,N(i,function(e,r){a--,y(s+=n);var o={account:e};r&&(o.invite=!0),v.push(o),a||t()},function(e,r){a--,y(s+=n),v.push({account:r,error:e}),a||t()})},function(e,r){a--,y(s+=n),v.push({account:r,error:e}),a||t()})}}(0,function(){return St("OnComplete ->",p,c.FUNC_INOUT),m?f(v):v[0].error?u(v[0].error):void f()})},function(e){St("OnGetPwdError ->",p,c.FUNC_INOUT),void 0!==u&&u(e)})},function(e){St("OnGetKeyError ->",p,c.FUNC_INOUT),void 0!==u&&u(e)}),void St(Pe+R,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(R,e,u)}},at.prototype[V]=function(e,t,r,a){var n=V,s="RfDataManager."+n;try{var o=this;if(St(Fe+s+" accountId='"+e+"'",p,c.FUNC_INOUT),!o.misc_checkParameters({SERVER_URL:o.m_sServerUrl,USER:o.m_sUserId,SHARED_ACCOUNT:e},r))return St(s+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var i={};i.grantor=e,typeof a!=_&&(i.keep=a);var f=JSON.stringify(i);return o.internal_RequestAsync(n,o.internal_CreateRequestUrl("?reject"),f,o.internal_CreateHeaders(),"POST",!1,!1,!1,{},function(a,n){o[W](e,function(e,r){typeof t!=_&&t(e,r)},function(e){return typeof r!=_&&r(e),!1})},r),void St(Pe+s,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(s,e,r)}},at.prototype[j]=function(e,t,r,a){var n=j,s="RfDataManager."+n;try{var o=this;if(St(Fe+s+" shared_account_id='"+e+"'",p,c.FUNC_INOUT),!o.misc_checkParameters({SERVER_URL:o.m_sServerUrl,USER:o.m_sUserId,SHARED_ACCOUNT:e},r))return St(s+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;function i(){var a=o.m_sServerUrl+"/rf-api/"+encodeURI(e)+"?delete-shared-account";o.internal_RequestAsync(n,a,null,o.internal_CreateHeaders(),"POST",!1,!1,!1,{},function(a,n){o[W](e,function(e,r){t(e,r)},r)},r)}a?o[x](e,function(t,a){if(t.company)return i();o[w](e,function(t){for(var r=t.accounts,a=r.length,n=0;n<r.length;n++){var s=r[n],c=s.accountId;s.current?--a||i():f(e,c,function(){--a||i()},function(){--a||i()})}function f(e,t,r,a){o[K](e,t,function(){r()},a,void 0,!0)}},r)},r):i(),St(Pe+s,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(s,e,r)}},at.prototype.AcceptSharedAccount=function(e,t,r,a){var n="RfDataManager.AcceptSharedAccount";try{var s=this;St(Fe+n+" accountId='"+e+"'",p,c.FUNC_INOUT);if(!(typeof a!=_?this.misc_checkParameters({SERVER_URL:s.m_sServerUrl,USER:s.m_sUserId},r):this.misc_checkParameters({SERVER_URL:s.m_sServerUrl,USER:s.m_sUserId,SHARED_ACCOUNT:e},r)))return St(n+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var o={};typeof e!=_&&(o.grantor=e),typeof a!=_&&(o.acceptCode=a);var i=JSON.stringify(o);return s.internal_RequestAsync("AcceptSharedAccount",s.internal_CreateRequestUrl("?accept-account"),i,s.internal_CreateHeaders(),"POST",!1,!1,!1,{},function(a,o){St(Fe+n+" innerAnswerCallBack-> . New, update list of accounts.  Status="+o+"'",p,c.FUNC_INOUT),s[W](e,function(e,r){St(Fe+n+" UpdateAccount_OkCallback-> . List updated!.  HttpStatus="+e+"'",p,c.FUNC_INOUT),typeof t!=_&&t(e,r)},function(e){return typeof r!=_&&r(e),!1})},r),void St(Pe+n,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(n,e,r)}},at.prototype[K]=function(e,t,r,a,n,s){var o=K,i="RfDataManager."+o;try{var f=this;if(St(Fe+i+" accountId='"+e+"' recipient='"+t+"'",p,c.FUNC_INOUT),!f.misc_checkParameters({SERVER_URL:f.m_sServerUrl,USER:f.m_sUserId,SHARED_ACCOUNT:e,RECIPIENT:t},a))return St(i+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var u={};u[Xe]=t,typeof n!=_&&(u.keep=n);var l=JSON.stringify(u),d=f.m_sServerUrl+"/rf-api/"+encodeURI(e)+"?revoke";return f.internal_RequestAsync(o,d,l,f.internal_CreateHeaders(),"POST",!1,!1,!1,{},function(t,n){s?r(n):f[W](e,function(e){typeof r!=_&&r(e)},function(e){return typeof a!=_&&a(e),!1})},a),void St(Pe+i,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(i,e,a)}},at.prototype[L]=function(e,t,r){var a=L,n="RfDataManager."+a;try{if(St(Fe+n,p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId},t))return St(n+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var s=r&&r.recipientId,o=s||this.m_sUserId,i=this.m_sServerUrl+"/rf-api/"+encodeURI(o)+"?received";return this.internal_RequestAsync(a,i,null,this.internal_CreateHeaders(),"POST",!1,!1,!1,{},e,t,!0),void St(Pe+n,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(n,e,t)}},at.prototype[W]=function(e,r,n,s){var o="RfDataManager."+W,i=this;try{function f(e,s,f,u,l){var _=t.base64ToBytes(s),d=t.bytesToHex(_),S=new RSAKey,y=a.GetHexFromPEM(l,!1);S.setPrivateEx(y.modulus,y.exponent,y.privateexp,y.P,y.Q,y.DP,y.DQ,y.InverseQ);var R=S.decrypt(d);if(R){var U=a.GetHexFromPEM(e,!0),h=new RSAKey;h.setPublic(U.modulus,U.exponent);var I=h.encrypt(R),O=t.bytesToBase64(t.hexToBytes(I)),m={};m[Xe]=f,m.mp=O;var C=JSON.stringify(m),v=i.m_sServerUrl+"/rf-api/"+encodeURI(u)+"?grantaccount";i.internal_RequestAsync(q,v,C,i.internal_CreateHeaders(),"POST",!1,!1,!1,{},r,n)}else St(o+"._reGrantAccount. Decryption of the password failed",p,c.FUNC_INOUT)}return St(Fe+o+"  accountId='"+e+"'",p,c.FUNC_INOUT),i[L](function(t,a){St(o+".GetAccounts_AnswerCallBack ->  HttpStatus="+a,p,c.FUNC_INOUT);var n=t.accounts;I.m_AuthUser||I.setUser(i.m_sUserId),s||I.setSharedAccounts({accounts:n,accountId:e,showAllGroups:i.m_show_all_groups}),t.pendingFolders&&t.pendingFolders.length&&function(e){var t=I.getPrivateKey();if(t)for(var r=e.pendingFolders,a=e.accounts,n=e.publicKeys,s=0;s<r.length;s++){for(var i=r[s],u=i.accountId,l=i.recipient,_=null,d=0;d<a.length;d++)if(a[d][RfapiJS.ACCOUNT_ID_PROP]==u){_=a[d];break}if(_){var S=_.mp;if(S){for(var y="",R=0;R<n.length;R++)if(n[R].recipient==l){y=n[R].publicKey;break}y?f(y,S,l,u,t):St(o+"._CheckPendingAccounts. No RSA Public key for account "+u,p,c.FUNC_INOUT)}else St(o+"._CheckPendingAccounts. Account="+u+" mp is empty.",p,c.FUNC_INOUT)}else St(o+"._CheckPendingAccounts. Account="+u+" not found.",p,c.FUNC_INOUT)}else St(o+"._CheckPendingAccounts. No private key of the owner",p,c.FUNC_INOUT)}(t),typeof r!=_&&r(a,n)},function(e){return typeof n!=_&&n(e),!1}),void St(Pe+o,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(o,e,n)}};var ot=!1;at.prototype[$]=function(e,r){if(ot)typeof e!=_&&e(200);else{ot=!0;var a="RfDataManager."+$,n=this;try{function s(t){n[ne](function(t){ot=!1,typeof e!=_&&e(200);var r=[];r.push(n.m_sUserId),n.FireEvent("OnAccountChanged",{accounts:r})},function(e){ot=!1,St(a+".saveAccounts. ***putOFS_ErrorCallback*** ->",p,c.FUNC_INOUT),typeof r!=_&&r(e)},rt.USER_DATA,n.m_sUserId);for(var s=t.length,o=0;o<s;o++)n[Q](t[o].grantor,t[o].fileId,function(){},function(){},void 0,!0)}function o(e,n,o){function i(e,t,r){var a=e+r,n=I.FindItemByName(a,t);if(!n)return a;var s=0;for(s=0;s<20;s++)if(a=e+"["+s+"]"+r,!(n=I.FindItemByName(a,t)))return a;return e+r}St(a+"._PutDataToItems ->",p,c.FUNC_INOUT);for(var f=[],u=0;u<n.length;u++){for(var l,_=n[u],d="",S="",y="",R=!1,U=0;U<e.length;U++)if(e[U].id==_.id){d=e[U].name,S=e[U].grantorName?e[U].grantorName:e[U].grantor,l=e[U].localFile,R=!e[U].hash,y=e[U].grantor;break}if(d){if(o=!0,R){var h={};h.fileId=_.id,h.grantor=y,f.push(h)}var O=d.lastIndexOf("."),m=d.substr(O),C=t.FileExtToType(m),v={};if(v[Be]={},v[Be][Ge]="putdataitem",v[Be][Le]=C,v[Be].data=JSON.parse(_.content),l){var E=""==l.path?"/"+l.i.n:l.path+l.i.n;if(!I.FindItemByName(E,C))continue;v[Be][xe]=E}else{var N=d.substr(0,d.lastIndexOf("."));R||(v[Be].shared="R"+_.id);var T=i(R?"/"+N+" (from "+S+")":"/"+S+"'s "+N,C,m);v[Be][xe]=T}I.PutDataItem(v,function(e,t,r){St(a+"._PutDataToItems putAnswer->",p,c.INFO)},r)}}o||f.length?s(f):ot=!1}function i(e,s){for(var i=[],f=0;f<e.length;f++){var u={};u.grantor=e[f].grantor,u.fileId=e[f].id,i.push(u)}n[z](i,function(r){!function(e,r,n){St(a+"._DecryptFileBodiesWithPrivateKey ->",p,c.FUNC_INOUT);var s=I.getPrivateKey();function i(e,r,a,n){var o={in_bytes:t.base64ToBytes(r),key_pem:s,is_key_private:!0};t.SibRSADecryptLongStr(o,function(t){var r=RfapiJS.UTF8.bytesToString(t);a(e,r)},function(e){n(e)})}for(var f=r.length,u=[],l=0;l<r.length;l++){var _=r[l];_.body?i(_.id,_.body,function(t,r){var a={};a.id=t,a.content=r,u.push(a),n=!0,--f||o(e,u,n)},function(t){--f||o(e,u,n)}):(St(a+". File is still in pending status, no body on server id="+_.id,p,c.SPECIAL_CASE),--f||o(e,u,n))}}(e,r.files,s)},function(e){ot=!1,typeof r!=_&&r(e)})}function f(e,r){function a(r,a){for(var s=[],o=0;o<a.length;o++){for(var i=a[o],c=i.id,f=null,u=0;u<e.length;u++){if(c==e[u].s.substr(1)){f=e[u];break}}if(f){for(var p=null,l=0;l<r.length;l++)if(i.recipientEmail==r[l].id){p=r[l].key;break}if(p){var _,d=f.i.n,S=(d.lastIndexOf("."),d.substr(d.lastIndexOf("."))),y=(t.FileExtToType(S),""==f.path?"/"+f.i.n:f.path+"/"+f.i.n),R={};R.path=y,R.pendingItem=i,_=f.e?I.base64Decode(f.i.n,f.b):f.b,R.body=_,R.key=p,s.push(R)}}}!function(e){function t(e,t,r,a,s,o,i,c){n[X]({recipient:e,fileName:r,fileId:t,fileContent:a,skipHash:o,publicKey:s},function(e){i(e)},function(e){c(e)},!0)}e.length;for(var r=0;r<e.length;r++){var a=e[r];t(a.pendingItem.recipientEmail,a.pendingItem.id,a.path,a.body,a.key,!a.pendingItem.hash,function(e,t){},function(e){})}}(s)}function s(e,t,r){n[G](function(e,r,a){t(e,a)},function(e){r(e)},e)}for(var o=[],i=0;i<r.length;i++){for(var c=r[i],f=c.id,u=!1,p=0;p<e.length;p++){if(f==e[p].s.substr(1)){u=!0;break}}u&&(c.pending&&c.recipientEmail&&o.push(c))}for(var l=o.length,_=[],d=0;d<o.length;d++){s(o[d].recipientEmail,function(e,t){var r={};r.key=e,r.id=t,_.push(r),--l||a(_,o)},function(e){--l||a(_,o)})}}return St(Fe+a,p,c.FUNC_INOUT),n[Z](function(o){St(a+".GetFiles_AnswerCallBack ->",p,c.FUNC_INOUT),I.m_AuthUser||I.setUser(n.m_sUserId),I.setSharedFiles(o.receivedFiles,o.grantedFiles);var u=I.GetSharedFiles();if(!u)return ot=!1,void(typeof e!=_&&e(200));var l=u.received,d=o.receivedFiles,S=function(e,n){for(var s=!1,o=0;o<e.length;o++){for(var i=e[o],f=i.s.substr(1),u=!1,l=0;l<n.length;l++)if(n[l].accepted&&f==n[l].id){u=!0;break}if(!u){var _=i.i.n,d=(_.lastIndexOf("."),_.substr(_.lastIndexOf("."))),S=t.FileExtToType(d),y=i.path+_;if(I.FindItemByName(y,S)&&I.FindItemParentByName(y,S)){var R=""==i.path?"/"+i.i.n:i.path+i.i.n,U={};U[Be]={},U[Be][Ge]="delete",U[Be][Le]=S,U[Be][xe]=R,I.DeleteObject(U,function(e,t,r){St(a+"._CheckReceivedFileToDelete putAnswer->",p,c.INFO)},r),s=!0}}}return s}(l,d),y=function(e,t){for(var r=[],a=0;a<t.length;a++){var n=t[a];if(n.accepted){for(var s=n.id,o=!1,i=0;i<e.length;i++){var c=e[i];if(s==c.s.substr(1)){o=!0;break}}if(o){var f,u=n.hash;if(!u)continue;var p=(f=c.e?I.base64Decode(c.i.n,c.b):c.b).replace(new RegExp("/","g"),"\\/"),l=md5.hex(f),_=md5.hex(p);u.toLowerCase()!=l.toLowerCase()&&u.toLowerCase()!=_.toLowerCase()&&(n.localFile=c,n.body=f,r.push(n))}else r.push(n)}}return r}(l,d),R=o.grantedFiles,U=u.granted,h=function(e,r){for(var a=!1,s=0;s<e.length;s++){for(var o=e[s],i=o.s.substr(1),c=!1,f=0;f<r.length;f++)if(i==r[f].id){c=!0;break}if(!c){var u=o.i.n,p=(u.lastIndexOf("."),u.substr(u.lastIndexOf("."))),l=t.FileExtToType(p),_=""==o.path?"/"+o.i.n:o.path+"/"+o.i.n,d=I.FindItemByName(_,l);d&&(delete d.s,I.syncChanges(n.m_sUserId),a=!0)}}return a}(U,R);!function(e,t){function r(e,t,r,a){n[Y](e,t,function(e){r(e)},function(e){a(e)},!0)}for(var a=[],s=0;s<t.length;s++){for(var o=t[s],i=o.id,c=!1,f=0;f<e.length;f++)if(i==e[f].s.substr(1)){c=!0;break}c||a.push(o)}a.length;for(var u=0;u<a.length;u++){var p=a[u];r(p.recipient,p.id,function(e){},function(e){})}}(U,R),f(U,R),y.length?i(y,S||h):S||h?s([]):(ot=!1,typeof e!=_&&e(200))},function(e){return ot=!1,typeof r!=_&&r(e),!1}),void St(Pe+a,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(a,e,r),ot=!1}}},at.prototype[X]=function(e,r,a){var n=X,s="RfDataManager."+n;try{var o=this,i=e.recipient,f=e.fileName,u=e.fileContent,l=e.fileId,d=!!e.skipHash,S=!l,y=f.substr(f.lastIndexOf("/")+1);if(St(Fe+s+"  recipient='"+i+"' file_Id='"+l+"'",p,c.FUNC_INOUT),!o.misc_checkParameters({SERVER_URL:o.m_sServerUrl,USER:o.m_sUserId,RECIPIENT:i},a))return St(s+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;function R(e,u,R){St(s+".grantFile ->",p,c.FUNC_INOUT);var U={};U[Xe]=i,U[we]=l,U[Ye]=e,d||(U.hash=u),typeof y!=_&&(U[Je]=y),U.invite=!0;var h=JSON.stringify(U);return o.internal_RequestAsync(n,o.internal_CreateRequestUrl("?grant-file"),h,o.internal_CreateHeaders(),"POST",!1,!1,!1,{},function(e){if(S){var n=y.lastIndexOf("."),i=y.substr(n),u=t.FileExtToType(i),d={};d[Be]={},d[Be][Ge]="putdataitem",d[Be][Le]=u,d[Be].shared="G"+l,d[Be][xe]=f,d[Be].data=JSON.parse(R),I.PutDataItem(d,function(e,t,n){St(s+"_grant_Ok._PutDataToItems putAnswer->",p,c.INFO),St(s+"._UpdateOneFile ->",p,c.FUNC_INOUT),o[ne](function(e){typeof r!=_&&r(200,l)},function(e){St(s+"._UpdateOneFile. ***putOFS_ErrorCallback*** ->",p,c.FUNC_INOUT),typeof a!=_&&a(e)},rt.USER_DATA,o.m_sUserId)},a)}else typeof r!=_&&r(e,l)},a),!0}function U(e,r){St(s+".encryptFileContentByRecipientPublicKey ->",p,c.FUNC_INOUT);var n=d?"":md5.hex(r);if(l||(l=t.bytesToBase64(t.randomBytes(16)),St(s+".encryptFileContentByRecipientPublicKey. Generate new file_id="+l,p,c.INFO)),e){var o={in_bytes:RfapiJS.UTF8.stringToBytes(r),key_pem:e,is_key_private:!1};t.SibRSAEncryptLongStr(o,function(e){R(t.bytesToBase64(e),n,r)},function(e){typeof a!=_&&a(e)}),St(s+".encryptFileContentByRecipientPublicKey <-",p,c.FUNC_INOUT)}else R("",n,r)}function h(e){if(St(s+"._GetItemBody ->",p,c.FUNC_INOUT),u)U(e,u);else{var r=y.lastIndexOf("."),n=y.substr(r),o=t.FileExtToType(n),i={};i[Be]={},i[Be][Ge]="getdataitem",i[Be][Le]=o,i[Be][xe]=f,I.GetDataItem(i,function(t){St(s+". _GetItemBody. Step 2. _getDataItem_Ok->",p,c.INFO),U(e,JSON.stringify(t))},function(e){typeof a!=_&&a(e)}),St(s+"._GetItemBody <-",p,c.FUNC_INOUT)}}function m(){St(s+"._DownloadRecipientPublicKey ->",p,c.FUNC_INOUT),o[G](function(e,t){St(s+".GetPublicKey_AnswerCallBack. Got public key...",p,c.FUNC_INOUT),h(e)},function(e){o._CheckRegionalServerFromHeader({request:e.HttpRequest},function(){St(s+".GetPublicKey_ErrorCallBack No Public Key.  _OnSameServer ->",p,c.INFO),h("")},a)},i),St(s+".downloadRecipientPublicKey <-",p,c.FUNC_INOUT)}function C(){St(s+"._CheckRecipientsList ->",p,c.FUNC_INOUT),o[Z](function(e){St(s+".GetFiles_AnswerCallBack ->",p,c.FUNC_INOUT);var t=e.grantedFiles;if(t&&t.length){for(var r=!1,n=0;n<t.length;n++){if(t[n].id==l)if(t[n].hash)(t[n].recipientEmail?t[n].recipientEmail:t[n].recipient)==i&&(r=!0)}if(r)return typeof a!=_&&a({Code:O.SibTErr_LocalErr,Description:"Forbidden: Send file to the same recipient after sharing"}),!1;m()}else m()},function(e){return typeof a!=_&&a(e),!1})}return St(s+"._CheckUserDataEtag ->",p,c.FUNC_INOUT),o[oe](function(t,r,n){return St(s+".CheckETag_AnswerCallback. #STEP 1#.  serverTag='"+t+"' account_inner="+n,p,c.FUNC_INOUT),t?o.internal_GetFileTag(n,rt.USER_DATA)==t?(St(s+".CheckETag_AnswerCallback. #STEP 1#. eTags are equal. Proceed to the next step",p,c.FUNC_INFO),void(d?C():e.publicKey?h(e.publicKey):m())):(St(s+".CheckETag_AnswerCallback. #STEP 1#. eTags are NOT equal. GET NEW VERSION FROM SERVER",p,c.FUNC_INFO),I.resetAccountData(n,rt.USER_DATA),i=n,f=rt.USER_DATA,St(s+".  _GetDataFromServer. *Step 1.1* file='"+f+"' account='"+i+"'  ->",p,c.FUNC_INOUT),o[se](function(t,r){St(s+".getAccount_OkCallBack. *Step 1.1* GOT from server OFS='"+f+"'  status='"+t+"' ->",p,c.FUNC_INOUT),d?C():e.publicKey?h(e.publicKey):m()},function(e){St(s+".getAccount_ErrorCallBack.  *Step 1.1* OFS='"+f+"'  account='"+i+" ->",p,c.FUNC_INOUT),typeof a!=_&&a(e)},f,i),void St(" <- "+s+".  _GetDataFromServer. *Step 1.1* file='"+f+"' account='"+i+"'",p,c.FUNC_INOUT)):(St(s+"CheckETag_AnswerCallback. #STEP 1# There is no file on server. Error.",p,c.FUNC_INFO),typeof a!=_&&a({Code:O.SibTErr_LocalErr,Description:"File user-data.rfo not found on server"}),!1);var i,f},function(e){return St(s+".CheckETag_ErrorCallback. ",p,c.FUNC_INOUT),typeof a!=_&&a(e),!1},rt.USER_DATA,o.m_sUserId),void St(Pe+s,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(s,e,a)}},at.prototype[Y]=function(e,t,r,a,n){var s=Y,o="RfDataManager."+s,i=this;try{if(St(Fe+o+" recipient='"+e+"' fileId='"+t+"'",p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId,FILEID:t,RECIPIENT:e},a))return St(o+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var f={};f[Xe]=e,f[we]=t;var u=JSON.stringify(f);return this.internal_RequestAsync(s,this.internal_CreateRequestUrl("?revoke-file"),u,this.internal_CreateHeaders(),"POST",!1,!1,!1,{},function(e){n?typeof r!=_&&(St(o+". innerAnswerCallBack ->",p,c.FUNC_INOUT),r(e)):i[$](function(e){typeof r!=_&&r(e)},function(e){return typeof a!=_&&a(e),!1})},a),void St(Pe+o,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(o,e,a)}},at.prototype[Q]=function(e,t,r,a,n,s){var o=Q,i="RfDataManager."+o,f=this;try{if(St(Fe+i+" grantorId='"+e+"' fileId='"+t+"'",p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId,grantorId:e,FILEID:t},a))return St(i+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var u={};u.grantor=e,u[we]=t,typeof n!=_&&(u.acceptCode=n);var l=JSON.stringify(u);return f.internal_RequestAsync(o,f.internal_CreateRequestUrl("?reject-file"),l,f.internal_CreateHeaders(),"POST",!1,!1,!1,{},function(e){s?typeof r!=_&&(St(i+". innerAnswerCallBack ->",p,c.FUNC_INOUT),r(e)):f[$](function(e){typeof r!=_&&r(e)},function(e){return typeof a!=_&&a(e),!1})},a),void St(Pe+i,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(i,e,a)}},at.prototype.AcceptSharedFile=function(e,t,r){var a="RfDataManager.AcceptSharedFile",n=this;try{if(St(Fe+a,p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId},r))return St(a+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var s=e.grantorId,o=e.fileId,i=e.acceptCode;St(a+"  grantorId='"+s+"' fileId='"+o+"' acceptCode='"+i+"'",p,c.SPECIAL_CASE);var f={};typeof s!=_&&(f.grantor=s),typeof o!=_&&(f[we]=o),typeof i!=_&&(f.acceptCode=i);var u=JSON.stringify(f);return n.internal_RequestAsync("AcceptSharedFile",n.internal_CreateRequestUrl("?accept-file"),u,n.internal_CreateHeaders(),"POST",!1,!1,!1,{},function(e){n[$](function(e){typeof t!=_&&t(e)},r)},r),void St(Pe+a,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(a,e,r)}},at.prototype[Z]=function(e,t){var r=Z,a="RfDataManager."+r;try{return St(Fe+a,p,c.FUNC_INOUT),this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId},t)?(this.internal_RequestAsync(r,this.internal_CreateRequestUrl("?shared-files"),null,this.internal_CreateHeaders(),"GET",!1,!1,!1,{},e,t,!0),void St(Pe+a,p,c.FUNC_INOUT)):(St(a+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1)}catch(e){this.internal_catchedException(a,e,t)}},at.prototype[ee]=function(e,t,r){var a=ee,n="RfDataManager."+a;try{if(St(Fe+n,p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId},r))return St(n+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var s={};typeof e!=_&&(s.fileIds=[e]);var o=JSON.stringify(s);return this.internal_RequestAsync(a,this.internal_CreateRequestUrl("?shared-files"),o,this.internal_CreateHeaders(),"POST",!1,!1,!1,{},t,r,!0),void St(Pe+n,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(n,e,r)}},at.prototype[z]=function(e,t,r){var a=z,n="RfDataManager."+a;try{if(St(Fe+n,p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId},r))return St(n+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var s={};s.files=e;var o=JSON.stringify(s);return this.internal_RequestAsync(a,this.internal_CreateRequestUrl("?received-files"),o,this.internal_CreateHeaders(),"POST",!1,!1,!1,{},t,r),void St(Pe+n,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(n,e,r)}},at.prototype[G]=function(e,t,r){var a=G,n="RfDataManager."+a;try{if(St(Fe+n,p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId},t))return St(n+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var s=typeof r==_?this.m_sUserId:r,o=this.m_sServerUrl+"/rf-api/"+encodeURI(s)+"?publickey";return this.internal_RequestAsync(a,o,null,this.internal_CreateHeaders(),"GET",!1,!1,!1,{},function(t,r,a){e(t,r,a)},t),void St(Pe+n,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(n,e,t)}},at.prototype[B]=function(e,t,r,a){var n=B,s="RfDataManager."+n;try{if(St(Fe+s,p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId},r))return St(s+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var o=typeof a==_?this.m_sUserId:a,i=this.m_sServerUrl+"/rf-api/"+encodeURI(o)+"?publickey";return this.internal_RequestAsync(n,i,e,this.internal_CreateHeaders(),"POST",!1,!1,!1,{},t,r),void St(Pe+s,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(s,e,r)}},at.prototype.CreateCompanyMember=function(e,n,s){var o="RfDataManager.CreateCompanyMember";try{e.onProgress||(e.onProgress=function(){}),typeof s==_&&(s=function(){});var i=e.memberLogin,f=e.memberPwd,u=e.memberName,l=e.memberMail,d=e.memberPhone,S=e.company,y=e.isAdmin,R=e.otpOn,U=e.passwordExpires,h=e.passwordExpiresInDays,I=e.sendNotifyEmail,m=e.onProgress;St(Fe+o+" member='"+i+"'  company='"+S+"'",p,c.FUNC_INOUT);var C=this;if(!C.m_sServerUrl)return St(o+". Server Url is undefined. Return false",p,c.SPECIAL_CASE),s(new tt(N.RfErr_WrongParams,"Server URL is not defined"));if(!C.m_sUserId)return St(o+". Current user is undefined. Return false",p,c.SPECIAL_CASE),s(new tt(N.RfErr_WrongParams,"UserId is not defined"));if(!i)return St(o+". Company Member login is undefined. Return false",p,c.SPECIAL_CASE),s(new tt(N.RfErr_WrongParams,"UserId is not defined"));if((i=i.trim()).length<6||i.length>80)return St(o+". Company member login is incorrect (6-30 symbols). Return false",p,c.SPECIAL_CASE),s(new tt(N.RfErr_WrongParams,"Company member login is incorrect (6-30 symbols)"));if(!f)return St(o+". Company member password is undefined. Return false",p,c.SPECIAL_CASE),s(new tt(N.RfErr_WrongParams,"Password cannot be empty"));if(!C.internal_isPasswordCorrect(f,s))return!1;if(!u)return St(o+". Company member Name is undefined. Return false",p,c.SPECIAL_CASE),s(new tt(N.RfErr_WrongParams,"User name is not defined"));if((u=u.trim()).length<2||u.length>60)return St(o+". Company member name is incorrect (2-60 symbols). Return false",p,c.SPECIAL_CASE),s(new tt(N.RfErr_WrongParams,"Company member name is incorrect (2-60 symbols)"));if(!S)return St(o+". Company Name is undefined. Return false",p,c.SPECIAL_CASE),s(new tt(N.RfErr_WrongParams,"Empty Company Name"));if((S=S.trim()).length<6||S.length>80)return St(o+". Company name is incorrect (6-80 symbols). Return false",p,c.SPECIAL_CASE),s(new tt(N.RfErr_WrongParams,"Company name is incorrect (6-80 symbols)"));if(!l)return St(o+". Member email is undefined. Return false",p,c.SPECIAL_CASE),s(new tt(N.RfErr_WrongParams,"User email is empty."));if((l=l.trim()).length<6||l.length>80)return St(o+". Member email is incorrect (6-50 symbols). Return false",p,c.SPECIAL_CASE),s(new tt(N.RfErr_WrongParams,"Member email is incorrect (6-50 symbols)"));if(typeof d!=_&&""!=d&&(d.length<7||d.length>20))return St(o+". Member phone is incorrect (7-20 symbols). Return false",p,c.SPECIAL_CASE),s(new tt(N.RfErr_WrongParams,"Member phone is incorrect (7-20 symbols)"));function v(e){St(o+". EncryptData. Step 3.a -> ",p,c.INFO);var t=new RfapiJS.CRfOneFileSys;C.ObjectOFSToBytes(e,function(e){t.EncodeZipOFSBytes(e,rt.USER_DATA,i,f,be,!0,function(e){St(o+". Step 3.a  encrypt_Ok callback ->",p,c.FUNC_INOUT),m(90),function(e){St(o+". uploadOFS_CompanyMember. Step 3. -> ",p,c.INFO);var t=C.internal_CreateHeaders(!0),r=rt.USER_DATA,a=C.m_sServerUrl+"/rf-api/"+encodeURI(i)+"/"+r;St(o+". Step 3. SAVE OFS "+a,p,c.INFO),C.makeRequestAsync(a,e,t,"POST",!1,!0,function(e,t){return St(o+". Step 3.  makeRequestAsync.saveOFS_callback ->",p,c.FUNC_INOUT),C.misc_checkHttpResponse(e,t,s)?e.status==Ae?s(new tt(e.status,e.statusText,void 0,e,void 0)):e.status==ge?s(new tt(e.status,e.statusText,void 0,e,void 0)):(St(o+". Step 3.  makeRequestAsync.saveOFS_callback. OK. Exit.",p,c.FUNC_INOUT),m(100),void(typeof n!=_&&n(e.status))):(St(o+". Step 3. makeRequestAsync.saveOFS_callback failed. Return false.",p,c.SPECIAL_CASE),!1)})}(new Uint8Array(e))},s)},s),St(o+". EncryptData. Step 3.a <-",p,c.INFO)}var E=t.randomBytes(16),T=new RfapiJS.SibScramAuthClient;St(o+". member pwd='"+f+"'",p,c.INFO);for(var A=T.CalcStoredInfo(r.stringToBytes(f),E,Me),g=A.item2,F=A.item3,P=0;P<F.length;P++)g.push(F[P]);var D=t.bytesToBase64(g);D=D.replace(new RegExp("=","g"),""),E=(E=t.bytesToBase64(E)).replace(new RegExp("=","g"),"");var k={};k[Je]=u,k.login=i,k.email=l,k[et]=S,typeof d!=_&&(k.phone=d),typeof y!=_&&(k.isAdmin=y),typeof R!=_&&(k.otpOn=R),typeof U!=_&&(k.passwordExpires=U),typeof h!=_&&(k.passwordExpiresInDays=h),typeof I!=_&&(k.sendNotifyEmail=I),k.method="SCRAM-SHA-256",k.iterations=Me,k.salt=E,k.hash=D,k.pwd=f;var b=C.internal_CreateHeaders(),M=JSON.stringify(k),w=C.m_sServerUrl+"/rf-api?create-company-member";return C.makeRequestAsync(w,M,b,"POST",!1,!1,function(e,t){if(St(o+". makeRequestAsync ->",p,c.FUNC_INOUT),!C.misc_checkHttpResponse(e,t,s))return St(o+". checkHttpResponse failed. Return false.",p,c.SPECIAL_CASE),!1;if(e.status==Ee){if(St(o+". Status code=OK. Need to parse response for errors. RESPONSE  = "+e.responseText,p,c.INFO),e.responseText)try{var r=JSON.parse(e.responseText),n=r[je][We];if("error"==n)return St(o+". Server returns status=error.",p,c.SPECIAL_CASE),s(new tt(O.SibTErr_ServerErr,"Server returns status=error",r[je]));if("ok"==n)return St(o+". Status=OK. It's time to generate RSA keys, OFS. makeRequestAsync ->",p,c.FUNC_INOUT),m(50),void function(){St(o+". generateRsaKeys. Step 2. -> ",p,c.INFO);var e=a.GenerateKeysWithCheck(1024),t=e.Public_Pem,r=e.Private_Pem,n=Math.round(new Date/1e3),f={i:{F:!0},c:[{b:r,i:{n:"private-key.pem",c:n,m:n,s:r.length}},{i:{F:!0,n:"root"},c:[]}]};C[B](t,function(e){return m(80),v(f),!0},function(e){return s(e)},i)}()}catch(e){return St(o+". Error while parsing JSON response",p,c.SPECIAL_CASE),s(new tt(O.SibTErr_ServerErr,"Error Parsing JSON response"))}return!0}return s(new tt(e.status,e.statusText,void 0,e,void 0))}),void St(Pe+o,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(o,e,s)}},at.prototype.GetCompanies=function(e,t){var r="RfDataManager.GetCompanies";try{return St(Fe+r,p,c.FUNC_INOUT),this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId},t)?(this.internal_RequestAsync("GetCompanies",this.internal_CreateRequestUrl("?companies"),null,this.internal_CreateHeaders(),"GET",!1,!1,!1,{},e,t),void St(Pe+r,p,c.FUNC_INOUT)):(St(r+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1)}catch(e){this.internal_catchedException(r,e,t)}},at.prototype.CompanyAddUser=function(e,t,r,a,n,s){var o="RfDataManager.CompanyAddUser";try{if(St(Fe+o+". UserToAdd='"+e+"'  ToCompany='"+t+"'",p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId,ADD_USERNAME:e,COMPANY:t},a))return St(o+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;e=e.trim(),t=t.trim();var i={};i.user=e,i[et]=t,typeof n!=_&&(i.isAdmin=n),typeof s!=_&&(i.status=s);var f=JSON.stringify(i);return this.internal_RequestAsync("CompanyAddUser",this.internal_CreateRequestUrl("?company-add-user"),f,this.internal_CreateHeaders(),"POST",!1,!1,!1,{},r,a),void St(Pe+o,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(o,e,a)}},at.prototype.CompanyRemoveUser=function(e,t,r,a){var n="RfDataManager.CompanyRemoveUser";try{if(St(Fe+n+". UserToRemove='"+e+"'  FromCompany='"+t+"'",p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId,REMOVE_USERNAME:e,COMPANY:t},a))return St(p+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var s={};s.user=e,s[et]=t;var o=JSON.stringify(s);return this.internal_RequestAsync("CompanyRemoveUser",this.internal_CreateRequestUrl("?company-remove-user"),o,this.internal_CreateHeaders(),"POST",!1,!1,!1,{},r,a),void St(Pe+n,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(n,e,a)}},at.prototype.ConvertCompanyMemberToPersonal=function(e,t,r){var a="ConvertCompanyMemberToPersonal",n="RfDataManager."+a;try{var s=e.user,o=e.company;if(St(Fe+n+". user='"+s+"' from company='"+o+"'",p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:s,COMPANY:o},r))return St(n+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var i={};i.user=s,i[et]=o;var f=JSON.stringify(i),u=this.m_sServerUrl+"/rf-api/"+encodeURI(this.m_sUserId)+"?company-member-to-personal";return this.internal_RequestAsync(a,u,f,this.internal_CreateHeaders(),"POST",!1,!1,!1,{},t,r),void St(Pe+n,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(n,e,r)}},at.prototype.CreateCompany=function(e,t,r,a,n,s,o,i){var f="RfDataManager.CreateCompany";try{if(St(Fe+f+". CompanyName='"+e+"'",p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,NAME:e},r))return St(f+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;if((e=e.trim()).length<2||e.length>60)return St(f+". Company NAME is incorrect (2-60 symbols). Return false",p,c.SPECIAL_CASE),typeof r!=_&&r(new tt(N.RfErr_WrongParams,"Company NAME is incorrect (2-60 symbols)")),!1;if(typeof a!=_&&(a.length<6||a.length>80))return St(f+". Company ID is incorrect (6-80 symbols). Return false",p,c.SPECIAL_CASE),typeof r!=_&&r(new tt(N.RfErr_WrongParams,"Company ID is incorrect (6-80 symbols)")),!1;if(typeof n!=_){if(n.length<6||n.length>80)return St(f+". Company admin is incorrect (6-80 symbols). Return false",p,c.SPECIAL_CASE),typeof r!=_&&r(new tt(N.RfErr_WrongParams,"Company admin is incorrect (6-80 symbols)")),!1;if(n==e)return St(f+". Company Name must be unique for this admin account ID. Return false",p,c.SPECIAL_CASE),typeof r!=_&&r(new tt(N.RfErr_WrongParams,"Company Name must be unique for this admin account ID.")),!1}if(typeof s!=_&&(s.length<7||s.length>60))return St(f+". Company URL is incorrect (7-60 symbols)[Optional]. Return false",p,c.SPECIAL_CASE),typeof r!=_&&r(new tt(N.RfErr_WrongParams,"Company URL is incorrect (7-60 symbols)[Optional]")),!1;var u={};u[Je]=e,typeof a!=_&&(u.id=a),typeof n!=_&&(u.admin=n),typeof s!=_&&(u.url=s),typeof i!=_&&(u.policies=i);var l=JSON.stringify(u);if(typeof o!=_)var d=this.m_sServerUrl+"/rf-api/"+encodeURI(o)+"?createcompany";else d=this.m_sServerUrl+"/rf-api?createcompany";return this.internal_RequestAsync("CreateCompany",d,l,this.internal_CreateHeaders(),"POST",!1,!1,!1,{},t,r),void St(Pe+f,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(f,e,r)}},at.prototype.DeleteCompany=function(e,t,r){var a="RfDataManager.DeleteCompany";try{if(St(Fe+a+". Company='"+e+"'",p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId,COMPANY:e},r))return St(a+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;if(e.length<6||e.length>80)return St(a+". Company name is incorrect (6-80 symbols). Return false",p,c.SPECIAL_CASE),typeof r!=_&&r(new tt(N.RfErr_WrongParams,"Company name is incorrect (6-80 symbols)")),!1;var n={};n[et]=e;var s=JSON.stringify(n);return this.internal_RequestAsync("DeleteCompany",this.internal_CreateRequestUrl("?delete-company"),s,this.internal_CreateHeaders(),"POST",!1,!1,!1,{},t,r),void St(Pe+a,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(a,e,r)}},at.prototype.JoinCompany=function(e,t,r){var a="RfDataManager.JoinCompany";try{if(St(Fe+a+". Company='"+e+"'",p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId,COMPANY:e},r))return St(a+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;if(e.length<6||e.length>80)return St(a+". Company name is incorrect (6-80 symbols). Return false",p,c.SPECIAL_CASE),typeof r!=_&&r(new tt(N.RfErr_WrongParams,"Company name is incorrect (6-80 symbols)")),!1;var n={};n[et]=e;var s=JSON.stringify(n);return this.internal_RequestAsync("JoinCompany",this.internal_CreateRequestUrl("?company-join"),s,this.internal_CreateHeaders(),"POST",!1,!1,!1,{},t,r),void St(Pe+a,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(a,e,r)}},at.prototype.LeaveCompany=function(e,t,r){var a="RfDataManager.LeaveCompany";try{if(St(Fe+a+". Company='"+e+"'",p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId,COMPANY:e},r))return St(a+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;if(e.length<6||e.length>80)return St(a+". Company name is incorrect (6-80 symbols). Return false",p,c.SPECIAL_CASE),typeof r!=_&&r(new tt(N.RfErr_WrongParams,"Company name is incorrect (6-80 symbols)")),!1;var n={};n[et]=e;var s=JSON.stringify(n);return this.internal_RequestAsync("LeaveCompany",this.internal_CreateRequestUrl("?company-leave"),s,this.internal_CreateHeaders(),"POST",!1,!1,!1,{},t,r),void St(Pe+a,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(a,e,r)}},at.prototype[H]=function(e,t,r,a){var n=H,s="RfDataManager."+n;try{St(Fe+s+". Company='"+e+"'",p,c.FUNC_INOUT);var o=a&&a.company?a.company:e;if(!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId,COMPANY:o},r))return St(s+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;if("POST"==(a&&a.method&&("GET"==a.method||"POST"==a.method)?a.method:"GET")){var i={};i[et]=o,a&&(typeof a.sort!=_&&(i.sort=a.sort),typeof a.fields!=_&&(i.fields=a.fields),typeof a.offset!=_&&(i.offset=a.offset),typeof a.limit!=_&&(i.limit=a.limit),typeof a.filter!=_&&(i.filter=a.filter),typeof a.after!=_&&(i.after=a.after),typeof a.countOnly!=_&&(i.countOnly=a.countOnly));var f=JSON.stringify(i);this.internal_RequestAsync(n,this.internal_CreateRequestUrl("?company-users"),f,this.internal_CreateHeaders(),"POST",!1,!1,!1,{},t,r)}else{var u=this.internal_CreateRequestUrl("?company-users"),l="&company="+encodeURIComponent(o);if(a)for(var d in a)"company"!=d&&"method"!=d&&(l=l+"&"+d+"="+encodeURIComponent(a[d]));this.internal_RequestAsync(n,u+l,null,this.internal_CreateHeaders(),"GET",!1,!1,!1,{},t,r)}return void St(Pe+s,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(s,e,r)}},at.prototype.GetAllCompanies=function(e,t,r){var a="RfDataManager.GetAllCompanies";try{if(St(Fe+a,p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId},r))return St(a+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;if("POST"==(e&&e.doPost?"POST":"GET")){var n={};e&&(void 0!==e.fields&&(n.fields=e.fields),void 0!==e.filter&&(n.filter=e.filter),void 0!==e.after&&(n.after=e.after),void 0!==e.sort&&(n.sort=e.sort),void 0!==e.limit&&(n.limit=e.limit),void 0!==e.offset&&(n.offset=e.offset),void 0!==e.countOnly&&(n.countOnly=e.countOnly));var s=JSON.stringify(n);this.internal_RequestAsync("GetAllCompanies",this.internal_CreateRequestUrl("?all-companies"),s,this.internal_CreateHeaders(),"POST",!1,!1,!1,{},t,r)}else{var o=this.internal_CreateRequestUrl("?all-companies"),i="";if(e)for(var f in e)"fields"!=f&&"filter"!=f&&"after"!=f&&"sort"!=f&&"limit"!=f&&"offset"!=f&&"countOnly"!=f||(i=i+"&"+f+"="+encodeURIComponent(e[f]));this.internal_RequestAsync("GetAllCompanies",o+i,null,this.internal_CreateHeaders(),"GET",!1,!1,!1,{},t,r)}return void St(Pe+a,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(a,e,r)}},at.prototype.UpdateCompanyProperties=function(e,t,r){var a="RfDataManager.UpdateCompanyProperties";try{var n=e.companyId,s=e.name,o=e.url,i=e.logo,f=e.numberOfLicenses,u=e.expirationTime,l=e.policies;if(St(Fe+a+". company_id='"+n+"' set name='"+s+"' url='"+o+"'",p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId,COMPANY:n},r))return St(a+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var d={};d[et]=n,typeof l!=_&&(d.policies=l),typeof s!=_&&(d.name=s),typeof o!=_&&(d.url=o),typeof i!=_&&(d.logo=i),typeof f!=_&&(d.numberOfLicenses=f),typeof u!=_&&(d.expirationTime=u);var S=JSON.stringify(d),y=this.m_sServerUrl+"/rf-api/"+encodeURI(this.m_sUserId)+"?company-member-info";return this.internal_RequestAsync("UpdateCompanyProperties",y,S,this.internal_CreateHeaders(),"POST",!1,!1,!1,{},t,r),void St(Pe+a,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(a,e,r)}},at.prototype.UpdateCompanyMemberInfo=function(e,r,n,s,o,i,f,u,l,d,S){var y,R="UpdateCompanyMemberInfo",U="RfDataManager."+R;try{var h=this;if(St(Fe+U+". Member='"+e+"' from Company='"+r+"'",p,c.FUNC_INOUT),!h.misc_checkParameters({SERVER_URL:h.m_sServerUrl,USER:h.m_sUserId,COMPANY:r},s))return St(U+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;function O(o,i,f,u){St(U+". encryptGroupPwdByUserPublicKey. Step 4. ->",p,c.INFO);var l=[];St(U+". encryptGroupPwdByUserPublicKey. Step 4. allgroups="+i.length,p,c.INFO);for(var d=0;d<i.length;d++){if((typeof i[d].company==_?"":i[d].company)==r)try{var S={};S[RfapiJS.ACCOUNT_ID_PROP]=i[d][RfapiJS.ACCOUNT_ID_PROP],St(U+". encryptGroupPwdByUserPublicKey. Step 4. accountId="+S[RfapiJS.ACCOUNT_ID_PROP],p,c.INFO);var y=i[d].mp,I=t.base64ToBytes(y),O=t.bytesToHex(I),m=new RSAKey,C=a.GetHexFromPEM(u,!1);m.setPrivateEx(C.modulus,C.exponent,C.privateexp,C.P,C.Q,C.DP,C.DQ,C.InverseQ);var v=m.decrypt(O);if(!v){St(U+". encryptGroupPwdByUserPublicKey. CANNOT decrypt password for accountId='"+S[RfapiJS.ACCOUNT_ID_PROP]+"'  name='"+i[d].name+"'",p,c.INFO);continue}var E=new RSAKey,N=a.GetHexFromPEM(f,!0);E.setPublic(N.modulus,N.exponent);var T=E.encrypt(v),A=t.bytesToBase64(t.hexToBytes(T));if(S.mp=A,!A){St(U+". encryptGroupPwdByUserPublicKey. New Password is empty for for accountId='"+S[RfapiJS.ACCOUNT_ID_PROP]+"'  name='"+i[d].name+"'",p,c.INFO);continue}l.push(S),St(U+". encryptGroupPwdByUserPublicKey. Step 4. groupId="+S.accountId+"  realPwd='"+v+"'",p,c.INFO)}catch(e){St(U+". encryptGroupPwdByUserPublicKey. ERROR="+e,p,c.INFO)}}o.groups=l,St(U+".encryptGroupPwdByUserPublicKey. Step 4. isAdmin. There are groups. Send them in json body.",p,c.INFO);var g=JSON.stringify(o),F=h.m_sServerUrl+"/rf-api/"+encodeURI(e)+"?company-member-info";h.internal_RequestAsync(R,F,g,h.internal_CreateHeaders(),"POST",!1,!1,!1,{},n,s),St(U+". encryptGroupPwdByUserPublicKey. Step 4. ->",p,c.INFO)}function m(t,r){St(U+". getPublicUserKey. Step 2. ->",p,c.INFO),h[G](function(e,a){St(U+". getPublicUserKey_AnswerCallBack. Step 2. -> ",p,c.INFO),function(e,t,r){if(St(U+". getPrivateAdminKey. Step 3. ->",p,c.INFO),I.getDataByAccountId(rt.USER_DATA,h.m_sUserId)){var a=I.getPrivateKey();if(!a)return void(typeof s!=_&&s(new tt(N.RfErr_BadData,"Cannot get RSA Private Key")));O(e,t,r,a)}else h[se](function(a){if(St(U+". getOFS_OkCallBack. Step 3. ->",p,c.INFO),a==Ee){var n=I.getPrivateKey();return n?void O(e,t,r,n):void(typeof s!=_&&s(new tt(N.RfErr_BadData,"Cannot get RSA Private Key")))}typeof s!=_&&s(new tt(N.RfErr_BadData,"Cannot get user-data.rfo"))},s,rt.USER_DATA,h.m_sUserId);St(U+". getPrivateAdminKey. Step 3. <-",p,c.INFO)}(t,r,e)},function(e){return St(U+". getPublicUserKey_ErrorCallBack. Step 2. -> ",p,c.INFO),typeof s!=_&&s(e),!1},e),St(U+". getPublicUserKey. Step 2. <-",p,c.INFO)}var C={};if(C[et]=r,typeof i!=_&&(C.policies=i),typeof f!=_&&(C.name=f),typeof u!=_&&(C.url=u),typeof l!=_&&(C.logo=l),typeof d!=_&&(C.numberOfLicenses=d),typeof S!=_&&(C.expirationTime=S),typeof o!=_){if(St(U+". isAdmin='"+o+"'",p,c.INFO),C.isAdmin=o,o)return St(U+". isAdmin!  Need to get groups of this company..",p,c.INFO),y=C,St(U+". getAllGroups. Step 1. -> ",p,c.INFO),h[L](function(t,r){if(St(U+". getGroups_OKCallback. Step 1. -> ",p,c.INFO),t.accounts.length)m(y,t.accounts);else{y.groups=[],St(U+".getAllGroups. Step 1. isAdmin. There are no groups. Send empty array array in json body.",p,c.INFO);var a=JSON.stringify(y),o=h.m_sServerUrl+"/rf-api/"+encodeURI(e)+"?company-member-info";h.internal_RequestAsync(R,o,a,h.internal_CreateHeaders(),"POST",!1,!1,!1,{},n,s)}},function(e){St(U+". getGroups_ErrorCallback. Step 1. -> ",p,c.INFO),typeof s!=_&&s(e)}),void St(U+". getAllGroups. Step 1. <-",p,c.INFO);var v=JSON.stringify(C),E=h.m_sServerUrl+"/rf-api/"+encodeURI(e)+"?company-member-info";h.internal_RequestAsync(R,E,v,h.internal_CreateHeaders(),"POST",!1,!1,!1,{},n,s)}else{v=JSON.stringify(C);if(e){E=h.m_sServerUrl+"/rf-api/"+encodeURI(e)+"?company-member-info";h.internal_RequestAsync(R,E,v,h.internal_CreateHeaders(),"POST",!1,!1,!1,{},n,s)}else{var E=h.m_sServerUrl+"/rf-api/"+encodeURI(h.m_sUserId)+"?company-member-info";h.internal_RequestAsync(R,E,v,h.internal_CreateHeaders(),"POST",!1,!1,!1,{},n,s)}}return void St(Pe+U,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(U,e,s)}},at.prototype.GetCompanyGroups=function(e,t,r){var a="RfDataManager.GetCompanyGroups";try{if(St(Fe+a+". Company='"+e+"'",p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId,COMPANY:e},r))return St(a+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var n={};n[et]=e;var s=JSON.stringify(n);return this.internal_RequestAsync("GetCompanyGroups",this.internal_CreateRequestUrl("?company-groups"),s,this.internal_CreateHeaders(),"POST",!1,!1,!1,{},t,r),void St(Pe+a,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(a,e,r)}},at.prototype.GetCompanyInfo=function(e,t){var r="RfDataManager.GetCompanyInfo";try{return St(Fe+r,p,c.FUNC_INOUT),this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId},t)?(this.internal_RequestAsync("GetCompanyInfo",this.internal_CreateRequestUrl("?company-info"),null,this.internal_CreateHeaders(),"GET",!1,!1,!1,{},e,t),void St(Pe+r,p,c.FUNC_INOUT)):(St(r+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1)}catch(e){this.internal_catchedException(r,e,t)}},at.prototype[b]=function(e,t,r){var a=b,n="RfDataManager."+a;try{if(St(Fe+n,p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId},t))return St(n+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var s=typeof r==_?this.m_sUserId:r,o=this.m_sServerUrl+"/rf-api/"+encodeURI(s)+"?trusted-users";return this.internal_RequestAsync(a,o,null,this.internal_CreateHeaders(),"GET",!1,!1,!1,{},e,t),void St(Pe+n,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(n,e,t)}},at.prototype[D]=function(e,t,r){var a=D,n="RfDataManager."+a;try{if(St(Fe+n,p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId},r))return St(n+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var s={};s.trustedUsers=e;var o=JSON.stringify(s);return this.internal_RequestAsync(a,this.internal_CreateRequestUrl("?trusted-users"),o,this.internal_CreateHeaders(),"POST",!1,!1,!1,{},t,r),void St(Pe+n,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(n,e,r)}},at.prototype[k]=function(e,r){var n="RfDataManager."+k;try{var s=this;if(St(Fe+n,p,c.FUNC_INOUT),!s.misc_checkParameters({SERVER_URL:s.m_sServerUrl,USER:s.m_sUserId},r))return St(n+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;function o(o){St(n+". encryptNewPasswordByUserPublicKey. Step 2. ->",p,c.INFO);for(var i=s[Oe](),f=[],u=0;u<o.length;u++){var l=o[u],d=l.publicKey,S=CryptoJS.MD5(d).toString(CryptoJS.enc.hex),y=new RSAKey,R=a.GetHexFromPEM(d,!0);y.setPublic(R.modulus,R.exponent);var U=y.encrypt(i),h=t.bytesToBase64(t.hexToBytes(U)),I={};I.accountId=l.accountId,I.mp=h,I.publicKeyHash=S,f.push(I)}!function(t){St(n+". updateTrustedUsersPwd. Step 3. ->",p,c.INFO),s[D](t,function(r){St(n+". putTrusted_Ok. Step 3. -> ",p,c.INFO),typeof e!=_&&e({count:t.length}),St(n+". putTrusted_Ok. Step 3. updated Users="+t.length+" <-",p,c.INFO)},function(e){St(n+". putTrusted_Error. Step 3. -> ",p,c.INFO),typeof r!=_&&r(e)}),St(n+". updateTrustedUsersPwd. Step 3. <-",p,c.INFO)}(f),St(n+". encryptNewPasswordByUserPublicKey. Step 2. <-",p,c.INFO)}return St(n+". getTrustedUsersList. Step 1. -> ",p,c.INFO),s[b](function(t){St(n+". getTrusted_Ok. Step 1. -> ",p,c.INFO);for(var r=t.trustedUsers,a=[],s=0;s<r.length;s++){var i=r[s];typeof i.uptodate!=_&&i.uptodate||(a.push(i),St(n+". getTrusted_Ok. Step 1. Need to update accountId='"+i.accountId+"'",p,c.INFO))}if(!a.length)return typeof e!=_&&e({count:0}),void St(n+". getTrusted_Ok. Step 1. <-(AnswerCallBack)",p,c.INFO);o(a),St(n+". getTrusted_Ok. Step 1. updatedUsers="+a.length+" <-",p,c.INFO)},function(e){St(n+". getTrusted_Error. Step 1. -> ",p,c.INFO),typeof r!=_&&r(e)}),St(n+". getTrustedUsersList. Step 1. <- ",p,c.INFO),void St(Pe+n,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(n,e,r)}},at.prototype[M]=function(e,r,n){var s="RfDataManager."+M;try{var o=this;if(St(Fe+s,p,c.FUNC_INOUT),!o.misc_checkParameters({SERVER_URL:o.m_sServerUrl,USER:o.m_sUserId,ACCOUNT:e},n))return St(s+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;function i(n,o){St(s+". decryptPwdByPrivateKey. Step 3. ->",p,c.INFO);var i=t.base64ToBytes(n),f=t.bytesToHex(i),u=a.GetHexFromPEM(o,!1),l=new RSAKey;l.setPrivateEx(u.modulus,u.exponent,u.privateexp,u.P,u.Q,u.DP,u.DQ,u.InverseQ);var d=l.decrypt(f);typeof r!=_&&r({pwd:d,account:e}),St(s+". decryptPwdByPrivateKey. Step 3. pwd='"+d+"'",p,c.INFO)}return function(){St(s+". getCompanyMemberAccountInfo. Step 1. ->",p,c.INFO);var t=o.m_sServerUrl+"/rf-api/"+encodeURI(e)+"?get-account-info";o.internal_RequestAsync(F,t,null,o.internal_CreateHeaders(),"POST",!1,!1,!1,{userId:e,getUserInfo:!0},function(e){St(s+". getUserInfo_Ok. Step 1. ->",p,c.INFO);var t=e.mp;if(!t)return St(s+". getUserInfo_Ok. Step 1. Master pwd is empty!",p,c.INFO),void(typeof n!=_&&n(new tt(N.RfErr_BadData,"get-account-info returned empty mp field")));!function(e){if(St(s+". getPrivateAdminKey. Step 2. ->",p,c.INFO),I.getDataByAccountId(rt.USER_DATA,o.m_sUserId)){var t=I.getPrivateKey();if(!t)return void(typeof n!=_&&n(new tt(N.RfErr_BadData,"Cannot get RSA Private Key")));i(e,t)}else o[se](function(t){if(St(s+". getOFS_OkCallBack. Step 2. ->",p,c.INFO),t==Ee){var r=I.getPrivateKey();return r?void i(e,r):void(typeof n!=_&&n(new tt(N.RfErr_BadData,"Cannot get RSA Private Key")))}typeof n!=_&&n(new tt(N.RfErr_BadData,"Cannot get user-data.rfo"))},n,rt.USER_DATA,o.m_sUserId);St(s+". getPrivateAdminKey. Step 2. <-",p,c.INFO)}(t),St(s+". getUserInfo_Ok. Step 1. mp='"+t+"'",p,c.INFO)},function(e){St(s+". getUserInfo_Error. Step 1. ->",p,c.INFO),typeof n!=_&&n(e)},!0),St(s+". getCompanyMemberAccountInfo. Step 1. ->",p,c.INFO)}(),void St(Pe+s,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(s,e,n)}},at.prototype.InviteEmergencyContact=function(e,t,r,a,n,s,o){var i="InviteEmergencyContact",f="RfDataManager."+i;try{var u=this;if(St(Fe+f,p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId,CONTACT:e},a))return St(f+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;function l(){if(typeof t==_&&typeof n==_)return typeof a!=_&&a(new tt(N.RfErr_BadData,"TimeoutDays or TimeoutSecs must be present.")),St(f+". misc_checkParameters failed. Return false. TimeoutDays or TimeoutSecs must be present.",p,c.SPECIAL_CASE),!1;if(typeof t!=_&&NaN==parseInt(t))return typeof a!=_&&a(new tt(N.RfErr_BadData,"Timeout in days must be integer.")),St(f+". misc_checkParameters failed. Return false. TimeoutDays must be integer",p,c.SPECIAL_CASE),!1;if(typeof n!=_&&NaN==parseInt(n))return typeof a!=_&&a(new tt(N.RfErr_BadData,"Timeout in seconds must be integer.")),St(f+". misc_checkParameters failed. Return false. TimeoutSecs must be integer",p,c.SPECIAL_CASE),!1;var l=0;typeof t==_&&typeof n!=_?l=parseInt(n):typeof t!=_&&typeof n==_?l=60*parseInt(t)*60*24:typeof t!=_&&typeof n!=_&&(l=parseInt(n));var d={};d.contact=e,d.timeoutSecs=l,typeof s!=_&&(d.note=s),typeof o!=_&&(d.invite=o);var S=JSON.stringify(d);u.internal_RequestAsync(i,u.internal_CreateRequestUrl("?ea-invite"),S,u.internal_CreateHeaders(),"POST",!1,!1,!1,{},function(e){St(f+".OK_callback #STEP 1#",p,c.FUNC_INOUT),u[k](function(e){St(f+". updateTrustedUsers. OK_callback #STEP 2#",p,c.FUNC_INOUT),typeof r!=_&&r(e)},function(e){return St(f+". updateTrustedUsers. Error_callback #STEP 2#",p,c.FUNC_INOUT),typeof a!=_&&a(e),!1})},function(e){St(f+".Error_callback #STEP 1#",p,c.FUNC_INOUT),typeof a!=_&&a(e)})}return St(f+"._DownloadInvitedUserPublicKey ->",p,c.FUNC_INOUT),u[G](function(e,t){St(f+".GetPublicKey_AnswerCallBack. Got public key.",p,c.FUNC_INOUT),l()},function(e){u._CheckRegionalServerFromHeader({request:e.HttpRequest},function(){St(f+".GetPublicKey_ErrorCallBack No Public Key.  _OnSameServer ->",p,c.INFO),l()},a)},e),St(f+"._DownloadInvitedUserPublicKey <-",p,c.FUNC_INOUT),void St(Pe+f,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(f,e,a)}},at.prototype.UpdateEmergencyContactInfo=function(e,t,r,a,n,s){var o="UpdateEmergencyContactInfo",i="RfDataManager."+o;try{if(St(Fe+i,p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId,CONTACT:e},r))return St(i+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;if(typeof a!=_&&NaN==parseInt(a))return typeof r!=_&&r(new tt(N.RfErr_BadData,"Timeout in days must be integer.")),St(i+". misc_checkParameters failed. Return false. TimeoutDays must be integer",p,c.SPECIAL_CASE),!1;if(typeof n!=_&&NaN==parseInt(n))return typeof r!=_&&r(new tt(N.RfErr_BadData,"Timeout in seconds must be integer.")),St(i+". misc_checkParameters failed. Return false. TimeoutSecs must be integer",p,c.SPECIAL_CASE),!1;var f=-1;typeof a==_&&typeof n!=_?f=parseInt(n):typeof a!=_&&typeof n==_?f=60*parseInt(a)*60*24:typeof a!=_&&typeof n!=_&&(f=parseInt(n));var u={};u.contact=e,-1!=f&&(u.timeoutSecs=f),typeof s!=_&&(u.note=s);var l=JSON.stringify(u);return this.internal_RequestAsync(o,this.internal_CreateRequestUrl("?ea-update"),l,this.internal_CreateHeaders(),"POST",!1,!1,!1,{},t,r),void St(Pe+i,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(i,e,r)}},at.prototype.RevokeEmergencyContact=function(e,t,r){var a="RfDataManager.RevokeEmergencyContact";try{if(St(Fe+a,p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId},r))return St(a+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var n={};n.contact=e;var s=JSON.stringify(n);return this.internal_RequestAsync("RevokeEmergencyContact",this.internal_CreateRequestUrl("?ea-revoke"),s,this.internal_CreateHeaders(),"POST",!1,!1,!1,{},t,r),void St(Pe+a,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(a,e,r)}},at.prototype.GetEmergencyContacts=function(e,t){var r="RfDataManager.GetEmergencyContacts";try{return St(Fe+r,p,c.FUNC_INOUT),this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId},t)?(this.internal_RequestAsync("GetEmergencyContacts",this.internal_CreateRequestUrl("?emergency-contacts"),null,this.internal_CreateHeaders(),"GET",!1,!1,!1,{},e,t),void St(Pe+r,p,c.FUNC_INOUT)):(St(r+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1)}catch(e){this.internal_catchedException(r,e,t)}},at.prototype.GetTestators=function(e,t){var r="RfDataManager.GetTestators";try{return St(Fe+r,p,c.FUNC_INOUT),this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId},t)?(this.internal_RequestAsync("GetTestators",this.internal_CreateRequestUrl("?testators"),null,this.internal_CreateHeaders(),"GET",!1,!1,!1,{},e,t),void St(Pe+r,p,c.FUNC_INOUT)):(St(r+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1)}catch(e){this.internal_catchedException(r,e,t)}},at.prototype.AcceptEmergencyContactInvitation=function(e,t,r,a){var n="AcceptEmergencyContactInvitation",s="RfDataManager."+n;try{if(St(Fe+s,p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId},r))return St(s+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var o={};o.testator=e,typeof a!=_&&(o.acceptCode=a);var i=JSON.stringify(o);return this.internal_RequestAsync(n,this.internal_CreateRequestUrl("?ea-accept"),i,this.internal_CreateHeaders(),"POST",!1,!1,!1,{},t,r),void St(Pe+s,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(s,e,r)}},at.prototype.RejectEmergencyContactInvitation=function(e,t,r){var a="RejectEmergencyContactInvitation",n="RfDataManager."+a;try{if(St(Fe+n,p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId},r))return St(n+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var s={};s.testator=e;var o=JSON.stringify(s);return this.internal_RequestAsync(a,this.internal_CreateRequestUrl("?ea-reject"),o,this.internal_CreateHeaders(),"POST",!1,!1,!1,{},t,r),void St(Pe+n,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(n,e,r)}},at.prototype.GrantEmergencyAccess=function(e,t,r){var a="RfDataManager.GrantEmergencyAccess";try{if(St(Fe+a,p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId},r))return St(a+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var n={};n.contact=e;var s=JSON.stringify(n);return this.internal_RequestAsync("GrantEmergencyAccess",this.internal_CreateRequestUrl("?access-grant"),s,this.internal_CreateHeaders(),"POST",!1,!1,!1,{},t,r),void St(Pe+a,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(a,e,r)}},at.prototype.RevokeEmergencyAccess=function(e,t,r){var a="RfDataManager.RevokeEmergencyAccess";try{if(St(Fe+a,p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId},r))return St(a+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var n={};n.contact=e;var s=JSON.stringify(n);return this.internal_RequestAsync("RevokeEmergencyAccess",this.internal_CreateRequestUrl("?access-revoke"),s,this.internal_CreateHeaders(),"POST",!1,!1,!1,{},t,r),void St(Pe+a,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(a,e,r)}},at.prototype.RejectEmergencyAccess=function(e,t,r){var a="RfDataManager.RejectEmergencyAccess";try{if(St(Fe+a,p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId},r))return St(a+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var n={};n.owner=e;var s=JSON.stringify(n);return this.internal_RequestAsync("RejectEmergencyAccess",this.internal_CreateRequestUrl("?access-reject"),s,this.internal_CreateHeaders(),"POST",!1,!1,!1,{},t,r),void St(Pe+a,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(a,e,r)}},at.prototype.RequestEmergencyAccess=function(e,t,r){var a="RfDataManager.RequestEmergencyAccess";try{if(St(Fe+a,p,c.FUNC_INOUT),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId},r))return St(a+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var n={};n.owner=e;var s=JSON.stringify(n);return this.internal_RequestAsync("RequestEmergencyAccess",this.internal_CreateRequestUrl("?access-request"),s,this.internal_CreateHeaders(),"POST",!1,!1,!1,{},t,r),void St(Pe+a,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(a,e,r)}},at.prototype.GetTrustedUserData=function(e,t,r){var a="GetTrustedUserData",n="RfDataManager."+a;try{St(Fe+n,p,c.FUNC_INOUT);var s=this;if(!s.misc_checkParameters({SERVER_URL:s.m_sServerUrl,USER:s.m_sUserId},r))return St(n+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;return St(n+". getUserPassword. Step 1. ->",p,c.INFO),s[M](e,function(o){St(n+". getPWD_OkCallBack. Step 1. ->",p,c.INFO),o&&o.pwd?function(o){St(n+". getTrustedUserData. Step 2. ->",p,c.INFO);var i=rt.USER_DATA,f=s.m_sServerUrl+"/rf-api/"+encodeURI(e)+"/"+i;St("RfDataManager. "+a+" file='"+i+"' for trusted account='"+e+"' . Current auth user is ='"+s.m_sUserId+"'. Make request *GET* to "+f,p,c.INFO);var u=s.internal_CreateHeaders();s.makeRequestAsync(f,null,u,"GET",!0,!0,function(n,i){if(St("RfDataManager. "+a+". makeRequestAsync callback ->",p,c.FUNC_INOUT),!s.misc_checkHttpResponse(n,i,r))return St("RfDataManager. "+a+". checkHttpResponse failed. Return false.",p,c.SPECIAL_CASE),!1;var u=f,l=u.substr(u.lastIndexOf("/")+1);l.lastIndexOf("?")>0&&(l=l.substr(0,l.lastIndexOf("?")));var d=(u=u.substr(0,u.lastIndexOf("/"))).substr(u.lastIndexOf("/")+1);if(n.status==Te)return St("RfDataManager. "+a+" StatusCode is 404. file not found='"+l+"' for account='"+d+"' current='"+s.m_sUserId+"'",p,c.INFO),typeof r!=_&&r(new tt(N.RfErr_BadData,"Cannot get user-data.rfo for user='"+e+"'")),!1;if(n.status==Ee){St("RfDataManager. "+a+" Return true. StatusCode is 200. File='"+l+"' for account='"+d+"' current='"+s.m_sUserId+"'",p,c.INFO);var S=typeof n.response!=_,y=S?n.response:n.responseText,R=S?y.byteLength:y.length;St("RfDataManager. "+a+"  File='"+l+"' for account='"+d+"' current='"+s.m_sUserId+"' BYTES="+R,p,c.INFO);var U=null!=s.m_OFSMgr?s.m_OFSMgr:new RfapiJS.CRfOneFileSys,h=(y=n.response,s.convertFromArrayBuffer(y));return U.DecodeUnZipOFSBytes(h,l,d,o,!0,function(e,n){St("RfDataManager."+a+". DecodeOFS_Ok.",p,c.INFO);var o=JSON.parse(n);FileReader.prototype.readAsText||s.convertUTF8Strings(o,!0);var i=o[RfapiJS.ITEM_CHILDS_PROP];if(!i||!i.length)return typeof r!=_&&r(new tt(N.RfErr_BadData,"Cannot get childs for user-data.rfo root")),!1;for(var f=null,u=0;u<i.length;u++){var l=i[u];if(l[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]==RfapiJS.ROOT_NODE){f=l;break}}I.ParseRFObjects(f),typeof t!=_&&t(f)},function(e){if(St("RfDataManager."+a+". DecodeOFS_Error. ",p,c.INFO),e.Code==N.RfErr_AuthRejected){if(typeof r!=_)return r(new tt(N.RfErr_AuthRejected,"Wrong Master Password.")),!1}else if(typeof r!=_)return r(new tt(e.Code,e.Description)),!1;return!1}),!0}return typeof r!=_?(r(new tt(N.RfErr_BadData,"Unknown response status='"+n.status+"'")),!1):void 0}),St(n+". getTrustedUserData. Step 2. ->",p,c.INFO)}(o.pwd):typeof r!=_&&r(new tt(N.RfErr_BadData,"Cannot get password for user='"+e+"'"))},r),St(n+". getUserPassword. Step 1. ->",p,c.INFO),void St(Pe+n,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(n,e,r)}};var it="PutDataToFolder";at.prototype[it]=function(e,t,r,a,n,s){var o=it,i="RfDataManager."+o;try{St(Fe+i,p,c.FUNC_INOUT);if(n||(n=function(e){}),!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId,DATA:e},a))return St(i+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;n(5);var f={};return f[Be]={},f[Be][Ge]="putdatatofolder",f[Be].folder=t,f[Be].data=e,this.internal_RepositoryAction(f,o,r,a,rt.USER_DATA,n,s),void St(Pe+i,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(i,e,a)}};var ct="_gsdata_",ft="_saved_",ut="RESTORED";at.prototype.ClearSyncSavedData=function(e,t,r,a){var n="RfDataManager.ClearSyncSavedData";try{St(Fe+n,p,c.FUNC_INOUT);var s=this;if(r||(r=function(e){}),!s.misc_checkParameters({SERVER_URL:s.m_sServerUrl,USER:s.m_sUserId},t))return St(n+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var o=s.m_sUserId;return r(5),function(){try{St(n+". getAccountSyncData. Step 1 ->",p,c.INFO),r(15);var a=rt.SYNC_DATA;s[te](function(i,f,u,l,d){if(St(n+".getAccountSyncData. CheckoutOFS_CallBack. Step  file='"+f+"' account='"+u+"' status="+i+" eTag="+l,p,c.FUNC_INOUT),r(35),d){var S=null!=s.m_OFSMgr?s.m_OFSMgr:new RfapiJS.CRfOneFileSys,y=typeof d.byteLength!=_?s.convertFromArrayBuffer(d):d;S.DecodeUnZipOFSBytes(y,a,o,s.m_sMasterPwd,!0,function(a,i){St(n+".getAccountSyncData. Decode. Ok_CallBack. Step 1",p,c.FUNC_INOUT);try{r(50);var f=JSON.parse(i);FileReader.prototype.readAsText||s.convertUTF8Strings(f,!0)}catch(e){return typeof t!=_&&t({Code:O.SibTErr_LocalErr,Description:"[getAccountSyncData] Exception while ParseOneFileDataString: "+e.toString()+".  End of data:  ..."+i.substring(i.length-20)}),!1}var u=f.c;if(u){for(var d=null,y=0;y<u.length;y++)if(u[y][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]==ct){d=u[y];break}if(d){var R=d.c;if(!R)return r(100),void(typeof e!=_&&e({cleared:!1,_gsdata_:!1}));var U=null;for(y=0;y<R.length;y++)if(R[y][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]==ft){U=R[y];break}if(!U)return r(100),void(typeof e!=_&&e({cleared:!1,_saved_:!1}));var h=U.c;if(!h||!h.length)return r(100),void(typeof e!=_&&e({cleared:!1,items:!1}));U.c=[],s.ObjectOFSToBytes(f,function(a){S.EncodeZipOFSBytes(a,rt.SYNC_DATA,o,s.m_sMasterPwd,4096,!0,function(a){St(n+".[getAccountSyncData] encrypt_Ok callback ->",p,c.FUNC_INOUT),function(a,i){St(n+". upLoadOFS. Step 2 ->",p,c.INFO),r(75);var f=s.internal_CreateHeaders(!0);f["If-Match"]=i;var u=rt.SYNC_DATA,l=s.m_sServerUrl+"/rf-api/"+encodeURI(o)+"/"+u;s.makeRequestAsync(l,a,f,"POST",!1,!0,function(a,o){return St(n+".[upLoadOFS] Step 2.  makeRequestAsync.saveOFS_callback ->",p,c.FUNC_INOUT),r(95),s.misc_checkHttpResponse(a,o,t)?a.status==Ae?(typeof t!=_&&t(new tt(a.status,a.statusText,void 0,a,void 0)),!1):a.status==ge?(typeof t!=_&&t(new tt(a.status,a.statusText,void 0,a,void 0)),!1):a.status==Ee?(St(n+".[upLoadOFS] Step 2.  makeRequestAsync.saveOFS_callback. HTTP_Status_Code_OK.",p,c.FUNC_INOUT),r(100),void(typeof e!=_&&e({cleared:!0}))):void(typeof t!=_&&t(new tt(a.status,a.statusText,void 0,a,void 0))):(St(n+".[upLoadOFS] Step 2. makeRequestAsync.saveOFS_callback failed. Return false.",p,c.SPECIAL_CASE),!1)}),St(n+". upLoadOFS. Step 2 <-",p,c.INFO)}(new Uint8Array(a),l)},function(e){St(n+".[getAccountSyncData] encrypt_Error callback ->",p,c.FUNC_INOUT),typeof t!=_&&t(e)})},function(e){typeof t!=_&&t(e)})}else typeof t!=_&&t({Code:O.SibTErr_LocalErr,Description:"[getAccountSyncData]. Could not find '_gsdata_' folder."})}else typeof t!=_&&t({Code:O.SibTErr_LocalErr,Description:"[getAccountSyncData]. There are no childs items in sync-data.rfo"})},function(e){if(St(n+".getAccountSyncData. Decode. Error_CallBack. Step 1",p,c.FUNC_INOUT),e.Code==N.RfErr_AuthRejected){if(typeof t!=_)return t(new tt(N.RfErr_AuthRejected,"Wrong Master Password.")),!1}else if(typeof t!=_)return t(new tt(e.Code,e.Description)),!1;return!1})}else typeof e!=_&&e({cleared:!1,"sync-data":!1})},t,a,o),St(n+". getAccountSyncData. Step 1 <-",p,c.INFO)}catch(e){Rt("EXCEPTION in "+n+" getAccountSyncData. Step 1"+e.toString(),p)}}(),void St(Pe+n,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(n,e,t)}},at.prototype.RestoreUserData=function(e,r,a,n){var s="RfDataManager.RestoreUserData";try{St(Fe+s,p,c.FUNC_INOUT);var o=this;if(a||(a=function(e){}),!o.misc_checkParameters({SERVER_URL:o.m_sServerUrl,USER:o.m_sUserId},r))return St(s+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var i=o.m_sUserId,f=!(!n||!n.getInfoOnly)&&n.getInfoOnly;function u(t,n,f,u){St(s+". saveUpLoadSyncOFS. Step 5 ->",p,c.INFO);var l=new RfapiJS.CRfOneFileSys;o.ObjectOFSToBytes(f,function(f){l.EncodeZipOFSBytes(f,rt.SYNC_DATA,i,o.m_sMasterPwd,4096,!0,function(f){St(s+".[saveRestoredFolder] saveUpLoadSyncOFS callback ->",p,c.FUNC_INOUT),function(f){var l=o.internal_CreateHeaders(!0);l["If-Match"]=n;var d=rt.SYNC_DATA,S=o.m_sServerUrl+"/rf-api/"+encodeURI(i)+"/"+d;o.makeRequestAsync(S,f,l,"POST",!1,!0,function(n,i){return St(s+".[_Upload] Step 5.  makeRequestAsync.saveSyncOFS_callback ->",p,c.FUNC_INOUT),a(92),o.misc_checkHttpResponse(n,i,r)?n.status==Ae?(typeof r!=_&&r(new tt(n.status,n.statusText,void 0,n,void 0)),!1):n.status==ge?(typeof r!=_&&r(new tt(n.status,n.statusText,void 0,n,void 0)),!1):n.status==Ee?(St(s+".[_Upload] Step 5.  makeRequestAsync.saveSyncOFS_callback. HTTP_Status_Code_OK.",p,c.FUNC_INOUT),a(100),void(typeof e!=_&&e({restored:!0,items:t,folderName:u}))):void(typeof r!=_&&r(new tt(n.status,n.statusText,void 0,n,void 0))):(St(s+".[_Upload] Step 5. makeRequestAsync.saveSyncOFS_callback failed. Return false.",p,c.SPECIAL_CASE),!1)})}(new Uint8Array(f))},function(e){St(s+".[saveRestoredFolder] saveUpLoadSyncOFS ERROR callback ->",p,c.FUNC_INOUT),typeof r!=_&&r(e)})},function(e){typeof r!=_&&r(e)})}function l(e,n,f,l,d){St(s+". saveRestoredFolder. Step 3 ->",p,c.INFO),a(80);var S=f[RfapiJS.ITEM_CHILDS_PROP];if(S&&typeof S.length!=_){for(var y=null,R=0;R<S.length;R++){if((C=S[R])[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]==RfapiJS.ROOT_NODE){y=C;break}}if(y){typeof y[RfapiJS.ITEM_CHILDS_PROP]==_&&(y.c=[]);var U=null;(E=y.c)||(E=y.c=[]);var h=t.getDateTime(),I=ut+"["+h+"]";for(R=0;R<E.length;R++){if((C=E[R])[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]==I){U=C;break}}if(!U){(U={})[RfapiJS.ITEM_INFO_PROP]={},U[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_ISFOLDER_PROP]=!0,U[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]=I;var m=Math.round(new Date/1e3);U[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_MODTIME_PROP]=m,U[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_CRETIME_PROP]=m,E.push(U)}U[RfapiJS.ITEM_CHILDS_PROP]=[];for(R=0;R<e.length;R++){var C=e[R];U[RfapiJS.ITEM_CHILDS_PROP].push(C)}var v=e.length,E=d.c,N=null;for(R=0;R<E.length;R++)if(E[R][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]==ct){N=E[R];break}var T=N.c,A=null;for(R=0;R<T.length;R++)if(T[R][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]==ft){A=T[R];break}A.c=[],e=[];var g=new RfapiJS.CRfOneFileSys;o.ObjectOFSToBytes(f,function(e){g.EncodeZipOFSBytes(e,rt.USER_DATA,i,o.m_sMasterPwd,4096,!0,function(e){St(s+".[saveRestoredFolder] encrypt_Ok callback ->",p,c.FUNC_INOUT),function(e,t,n,f,l,d){St(s+". upLoadOFS. Step 4 ->  folder_name='"+d+"'",p,c.INFO),a(90);var S=o.internal_CreateHeaders(!0);S["If-Match"]=n;var y=rt.USER_DATA,R=o.m_sServerUrl+"/rf-api/"+encodeURI(i)+"/"+y;o.makeRequestAsync(R,e,S,"POST",!1,!0,function(e,n){return St(s+".[upLoadOFS] Step 4.  makeRequestAsync.saveOFS_callback ->",p,c.FUNC_INOUT),a(92),o.misc_checkHttpResponse(e,n,r)?e.status==Ae?(typeof r!=_&&r(new tt(e.status,e.statusText,void 0,e,void 0)),!1):e.status==ge?(typeof r!=_&&r(new tt(e.status,e.statusText,void 0,e,void 0)),!1):e.status==Ee?(St(s+".[upLoadOFS] Step 4.  makeRequestAsync.saveOFS_callback. HTTP_Status_Code_OK.",p,c.FUNC_INOUT),void u(t,f,l,d)):void(typeof r!=_&&r(new tt(e.status,e.statusText,void 0,e,void 0))):(St(s+".[upLoadOFS] Step 4. makeRequestAsync.saveOFS_callback failed. Return false.",p,c.SPECIAL_CASE),!1)}),St(s+". upLoadOFS. Step 4 <-",p,c.INFO)}(new Uint8Array(e),v,l,n,d,I)},function(e){St(s+".[saveRestoredFolder] encrypt_Error callback ->",p,c.FUNC_INOUT),typeof r!=_&&r(e)})},function(e){typeof r!=_&&r(e)}),St(s+". saveRestoredFolder. Step 3 <-",p,c.INFO)}else typeof r!=_&&r({Code:O.SibTErr_LocalErr,Description:"[saveRestoredFolder]. There is no root folder in user-data.rfo"})}else typeof r!=_&&r({Code:O.SibTErr_LocalErr,Description:"[saveRestoredFolder]. There are no childs items in user-data.rfo"})}return a(5),function(){try{St(s+". getAccountSyncData. Step 1 ->",p,c.INFO),a(15);var t=rt.SYNC_DATA;o[te](function(n,u,d,S,y){if(St(s+".getAccountSyncData. CheckoutOFS_CallBack. Step  file='"+u+"' account='"+d+"' status="+n+" eTag="+S,p,c.FUNC_INOUT),y){var R=null!=o.m_OFSMgr?o.m_OFSMgr:new RfapiJS.CRfOneFileSys,U=typeof y.byteLength!=_?o.convertFromArrayBuffer(y):y;R.DecodeUnZipOFSBytes(U,t,i,o.m_sMasterPwd,!0,function(t,n){St(s+".getAccountSyncData. Decode. Ok_CallBack. Step 1",p,c.FUNC_INOUT);try{a(50);var u=JSON.parse(n);FileReader.prototype.readAsText||o.convertUTF8Strings(u,!0)}catch(e){return typeof r!=_&&r({Code:O.SibTErr_LocalErr,Description:"[getAccountSyncData] Exception while ParseOneFileDataString: "+e.toString()+".  End of data:  ..."+n.substring(n.length-20)}),!1}var d=u.c;if(d){for(var y=null,R=0;R<d.length;R++)if(d[R][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]==ct){y=d[R];break}if(y){var U=y.c;if(!U)return a(100),void(typeof e!=_&&e({restored:!1,_gsdata_:!1,getInfoOnly:f}));var h=null;for(R=0;R<U.length;R++)if(U[R][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]==ft){h=U[R];break}if(!h)return a(100),void(typeof e!=_&&e({restored:!1,_saved_:!1,getInfoOnly:f}));var I=h.c;return I&&I.length?f?(a(100),void(typeof e!=_&&e({restored:!1,data:h,getInfoOnly:f}))):void function(e,t,n){try{St(s+". getAccountUserData. Step 2 ->",p,c.INFO),a(25);var f=rt.USER_DATA;o[te](function(i,f,u,d,S){St(s+".getAccountUserData. CheckoutOFS_CallBack. Step 2 file='"+f+"' account='"+u+"' status="+i+" eTag="+d,p,c.FUNC_INOUT);var y=typeof S.byteLength!=_?o.convertFromArrayBuffer(S):S,R=null!=o.m_OFSMgr?o.m_OFSMgr:new RfapiJS.CRfOneFileSys,U=rt.USER_DATA;R.DecodeUnZipOFSBytes(y,U,u,o.m_sMasterPwd,!0,function(i,f){St(s+".getAccountUserData. Ok_CallBack. Step 2",p,c.FUNC_INOUT),a(45);try{var u=JSON.parse(f);a(50),FileReader.prototype.readAsText||o.convertUTF8Strings(u,!0)}catch(e){return typeof r!=_&&r({Code:O.SibTErr_LocalErr,Description:"[getAccountUserData] Exception while ParseOneFileDataString: "+e.toString()+".  End of data:  ..."+f.substring(f.length-20)}),!1}l(e,t,u,d,n)},function(e){if(St(s+".getAccountUserData. Error_CallBack. Step 2",p,c.FUNC_INOUT),e.Code==N.RfErr_AuthRejected){if(typeof r!=_)return r(new tt(N.RfErr_AuthRejected,"Wrong Master Password.")),!1}else if(typeof r!=_)return r(new tt(e.Code,e.Description)),!1;return!1})},r,f,i),St(s+". getAccountUserData. Step 2 <-",p,c.INFO)}catch(e){Rt("EXCEPTION in "+s+" getAccountUserData. Step 2 "+e.toString(),p)}}(I,S,u):(a(100),void(typeof e!=_&&e({restored:!1,items:!1,getInfoOnly:f})))}typeof r!=_&&r({Code:O.SibTErr_LocalErr,Description:"[restoreSyncSavedFolder]. Could not find '_gsdata_' folder."})}else typeof r!=_&&r({Code:O.SibTErr_LocalErr,Description:"[getAccountSyncData]. There are no childs items in sync-data.rfo"})},function(e){if(St(s+".getAccountSyncData. Decode. Error_CallBack. Step 1",p,c.FUNC_INOUT),e.Code==N.RfErr_AuthRejected){if(typeof r!=_)return r(new tt(N.RfErr_AuthRejected,"Wrong Master Password.")),!1}else if(typeof r!=_)return r(new tt(e.Code,e.Description)),!1;return!1})}else typeof e!=_&&e({restored:!1,"sync-data":!1,getInfoOnly:f})},r,t,i),St(s+". getAccountSyncData. Step 1 <-",p,c.INFO)}catch(e){Rt("EXCEPTION in "+s+" getAccountSyncData. Step 1"+e.toString(),p)}}(),void St(Pe+s,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(s,e,r)}},at.prototype.RestoreDataForGroup=function(e,r,n,s,o){var i="RfDataManager.RestoreDataForGroup";try{St(Fe+i,p,c.FUNC_INOUT);var f=this;if(s||(s=function(e){}),!f.misc_checkParameters({SERVER_URL:f.m_sServerUrl,USER:f.m_sUserId,ACCOUNT_ID:e},n))return St(i+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;function u(a,o,u,l){St(i+". saveRestoredFolder. Step 5 ->",p,c.INFO),s(80);var d=o[RfapiJS.ITEM_CHILDS_PROP];if(d&&typeof d.length!=_){for(var S=null,y=0;y<d.length;y++){if((C=d[y])[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]==RfapiJS.ROOT_NODE){S=C;break}}if(S){typeof S[RfapiJS.ITEM_CHILDS_PROP]==_&&(S.c=[]);var R=null,U=S.c;U||(U=S.c=[]);var h=t.getDateTime(),I=ut+"["+h+"]";for(y=0;y<U.length;y++){if((C=U[y])[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]==I){R=C;break}}if(!R){(R={})[RfapiJS.ITEM_INFO_PROP]={},R[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_ISFOLDER_PROP]=!0,R[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]=I;var m=Math.round(new Date/1e3);R[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_MODTIME_PROP]=m,R[RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_CRETIME_PROP]=m,U.push(R)}R[RfapiJS.ITEM_CHILDS_PROP]=[];for(y=0;y<a.length;y++){var C=a[y];R[RfapiJS.ITEM_CHILDS_PROP].push(C)}var v=new RfapiJS.CRfOneFileSys;f.ObjectOFSToBytes(o,function(t){v.EncodeZipOFSBytes(t,rt.USER_DATA,e,u,4096,!0,function(t){St(i+".[saveRestoredFolder] encrypt_Ok callback ->",p,c.FUNC_INOUT),function(t,a,o,u){St(i+". upLoadOFS. Step 6 ->",p,c.INFO),s(90);var l=f.internal_CreateHeaders(!0);l["If-Match"]=o;var d=rt.USER_DATA,S=f.m_sServerUrl+"/rf-api/"+encodeURI(e)+"/"+d;f.makeRequestAsync(S,t,l,"POST",!1,!0,function(e,t){return St(i+".[upLoadOFS] Step 6.  makeRequestAsync.saveOFS_callback ->",p,c.FUNC_INOUT),s(95),f.misc_checkHttpResponse(e,t,n)?e.status==Ae?(typeof n!=_&&n(new tt(e.status,e.statusText,void 0,e,void 0)),!1):e.status==ge?(typeof n!=_&&n(new tt(e.status,e.statusText,void 0,e,void 0)),!1):e.status==Ee?(St(i+".[upLoadOFS] Step 6.  makeRequestAsync.saveOFS_callback. HTTP_Status_Code_OK.",p,c.FUNC_INOUT),s(100),void(typeof r!=_&&r({restored:!0,items:a.length,folderName:u}))):void(typeof n!=_&&n(new tt(e.status,e.statusText,void 0,e,void 0))):(St(i+".[upLoadOFS] Step 6. makeRequestAsync.saveOFS_callback failed. Return false.",p,c.SPECIAL_CASE),!1)}),St(i+". upLoadOFS. Step 6 <-",p,c.INFO)}(new Uint8Array(t),a,l,I)},function(e){St(i+".[saveRestoredFolder] encrypt_Error callback ->",p,c.FUNC_INOUT),typeof n!=_&&n(e)})},function(e){typeof n!=_&&n(e)}),St(i+". saveRestoredFolder. Step 5 <-",p,c.INFO)}else typeof n!=_&&n({Code:O.SibTErr_LocalErr,Description:"[saveRestoredFolder]. There is no root folder in user-data.rfo"})}else typeof n!=_&&n({Code:O.SibTErr_LocalErr,Description:"[saveRestoredFolder]. There are no childs items in user-data.rfo"})}function l(o,l,d,S,y){St(i+". decryptGroupSyncRFO. Step 3 ->",p,c.INFO),s(55);var R=typeof l.byteLength!=_?f.convertFromArrayBuffer(l):l,U="",h=o.receivedData.accounts;if(h)for(var I=0;I<h.length;I++)if(h[I].accountId==e){U=h[I].mp;break}if(!U)return typeof n!=_&&n(new tt(N.RfErr_BadData,"Cannot get MP from accountInfo for account '"+e+"'")),!1;var m=null,C=S.c;if(C){for(I=0;I<C.length;I++)if("private-key.pem"==C[I][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]){m=C[I][RfapiJS.ITEM_BODY_PROP];break}if(m){var v=t.base64ToBytes(U),E=t.bytesToHex(v),T=new RSAKey,A=a.GetHexFromPEM(m,!1);T.setPrivateEx(A.modulus,A.exponent,A.privateexp,A.P,A.Q,A.DP,A.DQ,A.InverseQ);var g=T.decrypt(E),F=rt.SYNC_DATA;(null!=f.m_OFSMgr?f.m_OFSMgr:new RfapiJS.CRfOneFileSys).DecodeUnZipOFSBytes(R,F,e,g,!0,function(t,a){St(i+".decryptGroupSyncRFO. Ok_CallBack. Step 3",p,c.FUNC_INOUT);try{s(60);var o=JSON.parse(a);FileReader.prototype.readAsText||f.convertUTF8Strings(o,!0)}catch(e){return typeof n!=_&&n({Code:O.SibTErr_LocalErr,Description:"[decryptGroupSyncRFO] Exception while ParseOneFileDataString: "+e.toString()+".  End of data:  ..."+a.substring(a.length-20)}),!1}!function(t,a,o,l){St(i+". restoreSyncSavedFolder. Step 4 ->",p,c.INFO),s(65);var d=a.c;if(d){for(var S=null,y=0;y<d.length;y++)if(d[y][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]==ct){S=d[y];break}if(S){var R=S.c;if(!R)return s(100),void(typeof r!=_&&r({restored:!1,_gsdata_:!1}));var U=null;for(y=0;y<R.length;y++)if(R[y][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]==ft){U=R[y];break}if(!U)return s(100),void(typeof r!=_&&r({restored:!1,_saved_:!1}));var h=U.c;if(!h)return s(100),void(typeof r!=_&&r({restored:!1,items:!1}));var I=typeof t.byteLength!=_?f.convertFromArrayBuffer(t):t,m=rt.USER_DATA;(null!=f.m_OFSMgr?f.m_OFSMgr:new RfapiJS.CRfOneFileSys).DecodeUnZipOFSBytes(I,m,e,o,!0,function(e,t){St(i+".restoreSyncSavedFolder. Ok_CallBack. Step 4",p,c.FUNC_INOUT);try{s(75);var r=JSON.parse(t);FileReader.prototype.readAsText||f.convertUTF8Strings(r,!0)}catch(e){return typeof n!=_&&n({Code:O.SibTErr_LocalErr,Description:"[restoreSyncSavedFolder] Exception while ParseOneFileDataString: "+e.toString()+".  End of data:  ..."+t.substring(t.length-20)}),!1}u(h,r,o,l)},function(e){if(St(i+".restoreSyncSavedFolder. Error_CallBack. Step 4",p,c.FUNC_INOUT),e.Code==N.RfErr_AuthRejected){if(typeof n!=_)return n(new tt(N.RfErr_AuthRejected,"Wrong Master Password.")),!1}else if(typeof n!=_)return n(new tt(e.Code,e.Description)),!1;return!1}),St(i+". restoreSyncSavedFolder. Step 4 <-",p,c.INFO)}else typeof n!=_&&n({Code:O.SibTErr_LocalErr,Description:"[restoreSyncSavedFolder]. Could not find '_gsdata_' folder."})}else typeof n!=_&&n({Code:O.SibTErr_LocalErr,Description:"[restoreSyncSavedFolder]. There are no childs items in sync-data.rfo"})}(d,o,g,y)},function(e){if(St(i+".decryptGroupSyncRFO. Error_CallBack. Step 3",p,c.FUNC_INOUT),e.Code==N.RfErr_AuthRejected){if(typeof n!=_)return n(new tt(N.RfErr_AuthRejected,"Wrong Master Password.")),!1}else if(typeof n!=_)return n(new tt(e.Code,e.Description)),!1;return!1}),St(i+". decryptGroupSyncRFO. Step 3 <-",p,c.INFO)}else typeof n!=_&&n({Code:O.SibTErr_LocalErr,Description:"[decryptGroupSyncRFO]. There is no private-key.pem in user-data.rfo"})}else typeof n!=_&&n({Code:O.SibTErr_LocalErr,Description:"[decryptGroupSyncRFO]. There are no childs items"})}function d(t,r){try{St(i+". getGroupAccountData. Step 2.2 ->",p,c.INFO),s(25);var a=rt.USER_DATA;return f[te](function(a,o,u,d,S){St(i+".getGroupAccountData. CheckoutOFS_CallBack. Step 2.2 file='"+o+"' account='"+u+"' status="+a+" eTag="+d,p,c.FUNC_INOUT),function(t,r,a,o){try{St(i+". getUserAccountData. Step 2.3. ->",p,c.INFO),s(35);var u=rt.USER_DATA,d=!1,S=t.receivedData.accounts;if(S)for(var y=0;y<S.length;y++)if(S[y].accountId==e){d=!0;break}d?(f[te](function(e,u,d,S,y){St(i+".getUserAccountData. CheckoutOFS_CallBack. Step 2.3 file='"+u+"' account='"+d+"' status="+e+" eTag="+S,p,c.FUNC_INOUT),s(40);var R=typeof y.byteLength!=_?f.convertFromArrayBuffer(y):y,U=null!=f.m_OFSMgr?f.m_OFSMgr:new RfapiJS.CRfOneFileSys,h=rt.USER_DATA;U.DecodeUnZipOFSBytes(R,h,d,f.m_sMasterPwd,!0,function(e,u){St(i+".getUserAccountData. Ok_CallBack. Step 2.3",p,c.FUNC_INOUT),s(45);try{var d=JSON.parse(u);s(50),FileReader.prototype.readAsText||f.convertUTF8Strings(d,!0)}catch(e){return typeof n!=_&&n({Code:O.SibTErr_LocalErr,Description:"[getUserAccountData] Exception while ParseOneFileDataString: "+e.toString()+".  End of data:  ..."+u.substring(u.length-20)}),!1}l(t,r,a,d,o)},function(e){if(St(i+".getUserAccountData. Error_CallBack. Step 2.3",p,c.FUNC_INOUT),e.Code==N.RfErr_AuthRejected){if(typeof n!=_)return n(new tt(N.RfErr_AuthRejected,"Wrong Master Password.")),!1}else if(typeof n!=_)return n(new tt(e.Code,e.Description)),!1;return!1})},n,u,f.m_sUserId),St(i+". getUserAccountData. Step 2.3. <-",p,c.INFO)):typeof n!=_&&n(new tt(N.RfErr_BadData,"[getUserAccountData] Cannot restore deleted data for account '"+e+"'"))}catch(e){Rt("EXCEPTION in "+i+" getUserAccountData. Step 2.3 "+e.toString(),p)}}(t,r,S,d)},n,a,e),void St(i+". getGroupAccountData. Step 2.2 <-",p,c.INFO)}catch(e){Rt("EXCEPTION in "+i+" getGroupAccountData. Step 2.2 "+e.toString(),p)}}return s(5),function(){St(i+". getAccountInfo. Step 1. ->",p,c.INFO);var t=f.m_sServerUrl+"/rf-api/"+encodeURI(f.m_sUserId)+"?get-account-info";f.internal_RequestAsync(F,t,null,f.internal_CreateHeaders(),"POST",!1,!1,!1,{userId:f.m_sUserId,getUserInfo:!0},function(t){St(i+". getAccountInfo. Step 1. Ok->",p,c.INFO),f[L](function(a,o){St(i+". getAccountInfo.GetAccounts_AnswerCallBack. Step 1.1 Ok->",p,c.INFO),t.receivedData=a,function(t){try{St(i+". getGroupSyncData. Step 2.1 ->",p,c.INFO),s(15);var a=rt.SYNC_DATA;f[te](function(e,a,n,s,o){St(i+".getGroupAccountData. CheckoutOFS_CallBack. Step 2.1 file='"+a+"' account='"+n+"' status="+e+" eTag="+s,p,c.FUNC_INOUT),o?d(t,o):typeof r!=_&&r({restored:!1,"sync-data":!1})},n,a,e),St(i+". getGroupSyncData. Step 2.1 <-",p,c.INFO)}catch(e){Rt("EXCEPTION in "+i+" getGroupSyncData. Step 2.1"+e.toString(),p)}}(t)},function(e){return typeof n!=_&&n(e),!1})},function(e){St(i+".getAccountInfo. Step 1. Error->",p,c.INFO),typeof n!=_&&n(e)},!0),St(i+". getAccountInfo. Step 1. ->",p,c.INFO)}(),void St(Pe+i,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(i,e,n)}};at.prototype.GetAccountSecurityInfo=function(e,r,n,s){var o="RfDataManager.GetAccountSecurityInfo";try{St(Fe+o,p,c.FUNC_INOUT);var i=this,f=e.accountId;if(!i.misc_checkParameters({SERVER_URL:i.m_sServerUrl,USER:i.m_sUserId,ACCOUNT:f},n))return St(o+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;s||(s=function(e){});var u=void 0===e.countGrantedFiles||e.countGrantedFiles,l=void 0!==e.countReceivedFiles&&e.countReceivedFiles,d=void 0===e.countOwnedSharedFolders||e.countOwnedSharedFolders,S=void 0!==e.countRegularSharedFolders&&e.countRegularSharedFolders,y=void 0!==e.countGroups&&e.countGroups;function R(e){St(o+". calculateSecurityInfo. Step 4. ->",p,c.INFO),s(75);var t={};t[Be]={},t[Be][Ge]="list",t[Be][xe]="",t[Be][qe]=63,t[Be][Le]=v.RfItemType_Login,t[Be][He]=!0,t[Be].otherInfo=!0,t[Be].bBody=!0;var a=RfapiJS.RfPasswordAudit.Init(u,l);function i(){var e=new RfapiJS.CSecurityStats;a.GetSecurityStats(e);var t=a.GetAverageSafetyLevel().score;St(o+". calculateSecurityInfo. Step 4 getItems_CallBack 2. SUMMARY SC="+(t=t>100?100:t),p,c.INFO);var n=a.GetItems();(e=e.GetStats()).score=t,typeof r!=_&&r({accountId:f,items:n,securityStats:e})}for(var d=e.length,S=0;S<e.length;S++){var y=e[S].ofs,R=e[S].accountInfo;delete R.receivedData,delete R.companies,delete R.publicKey,delete R.policies,I.GetItemsList2(t,y,function(e){d--,St(o+". calculateSecurityInfo. Step 4.b getItems_CallBack 2 ->",p,c.INFO),s(85);for(var t=e.length,r=0;r<t;r++){var n=e[r];a.AddItem(n)}d||i()},n,R)}St(o+". calculateSecurityInfo. Step 4. <-",p,c.INFO)}function U(e,r){try{St(o+". getGroupAccountData. Step 2.2 ->",p,c.INFO),s(45);var u=rt.USER_DATA;return i[te](function(u,l,d,S,y){St(o+".getGroupAccountData. CheckoutOFS_CallBack. Step 2.2 file='"+l+"' account='"+d+"' status="+u+" eTag="+S,p,c.FUNC_INOUT),function(e,r,u){St(o+". decryptGroupRFO. Step 2.3. ->",p,c.INFO),s(55);var l,d=typeof u.byteLength!=_?i.convertFromArrayBuffer(u):u,S="",y=e.receivedData.accounts;if(y)for(var U=0;U<y.length;U++)if(y[U].accountId==f){S=y[U].mp,l=y[U];break}if(!S)return typeof n!=_&&n(new tt(N.RfErr_BadData,"Cannot get MP from accountInfo for account '"+f+"'")),!1;var h=null,I=r.c;if(I){for(U=0;U<I.length;U++)if("private-key.pem"==I[U][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]){h=I[U][RfapiJS.ITEM_BODY_PROP];break}if(h){var m=t.base64ToBytes(S),C=t.bytesToHex(m),v=new RSAKey,E=a.GetHexFromPEM(h,!1);v.setPrivateEx(E.modulus,E.exponent,E.privateexp,E.P,E.Q,E.DP,E.DQ,E.InverseQ);var T=v.decrypt(C),A=rt.USER_DATA;(null!=i.m_OFSMgr?i.m_OFSMgr:new RfapiJS.CRfOneFileSys).DecodeUnZipOFSBytes(d,A,f,T,!0,function(e,t){St(o+".decryptGroupRFO. Ok_CallBack. Step 2.3",p,c.FUNC_INOUT);try{var r=JSON.parse(t);FileReader.prototype.readAsText||i.convertUTF8Strings(r,!0)}catch(e){return typeof n!=_&&n({Code:O.SibTErr_LocalErr,Description:"[decryptGroupRFO] Exception while ParseOneFileDataString: "+e.toString()+".  End of data:  ..."+t.substring(t.length-20)}),!1}var a=[],s={};s.ofs=r,s.accountInfo=l,a.push(s),R(a)},function(e){if(St(o+".decryptGroupRFO. Error_CallBack. Step 2.3",p,c.FUNC_INOUT),e.Code==N.RfErr_AuthRejected){if(typeof n!=_)return n(new tt(N.RfErr_AuthRejected,"Wrong Master Password.")),!1}else if(typeof n!=_)return n(new tt(e.Code,e.Description)),!1;return!1}),St(o+". decryptGroupRFO. Step 2.3. <-",p,c.INFO)}else typeof n!=_&&n({Code:O.SibTErr_LocalErr,Description:"[decryptGroupRFO]. There is no private-key.pem in user-data.rfo"})}else typeof n!=_&&n({Code:O.SibTErr_LocalErr,Description:"[decryptGroupRFO]. There are no childs items"})}(e,r,y)},n,u,f),void St(o+". getGroupAccountData. Step 2.2 <-",p,c.INFO)}catch(e){Rt("EXCEPTION in "+o+" getGroupAccountData. Step 2.2 "+e.toString(),p)}}function h(e){try{St(o+". getUserAccountData. Step 2. ->",p,c.INFO),s(30);var r=rt.USER_DATA,u=!1;if(i.m_sUserId==f)u=!0;else{var l=e.receivedData.accounts;if(l)for(var h=0;h<l.length;h++)if(l[h].accountId==f){u=!0;break}}return u?(i[te](function(r,u,l,h,I){St(o+".getUserAccountData. CheckoutOFS_CallBack. Step 2 file='"+u+"' account='"+l+"' status="+r+" eTag="+h,p,c.FUNC_INOUT),s(35);var m=typeof I.byteLength!=_?i.convertFromArrayBuffer(I):I,C=null!=i.m_OFSMgr?i.m_OFSMgr:new RfapiJS.CRfOneFileSys,v=rt.USER_DATA;C.DecodeUnZipOFSBytes(m,v,l,i.m_sMasterPwd,!0,function(r,u){St(o+".getUserAccountData. Ok_CallBack. Step 2",p,c.FUNC_INOUT),s(40);try{var l=JSON.parse(u);s(45),FileReader.prototype.readAsText||i.convertUTF8Strings(l,!0)}catch(e){return typeof n!=_&&n({Code:O.SibTErr_LocalErr,Description:"[getUserAccountData] Exception while ParseOneFileDataString: "+e.toString()+".  End of data:  ..."+u.substring(u.length-20)}),!1}var h=[],I={};I.ofs=l,I.accountInfo=e,h.push(I),i.m_sUserId==f?function(e){St(o+". getSharedAccountsGroups. Step 3.1. ->",p,c.INFO);var r=e[0].accountInfo,n=e[0].ofs;function s(e,t){for(var r=0;r<e.length;r++){var a=e[r];if(a.accountId==t)return a}}function f(e,r){for(var s,o=0;o<e.length;o++){var i=e[o];i.accountId==r&&(s=i.mp)}var c=null,f=n.c;if(f){for(o=0;o<f.length;o++)if("private-key.pem"==f[o][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]){c=f[o][RfapiJS.ITEM_BODY_PROP];break}if(c){var u=t.base64ToBytes(s),p=t.bytesToHex(u),l=new RSAKey,_=a.GetHexFromPEM(c,!1);return l.setPrivateEx(_.modulus,_.exponent,_.privateexp,_.P,_.Q,_.DP,_.DQ,_.InverseQ),l.decrypt(p)}}}function u(e,t,r){try{St(o+". _getAccountData. Step 3.2 ->",p,c.INFO);var a=rt.USER_DATA;return i[te](function(e,r,a,n,s){St(o+"._getAccountData. CheckoutOFS_CallBack. Step 3.2 file='"+r+"' account='"+a+"' status="+e+" eTag="+n,p,c.FUNC_INOUT),t(a,s)},r,a,e),void St(o+". _getAccountData. Step 3.2 <-",p,c.INFO)}catch(e){Rt("EXCEPTION in "+o+" _getAccountData. Step 3.2 "+e.toString(),p)}}var l=[],U=r.receivedData.accounts;if(U)for(var h=0;h<U.length;h++){var I=U[h],m=I.company,C=I.readOnly,v=I.isAdmin,E=I.isManager;I.accepted&&(I.mp?m&&y&&!C?l.push(I):(m||!d||!E&&!v)&&(m||!S||C)||l.push(I):Rt("getSharedAccountsGroups mp is empty for account='"+I.accountId,p))}var T=l.length;if(!T)return R(e),void St(o+". getSharedAccountsGroups. Step 3.1. <-",p,c.INFO);for(h=0;h<l.length;h++)u(l[h].accountId,function(t,r){var a,n,u,d,S,y,h,I=f(l,t);n=I,u=t,d=function(t,r){T--;var a=s(U,r),n={};n.ofs=t,n.accountInfo=a,e.push(n),T||R(e)},S=function(t){T--,Rt("getSharedAccountsGroups error while decoding. Error="+t.description,p),T||R(e)},y=typeof(a=r).byteLength!=_?i.convertFromArrayBuffer(a):a,h=rt.USER_DATA,(null!=i.m_OFSMgr?i.m_OFSMgr:new RfapiJS.CRfOneFileSys).DecodeUnZipOFSBytes(y,h,u,n,!0,function(e,t){St(o+".getSharedAccountsGroups. Ok_CallBack. Step 3.3",p,c.FUNC_INOUT);try{var r=JSON.parse(t);FileReader.prototype.readAsText||i.convertUTF8Strings(r,!0)}catch(e){return S({Code:O.SibTErr_LocalErr,Description:"[decryptGroupRFO] Exception while ParseOneFileDataString: "+e.toString()+".  End of data:  ..."+t.substring(t.length-20)}),!1}d(r,u)},function(e){return St(o+".getSharedAccountsGroups. Error_CallBack. Step 3.3",p,c.FUNC_INOUT),e.Code==N.RfErr_AuthRejected?(S(new tt(N.RfErr_AuthRejected,"Wrong Master Password.")),!1):(S(new tt(e.Code,e.Description)),!1)})},function(t){T--,Rt("getSharedAccountsGroups error while downloading. Error="+t.description,p),T||R(e)});St(o+". getSharedAccountsGroups. Step 3.1. <-",p,c.INFO)}(h):U(e,l)},function(e){if(St(o+".getUserAccountData. Error_CallBack. Step 2",p,c.FUNC_INOUT),e.Code==N.RfErr_AuthRejected){if(typeof n!=_)return n(new tt(N.RfErr_AuthRejected,"Wrong Master Password.")),!1}else if(typeof n!=_)return n(new tt(e.Code,e.Description)),!1;return!1})},n,r,i.m_sUserId),void St(o+". getUserAccountData. Step 2. <-",p,c.INFO)):(typeof n!=_&&n(new tt(N.RfErr_BadData,"Cannot calculate info for account '"+f+"'")),!1)}catch(e){Rt("EXCEPTION in "+o+" getUserAccountData. Step 2 "+e.toString(),p)}}return s(5),function(){St(o+". getAccountInfo. Step 1. ->",p,c.INFO);var e=i.m_sServerUrl+"/rf-api/"+encodeURI(i.m_sUserId)+"?get-account-info";i.internal_RequestAsync(F,e,null,i.internal_CreateHeaders(),"POST",!1,!1,!1,{userId:i.m_sUserId,getUserInfo:!0},function(e){St(o+". getAccountInfo. Step 1. Ok->",p,c.INFO),s(15),i[L](function(t,r){St(o+". getAccountInfo.GetAccounts_AnswerCallBack. Step 1.1 Ok->",p,c.INFO),e.receivedData=t,h(e)},function(e){return typeof n!=_&&n(e),!1})},function(e){St(o+".getAccountInfo. Step 1. Error->",p,c.INFO),typeof n!=_&&n(e)},!0),St(o+". getAccountInfo. Step 1. ->",p,c.INFO)}(),void St(Pe+o,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(o,e,n)}},at.prototype.UpdateSecurityScore=function(e,r,n,o){var i="RfDataManager.UpdateSecurityScore";try{St(Fe+i,p,c.FUNC_INOUT);var f=this;if(o||(o=function(e){}),!f.misc_checkParameters({SERVER_URL:f.m_sServerUrl,USER:f.m_sUserId},n))return St(i+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var u=e.accountId,l=e.accountInfo,d=(void 0===e.itemsCounters||e.itemsCounters,void 0!==e.forceUpdateStats&&e.forceUpdateStats),S=void 0!==e.countCurrentUser&&e.countCurrentUser,y=!0,R=!1,U=!0,h=!1,m=!1;function C(e,t){function a(e){var t=new RfapiJS.CSecurityStats;l.GetSecurityStats(t);var a=l.GetAverageSafetyLevel().score;St(i+". calculateSecurityInfo. Step 4 getItems_CallBack 2. SUMMARY SC="+(a=a>100?100:a),p,c.INFO);var s=Math.round(new Date/1e3);e.scoreUpdatedTime=s,e.score=a,e.weak=t.m_weak,e.medium=t.m_medium,e.good=t.m_good,e.excellent=t.m_excellent,e.reused=t.m_reused,e.duplicates=t.m_duplicates,function(e,t){St(i+". updateSecurityScore. Step 5. -> security Score="+(e=void 0===e?0:e)+" for account='"+u+"'",p,c.INFO),o(95);var a=JSON.stringify(t),s=RfapiJS.UTF8.stringToBytes(a),l=RfapiJS.utils.bytesToBase64(s);f.m_sUserId==u||S?f[P](function(e){typeof r!=_&&r({updated:!0,accountId:u,securityStats:t})},function(e){typeof n!=_&&n(e)},u,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,l):f[J](u,function(e){typeof r!=_&&r({updated:!0,accountId:u,securityStats:t})},function(e){typeof n!=_&&n(e)},void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,l),St(i+". updateSecurityScore. Step 5. <-",p,c.INFO)}(a,e)}function s(t){var r={};r[Be]={},r[Be][Ge]="list",r[Be][xe]="",r[Be][qe]=63,r[Be][Le]=v.RfItemType_Login,r[Be][He]=!0,r[Be].otherInfo=!0,r[Be].bBody=!0;for(var s=e.length,f=0;f<e.length;f++){var u=e[f];I.GetItemsList2(r,u,function(e){s--,St(i+". calculateSecurityInfo._calculateScore Step 4.b getItems_CallBack 2 ->",p,c.INFO);for(var r=e.length,n=0;n<r;n++){var f=e[n];l.AddItem(f)}s||(o(85),a(t))},n)}}St(i+". calculateSecurityInfo. Step 4. ->",p,c.INFO),o(75);var l=RfapiJS.RfPasswordAudit.Init(y,R);!function(){var t={};t[Be]={},t[Be][Ge]="list",t[Be][xe]="",t[Be][He]=!0,t[Be][qe]=0,t[Be][Le]=[1,2,3,4,5,6,7],t[Be].bBody=!1,t[Be].countGrantedFiles=y,t[Be].countReceivedFiles=R;for(var r={loginsCount:0,identitiesCount:0,bookmarksCount:0,contactsCount:0,safenotesCount:0},a=e.length,f=0;f<e.length;f++){var u=e[f];I.GetItemsCount2(t,u,function(e){a--,St(i+". calculateSecurityInfo._calculateCounters Step 4.a getItems_CallBack 2 ->",p,c.INFO),r.loginsCount+=e.loginsCount,r.identitiesCount+=e.identitiesCount,r.bookmarksCount+=e.bookmarksCount,r.contactsCount+=e.contactsCount,r.safenotesCount+=e.safenotesCount,a||(o(80),s(r))},n)}}(),St(i+". calculateSecurityInfo. Step 4. <-",p,c.INFO)}function E(e,r,s,l){try{St(i+". getGroupAccountData. Step 3.2 ->",p,c.INFO),o(45);var d=rt.USER_DATA;return f[te](function(r,l,d,S,y){St(i+".getGroupAccountData. CheckoutOFS_CallBack. Step 3.2 file='"+l+"' account='"+d+"' status="+r+" eTag="+S,p,c.FUNC_INOUT),function(e,r,s,l,d){St(i+". decryptGroupRFO. Step 3.3. ->",p,c.INFO),o(55);var S=typeof s.byteLength!=_?f.convertFromArrayBuffer(s):s,y="",R=e.receivedData.accounts;if(R)for(var U=0;U<R.length;U++)if(R[U].accountId==u){y=R[U].mp;break}if(!y)return typeof n!=_&&n(new tt(N.RfErr_BadData,"Cannot get MP from accountInfo for account '"+u+"'")),!1;var h=null,I=l.c;if(I){for(U=0;U<I.length;U++)if("private-key.pem"==I[U][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]){h=I[U][RfapiJS.ITEM_BODY_PROP];break}if(h){var m=t.base64ToBytes(y),v=t.bytesToHex(m),E=new RSAKey,T=a.GetHexFromPEM(h,!1);E.setPrivateEx(T.modulus,T.exponent,T.privateexp,T.P,T.Q,T.DP,T.DQ,T.InverseQ);var A=E.decrypt(v),g=rt.USER_DATA;(null!=f.m_OFSMgr?f.m_OFSMgr:new RfapiJS.CRfOneFileSys).DecodeUnZipOFSBytes(S,g,u,A,!0,function(e,t){St(i+".decryptGroupRFO. Ok_CallBack. Step 3.3",p,c.FUNC_INOUT);try{var r=JSON.parse(t);FileReader.prototype.readAsText||f.convertUTF8Strings(r,!0)}catch(e){return typeof n!=_&&n({Code:O.SibTErr_LocalErr,Description:"[decryptGroupRFO] Exception while ParseOneFileDataString: "+e.toString()+".  End of data:  ..."+t.substring(t.length-20)}),!1}var a=[];a.push(r),C(a)},function(e){if(St(i+".decryptGroupRFO. Error_CallBack. Step 3.3",p,c.FUNC_INOUT),e.Code==N.RfErr_AuthRejected){if(typeof n!=_)return n(new tt(N.RfErr_AuthRejected,"Wrong Master Password.")),!1}else if(typeof n!=_)return n(new tt(e.Code,e.Description)),!1;return!1}),St(i+". decryptGroupRFO. Step 3.3. <-",p,c.INFO)}else typeof n!=_&&n({Code:O.SibTErr_LocalErr,Description:"[decryptGroupRFO]. There is no private-key.pem in user-data.rfo"})}else typeof n!=_&&n({Code:O.SibTErr_LocalErr,Description:"[decryptGroupRFO]. There are no childs items"})}(e,0,y,s)},n,d,u),void St(i+". getGroupAccountData. Step 3.2 <-",p,c.INFO)}catch(e){Rt("EXCEPTION in "+i+" getGroupAccountData. Step 3.2 "+e.toString(),p)}}function T(e,r,s){try{St(i+". getUserAccountData. Step 3. ->",p,c.INFO),o(35);var l=rt.USER_DATA,d=!1;if(f.m_sUserId==u||S)d=!0;else{var y=e.receivedData.accounts;if(y)for(var R=0;R<y.length;R++)if(y[R].accountId==u){d=!0;break}}return d?(f[te](function(r,s,l,d,y){St(i+".getUserAccountData. CheckoutOFS_CallBack. Step 3 file='"+s+"' account='"+l+"' status="+r+" eTag="+d,p,c.FUNC_INOUT),o(45);var R=typeof y.byteLength!=_?f.convertFromArrayBuffer(y):y,I=null!=f.m_OFSMgr?f.m_OFSMgr:new RfapiJS.CRfOneFileSys,v=rt.USER_DATA;I.DecodeUnZipOFSBytes(R,v,l,f.m_sMasterPwd,!0,function(r,s){St(i+".getUserAccountData. Ok_CallBack. Step 3",p,c.FUNC_INOUT),o(55);try{var l=JSON.parse(s);o(65),FileReader.prototype.readAsText||f.convertUTF8Strings(l,!0)}catch(e){return typeof n!=_&&n({Code:O.SibTErr_LocalErr,Description:"[getUserAccountData] Exception while ParseOneFileDataString: "+e.toString()+".  End of data:  ..."+s.substring(s.length-20)}),!1}var d=[];d.push(l),f.m_sUserId==u||S?function(e,r){St(i+". getSharedAccountsGroups. Step 3.1. ->",p,c.INFO);var n=r[0];function s(e,r){for(var s,o=0;o<e.length;o++){var i=e[o];i.accountId==r&&(s=i.mp)}var c=null,f=n.c;if(f){for(o=0;o<f.length;o++)if("private-key.pem"==f[o][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]){c=f[o][RfapiJS.ITEM_BODY_PROP];break}if(c){var u=t.base64ToBytes(s),p=t.bytesToHex(u),l=new RSAKey,_=a.GetHexFromPEM(c,!1);return l.setPrivateEx(_.modulus,_.exponent,_.privateexp,_.P,_.Q,_.DP,_.DQ,_.InverseQ),l.decrypt(p)}}}function o(e,t,r){try{St(i+". _getAccountData. Step 3.2 ->",p,c.INFO);var a=rt.USER_DATA;return f[te](function(e,r,a,n,s){St(i+"._getAccountData. CheckoutOFS_CallBack. Step 3.2 file='"+r+"' account='"+a+"' status="+e+" eTag="+n,p,c.FUNC_INOUT),t(a,s)},r,a,e),void St(i+". _getAccountData. Step 3.2 <-",p,c.INFO)}catch(e){Rt("EXCEPTION in "+i+" _getAccountData. Step 3.2 "+e.toString(),p)}}var u=[],l=e.receivedData.accounts;if(l)for(var d=0;d<l.length;d++){var S=l[d],y=S.company,R=S.readOnly,I=S.isAdmin,v=S.isManager;S.accepted&&(S.mp?y&&m&&!R?u.push(S):(y||!U||!v&&!I)&&(y||!h||R)||u.push(S):Rt("getSharedAccountsGroups mp is empty for account='"+S.accountId,p))}var E=u.length;if(!E)return C(r),void St(i+". getSharedAccountsGroups. Step 3.1. <-",p,c.INFO);for(d=0;d<u.length;d++)o(u[d].accountId,function(e,t){var a,n,o,l,d,S,y,R=s(u,e);n=R,o=e,l=function(e){E--,r.push(e),E||C(r)},d=function(e){E--,Rt("getSharedAccountsGroups error while decoding. Error="+e.description,p),E||C(r)},S=typeof(a=t).byteLength!=_?f.convertFromArrayBuffer(a):a,y=rt.USER_DATA,(null!=f.m_OFSMgr?f.m_OFSMgr:new RfapiJS.CRfOneFileSys).DecodeUnZipOFSBytes(S,y,o,n,!0,function(e,t){St(i+".getSharedAccountsGroups. Ok_CallBack. Step 3.3",p,c.FUNC_INOUT);try{var r=JSON.parse(t);FileReader.prototype.readAsText||f.convertUTF8Strings(r,!0)}catch(e){return d({Code:O.SibTErr_LocalErr,Description:"[decryptGroupRFO] Exception while ParseOneFileDataString: "+e.toString()+".  End of data:  ..."+t.substring(t.length-20)}),!1}l(r)},function(e){return St(i+".getSharedAccountsGroups. Error_CallBack. Step 3.3",p,c.FUNC_INOUT),e.Code==N.RfErr_AuthRejected?(d(new tt(N.RfErr_AuthRejected,"Wrong Master Password.")),!1):(d(new tt(e.Code,e.Description)),!1)})},function(e){E--,Rt("getSharedAccountsGroups error while downloading. Error="+e.description,p),E||C(r)});St(i+". getSharedAccountsGroups. Step 3.1. <-",p,c.INFO)}(e,d):E(e,0,l)},function(e){if(St(i+".getUserAccountData. Error_CallBack. Step 3",p,c.FUNC_INOUT),e.Code==N.RfErr_AuthRejected){if(typeof n!=_)return n(new tt(N.RfErr_AuthRejected,"Wrong Master Password.")),!1}else if(typeof n!=_)return n(new tt(e.Code,e.Description)),!1;return!1})},n,l,f.m_sUserId),void St(i+". getUserAccountData. Step 3. <-",p,c.INFO)):(typeof n!=_&&n(new tt(N.RfErr_BadData,"Cannot update security score for account '"+u+"'")),!1)}catch(e){Rt("EXCEPTION in "+i+" getUserAccountData. Step3 "+e.toString(),p)}}function A(e){try{function t(e){if(d)return!0;if(s.NeedToUpdate(e))return!0;if(St(i+". No need to update SSC for account ='"+u+"'",p,c.SPECIAL_CASE),o(De),typeof r!=_){var t=e.securityStats,a=RfapiJS.utils.base64ToBytes(t),n=RfapiJS.UTF8.bytesToString(a),f=JSON.parse(n);r({updated:!1,accountId:u,securityStats:f})}return!1}if(St(i+". checkForUpdate. Step 2. ->",p,c.INFO),o(15),f.m_sUserId==u){if(!t(e))return;return St(i+". checkForUpdate. Step 2. Need to update. Get user-data.rfo for account='"+u+"'",p,c.INFO),void T(e)}var a=f.m_sServerUrl+"/rf-api/"+encodeURI(u)+"?shared-account-info";return f.internal_RequestAsync(F,a,null,f.internal_CreateHeaders(),"GET",!1,!1,!1,{userId:u,getUserInfo:!0},function(r){St(i+". getSharedAccountInfo_Ok. Step 2. Ok->",p,c.INFO),r.oneFile=!0,t(r)&&(St(i+". checkForUpdate. Step 2. Need to update. Get user-data.rfo for account='"+u+"'",p,c.INFO),T(e))},function(e){St(i+".getSharedAccountInfo_Error. Step 2. Error->",p,c.INFO),typeof n!=_&&n(e)},!0),void St(i+". checkForUpdate. Step 2. <-",p,c.INFO)}catch(e){Rt("EXCEPTION in "+i+" checkForUpdate. Step2 "+e.toString(),p)}}return o(5),function(){if(St(i+". getAccountInfo. Step 1. ->",p,c.INFO),l)A(l);else{var e=f.m_sServerUrl+"/rf-api/"+encodeURI(f.m_sUserId)+"?get-account-info";f.internal_RequestAsync(F,e,null,f.internal_CreateHeaders(),"POST",!1,!1,!1,{userId:f.m_sUserId,getUserInfo:!0},function(e){St(i+". getAccountInfo. Step 1. Ok->",p,c.INFO),f[L](function(t,r){St(i+". getAccountInfo.GetAccounts_AnswerCallBack. Step 1.1 Ok->",p,c.INFO),e.receivedData=t,A(e)},function(e){return typeof n!=_&&n(e),!1})},function(e){St(i+".getAccountInfo. Step 1. Error->",p,c.INFO),typeof n!=_&&n(e)},!0)}St(i+". getAccountInfo. Step 1. ->",p,c.INFO)}(),void St(Pe+i,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(i,e,n)}};var pt="AdSyncGroup",lt="ad_state.json";at.prototype.HandleADConnectorData=function(e,r,n,s){var o="RfDataManager.HandleADConnectorData";try{St(Fe+o,p,c.FUNC_INOUT);var i=this;if(s||(s=function(e){}),!i.misc_checkParameters({SERVER_URL:i.m_sServerUrl,USER:i.m_sUserId},n))return St(o+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var f=null!=i.m_OFSMgr?i.m_OFSMgr:new RfapiJS.CRfOneFileSys;function u(u,l,d){St(o+". decryptGroupRFO. Step 4 ->",p,c.INFO),s(55);var S=typeof d.byteLength!=_?i.convertFromArrayBuffer(d):d,y=u.mp;if(!y)return typeof n!=_&&n(new tt(N.RfErr_BadData,"Cannot get MP from accountInfo for ADGroup")),!1;var R=null,U=l.c;if(U){for(var h=0;h<U.length;h++)if("private-key.pem"==U[h][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]){R=U[h][RfapiJS.ITEM_BODY_PROP];break}if(R){var I=t.base64ToBytes(y),m=t.bytesToHex(I),C=new RSAKey,v=a.GetHexFromPEM(R,!1);C.setPrivateEx(v.modulus,v.exponent,v.privateexp,v.P,v.Q,v.DP,v.DQ,v.InverseQ);var E=C.decrypt(m),T=rt.USER_DATA;f.DecodeUnZipOFSBytes(S,T,u.accountId,E,!0,function(t,a){St(o+".decryptGroupRFO. Ok_CallBack. Step 4",p,c.FUNC_INOUT);try{s(75);var l=JSON.parse(a);FileReader.prototype.readAsText||i.convertUTF8Strings(l,!0)}catch(e){return typeof n!=_&&n({Code:O.SibTErr_LocalErr,Description:"[decryptGroupRFO] Exception while ParseOneFileDataString: "+e.toString()+".  End of data:  ..."+a.substring(a.length-20)}),!1}var d=l.c;if(d){for(var S,y=0;y<d.length;y++)if(d[y][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]==lt){S=d[y][RfapiJS.ITEM_BODY_PROP];break}S?e&&e.json?function(e,t,a,u){St(o+". saveGroup. Step 5 ->",p,c.INFO),s(80);var l=t.c;if(l){for(var d=0;d<l.length;d++)if(l[d][RfapiJS.ITEM_INFO_PROP][RfapiJS.ITEM_NAME_PROP]==lt){l[d][RfapiJS.ITEM_BODY_PROP]=u,l[d][RfapiJS.ITEM_INFO_PROP].m=Math.round(new Date/1e3),l[d][RfapiJS.ITEM_INFO_PROP].s=u.length;break}var S=rt.USER_DATA,y=e.accountId;i.ObjectOFSToBytes(t,function(e){f.EncodeZipOFSBytes(e,S,y,a,be,!0,function(e){St(o+". Step 5. encrypt_Ok callback ->",p,c.FUNC_INOUT);var t=new Uint8Array(e),a=i.internal_CreateHeaders(!0),f=i.internal_GetFileTag(y,S);f?a["If-Match"]=f:a["If-None-Match"]="*";var u=i.m_sServerUrl+"/rf-api/"+encodeURI(y)+"/"+S;i.makeRequestAsync(u,t,a,"POST",!1,!0,function(e,t){return St(o+".upload_group Step 5 -> upLoadOFS_callback",p,c.FUNC_INOUT),s(90),i.misc_checkHttpResponse(e,t,n)?e.status==Ae?(s(De),typeof n!=_&&n(new tt(e.status,e.statusText,void 0,e,void 0)),!1):e.status==ge?(s(De),typeof n!=_&&n(new tt(e.status,e.statusText,void 0,e,void 0)),!1):(i.internal_PutFileTag(e.getResponseHeader("eTag"),y,S),void(typeof r!=_&&r(Ee))):(St(o+".upload_group Step 5. -> upLoadOFS_callback failed. Return false.",p,c.SPECIAL_CASE),s(De),!1)})},function(e){St(o+". Step 5  encrypt_Error callback ->",p,c.FUNC_INOUT),typeof n!=_&&n(e)})},function(e){typeof n!=_&&n(e)}),St(o+". saveGroup. Step 5 <-",p,c.INFO)}else typeof n!=_&&n({Code:O.SibTErr_LocalErr,Description:"[decryptGroupRFO]. There are no childs items"})}(u,l,E,e.json):(s(99),typeof r!=_&&r(S)):typeof n!=_&&n({Code:O.SibTErr_LocalErr,Description:"[decryptGroupRFO]. There is no ad_state.json file"})}else typeof n!=_&&n({Code:O.SibTErr_LocalErr,Description:"[decryptGroupRFO]. There are no childs items"})},function(e){if(St(o+".decryptGroupRFO. Error_CallBack. Step 4",p,c.FUNC_INOUT),e.Code==N.RfErr_AuthRejected){if(typeof n!=_)return n(new tt(N.RfErr_AuthRejected,"Wrong Master Password.")),!1}else if(typeof n!=_)return n(new tt(e.Code,e.Description)),!1;return!1}),St(o+". decryptGroupRFO. Step 4 <-",p,c.INFO)}else typeof n!=_&&n({Code:O.SibTErr_LocalErr,Description:"[decryptGroupRFO]. There is no private-key.pem in user-data.rfo"})}else typeof n!=_&&n({Code:O.SibTErr_LocalErr,Description:"[decryptGroupRFO]. There are no childs items"})}function l(e){try{St(o+". getUserAccountData. Step 2. ->",p,c.INFO),s(35);var t=rt.USER_DATA;return i[te](function(t,r,a,f,l){St(o+".getUserAccountData. CheckoutOFS_CallBack. Step 2 file='"+r+"' account='"+a+"' status="+t+" eTag="+f,p,c.FUNC_INOUT),s(45);var d=typeof l.byteLength!=_?i.convertFromArrayBuffer(l):l,S=null!=i.m_OFSMgr?i.m_OFSMgr:new RfapiJS.CRfOneFileSys,y=rt.USER_DATA;S.DecodeUnZipOFSBytes(d,y,a,i.m_sMasterPwd,!0,function(t,r){St(o+".getUserAccountData. Ok_CallBack. Step 2",p,c.FUNC_INOUT),s(55);try{var a=JSON.parse(r);s(65),FileReader.prototype.readAsText||i.convertUTF8Strings(a,!0)}catch(e){return typeof n!=_&&n({Code:O.SibTErr_LocalErr,Description:"[getUserAccountData] Exception while ParseOneFileDataString: "+e.toString()+".  End of data:  ..."+r.substring(r.length-20)}),!1}!function(e,t){try{St(o+". parseADGroup. Step 3 ->",p,c.INFO),s(45);var r=rt.USER_DATA;i[te](function(a,n,s,f,l){St(o+".getGroupAccountData. CheckoutOFS_CallBack. Step 3 file='"+n+"' account='"+s+"' status="+a+" eTag="+f,p,c.FUNC_INOUT),i.internal_PutFileTag(f,s,r),u(e,t,l)},n,r,e.accountId),St(o+". parseADGroup. Step 3 <-",p,c.INFO)}catch(e){Rt("EXCEPTION in "+o+" parseADGroup. Step 3 "+e.toString(),p)}}(e,a)},function(e){if(St(o+".getUserAccountData. Error_CallBack. Step 2",p,c.FUNC_INOUT),e.Code==N.RfErr_AuthRejected){if(typeof n!=_)return n(new tt(N.RfErr_AuthRejected,"Wrong Master Password.")),!1}else if(typeof n!=_)return n(new tt(e.Code,e.Description)),!1;return!1})},n,t,i.m_sUserId),void St(o+". getUserAccountData. Step 2. <-",p,c.INFO)}catch(e){Rt("EXCEPTION in "+o+" getUserAccountData. Step2 "+e.toString(),p)}}return s(5),i[L](function(e,t){s(15),St(o+". getAccountInfo.GetGroups_AnswerCallBack. Step 1 Ok->",p,c.INFO);var r=e.accounts;if(r&&r.length){for(var a,i=0;i<r.length;i++){var f=r[i];if(f[Je]==pt){a=f;break}}a?l(a):typeof n!=_&&n({Code:O.SibTErr_LocalErr,Description:"There is no AdSyncGroup"})}else typeof n!=_&&n({Code:O.SibTErr_LocalErr,Description:"There are no groups."})},function(e){return typeof n!=_&&n(e),!1}),void St(Pe+o,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(o,e,n)}};at.prototype.PutIdenticalFiles=function(e,r,a,n){var s="RfDataManager.PutIdenticalFiles";try{St(Fe+s,p,c.FUNC_INOUT);var o=this;n||(n=function(e){});var i=e.data,f=e.itemsUpdate,u=e.itemsDelete,l=e.action;if(!o.misc_checkParameters({SERVER_URL:o.m_sServerUrl,USER:o.m_sUserId,ITEMS:f},a))return St(s+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;function d(e){St(s+". saveAccounts. Step 3. ->",p,c.INFO),n(40);for(var t=e.length,i=0,f=0;f<e.length;f++)o[ne](function(e){St(s+".saveAccounts. putOFS_AnswerCallback -> counter="+ ++i+" all="+t,p,c.FUNC_INOUT),n(40+60/t*f),i==t&&typeof r!=_&&(St(s+".saveAccounts. ***putOFS_AnswerCallback*** ->",p,c.FUNC_INOUT),r(e.status))},function(e){i++,St(s+".saveAccounts. ***putOFS_ErrorCallback*** ->",p,c.FUNC_INOUT),typeof a!=_&&a(e)},rt.USER_DATA,e[f])}function S(e){if(St(s+". deleteItems. Step 2. ->",p,c.INFO),n(20),u&&u.length){var r=f[0].lastIndexOf("."),o=f[0].substr(r),i=t.FileExtToType(o),l={};l[Be]={},l[Be][Ge]="deleteitem",l[Be][Le]=i;for(var _=0;_<u.length;_++)l[Be][xe]=u[_],I.DeleteObject(l,function(t,r,a){St(s+". deleteAnswer->",p,c.INFO),e.includes(a[0])||e.push(a[0])},a);d(e)}else d(e)}return n(5),0==l?function(){St(s+". updateFileDataForItems. Step 1.a ->",p,c.INFO),n(10);var e=f[0].lastIndexOf("."),r=f[0].substr(e),o=t.FileExtToType(r),u={};u[Be]={},u[Be][Ge]="putdataitem",u[Be][Le]=o;for(var l=[],_=0;_<f.length;_++)u[Be][xe]=f[_],u[Be].data=i,I.PutDataItem(u,function(e,t,r){St(s+". putAnswer->",p,c.INFO),l.includes(r[0])||l.push(r[0])},a);S(l)}():1==l?function(){St(s+". renameItems. Step 1.b ->",p,c.INFO),n(10);var e=f[0].lastIndexOf("."),r=f[0].substr(e),o=t.FileExtToType(r),u={};u[Be]={},u[Be][Ge]="move",u[Be][Ke]={},u[Be][Ke][Le]=o,u[Be][Ve]={},u[Be][Ve][Le]=o;for(var l=[],_=0;_<f.length;_++){var d=f[_];u[Be][Ke][xe]=d;var y=d.substr(0,d.lastIndexOf("/"))+"/"+i+r;u[Be][Ve][xe]=y,I.MoveObject(u,function(e,t,r){St(s+". moveAnswer->",p,c.INFO),l.includes(r[0])||l.push(r[0])},a)}S(l)}():S([]),void St(Pe+s,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(s,e,a)}};at.prototype.GetIdenticalFiles=function(e,r,a,n){var s="RfDataManager.GetIdenticalFiles";try{St(Fe+s,p,c.FUNC_INOUT);n||(n=function(e){});var o=e.path;if(!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId,PATH:o},a))return St(s+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var i=o.substring(o.lastIndexOf("/")+1),f=i.lastIndexOf("."),u=i.substr(f),l=t.FileExtToType(u),d=i.substr(0,f-1);d=d.toLowerCase(),i=i.toLowerCase();var S=e.fileData;return n(5),function(){St(s+". searchItems. Step 1. ->",p,c.INFO);var e={};e[Be]={},e[Be][Ge]="list",e[Be][xe]="",e[Be][qe]=63,e[Be][Le]=l,e[Be][He]=!0,I.GetItemsList(e,function(e){St(s+". searchItems. Step 1. searchAnswer->",p,c.INFO);for(var t=[],n=0;n<e.length;n++){var f=e[n],u=f.path;(u=u.toLowerCase()).substr(u.lastIndexOf("/")+1)==i&&(f.readOnly||(o.toLowerCase()==u&&(f.current=!0),t.push(f)))}t.length?function(e){St(s+". compareFileData. Step 2. ->",p,c.INFO);var t=[],n={};n[Be]={},n[Be][Ge]="getdataitem",n[Be][Le]=l;for(var o=0;o<e.length;o++){var i=e[o];n[Be][xe]=i.path,I.GetDataItem(n,function(e){switch(St(s+". compareFileData. Step 2. getItemDataAnswer->",p,c.INFO),l){case v.RfItemType_Identity:case v.RfItemType_Contact:if(e[RfapiJS.ID_OPTIONS_PROP]&&S[RfapiJS.ID_OPTIONS_PROP]&&JSON.stringify(e[RfapiJS.ID_OPTIONS_PROP])!=JSON.stringify(S[RfapiJS.ID_OPTIONS_PROP]))break;if(e[RfapiJS.ID_GROUPS_PROP]&&S[RfapiJS.ID_GROUPS_PROP]&&JSON.stringify(e[RfapiJS.ID_GROUPS_PROP])!=JSON.stringify(S[RfapiJS.ID_GROUPS_PROP]))break;t.push(i);break;case v.RfItemType_Login:if(e[RfapiJS.ITEM_GOTOURL_PROP]!=S[RfapiJS.ITEM_GOTOURL_PROP])break;if(e[RfapiJS.ITEM_MATCHURL_PROP]!=S[RfapiJS.ITEM_MATCHURL_PROP])break;if(e[RfapiJS.ITEM_NOTE_PROP]!=S[RfapiJS.ITEM_NOTE_PROP])break;if(e[RfapiJS.ITEMDATA_FIELDS_PROP]&&S[RfapiJS.ITEMDATA_FIELDS_PROP]&&JSON.stringify(e[RfapiJS.ITEMDATA_FIELDS_PROP])!=JSON.stringify(S[RfapiJS.ITEMDATA_FIELDS_PROP]))break;if(e[RfapiJS.ITEMDATA_FIELDS_PROP]&&!S[RfapiJS.ITEMDATA_FIELDS_PROP])break;if(!e[RfapiJS.ITEMDATA_FIELDS_PROP]&&S[RfapiJS.ITEMDATA_FIELDS_PROP])break;t.push(i);break;case v.RfItemType_Safenote:if(e[RfapiJS.ITEM_NOTE_PROP]!=S[RfapiJS.ITEM_NOTE_PROP])break;t.push(i);break;case v.RfItemType_Bookmark:if(e[RfapiJS.ITEM_GOTOURL_PROP]!=S[RfapiJS.ITEM_GOTOURL_PROP])break;if(e[RfapiJS.ITEM_NOTE_PROP]!=S[RfapiJS.ITEM_NOTE_PROP])break;t.push(i)}},a)}St(s+". compareFileData. <- Step 2.",p,c.INFO),typeof r!=_&&r(t)}(t):r(t)},a),St(s+". searchItems. <- Step 1",p,c.INFO)}(),void St(Pe+s,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(s,e,a)}};var _t="SendGroupActionsLog";function dt(e){for(var a=t.randomBytes(16),n=(new RfapiJS.SibScramAuthClient).CalcStoredInfo(r.stringToBytes(e),a,Me),s=n.item2,o=n.item3,i=0;i<o.length;i++)s.push(o[i]);var c=t.bytesToBase64(s);return c=c.replace(new RegExp("=","g"),""),{salt:a=(a=t.bytesToBase64(a)).replace(new RegExp("=","g"),""),hash:c}}function St(e,t,r){if(u&&!(f>r)){var a=(new Date).getTime()-i;typeof opera!=_&&typeof opera.postError!=_?opera.postError((new Date).toUTCString()+"\n"+a+"  (RfapiJS trace in "+t+") : "+e):d||U||y?console.log((new Date).toUTCString()+"\n"+a+"  (RfapiJS trace in "+t+") : "+e):R?typeof console!=_&&console.log((new Date).toUTCString()+"\n"+a+"  (RfapiJS trace in "+t+") : "+e):h?console.log((new Date).toUTCString()+"\n"+a+"  (RfapiJS trace in "+t+") : "+e):S?console.log((new Date).toUTCString()+"\n"+a+"  (RfapiJS trace in "+t+") : "+e):concoleService.logStringMessage((new Date).toUTCString()+"\n"+a+"  (RfapiJS trace in "+t+") : "+e),r==c.EXCEPTION&&alert(e)}}at.prototype[_t]=function(e,t,r){var a=_t,n="RfDataManager."+a;try{if(this.getAccountMode()!=m.OFS)return;St(Fe+n,p,c.FUNC_INOUT);var s=e.accountId;e.operation;if(!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:this.m_sUserId,ACCOUNT:s},r))return St(n+". misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var o={};o.type=e.operation_type,o.op=e.operation,typeof e.path!=_&&(o.path=e.path),e.pathTo&&(o.pathTo=e.pathTo);var i=[];i.push(o);var f={};f.actions=i;var u=JSON.stringify(f),l=this.m_sServerUrl+"/rf-api/"+encodeURI(s)+"?group-actions-log";return this.internal_RequestAsync(a,l,u,this.internal_CreateHeaders(),"POST",!1,!1,!1,{},t,r),void St(Pe+n,p,c.FUNC_INOUT)}catch(e){this.internal_catchedException(n,e,r)}},at.prototype.GetAccountDataBackups=function(e,t,r){St(Fe+"RfDataManager.GetAccountDataBackups",p,c.FUNC_INOUT);var a=e&&e.accountId?e.accountId:this.m_sUserId;if(this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:a},r)){var n=this.m_sServerUrl+"/rf-api/"+encodeURI(a)+"?backups";this.internal_RequestAsync("GetAccountDataBackups",n,null,this.internal_CreateHeaders(),"GET",!1,!1,!1,{},function(e){for(var r=e.backups||[],n=0;n<r.length;n++)r[n].accountId=a;t(r)},r)}else St("RfDataManager.GetAccountDataBackups. misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE)},at.prototype.DeleteAccountDataBackup=function(e,t,r){St("DeleteAccountDataBackup ->",p,c.FUNC_INOUT);var a=e&&e.accountId?e.accountId:this.m_sUserId,n=e&&e.backupId;if(!this.misc_checkParameters({SERVER_URL:this.m_sServerUrl,USER:a,BACKUP:n},r))return St("DeleteAccountDataBackup. misc_checkParameters failed. Return false.",p,c.SPECIAL_CASE),!1;var s={};s.id=n;var o=JSON.stringify(s),i=this.m_sServerUrl+"/rf-api/"+encodeURI(a)+"?delete-backup";this.internal_RequestAsync("DeleteAccountDataBackup",i,o,this.internal_CreateHeaders(),"POST",!1,!1,!1,{},t,r)};var yt=!1;function Rt(e,t){var r=(new Date).getTime()-i;typeof opera!=_&&typeof opera.postError!=_?opera.postError((new Date).toUTCString()+"\n"+r+"  (RfapiJS log in "+t+") : "+e):d||U||y?console.log((new Date).toUTCString()+"\n"+r+"  (RfapiJS log in "+t+") : "+e):R?typeof console!=_?console.log((new Date).toUTCString()+"\n"+r+"  (RfapiJS log in "+t+") : "+e):concoleService.logStringMessage((new Date).toUTCString()+"\n"+r+"  (RfapiJS log in "+t+") : "+e):h?console.log((new Date).toUTCString()+"\n"+r+"  (RfapiJS trace in "+t+") : "+e):S?console.log((new Date).toUTCString()+"\n"+r+"  (RfapiJS trace in "+t+") : "+e):concoleService.logStringMessage((new Date).toUTCString()+"\n"+r+"  (RfapiJS log in "+t+") : "+e),yt&&alert(e)}String.prototype.startsWith||(String.prototype.startsWith=function(e){return!this.indexOf(e)}),String.prototype.endsWith||(String.prototype.endsWith=function(e){return this.match(e+"$")==e}),String.prototype.trimLeft||(String.prototype.trimLeft=function(){return this.replace(new RegExp("^\\s+"),"")}),String.prototype.trimRight||(String.prototype.trimRight=function(){return this.replace(new RegExp("\\s+$"),"")}),String.prototype.trim||(String.prototype.trim=function(){return this.trimLeft().trimRight()}),RfapiJS.RfDataManager=at,RfapiJS.accountMode=m,RfapiJS.setTraceLevel=function(e){f=e},RfapiJS.setDebugMode=function(e){u=e},RfapiJS.traceJS=St,RfapiJS.SibErrType=O,RfapiJS.traceLevel=c,RfapiJS.logJS=Rt,RfapiJS.RfApiError=tt,RfapiJS.EnDataItemInfoParts=C,RfapiJS.RfErrType=N,RfapiJS.EnRfDataItemType=v,RfapiJS.EnDataPresenceLevel={enInitial:0,enHaveHeader:1,enHaveUnprotectedPart:2,enExecuteOnly:3,enHaveAll:4},RfapiJS.RfUrlMatchLevel={RF_MATCH_TYPE_NULL:0,RF_MATCH_TYPE_UNKNOWN:1,RF_MATCH_TYPE_BLOCKING:2,RF_MATCH_TYPE_DOMAIN:3,RF_MATCH_TYPE_SERVER:4,RF_MATCH_TYPE_PAGE:20,RF_MATCH_TYPE_URL_EXACT:21},RfapiJS.EnUrlType={enUrlType_Unknown:0,enUrlType_HTTP:1,enUrlType_FTP:2,enUrlType_File:3},RfapiJS.EnUrlSchema={enUrlSchema_Unknown:0,enUrlSchema_HTTP:1,enUrlSchema_HTTPS:2,enUrlSchema_FTP:3,enUrlSchema_FTPS:4,enUrlSchema_File:5,enUrlSchema_MOZPROXY:6,enUrlSchema_ChromeService:7},RfapiJS.EnUsageInfoList=T,RfapiJS.UserDataFiles=rt,RfapiJS.HTTP_Status_Code_OK=Ee,RfapiJS.HTTP_Status_Code_Unauthorized=Ne,RfapiJS.HTTP_Status_Code_Forbidden=403}).apply(RfapiJS);
//# sourceMappingURL=rf-api-lib.js.map