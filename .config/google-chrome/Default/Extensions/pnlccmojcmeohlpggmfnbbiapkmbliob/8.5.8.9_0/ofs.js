// Copyright (C) 1999-2019 Siber Systems Inc. All Rights Reserved.
var RfapiJS=RfapiJS||{};(function(){var e=RfapiJS.traceJS,t=RfapiJS.traceLevel,r=RfapiJS.SibErrType,n=RfapiJS.RfErrType,s=RfapiJS.logJS,i=RfapiJS.utils,a=RfapiJS.UTF8,o=RfapiJS.HTTP_Status_Code_OK,_=RfapiJS.UserDataFiles,h=RfapiJS.Binary,f=RfapiJS.StringConverter,c="ofs.js",m="undefined",y="rfosha#$",u="rfosha2#$",p="###",d="101112131415161718191a1b1c1d1e1f",l={enIntegrityCheck:1,enEncrypted:2,enZipped:4},C={enNoPadding:1};function S(){try{return"localStorage"in window&&null!==window.localStorage}catch(e){return!1}}function g(){e("CRfOneFileSys  ctor  ->",c,t.FUNC_INOUT),this.m_ofs_CashedSalts={},this.m_ofs_CashedKeys={},this.m_ofs_CashedIterations={},this.m_ofs_DBCached={};var r=S();try{if(r){for(var n in localStorage)n.startsWith(y)&&delete localStorage[n];for(var n in localStorage)if(n.startsWith(u)){var s=n.substr(u.length,n.indexOf(p)-u.length),o=n.substr(n.indexOf(p)+p.length),_=i.hexToBytes(s),h=i.hexToBytes(o),f=a.bytesToString(_),m=a.bytesToString(h);this.m_ofs_DBCached[f]||(this.m_ofs_DBCached[f]={}),this.m_ofs_DBCached[f][m]=localStorage[n]}}}catch(e){}e("CRfOneFileSys  ctor  <-",c,t.FUNC_INOUT)}g.prototype.ofs_ClearAccountsCache=function(){if(this.m_ofs_CashedSalts={},this.m_ofs_CashedKeys={},this.m_ofs_CashedIterations={},S())for(var e in localStorage)e.startsWith(u)&&delete localStorage[e]},g.prototype.ofs_ClearCacheForAccount=function(r,n){if(e("ofs_ClearCacheForAccount. File='"+n+"' account='"+r+"'",c,t.SPECIAL_CASE),n?(this.m_ofs_CashedSalts[r]&&this.m_ofs_CashedSalts[r][n]&&delete this.m_ofs_CashedSalts[r][n],this.m_ofs_CashedKeys[r]&&this.m_ofs_CashedKeys[r][n]&&delete this.m_ofs_CashedKeys[r][n],this.m_ofs_CashedIterations[r]&&this.m_ofs_CashedIterations[r][n]&&delete this.m_ofs_CashedIterations[r][n]):(delete this.m_ofs_CashedSalts[r],delete this.m_ofs_CashedKeys[r],delete this.m_ofs_CashedIterations[r]),S()){var s=i.bytesToHex(a.stringToBytes(r)),o=i.bytesToHex(a.stringToBytes(_.APP_DATA)),h=u+s+p+o;(!n||n&&n==_.APP_DATA)&&delete localStorage[h];var f=i.bytesToHex(a.stringToBytes(_.SYNC_DATA)),m=u+s+p+f;(!n||n&&n==_.SYNC_DATA)&&delete localStorage[m];var y=i.bytesToHex(a.stringToBytes(_.USER_DATA)),d=u+s+p+y;(!n||n&&n==_.USER_DATA)&&delete localStorage[d]}},g.prototype.ofs_SetData=function(r,n,s,o,_,h){try{for(var f=S(),y=i.bytesToHex(a.stringToBytes(_)),l=i.bytesToHex(a.stringToBytes(o)),C=u+y+p+l,g=[],b=0;b<r.length;b++)g.push(r[b]);for(b=0;b<n.length;b++)g.push(n[b]);var E=i.GetLittleEndianByteArrayFromInteger(s);for(b=0;b<E.length;b++)g.push(E[b]);var I=i.bytesToBase64(g),O=CryptoJS.enc.Latin1.parse(CryptoJS.enc.Latin1.stringify(CryptoJS.SHA256(h+h))),B=CryptoJS.enc.Hex.parse(d),v=CryptoJS.AES.encrypt(I,O,{iv:B}).toString(),F=CryptoJS.lib.CipherParams.create({ciphertext:CryptoJS.enc.Base64.parse(v)});return void(I==CryptoJS.AES.decrypt(F,O,{iv:B}).toString(CryptoJS.enc.Utf8)?(e("ofs_SetData. Cache salt and key to localStorage. for file='"+o+"' account='"+_+"' pwd='"+h+"'",c,t.SPECIAL_CASE),f&&(typeof localStorage[C]!=m&&localStorage[C]==v||(localStorage[C]=v)),this.m_ofs_CashedSalts[_]||(this.m_ofs_CashedSalts[_]={}),this.m_ofs_CashedSalts[_][o]=r,this.m_ofs_CashedKeys[_]||(this.m_ofs_CashedKeys[_]={}),this.m_ofs_CashedKeys[_][o]=n,this.m_ofs_CashedIterations[_]||(this.m_ofs_CashedIterations[_]={}),this.m_ofs_CashedIterations[_][o]=s):e("ofs_SetData. ### Encode-decode error ### . msg64 != result ",c,t.SPECIAL_CASE))}catch(r){e("ERROR  ofs_SetData: "+r,c,t.SPECIAL_CASE)}},g.prototype.ofs_GetData=function(e,t,r){if(!t)return{salt:null,key:null,iterations:0};if(this.m_ofs_CashedKeys[t]&&this.m_ofs_CashedSalts[t]&&this.m_ofs_CashedSalts[t][e]&&this.m_ofs_CashedKeys[t][e])return{salt:this.m_ofs_CashedSalts[t][e],key:this.m_ofs_CashedKeys[t][e],iterations:this.m_ofs_CashedIterations[t][e]};var n=this.ofs_decryptSaltKey(e,t,r);if(!n)return{salt:null,key:null,iterations:0};for(var s=[],a=[],o=[],_=0;_<16;_++)s.push(n[_]);for(_=16;_<80;_++)a.push(n[_]);for(_=80;_<n.length;_++)o.push(n[_]);this.m_ofs_CashedSalts[t]||(this.m_ofs_CashedSalts[t]={}),this.m_ofs_CashedSalts[t][e]=s,this.m_ofs_CashedKeys[t]||(this.m_ofs_CashedKeys[t]={}),this.m_ofs_CashedKeys[t][e]=a;var h=i.GetLittleEndianIntegerFromByteArray(o,0);return this.m_ofs_CashedIterations[t]||(this.m_ofs_CashedIterations[t]={}),this.m_ofs_CashedIterations[t][e]=h,{salt:s,key:a,iterations:h}},g.prototype.ofs_decryptSaltKey=function(r,n,s){try{if(!this.m_ofs_DBCached[n])return"";var a=this.m_ofs_DBCached[n][r];if(!a)return"";var o=CryptoJS.lib.CipherParams.create({ciphertext:CryptoJS.enc.Base64.parse(a)}),_=CryptoJS.enc.Latin1.parse(CryptoJS.enc.Latin1.stringify(CryptoJS.SHA256(s+s))),h=CryptoJS.enc.Hex.parse(d),f=CryptoJS.AES.decrypt(o,_,{iv:h}).toString(CryptoJS.enc.Utf8);return i.base64ToBytes(f)}catch(r){return e("ERROR  ofs_decryptSaltKey: "+r,c,t.SPECIAL_CASE),""}},g.prototype.RfTEST_OFS=function(s,i,_,h,f,y){selfObj=this;var u="RfTEST_OFS";e(u+" length="+s.length,c,t.FUNC_INOUT);var p=(new Date).getTime(),d=new I(s),C=new Array(8);if(d.GetBytes(C,8),"onefile1"!=(C=a.bytesToString(C)))return e(u+" Wrong file format! Could not read onefile1.",c,t.SPECIAL_CASE),typeof h!=m&&h({Code:n.RfErr_BadData,Description:"Wrong file format : Could not read onefile1",sibErr:"LocalErr"},b),!1;var S=d.GetByte();if(-1==S)return e(u+"  Wrong file format! Could not get flags.",c,t.SPECIAL_CASE),typeof h!=m&&h({Code:n.RfErr_BadData,Description:"Wrong file format : Could not get flags",sibErr:"LocalErr"},b),!1;if((e(u+".  flags="+S,c,t.INFO),S&l.enIntegrityCheck)&&(e(u+"  enIntegrityCheck!",c,t.INFO),!(g=new R(d)).OpenRead(!0)))return e(u+"  enIntegrityCheck FAILED!",c,t.SPECIAL_CASE),typeof h!=m&&h({Code:n.RfErr_BadData,Description:"enIntegrityCheck failed!",sibErr:"LocalErr"},b),!1;if(S&l.enEncrypted){if(e(u+"  enIntegrityCheck ENCRYPTED!",c,t.INFO),""==i)return typeof h!=m&&h({Code:r.SibTErr_AuthRejected,Description:"Password is required",sibErr:"LocalErr"},b),!1;var g;(g=new k(g,i)).m_bRead=!0;var O=selfObj.ofs_GetData(f,y,i);return O.key&&O.salt&&(g.encr_SetDataSalt(O.salt,f,y),g.encr_SetDataKey(O.key,f,y),g.encr_SetDataIterations(O.iterations,f,y)),void g.OpenRead(!0,f,y,function(){e(u+" okBack ->",c,t.INFO),S&l.enZipped&&e(u+" ZIPPED!",c,t.INFO),e(u+" After zip. Push to memoryStream.",c,t.INFO);for(var r=new Array,s=!1,i=0;!s;)-1==(i=g.GetByte())?s=!0:r.push(i);e(u+" Try to unzip memorystream. Length="+r.length,c,t.INFO),E(r,function(r){e(u+" --- OK - opened.",c,t.INFO);try{JSON.parse(r)}catch(s){return e(u+" End of data='"+r.substring(r.length-150)+"'",c,t.FUNC_INOUT),typeof h!=m&&h({Code:n.RfErr_BadData,Description:"Exception while JSON.Parse: "+s.toString()+".  End of data:  ..."+r.substring(r.length-50),sibErr:"LocalErr"},b),!1}var s=(new Date).getTime();e(u+"  <- TIME="+(s-p)+"ms.",c,t.FUNC_INOUT),typeof _!=m&&_(o)},function(e){return-1==e?(typeof h!=m&&h({Code:n.RfErr_AuthRejected,Description:"Wrong master password",sibErr:"LocalErr"},b),!1):-2==e?(typeof h!=m&&h({Code:-2,Description:"Pako.unzip. Maximum call stack size exceeded",sibErr:"LocalErr"},b),!1):void 0})},function(e){return h(e),!1})}e(u+" NOT encrypted!",c,t.INFO)};var b={};function E(r,n,s){try{e("SibOpenZipStreamRead  ->",c,t.FUNC_INOUT);var i=new Uint8Array(r);e("SibOpenZipStreamRead binData.byteLength="+i.byteLength,c,t.INFO),e("SibOpenZipStreamRead *Unzip start",c,t.INFO);var a=(new Date).getTime(),o=pako.ungzip(i);if(!o)return void s(-1);var _=(new Date).getTime();if(e("SibOpenZipStreamRead *Unzip FINISH, ### TIME ### = "+(_-a)+" ms.",c,t.INFO),FileReader.prototype.readAsText)f.BytesToString(o,function(r){var s=(new Date).getTime();e("SibOpenZipStreamRead <- RFStringConverter finish! Conversion FINISH, ### TIME ### = "+(s-_)+" ms.",c,t.FUNC_INOUT),n(r)},function(r){e("SibOpenZipStreamRead <- onFail error="+r,c,t.FUNC_INOUT),s(r)});else{r=h.bytesToString(o);var m=(new Date).getTime();e("SibOpenZipStreamRead bytesToString FINISH!  time="+(m-a)+"ms.",c,t.FUNC_INOUT),n(r)}return}catch(r){e("ERROR  SibOpenZipStreamRead: "+r,c,t.INFO),"RangeError"==r.name?s(-2):s(-1)}}function I(e){this.m_buf_len=typeof e!=m?e.length:8192,this.buf=typeof e!=m?e:[],this.m_buf_ix=0,this.m_buffer_stream=null,this.m_bEOF=!1,this.m_bIsOpen=!1,this.m_bRead=!1,this.m_nCurLineIn=0,this.m_nCurPosIn=0,this.m_nUngetChar=-1}g.prototype.EncodeZipOFSBytes=function(n,s,i,o,_,h,f,y,u,p,d){try{var C=this;d||(d=function(e){}),d(1);var S="EncodeZipOFSBytes",g="CRfOneFileSys."+S,E=n.length?n.length:n.byteLength;e("-> "+g+" account='"+i+"' length(json BYTES)="+E,c,t.FUNC_INOUT);var O=(new Date).getTime();function B(r,a,h){d(25);var l=r;if(a&&(l=new R(l)).OpenWrite(),h){var b=l=new k(l,o);l.encr_ClearCachedValues(s,i),l.OpenWrite(s,i,_,u,p)}e(g+" Wrote encryption headers and garbage",c,t.INFO),d(30),e(g+" uint START!",c,t.INFO);var E=new Uint8Array(n);e(g+" uint FINISH!",c,t.INFO);var I=(new Date).getTime(),B=pako.gzip(E);e(g+" zip FINISH!  TIME="+((new Date).getTime()-I)+" ms.",c,t.INFO);var v=n.length?n.length:n.byteLength;e(g+" GZIP json bytes: zipped length="+B.length+" unzipped length="+v,c,t.INFO),d(50),e(g+" Wrote(and encode) zipped json to encrypted stream.",c,t.INFO),l.PutBytes(B,B.length),d(60),l.Close();var F=l.GetBuffer();if(e("CRfOneFileSys."+S+" buffer.length="+F.length,c,t.INFO),i){var T=b.encr_GetDataSalt(s,i),N=b.encr_GetDataKey(s,i),A=b.encr_GetDataIterations(s,i);C.ofs_SetData(T,N,A,s,i,o)}var P=(new Date).getTime();e("CRfOneFileSys."+S+"  <- TIME="+(P-O)+"ms.",c,t.FUNC_INOUT),d(75),i?function(e){C.RfTEST_OFS(e,o,function(t){typeof f!=m&&(d(99),f(e))},function(e){typeof y!=m&&y(e)},s,i)}(F):f(F)}return void function(){d(5);var n=new I,s="onefile1";if(s=a.stringToBytes(s),!n.PutBytes(s,8))return e(S+" Could not write onefile1.",c,t.SPECIAL_CASE),void(typeof y!=m&&y({Code:r.SibTErr_LocalErr,Description:"Could not write onefile1",sibErr:"LocalErr"},b));e(g+" [ByteStream]: wrote signature 'onefile1'",c,t.INFO);var i=""!=o,_=l.enIntegrityCheck|l.enZipped;if(i&&(_|=l.enEncrypted),!n.PutByte(_))return e(S+"  Could not write flags.",c,t.SPECIAL_CASE),void(typeof y!=m&&y({Code:r.SibTErr_LocalErr,Description:"Could not write flags",sibErr:"LocalErr"},b));e(g+" [ByteStream]: wrote flags='"+_+"'",c,t.INFO);var h=0!=(_&l.enIntegrityCheck),f=0!=(_&l.enEncrypted),u=0!=(_&l.enZipped);e(g+" isIntegrityCheck="+h+", isEncrypted="+f+", isZipped="+u,c,t.INFO),d(20),B(n,h,f)}()}catch(n){return e("ERROR  EncodeZipOFSBytes: "+n,c,t.EXCEPTION),void(typeof y!=m&&y({Code:r.SibTErr_CatchedException,Description:n.toString(),sibErr:"LocalErr"}))}},g.prototype.DecodeUnZipOFSBytes=function(s,a,_,h,f,y,u,p){try{p||(p=function(e){}),selfObj=this,p(10);var d="DecodeUnZipOFSBytes";e(d+" FILE='"+a+"' Account='"+_+"' length="+s.length,c,t.FUNC_INOUT);var C=(new Date).getTime();function S(r,s){E(r,function(r){if(e(d+" --- OK - opened.",c,t.INFO),p(90),s){var n=s.encr_GetDataSalt(a,_),i=s.encr_GetDataKey(a,_),f=s.encr_GetDataIterations(a,_);selfObj.ofs_SetData(n,i,f,a,_,h)}var u=(new Date).getTime();e(d+"  <- TOTAL ### TIME ### ="+(u-C)+"ms. accountId='"+_+"' fileName='"+a+"'",c,t.FUNC_INOUT),p(99),typeof y!=m&&y(o,r)},function(e){return-1==e?(typeof u!=m&&u({Code:n.RfErr_AuthRejected,Description:"Wrong master password",sibErr:"LocalErr"}),!1):-2==e?(typeof u!=m&&u({Code:-2,Description:"Maximum call stack size exceeded",sibErr:"LocalErr"}),!1):void 0})}return void function(){p(15);var o=new I(s),y=new Array(8);o.GetBytes(y,8);var C=new Uint8Array([111,110,101,102,105,108,101,49]);if(!i.IsEqualArrays(y,C))return e(d+" Wrong file format! Could not read onefile1.",c,t.SPECIAL_CASE),typeof u!=m&&u({Code:n.RfErr_BadData,Description:"Wrong file format : Could not read onefile1",sibErr:"LocalErr"}),!1;var g=o.GetByte();if(-1==g)return e(d+"  Wrong file format! Could not get flags.",c,t.SPECIAL_CASE),typeof u!=m&&u({Code:n.RfErr_BadData,Description:"Wrong file format : Could not get flags",sibErr:"LocalErr"}),!1;if(e(d+".  flags="+g,c,t.INFO),g&l.enIntegrityCheck&&(e(d+"  enIntegrityCheck!",c,t.INFO),!(b=new R(o)).OpenRead(f)))return e(d+"  enIntegrityCheck FAILED!",c,t.SPECIAL_CASE),typeof u!=m&&u({Code:n.RfErr_BadData,Description:"enIntegrityCheck failed!",sibErr:"LocalErr"}),!1;if(0!=(g&l.enEncrypted)){if(e(d+"  enEncrypted!",c,t.SPECIAL_CASE),""==h)return typeof u!=m&&u({Code:r.SibTErr_AuthRejected,Description:"Password is required",sibErr:"LocalErr"}),!1;var b;(b=new k(b,h)).m_bRead=!0;var E=b,O=selfObj.ofs_GetData(a,_,h);O.key&&O.salt&&(b.encr_SetDataSalt(O.salt,a,_),b.encr_SetDataKey(O.key,a,_),b.encr_SetDataIterations(O.iterations,a,_)),p(20),setTimeout(function(){!function(r,n,s){p(40),r.OpenRead(f,a,_,function(){e(d+" okBack ->",c,t.INFO),p(60);var i=(new Date).getTime();e(d+". We already read headers and garbage bytes. Here goes real data...",c,t.INFO);for(var a=new Array,o=!1,_=0;!o;)-1==(_=r.GetByte())?o=!0:a.push(_);var h=(new Date).getTime();e(d+" After push data to memoryStream. Time="+(h-i),c,t.INFO),p(75),s&l.enZipped&&e(d+" ZIPPED!",c,t.INFO),S(a,n)},function(e){return u(e),!1})}(b,E,g)},0)}else{e(d+"  NOT ENCRYPTED!",c,t.INFO);var B=(new Date).getTime();e(d+".  Here goes real NOT encrypted data...",c,t.INFO);for(var v=new Array,F=!1,T=0;!F;)-1==(T=b.GetByte())?F=!0:v.push(T);var N=(new Date).getTime();e(d+" After push data to memoryStream. Time="+(N-B),c,t.INFO),g&l.enZipped&&e(d+" ZIPPED!",c,t.INFO),S(v,!1)}}()}catch(n){return e("ERROR  DecodeUnZipOFSBytes: "+n,c,t.EXCEPTION),typeof u!=m&&u({Code:r.SibTErr_CatchedException,Description:n.toString(),sibErr:"LocalErr"}),!1}},I.prototype.GetBuffer=function(){return this.buf},I.prototype.FlushBuffer=function(){null==this.m_buffer_stream&&(this.m_buffer_stream=new Array);for(var e=0;e<this.m_buf_ix;e++)this.m_buffer_stream.push(this.buf[e]);this.buf=new Array(this.m_buf_len),this.m_buf_ix=0},I.prototype.Close=function(){return null!=this.m_buffer_stream&&(this.FlushBuffer(),this.buf=this.m_buffer_stream,this.m_buffer_stream=null),this.buf.length=this.m_nCurPosIn,this.m_bEOF=!1,this.m_nUngetChar=-1,this.m_nCurPosIn=0,this.m_nCurLineIn=0,this.m_bIsOpen=!1,!0},I.prototype.PutBytes=function(e,t,r){var n=typeof r!=m?r:0;if(n+t>e.length)return!1;for(var s=0;s<t;s++)if(!this.PutByte(e[n+s]))return!1;return!0},I.prototype.PutByte=function(e){return this.m_buf_ix>=this.m_buf_len&&this.FlushBuffer(),this.buf[this.m_buf_ix++]=e,this.m_nCurPosIn++,!0},I.prototype.GetBytes=function(r,n,s){var i=typeof s!=m?s:0;if(i+n>r.length)return!1;for(var a=0;a<n;a++){var o=this.GetByte();if(-1==o)return e("ByteStream.GetBytes. Return false. <-",c,t.SPECIAL_CASE),!1;r[i+a]=o}return!0},I.prototype.GetByte=function(){var r;return this.m_nUngetChar>=0?(r=this.m_nUngetChar,this.m_nUngetChar=-1,this.m_nCurPosIn++,r):this.m_bEOF?(e("ByteStream.GetByte. Return false. Unexpected EOF",c,t.SPECIAL_CASE),-1):this.m_buf_ix>=this.m_buf_len?(this.m_bEOF=!0,e("ByteStream.GetByte. Return false. End of file at pos: "+this.m_nCurPosIn,c,t.SPECIAL_CASE),-1):(r=this.buf[this.m_buf_ix++],this.m_nCurPosIn++,10==r&&this.m_nCurLineIn++,r)};var O=0,B=1,v=2,F=3,T=100;function R(e,t){this.algorithm=-1,this.m_block_size=typeof t!=m?t:8192,this.m_hash_len=0,this.m_buf_len=0,this.m_buf_ix=0,this.m_Checkedbuffer=null,this.m_bIsOpen=!1,this.m_bEOF=!1,this.m_nUngetChar=-1,this.m_nCurPosIn=0,this.m_nCurLineIn=0,this.m_bRead=!1,this.m_src=e,this.m_bIsByteArray=!1}R.prototype.Clone=function(e){e&&(this.m_src=new R,this.m_src.m_bEOF=e.m_bEOF,this.m_src.m_bIsOpen=e.m_bIsOpen,this.m_src.m_nUngetChar=e.m_nUngetChar,this.m_src.m_nCurPosIn=e.m_nCurPosIn,this.m_src.m_nCurLineIn=e.m_nCurLineIn,this.m_src.m_buf_ix=e.m_buf_ix,this.m_src.m_buf_len=e.m_buf_len,this.m_src.buf=e.buf)},R.prototype.InitAlgorithm=function(e){switch(this.m_hash_len=0,e){case O:this.m_hash_len=4;break;case B:this.m_hash_len=16;break;case v:case F:break;default:return!1}return!0},R.prototype.Base_Init=function(){this.m_bEOF=!1,this.m_nUngetChar=-1,this.m_nCurPosIn=0,this.m_nCurLineIn=0,this.m_bIsOpen=!1},R.prototype.Base_OpenWrite=function(){return this.Base_Init(),this.m_bIsOpen=!0,this.m_bRead=!1,!0},R.prototype.Base_OpenRead=function(){return this.Base_Init(),this.m_bIsOpen=!0,this.m_bRead=!0,!0},R.prototype.OpenRead=function(e){return this.Base_OpenRead(),this.m_bIsByteArray=e,this.m_buf_len=0,this.m_buf_ix=0,this.m_Checkedbuffer=[],this.algorithm=this.m_src.GetByte(),!(this.algorithm>=T)&&this.InitAlgorithm(this.algorithm)},R.prototype.GetByte=function(){var e;return this.m_nUngetChar>=0?(e=this.m_nUngetChar,this.m_nUngetChar=-1,this.m_nCurPosIn++,e):this.m_bEOF?-1:this.m_buf_ix>=this.m_buf_len&&!this.ReadBuffer()?-1:(e=this.m_Checkedbuffer[this.m_buf_ix++],this.m_nCurPosIn++,e)},R.prototype.GetBytes=function(e,t,r){var n=typeof r!=m?r:0;if(n+t>e.length)return!1;for(var s=0;s<t;s++){e[n+s];var i=this.GetByte();if(-1==i)return!1;e[n+s]=i}return!0},R.prototype.OpenWrite=function(){return this.Base_OpenWrite(),this.algorithm=B,this.m_buf_len=0,this.m_buf_ix=0,this.m_Checkedbuffer=[],!!this.InitAlgorithm(this.algorithm)&&(!!this.m_src.PutByte(this.algorithm)&&(this.m_bIsOpen=!0,!0))},R.prototype.PutByte=function(e){return this.m_Checkedbuffer[this.m_buf_ix++]=e,this.m_nCurPosIn++,!(this.m_buf_ix>=this.m_block_size&&!this.WriteBuffer())},R.prototype.PutBytes=function(e,t,r){var n=typeof r!=m?r:0;if(n+t>e.length)return!1;for(var s=0;s<t;s++)if(!this.PutByte(e[n+s]))return!1;return!0},R.prototype.ReadBuffer=function(){var r="CheckedStream.ReadBuffer",n=new Array(4);if(!this.m_src.GetBytes(n,4))return e("<- "+r+".  Cannot get length of CheckedStream. Return FALSE.",c,t.FUNC_INOUT),!1;if(!this.m_bIsByteArray)for(var s=0;s<n.length;s++)n[s]=255&n[s].charCodeAt(0);if(this.m_buf_len=i.GetLittleEndianIntegerFromByteArray(n,0),0==this.m_buf_len)return this.m_bEOF=!0,e("<- "+r+".  EOF. Return FALSE. De(En)coding COMPLETE",c,t.FUNC_INOUT),!1;var a=new Array(this.m_hash_len);if(!this.m_src.GetBytes(a,this.m_hash_len))return e("<- "+r+".  Cannot get md5 HASH of CheckedStream (zipped). Return FALSE.",c,t.FUNC_INOUT),!1;var o=new Array(this.m_hash_len);for(s=0;s<a.length;s++)o[s]=this.m_bIsByteArray?a[s]:255&a[s].charCodeAt(0);return this.m_Checkedbuffer=new Array(this.m_buf_len),!!this.m_src.GetBytes(this.m_Checkedbuffer,this.m_buf_len)&&(i.IsEqualArrays(o,md5.array(this.m_Checkedbuffer))?(this.m_buf_ix=0,!0):(e("<- "+r+".  MD5 compare hash error. Return FALSE.",c,t.FUNC_INOUT),!1))},R.prototype.WriteBuffer=function(){var e=i.GetLittleEndianByteArrayFromInteger(this.m_buf_ix);if(!this.m_src.PutBytes(e,e.length))return!1;var t=new Array(this.m_buf_ix);i.BlockCopy(this.m_Checkedbuffer,0,t,0,this.m_buf_ix);var r=md5.array(t);return!!this.m_src.PutBytes(r,this.m_hash_len)&&(!!this.m_src.PutBytes(this.m_Checkedbuffer,this.m_buf_ix)&&(this.m_buf_ix=0,!0))},R.prototype.Close=function(){if(!this.m_bIsOpen)return!0;if(!this.m_bRead){if(!this.WriteBuffer())return!1;if(!this.m_src.PutBytes([0,0,0,0],4))return!1}return!!this.m_src.Close()&&(this.m_buf_len=0,this.m_buf_ix=0,this.m_Checkedbuffer=null,!0)},R.prototype.GetBuffer=function(){return this.m_src.GetBuffer()};var N=0,A=1,P=2,D=3,L=4;function k(e,t){this.m_encrPass=typeof t!=m?t:"",this.m_ctx=null,this.m_Encryptedbuffer=[],this.m_buf_len=0,this.m_buf_ix=0,this.m_bLastBlock=!1,this.m_nCurPosIn=0,this.m_bLastBlockLoaded=!1,this.m_bRead=!1,this.m_bIsOpen=!1,this.m_bEOF=!1,this.m_nUngetChar=-1,this.m_nCurPosIn=0,this.m_nCurLineIn=0,this.m_bNoPadding=!1,this.m_src=e,this.m_salt_length=16,this.m_max_leading_garbage_length=32,this.m_out_buf_len=512,this.m_read_buf_len=512,this.m_bIsByteArray=!1,this.m_encr_CashedSalts={},this.m_encr_CashedKeys={},this.m_encr_CashedIterations={}}k.prototype.encr_SetDataIterations=function(e,t,r){this.m_encr_CashedIterations[r]||(this.m_encr_CashedIterations[r]={}),this.m_encr_CashedIterations[r][t]=e},k.prototype.encr_GetDataIterations=function(e,t){return this.m_encr_CashedIterations[t]?this.m_encr_CashedIterations[t][e]:0},k.prototype.encr_SetDataSalt=function(e,t,r){this.m_encr_CashedSalts[r]||(this.m_encr_CashedSalts[r]={}),this.m_encr_CashedSalts[r][t]=e},k.prototype.encr_GetDataSalt=function(e,t){return this.m_encr_CashedSalts[t]?this.m_encr_CashedSalts[t][e]:[]},k.prototype.encr_SetDataKey=function(e,t,r){this.m_encr_CashedKeys[r]||(this.m_encr_CashedKeys[r]={}),this.m_encr_CashedKeys[r][t]=e},k.prototype.encr_GetDataKey=function(e,t){return this.m_encr_CashedKeys[t]?this.m_encr_CashedKeys[t][e]:null},k.prototype.OpenWrite=function(r,n,o,_,h){try{h=void 0!==h&&h,_=void 0===_?P:_;this.Base_OpenWrite();var f="gsencst1";f=a.stringToBytes(f),this.m_src.PutBytes(f,8),e("EncryptedStream.OpenWrite. [CheckedStream] Put string *gsencst1*. buffer["+this.m_src.m_Checkedbuffer.length+"]="+this.m_src.m_Checkedbuffer.join(),c,t.INFO);var m=h?1:0;this.m_src.PutByte(m),e("EncryptedStream.OpenWrite. [CheckedStream] Put noPaddingByte="+m,c,t.INFO),this.m_src.PutByte(_),e("EncryptedStream.OpenWrite. [CheckedStream] Put Algorithm="+_,c,t.INFO);var y=o||4096,u=i.GetLittleEndianByteArrayFromInteger(y);e("EncryptedStream.OpenWrite. [CheckedStream] Put 4 bytes rounds=' "+u+"'  (int)iterations=' "+o+"'",c,t.INFO),this.m_src.PutBytes(u,u.length),e("EncryptedStream.OpenWrite. [CheckedStream] buffer["+this.m_src.m_Checkedbuffer.length+"]="+this.m_src.m_Checkedbuffer.join(),c,t.INFO),this.m_src.PutByte(this.m_salt_length),e("EncryptedStream.OpenWrite. [CheckedStream] Put salt.length="+this.m_salt_length,c,t.INFO);var p=i.randomBytes(this.m_salt_length);n&&(this.encr_SetDataSalt(p,r,n),this.encr_SetDataIterations(y,r,n)),this.m_src.PutBytes(p,this.m_salt_length),h&&(this.m_src.PutByte(C.enNoPadding),e("EncryptedStream.OpenWrite. [CheckedStream] Put NoPadding byte=1",c,t.INFO)),e("EncryptedStream.OpenWrite. [CheckedStream]  buffer=["+this.m_src.m_Checkedbuffer.length+"]="+this.m_src.m_Checkedbuffer.join(),c,t.INFO);var d=1;switch(_){case P:d=2;break;case D:case L:d=3}var l=new RfapiJS.Pbkdf2(d,p,this.m_encrPass,y),S=new Array(64);S=l.GetBytes(64),n&&this.encr_SetDataKey(S,r,n),this.m_buf_len=0,this.m_buf_ix=0,this.m_bLastBlock=!1,this.m_bIsOpen=!0;var g=new Array(32),b=new Array(16);i.BlockCopy(S,0,g,0,32),i.BlockCopy(S,32,b,0,16);var E=CryptoJS.enc.Hex.parse(i.bytesToHex(g)),I=CryptoJS.enc.Hex.parse(i.bytesToHex(b));this.keyWords=E,this.ivWords=I;var O={};O.iv=I,O.mode=CryptoJS.mode.CBC,O.padding=h?CryptoJS.pad.NoPadding:CryptoJS.pad.Pkcs7,this.m_bNoPadding=!!h,this.m_ctx=CryptoJS.algo.AES.createEncryptor(E,O);for(var B=0==this.m_max_leading_garbage_length?0:this.m_max_leading_garbage_length<=32?i.random()%this.m_max_leading_garbage_length:i.random()%(this.m_max_leading_garbage_length-32)+32,v=170,F=0;F<B;F++){var T=i.longToSingleByte(i.random());if(0==i.longToSingleByte(T^v)&&(T=i.longToSingleByte(i.random()),0==i.longToSingleByte(T^v)&&T++),!this.PutByte(T))return!1;v=i.longToSingleByte(v^T)}return this.PutByte(v),e("EncryptedStream.OpenWrite. Put GARBAGE["+B+"] and  pattern = "+v,c,t.INFO),e("EncryptedStream.OpenWrite. Garbage was written exit-> EncryptedStream = "+this.m_Encryptedbuffer.join(),c,t.INFO),!0}catch(e){s("EXCEPTION in EncryptedStream.OpenWrite"+e.toString(),c)}},k.prototype.OpenRead=function(n,a,o,_,h){try{var f=this,y="EncryptedStream.OpenRead";function u(n,y){if(e(" PBkdf_callback -> ",c,t.INFO),100==n){try{o&&f.encr_SetDataKey(y,a,o);var u=new Array(32),p=new Array(16);i.BlockCopy(y,0,u,0,32),i.BlockCopy(y,32,p,0,16);var d=CryptoJS.enc.Hex.parse(i.bytesToHex(u)),l=CryptoJS.enc.Hex.parse(i.bytesToHex(p));f.keyWords=d,f.ivWords=l}catch(e){return s("EXCEPTION in EncryptedStream.OpenRead.PBkdf_Callback[1] "+e.toString(),c),typeof h!=m&&h({Code:r.SibTErr_LocalErr,Description:"EXCEPTION in EncryptedStream.OpenRead.PBkdf_Callback[1]:"+e.toString()}),!1}try{var S={};S.iv=l,S.mode=CryptoJS.mode.CBC,S.padding=CryptoJS.pad.Pkcs7,0!=(v&C.enNoPadding)&&(S.padding=CryptoJS.pad.NoPadding,f.m_bNoPadding=!0),f.m_ctx=CryptoJS.algo.AES.createDecryptor(d,S),f.m_buf_len=0,f.m_buf_ix=0,f.m_bLastBlock=!1,e("PBkdf_callback. Stream header OK",c,t.INFO);var g=1048576,b=170,E=0}catch(e){return s("EXCEPTION in EncryptedStream.OpenRead.PBkdf_Callback[2] "+e.toString(),c),typeof h!=m&&h({Code:r.SibTErr_LocalErr,Description:"EXCEPTION in EncryptedStream.OpenRead.PBkdf_Callback[2]:"+e.toString()}),!1}var I=[];for(E=0;E<g;E++){var O=f.GetByte();if(-1==O)return e("[READ_ERROR] --- NO - stream too short!",c,t.INFO),typeof h!=m&&h({Code:r.SibTErr_LocalErr,Description:"--- NO - stream too short!"}),!1;if(I.push(O),0==(O^b)){e("PBkdf_callback. garbage_bytes_read  BREAK. Return TRUE.",c,t.INFO);break}if(E==g-1)return e("[READ_ERROR] max_garbage_bytes! RETURN FALSE!",c,t.INFO),typeof h!=m&&h({Code:r.SibTErr_LocalErr,Description:"garbage_bytes_read RETURN FALSE!"}),!1;b^=O}return e("OK. GARBAGE bytes skipped ["+I.length+"] = "+I.join(),c,t.INFO),_(),!0}}e(y+"  ->",c,t.INFO),f.Base_OpenRead(),f.m_bIsByteArray=n;for(var p=new Array(8),d=0;d<8;d++)p[d]=f.m_src.GetByte();var l=new Uint8Array([103,115,101,110,99,115,116,49]);if(!i.IsEqualArrays(p,l))return typeof h!=m&&h({Code:r.SibTErr_LocalErr,Description:"Wrong file format. Bad stream header != gsencst1"}),!1;var S=f.m_src.GetByte();if(-1==S)return typeof h!=m&&h({Code:r.SibTErr_LocalErr,Description:"Wrong file format. Bad stream header. ext_header_len"}),!1;var g=f.m_src.GetByte();if(-1==g)return typeof h!=m&&h({Code:r.SibTErr_LocalErr,Description:"Wrong file format. Bad stream header. kdf_algorithm"}),!1;var b=g;if(b!=P&&b!=D)return typeof h!=m&&h({Code:r.SibTErr_LocalErr,Description:"Unknown ecryption method"}),!1;var E=new Array(4);if(!f.m_src.GetBytes(E,4))return typeof h!=m&&h({Code:r.SibTErr_LocalErr,Description:"Cannot get hash rounds"}),!1;var I=i.GetLittleEndianIntegerFromByteArray(E,0);if(0==I||I>524288)return typeof h!=m&&h({Code:r.SibTErr_LocalErr,Description:"Wrong ecryption parameters: hash rounds"}),!1;var O=f.m_src.GetByte();if(-1==O)return typeof h!=m&&h({Code:r.SibTErr_LocalErr,Description:"Wrong ecryption parameters: Cannot get salt length."}),!1;var B=new Array(O);if(!f.m_src.GetBytes(B,O))return typeof h!=m&&h({Code:r.SibTErr_LocalErr,Description:"Wrong ecryption parameters: Cannot get salt bytes."}),!1;var v=0,F=new Array(S);if(!f.m_src.GetBytes(F,S))return typeof h!=m&&h({Code:r.SibTErr_LocalErr,Description:"Wrong ecryption parameters: Cannot get reserved bytes."}),!1;if(v=F[0],b==N||b==A)return typeof h!=m&&h({Code:r.SibTErr_LocalErr,Description:"Wrong decryption parameters: Unsupported algorithm SHA1"}),!1;e(y+"  ALG='"+b+"' SKIP='"+F+"' Salt.length='"+O+"' hash_rounds='"+I+"'",c,t.INFO);try{if(o)var T=f.encr_GetDataSalt(a,o),R=f.encr_GetDataKey(a,o),k=f.encr_GetDataIterations(a,o);var x=!1;k==I&&T&&(x=i.compareSets(T,B))}catch(e){return s("EXCEPTION in EncryptedStream.OpenRead[6] "+e.toString(),c),typeof h!=m&&h({Code:r.SibTErr_LocalErr,Description:"EXCEPTION in EncryptedStream.OpenRead[6]:"+e.toString()}),!1}try{if(x&&R)e(y+" #####-- CACHED Salt and KEYS --##### ",c,t.INFO),u(100,R);else{o&&(f.encr_SetDataSalt(B,a,o),f.encr_SetDataIterations(I,a,o));var w=1;switch(b){case P:w=2;break;case D:case L:w=3}new RfapiJS.Pbkdf2(w,B,f.m_encrPass,I).GetBytes(64,u,_,h)}}catch(e){return s("EXCEPTION in EncryptedStream.OpenRead[7] "+e.toString(),c),typeof h!=m&&h({Code:r.SibTErr_LocalErr,Description:"EXCEPTION in EncryptedStream.OpenRead[7]:"+e.toString()}),!1}return}catch(e){s("EXCEPTION in EncryptedStream.OpenRead"+e.toString(),c),typeof h!=m&&h({Code:r.SibTErr_LocalErr,Description:"EXCEPTION in EncryptedStream.OpenRead:"+e.toString()})}},k.prototype.FillReadBuf=function(){var r="EncryptedStream.FillReadBuf";if(this.m_Encryptedbuffer=new Array(this.m_read_buf_len),!this.m_bLastBlock)for(var n,s=0;s<this.m_read_buf_len;s++){if(-1==(n=this.m_src.GetByte())){this.m_bLastBlock=!0,this.m_buf_len=s;break}this.m_Encryptedbuffer[s]=n}if(this.m_bLastBlock){this.m_bLastBlockLoaded=!0;for(var a=0;typeof this.m_Encryptedbuffer[a]!=m;)a++;this.m_Encryptedbuffer.length=a;var o=CryptoJS.enc.u8array.parse(this.m_Encryptedbuffer),_=this.m_ctx.process(o),h=this.m_ctx.finalize();if(e(r+". *LAST_BLOCK* ciphertextFinal='"+h+"'",c,t.INFO),h.sigBytes<0)var f=CryptoJS.enc.Base64.stringify(_);else{h=_.concat(h);f=CryptoJS.enc.Base64.stringify(h)}y=i.base64ToBytes(f);this.m_buf_len=y.length,e(r+". *LAST_BLOCK* m_Encryptedbuffers["+this.m_Encryptedbuffer.length+"] = "+this.m_Encryptedbuffer.join()+"\n READ TRANSFORMED bytes='"+y.join()+"'",c,t.INFO),this.m_Encryptedbuffer=y}else{var y;if(!(y=CryptoJS.enc.u8array.stringify(this.m_ctx.process(CryptoJS.enc.u8array.parse(this.m_Encryptedbuffer)))).length)return void this.FillReadBuf();this.m_buf_len=y.length,this.m_Encryptedbuffer=[];for(var u=0;u<y.length;u++)this.m_Encryptedbuffer.push(y[u])}},k.prototype.Base_OpenWrite=function(){return this.m_bRead=!1,this.m_bEOF=!1,this.m_nUngetChar=-1,this.m_nCurPosIn=0,this.m_nCurLineIn=0,this.m_bIsOpen=!0,!0},k.prototype.Base_OpenRead=function(){return this.m_bRead=!0,this.m_bEOF=!1,this.m_nUngetChar=-1,this.m_nCurPosIn=0,this.m_nCurLineIn=0,this.m_bIsOpen=!0,!0},k.prototype.TryGetByteFromReadBuf=function(){if(this.m_buf_len>0&&this.m_buf_ix<this.m_buf_len){var r=this.m_Encryptedbuffer[this.m_buf_ix++];return this.m_nCurPosIn++,r}return this.m_bLastBlock?(e("<-  EncryptedStream.TryGetByteFromReadBuf. Last block.",c,t.INFO),-1):(this.m_buf_ix=0,-1)},k.prototype.GetByte=function(){var e=this.TryGetByteFromReadBuf();if(-1==e){if(this.m_bLastBlockLoaded)return-1;try{this.FillReadBuf()}catch(e){return-1}return this.TryGetByteFromReadBuf()}return e},k.prototype.PutByte=function(e){if(this.m_buf_ix<this.m_out_buf_len)return this.m_Encryptedbuffer[this.m_buf_ix++]=e,!0;for(var t=CryptoJS.enc.u8array.stringify(this.m_ctx.process(CryptoJS.enc.u8array.parse(this.m_Encryptedbuffer))),r=t.length,n=[],s=0;s<t.length;s++)n.push(t[s]);return!!this.m_src.PutBytes(n,r)&&(this.m_buf_ix=0,this.m_Encryptedbuffer.length=0,this.m_Encryptedbuffer[this.m_buf_ix++]=e,!0)},k.prototype.PutBytes=function(e,t,r){var n=typeof r!=m?r:0;if(n+t>e.length)return!1;for(var s=0;s<t;s++)if(!this.PutByte(e[n+s]))return!1;return!0},k.prototype.GetBuffer=function(){return this.m_src.GetBuffer()},k.prototype.Close=function(){var r="EncryptedStream.Close";if(e("-> "+r,c,t.INFO),!this.m_bIsOpen)return!0;if(!this.m_bRead){if(this.m_bNoPadding){var n=0==this.m_max_leading_garbage_length?0:this.m_max_leading_garbage_length<=32?i.random()%this.m_max_leading_garbage_length:i.random()%(this.m_max_leading_garbage_length-32)+32,s=16*parseInt((this.m_buf_ix+n+16-1)/16)-this.m_buf_ix,a=i.randomBytes(s);e(r+". *NoPadding* put garbage to the end="+a.join(),c,t.INFO);for(var o=0;o<a.length;o++)this.m_Encryptedbuffer.push(a[o]),this.m_buf_ix++}e(r+". this.m_Encryptedbuffer="+this.m_Encryptedbuffer.join(),c,t.INFO);var _=CryptoJS.enc.u8array.parse(this.m_Encryptedbuffer),h=this.m_ctx.process(_),f=this.m_ctx.finalize();CryptoJS.enc.Base64.stringify(h),CryptoJS.enc.Base64.stringify(f);e(r+". textPart='"+h.toString()+"' textFinal='"+f+"'  textPart.sigBytes="+h.sigBytes+" textFinal.sigBytes="+f.sigBytes,c,t.INFO);var m=h.concat(f),y=CryptoJS.enc.u8array.stringify(m),u=[];for(o=0;o<y.length;o++)u.push(y[o]);if(!this.m_src.PutBytes(u,u.length))return e("<- "+r+"  this.m_src.PutBytes return false",c,t.INFO),!1}return this.m_ctx=null,this.m_src.Close()?(this.m_buf_len=0,this.m_buf_ix=0,this.m_Encryptedbuffer=[],e("<- "+r+" Correct return. TRUE.",c,t.INFO),!0):(e("<- "+r+"  this.m_src.Close return false",c,t.INFO),!1)},k.prototype.encr_ClearCachedValues=function(e,t){t&&(this.m_encr_CashedIterations[t]||(this.m_encr_CashedIterations[t]={}),this.m_encr_CashedIterations[t][e]=0,this.m_encr_CashedSalts[t]||(this.m_encr_CashedSalts[t]={}),this.m_encr_CashedSalts[t][e]=null,this.m_encr_CashedKeys[t]||(this.m_encr_CashedKeys[t]={}),this.m_encr_CashedKeys[t][e]=null)},RfapiJS.CRfOneFileSys=g}).apply(RfapiJS);
//# sourceMappingURL=ofs.js.map